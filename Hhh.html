<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ² Ù‡ÙØªÚ¯ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ (Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ)</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f8fafc;
            --surface: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --slot-h: 40px; /* Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø³Ø§Ø¹Øª */
            --danger: #ef4444;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            padding-bottom: 100px;
        }

        /* --- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± --- */
        .toolbar {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            z-index: 100;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        label { font-size: 12px; font-weight: bold; color: #64748b; }
        
        input, select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            outline: none;
            font-family: inherit;
        }

        input[type="color"] {
            padding: 0; border: none; width: 40px; height: 40px; cursor: pointer;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            color: white;
            transition: 0.2s;
        }

        .btn-add { background: var(--primary); }
        .btn-add:hover { background: #1d4ed8; }
        .btn-danger { background: var(--danger); }
        .btn-secondary { background: #64748b; }
        .btn-success { background: #10b981; }

        /* --- Ú¯Ø±ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ --- */
        .schedule-container {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding-bottom: 20px;
            min-height: 80vh;
        }

        .day-col {
            min-width: 200px;
            flex: 1;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
        }

        .day-header {
            background: #334155;
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .timeline {
            position: relative;
            /* 24 Ø³Ø§Ø¹Øª * Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø³Ø§Ø¹Øª */
            height: calc(24 * var(--slot-h)); 
            background: repeating-linear-gradient(
                to bottom,
                transparent 0,
                transparent calc(var(--slot-h) - 1px),
                var(--border) calc(var(--slot-h) - 1px),
                var(--border) var(--slot-h)
            );
        }

        /* Ø®Ø· Ú†ÛŒÙ† Ù†ÛŒÙ… Ø³Ø§Ø¹Øª */
        .timeline::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: repeating-linear-gradient(
                to bottom,
                transparent 0,
                transparent calc(var(--slot-h) / 2 - 1px),
                #f1f5f9 calc(var(--slot-h) / 2 - 1px),
                #f1f5f9 calc(var(--slot-h) / 2)
            );
            z-index: 0;
            pointer-events: none;
        }

        /* Ø³Ø§Ø¹Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø³ Ø²Ù…ÛŒÙ†Ù‡ */
        .time-marker {
            position: absolute;
            left: 2px;
            font-size: 10px;
            color: #94a3b8;
            transform: translateY(-50%);
            background: var(--surface);
            padding: 0 4px;
        }

        /* --- Ú©Ø§Ø±Øª ÙØ¹Ø§Ù„ÛŒØª --- */
        .task-card {
            position: absolute;
            left: 4px; right: 4px;
            border-radius: 4px;
            padding: 4px;
            font-size: 11px;
            color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            cursor: pointer;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            z-index: 5;
            border: 1px solid rgba(255,255,255,0.3);
            transition: transform 0.1s;
        }

        .task-card:hover {
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        /* --- Ù…ÙˆØ¯Ø§Ù„ --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .modal-title { margin-top: 0; color: var(--text); border-bottom: 2px solid var(--border); padding-bottom: 10px; }

        .btn-group { display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end; }

        /* --- Ù¾Ø±ÛŒÙ†Øª --- */
        @media print {
            body { background: white; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .toolbar { display: none; }
            
            .schedule-container {
                display: block;
                overflow: visible;
                min-height: auto;
            }

            .day-col {
                float: right;
                width: 48%; /* Ø¯Ùˆ Ø³ØªÙˆÙ† Ø¯Ø± ØµÙØ­Ù‡ */
                margin-left: 1%;
                margin-bottom: 20px;
                border: 1px solid #000;
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .day-header { background: #ddd !important; color: black !important; border-bottom: 1px solid #000; }
            
            .timeline { height: auto !important; position: relative; }
            
            /* Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ†Øª Ø§Ø±ØªÙØ§Ø¹ Ø±Ø§ ÙÛŒÚ©Ø³ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… Ú©Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø¨ÛŒÙØªØ¯ */
            .timeline {
                height: calc(24 * 30px); /* Ú©Ù…ÛŒ ÙØ´Ø±Ø¯Ù‡ ØªØ± Ø¨Ø±Ø§ÛŒ Ú©Ø§ØºØ° */
                --slot-h: 30px;
                background-size: 100% 30px; /* ØªÙ†Ø¸ÛŒÙ… Ú¯Ø±Ø§Ø¯ÛŒÙ†Øª */
            }
            
            .task-card {
                box-shadow: none; border: 1px solid #000;
            }
        }
    </style>
</head>
<body>

    <!-- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± -->
    <div class="toolbar no-print">
        <div class="form-group">
            <label>Ø¹Ù†ÙˆØ§Ù† ÙØ¹Ø§Ù„ÛŒØª</label>
            <input type="text" id="taskName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙˆØ±Ø²Ø´">
        </div>
        <div class="form-group">
            <label>Ø±ÙˆØ²</label>
            <select id="taskDay">
                <option value="sat">Ø´Ù†Ø¨Ù‡</option>
                <option value="sun">ÛŒÚ©Ø´Ù†Ø¨Ù‡</option>
                <option value="mon">Ø¯ÙˆØ´Ù†Ø¨Ù‡</option>
                <option value="tue">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</option>
                <option value="wed">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</option>
                <option value="thu">Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</option>
                <option value="fri">Ø¬Ù…Ø¹Ù‡</option>
            </select>
        </div>
        <div class="form-group">
            <label>Ø´Ø±ÙˆØ¹</label>
            <select id="taskStart"></select>
        </div>
        <div class="form-group">
            <label>Ù¾Ø§ÛŒØ§Ù†</label>
            <select id="taskEnd"></select>
        </div>
        <div class="form-group">
            <label>Ø±Ù†Ú¯</label>
            <input type="color" id="taskColor" value="#3b82f6">
        </div>
        <div class="form-group">
            <label>&nbsp;</label>
            <button class="btn-add" onclick="createTask()">+ Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        
        <div style="flex-grow: 1;"></div>

        <div class="form-group" style="flex-direction: row;">
            <button class="btn-secondary" onclick="exportData()">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾</button>
            <button class="btn-secondary" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
            <button class="btn-success" onclick="window.print()">ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª</button>
            <button class="btn-danger" onclick="clearAllData()">ğŸ—‘ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ Ø§ØµÙ„ÛŒ -->
    <div class="schedule-container" id="schedule">
        <!-- Ø±ÙˆØ²Ù‡Ø§ ØªÙˆØ³Ø· JS Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-box">
            <h3 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ¹Ø§Ù„ÛŒØª</h3>
            <input type="hidden" id="editId">
            
            <div class="form-group" style="margin-bottom: 10px;">
                <label>Ø¹Ù†ÙˆØ§Ù†:</label>
                <input type="text" id="editName">
            </div>

            <div class="form-group" style="margin-bottom: 10px;">
                <label>Ø±ÙˆØ²:</label>
                <select id="editDay">
                    <option value="sat">Ø´Ù†Ø¨Ù‡</option>
                    <option value="sun">ÛŒÚ©Ø´Ù†Ø¨Ù‡</option>
                    <option value="mon">Ø¯ÙˆØ´Ù†Ø¨Ù‡</option>
                    <option value="tue">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</option>
                    <option value="wed">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</option>
                    <option value="thu">Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</option>
                    <option value="fri">Ø¬Ù…Ø¹Ù‡</option>
                </select>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <div class="form-group" style="flex:1">
                    <label>Ø´Ø±ÙˆØ¹:</label>
                    <select id="editStart"></select>
                </div>
                <div class="form-group" style="flex:1">
                    <label>Ù¾Ø§ÛŒØ§Ù†:</label>
                    <select id="editEnd"></select>
                </div>
            </div>

            <div class="form-group">
                <label>Ø±Ù†Ú¯:</label>
                <input type="color" id="editColor" style="width: 100%;">
            </div>

            <div class="btn-group">
                <button class="btn-danger" onclick="deleteCurrentTask()">Ø­Ø°Ù</button>
                <button class="btn-secondary" onclick="closeModal()">Ù„ØºÙˆ</button>
                <button class="btn-add" onclick="saveEdit()">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
            </div>
        </div>
    </div>

    <script>
        // --- Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø¯Ù‡ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ---
        const DAYS = [
            { id: 'sat', label: 'Ø´Ù†Ø¨Ù‡' }, { id: 'sun', label: 'ÛŒÚ©Ø´Ù†Ø¨Ù‡' },
            { id: 'mon', label: 'Ø¯ÙˆØ´Ù†Ø¨Ù‡' }, { id: 'tue', label: 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡' },
            { id: 'wed', label: 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡' }, { id: 'thu', label: 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡' },
            { id: 'fri', label: 'Ø¬Ù…Ø¹Ù‡' }
        ];

        let db = []; // Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¢Ø¨Ø¬Ú©Øªâ€ŒÙ‡Ø§ÛŒ ØªØ³Ú©

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ Ø²Ù…Ø§Ù† ---
        // ØªØ¨Ø¯ÛŒÙ„ Ø³Ø§Ø¹Øª Ù…ØªÙ†ÛŒ "08:30" Ø¨Ù‡ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø§Ø² Ø§Ø¨ØªØ¯Ø§ÛŒ Ø±ÙˆØ² (8*60 + 30 = 510)
        function timeToMin(timeStr) {
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        }

        // ØªØ¨Ø¯ÛŒÙ„ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ù‡ Ù…ØªÙ† "08:30"
        function minToTime(minutes) {
            let h = Math.floor(minutes / 60);
            let m = minutes % 60;
            // Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† 24:00
            if (h === 24) return "24:00";
            return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
        }

        // ØªÙˆÙ„ÛŒØ¯ Ù„ÛŒØ³Øª Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø±Ø§Ù¾â€ŒØ¯Ø§ÙˆÙ† (15 Ø¯Ù‚ÛŒÙ‚Ù‡)
        function generateTimeOptions(selectElement, isEnd = false) {
            selectElement.innerHTML = '';
            for (let i = 0; i <= 24 * 60; i += 15) {
                // Ø§Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø§Ø³ØªØŒ 24:00 Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø´Ø¯. Ø§Ú¯Ø± Ø¨Ø±Ø§ÛŒ Ù¾Ø§ÛŒØ§Ù† Ø§Ø³ØªØŒ 00:00 Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø´Ø¯ (Ù…Ú¯Ø± Ø§ÛŒÙ†Ú©Ù‡ Ø¨Ø®ÙˆØ§Ù‡ÛŒØ¯)
                if (!isEnd && i === 24 * 60) continue; 
                if (isEnd && i === 0) continue;

                const timeStr = minToTime(i);
                const opt = new Option(timeStr, i); // Value = Ø¯Ù‚ÛŒÙ‚Ù‡
                selectElement.add(opt);
            }
        }

        // --- Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
        function init() {
            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
            generateTimeOptions(document.getElementById('taskStart'));
            generateTimeOptions(document.getElementById('taskEnd'), true);
            
            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„
            generateTimeOptions(document.getElementById('editStart'));
            generateTimeOptions(document.getElementById('editEnd'), true);

            // Ø³Øª Ú©Ø±Ø¯Ù† Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            document.getElementById('taskStart').value = 480; // 08:00
            document.getElementById('taskEnd').value = 540;   // 09:00

            // Ù„ÙˆØ¯ Ø¯ÛŒØªØ§
            const saved = localStorage.getItem('planner_pro_v2');
            if (saved) {
                try {
                    db = JSON.parse(saved);
                } catch(e) {
                    console.error("Data corrupted", e);
                    db = [];
                }
            }
            render();
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ---

        function createTask() {
            const name = document.getElementById('taskName').value.trim();
            const day = document.getElementById('taskDay').value;
            const start = parseInt(document.getElementById('taskStart').value);
            const end = parseInt(document.getElementById('taskEnd').value);
            const color = document.getElementById('taskColor').value;

            // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ
            if (!name) return alert('Ù†Ø§Ù… ÙØ¹Ø§Ù„ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
            if (start >= end) return alert('Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù† Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø´Ø¯.');

            // Ú†Ú© ØªØ¯Ø§Ø®Ù„
            if (checkOverlap(day, start, end)) return alert('ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±!');

            const task = {
                id: Date.now(),
                name, day, start, end, color
            };

            db.push(task);
            saveData();
            render();
            document.getElementById('taskName').value = ''; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙˆØ±ÙˆØ¯ÛŒ
        }

        function checkOverlap(day, start, end, excludeId = null) {
            return db.some(t => {
                if (t.day !== day) return false;
                if (excludeId && t.id === excludeId) return false;
                // Ø´Ø±Ø· ØªØ¯Ø§Ø®Ù„ Ø±ÛŒØ§Ø¶ÛŒ: (StartA < EndB) Ùˆ (EndA > StartB)
                return (start < t.end) && (end > t.start);
            });
        }

        function render() {
            const container = document.getElementById('schedule');
            container.innerHTML = '';

            DAYS.forEach(d => {
                const col = document.createElement('div');
                col.className = 'day-col';

                // Ù‡Ø¯Ø±
                const header = document.createElement('div');
                header.className = 'day-header';
                header.textContent = d.label;
                col.appendChild(header);

                // ØªØ§ÛŒÙ…â€ŒÙ„Ø§ÛŒÙ† (Ø³ØªÙˆÙ† Ø¹Ù…ÙˆØ¯ÛŒ Ø²Ù…Ø§Ù†)
                const timeline = document.createElement('div');
                timeline.className = 'timeline';

                // Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§Ø±Ú©Ø± Ø³Ø§Ø¹Øªâ€ŒÙ‡Ø§ (ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ø²ÙˆØ¬ Ø¨Ø±Ø§ÛŒ Ø´Ù„ÙˆØº Ù†Ø´Ø¯Ù†)
                for(let h=0; h<24; h+=1) {
                    const marker = document.createElement('div');
                    marker.className = 'time-marker';
                    marker.style.top = (h * 40) + 'px'; // 40px Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø³Ø§Ø¹Øª
                    marker.textContent = h + ':00';
                    timeline.appendChild(marker);
                }

                // Ø§ÙØ²ÙˆØ¯Ù† ØªØ³Ú©â€ŒÙ‡Ø§
                const dayTasks = db.filter(t => t.day === d.id);
                dayTasks.forEach(t => {
                    const card = document.createElement('div');
                    card.className = 'task-card';
                    
                    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª
                    // Ø§Ø±ØªÙØ§Ø¹ Ú©Ù„ ØªØ§ÛŒÙ… Ù„Ø§ÛŒÙ† = 24 * 40px = 960px
                    // Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ = 40 / 60 Ù¾ÛŒÚ©Ø³Ù„ = 0.666px
                    const pixelsPerMin = 40 / 60;
                    
                    card.style.top = (t.start * pixelsPerMin) + 'px';
                    card.style.height = ((t.end - t.start) * pixelsPerMin) + 'px';
                    card.style.backgroundColor = t.color;
                    
                    card.innerHTML = `<strong>${t.name}</strong><span>${minToTime(t.start)} - ${minToTime(t.end)}</span>`;
                    
                    card.onclick = () => openEditModal(t);

                    timeline.appendChild(card);
                });

                col.appendChild(timeline);
                container.appendChild(col);
            });
        }

        function saveData() {
            localStorage.setItem('planner_pro_v2', JSON.stringify(db));
        }

        function clearAllData() {
            if (confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ù…ÛŒâ€ŒØ´ÙˆØ¯!')) {
                db = [];
                saveData();
                render();
            }
        }

        // --- Ø¨Ø®Ø´ Ù…ÙˆØ¯Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ ---
        let currentEditId = null;

        function openEditModal(task) {
            currentEditId = task.id;
            document.getElementById('editId').value = task.id;
            document.getElementById('editName').value = task.name;
            document.getElementById('editDay').value = task.day;
            document.getElementById('editStart').value = task.start;
            document.getElementById('editEnd').value = task.end;
            document.getElementById('editColor').value = task.color;
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditId = null;
        }

        function saveEdit() {
            if (!currentEditId) return;

            const name = document.getElementById('editName').value.trim();
            const day = document.getElementById('editDay').value;
            const start = parseInt(document.getElementById('editStart').value);
            const end = parseInt(document.getElementById('editEnd').value);
            const color = document.getElementById('editColor').value;

            if (!name) return alert('Ù†Ø§Ù… Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
            if (start >= end) return alert('Ø²Ù…Ø§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
            if (checkOverlap(day, start, end, currentEditId)) return alert('ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø§ ØªØ³Ú© Ø¯ÛŒÚ¯Ø±!');

            // Ø¢Ù¾Ø¯ÛŒØª Ø¯Ø± Ø¢Ø±Ø§ÛŒÙ‡
            const index = db.findIndex(t => t.id === currentEditId);
            if (index !== -1) {
                db[index] = { id: currentEditId, name, day, start, end, color };
                saveData();
                render();
                closeModal();
            }
        }

        function deleteCurrentTask() {
            if (!currentEditId) return;
            if (confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) {
                db = db.filter(t => t.id !== currentEditId);
                saveData();
                render();
                closeModal();
            }
        }

        // --- Ø¨Ú©â€ŒØ¢Ù¾ Ú¯ÛŒØ±ÛŒ ---
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "my_schedule_backup.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if (Array.isArray(json)) {
                        if(confirm('Ø¢ÛŒØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ø­Ø°Ù Ùˆ Ø¨Ú©â€ŒØ¢Ù¾ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø´ÙˆØ¯ØŸ')) {
                            db = json;
                            saveData();
                            render();
                        }
                    } else {
                        alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª');
                    }
                } catch(err) {
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„');
                }
            };
            reader.readAsText(file);
            input.value = ''; // Ø±ÛŒØ³Øª Ø§ÛŒÙ†Ù¾ÙˆØª
        }

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
        window.onclick = function(e) {
            if (e.target == document.getElementById('editModal')) closeModal();
        }

        init();
    </script>
</body>
</html>
