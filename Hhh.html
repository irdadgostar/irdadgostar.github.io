<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ Ø¬Ø§Ù…Ø¹ PRO</title>
    <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ù…Ø¯Ø±Ù† Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ */
            --primary: #4f46e5;       
            --primary-dark: #3730a3;
            --bg: #f3f4f6;            
            --surface: #ffffff;
            --border: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 12px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Vazirmatn', system-ui, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            font-size: 14px;
            padding-bottom: 140px;
        }

        /* --- Loading Overlays (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ù…Ù†Ø·Ù‚) --- */
        #loadingBar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), #ec4899, var(--primary));
            background-size: 200% 100%; z-index: 10001; display: none;
            animation: loadingAnim 1.5s infinite linear;
        }
        @keyframes loadingAnim { 0% {background-position: 100% 0;} 100% {background-position: -100% 0;} }

        #processingMsg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* --- Toolbar Modernized --- */
        .toolbar {
            background: var(--surface); padding: 24px; border-radius: var(--radius);
            box-shadow: var(--shadow); margin-bottom: 24px; border: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 20px;
        }
        .toolbar-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        
        .brand { 
            font-weight: 900; font-size: 22px; color: var(--primary); 
            display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px;
        }
        
        .input-group { display: flex; gap: 12px; flex-wrap: wrap; width: 100%; }
        .input-modern {
            padding: 12px 16px; border: 2px solid var(--border); border-radius: 10px;
            font-family: inherit; background: #f9fafb; transition: 0.3s; flex: 1; min-width: 200px;
            font-size: 14px; color: var(--text-main);
        }
        .input-modern:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        /* Modern Buttons */
        .btn {
            padding: 10px 20px; border: none; border-radius: 10px; cursor: pointer;
            font-family: inherit; font-weight: 600; font-size: 13px; color: white;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 10px rgba(0,0,0,0.1); filter: brightness(1.05); }
        .btn:active { transform: translateY(0); }
        .btn svg { width: 18px; height: 18px; stroke-width: 2px; }

        .btn-primary { background: var(--primary); }
        .btn-success { background: #10b981; }
        .btn-danger { background: #ef4444; }
        .btn-dark { background: #374151; }
        .btn-purple { background: #8b5cf6; }
        .btn-orange { background: #f97316; }
        .btn-teal { background: #14b8a6; }
        .btn-blue { background: #3b82f6; }
        
        .mode-toggle { background: #f3f4f6; color: var(--text-muted); border: 1px solid #d1d5db; box-shadow: none; }
        .mode-toggle.active { background: var(--primary); color: white; border-color: transparent; box-shadow: var(--shadow); }

        /* --- Table Modernized --- */
        .planner-wrapper {
            background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow);
            overflow: auto; position: relative; border: 1px solid var(--border);
            max-height: 80vh;
        }
        table { width: 100%; border-collapse: separate; border-spacing: 0; table-layout: fixed; min-width: 1000px; }
        
        thead th {
            background: #1f2937; color: white; padding: 18px; position: sticky; top: 0; z-index: 20;
            border-bottom: 4px solid var(--primary); font-weight: 700; font-size: 15px;
            text-align: center;
        }
        
        .copy-col-btn { 
            background: rgba(255,255,255,0.15); border-radius: 6px; padding: 4px 10px; 
            cursor: pointer; float: left; transition:0.2s; font-size: 11px; display:flex; align-items:center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .copy-col-btn:hover { background: rgba(255,255,255,0.3); }
        
        th:first-child, td:first-child {
            width: 100px; background: #f9fafb; color: var(--text-muted); font-weight: 700; font-size: 12px;
            position: sticky; right: 0; z-index: 30; border-left: 2px solid #e5e7eb; text-align: center;
            vertical-align: middle;
        }
        td { border-bottom: 1px solid #f3f4f6; border-left: 1px dashed #f3f4f6; text-align: center; height: 45px; padding: 0; vertical-align: top; position: relative; }
        tr:last-child td { border-bottom: none; }

        /* Task Cell */
        td.task-cell {
            color: white; padding: 0; cursor: pointer; border: none; z-index: 10;
        }
        
        /* Ø·Ø±Ø§Ø­ÛŒ Ø¯Ø§Ø®Ù„ÛŒ Ø³Ù„ÙˆÙ„ ØªØ³Ú© Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø¨ÛŒØ´ØªØ± */
        .task-inner-block {
            margin: 2px;
            height: calc(100% - 4px);
            border-radius: 8px;
            padding: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: center;
            transition: transform 0.15s;
            overflow: hidden;
        }
        .task-inner-block:hover { transform: scale(1.02); z-index: 20; box-shadow: 0 5px 10px rgba(0,0,0,0.2); }
        
        .task-title { font-weight: 800; margin-bottom: 3px; font-size: 13px; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .task-time-range { font-size: 11px; opacity: 0.95; font-weight: 500; background: rgba(0,0,0,0.2); border-radius: 4px; padding: 2px 6px; width: fit-content; margin: 0 auto; }

        /* Selection */
        body.selection-mode td.empty-cell { cursor: cell; }
        .selected-cell { background-color: #c7d2fe !important; }

        /* --- Modals Modernized --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(17, 24, 39, 0.7); z-index: 2000;
            justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .modal {
            background: white; padding: 28px; border-radius: 20px; width: 90%; max-width: 480px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; flex-direction: column; gap: 20px;
            animation: pop 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes pop { from {transform: scale(0.95); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid #f3f4f6; padding-bottom: 15px; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; color: #111827; }
        .close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #9ca3af; transition: 0.2s; }
        .close-btn:hover { color: var(--danger); transform: rotate(90deg); }
        
        .copy-list { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; }
        .copy-item {
            display: flex; align-items: center; gap: 12px; padding: 12px;
            background: #f9fafb; border-radius: 12px; border: 1px solid #e5e7eb; cursor: pointer; transition: 0.2s;
        }
        .copy-item:hover { background: #f3f4f6; border-color: var(--primary); }
        .copy-item input { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }

        /* Checkbox & Extras */
        .extras-list { list-style: none; padding: 0; margin: 0; max-height: 300px; overflow-y: auto; }
        .extra-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #f3f4f6; background: #fff; 
            margin-bottom: 6px; border-radius: 10px; border: 1px solid #e5e7eb;
        }
        .extra-content { display: flex; align-items: center; gap: 10px; flex: 1; font-weight: 500; }
        .custom-chk {
            width: 22px; height: 22px; border-radius: 6px; border: 2px solid #d1d5db;
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s;
            color: white; flex-shrink: 0;
        }
        .custom-chk.checked { background: var(--primary); border-color: var(--primary); }
        .custom-chk svg { width: 14px; height: 14px; display: none; }
        .custom-chk.checked svg { display: block; }

        .color-options { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
        .color-dot { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; border: 3px solid #fff; box-shadow: 0 0 0 1px #d1d5db; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.active { box-shadow: 0 0 0 3px var(--primary); transform: scale(1.1); }

        /* --- PRINT & EXPORT STYLES (Ø§ØµÙ„Ø§Ø­Ø§Øª Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ) --- */
        #print-area { display: none; }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø­Ø§Ù„Øª Ø§Ú©Ø³Ù¾ÙˆØ±Øª Ø¹Ú©Ø³ - Ø§ØµÙ„Ø§Ø­ Ø¨Ø§Ú¯ Ø¨ÛŒØ±ÙˆÙ† Ø²Ø¯Ù† Ù…ØªÙ† */
        .export-mode {
            background: white;
            padding: 40px;
            font-family: 'Vazirmatn', sans-serif;
            width: 2000px; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ø²ÛŒØ§Ø¯ Ø¨Ø±Ø§ÛŒ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ */
            margin: 0 auto;
            color: #111827;
            text-align: right;
            direction: rtl;
        }
        
        .export-mode .copy-col-btn { display: none !important; }

        .print-header {
            display: flex; justify-content: space-between; align-items: flex-end;
            border-bottom: 4px solid var(--primary); padding-bottom: 20px; margin-bottom: 30px;
        }
        .print-title h1 { margin: 0; font-size: 48px; color: var(--primary-dark); font-weight: 900; }
        .print-meta div { font-size: 20px; color: #4b5563; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-top: 5px; }

        .print-grid-top { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
        .print-box { border: 2px solid #e5e7eb; border-radius: 16px; padding: 20px; background-color: #f9fafb; }
        .print-box h4 { margin: 0 0 15px 0; border-bottom: 2px solid #d1d5db; padding-bottom: 8px; font-size: 24px; color: #1f2937; }
        .print-items { list-style: none; padding: 0; margin: 0; font-size: 18px; columns: 2; gap: 20px; }
        .print-items li { margin-bottom: 8px; break-inside: avoid; display: flex; align-items: center; gap: 8px; }

        /* Ø¬Ø¯ÙˆÙ„ Ø§Ú©Ø³Ù¾ÙˆØ±Øª - ÙÛŒÚ©Ø³ Ú©Ø±Ø¯Ù† Ø¹Ø±Ø¶â€ŒÙ‡Ø§ */
        .print-table-container table {
            border: 2px solid #111827; font-size: 16px; width: 100%; border-collapse: collapse; table-layout: fixed;
        }
        .print-table-container th {
            background-color: #1f2937 !important; color: white !important;
            border: 1px solid #111827; padding: 15px; font-size: 20px; text-align: center;
        }
        .print-table-container tr td:first-child {
            background-color: #1f2937 !important; color: white !important;
            border: 1px solid #111827; font-weight: bold; text-align: center; width: 120px; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ø¨ÛŒØ´ØªØ± Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø¹Øª */
            white-space: nowrap;
        }
        .print-table-container td { border: 1px solid #9ca3af; height: 40px; padding: 0; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ ØªØ³Ú© Ø¯Ø± Ø¹Ú©Ø³ Ø®Ø±ÙˆØ¬ÛŒ */
        .print-table-container .task-inner-block {
            border-radius: 0; /* Ø¯Ø± Ú†Ø§Ù¾ Ú¯Ø±Ø¯ÛŒ Ø­Ø°Ù Ø´ÙˆØ¯ */
            display: flex; flex-direction: column; justify-content: center; height: 100%; width: 100%;
            color: white !important; text-align: center;
        }
        .print-table-container .task-title { font-size: 18px; margin-bottom: 5px; white-space: normal; }
        .print-table-container .task-time-range { font-size: 14px; border: 1px solid white; display: inline-block; padding: 0 8px; margin-bottom: 2px; }

        .print-footer { margin-top: 30px; border: 3px dashed #d1d5db; padding: 25px; border-radius: 16px; background: #fff; }
        .print-note-text { font-size: 18px; white-space: pre-wrap; line-height: 1.8; }

        /* --- PRINT (Paper/PDF) STYLES --- */
        /* Ø¯Ø³ØªÙˆØ± Ú†Ù‡Ø§Ø±Ù…: Ø­Ø§Ù„Øª Ú†Ø§Ù¾ Ù„ÛŒØ³Øª ÙˆØ§Ø± Ùˆ Ø³Ø§Ø¯Ù‡ */
        #print-list-view { display: none; }

        @media print {
            @page { size: A4 portrait; margin: 15mm; }
            body { background: white; padding: 0; margin: 0; }
            
            /* Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ú†ÛŒØ² Ø¬Ø² Ù„ÛŒØ³Øª Ú†Ø§Ù¾ */
            .toolbar, .planner-wrapper, #loadingBar, .modal-overlay, #print-area { display: none !important; }
            
            /* Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ø³Ø§Ø¯Ù‡ */
            #print-list-view { display: block !important; font-family: 'Vazirmatn', sans-serif; color: black; }
            
            .pdf-header { text-align: center; border-bottom: 2px solid black; padding-bottom: 15px; margin-bottom: 20px; }
            .pdf-header h1 { margin: 0; font-size: 24px; }
            .pdf-meta { margin-top: 5px; font-size: 14px; color: #555; }
            
            .pdf-day-block { margin-bottom: 20px; page-break-inside: avoid; border: 1px solid #ddd; border-radius: 8px; }
            .pdf-day-title { background: #eee; padding: 8px 15px; font-weight: bold; font-size: 16px; border-bottom: 1px solid #ddd; }
            
            .pdf-task-row { display: flex; padding: 8px 15px; border-bottom: 1px dotted #ccc; align-items: baseline; }
            .pdf-task-row:last-child { border-bottom: none; }
            .pdf-time { width: 100px; font-weight: bold; font-size: 13px; flex-shrink: 0; }
            .pdf-name { flex-grow: 1; font-size: 14px; }
            
            .pdf-footer { margin-top: 30px; border-top: 2px solid black; padding-top: 15px; font-size: 14px; }
            .pdf-extras-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù„Ø¨ */
        .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .template-card {
            background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 12px; padding: 15px;
            text-align: center; cursor: pointer; transition: 0.2s;
        }
        .template-card:hover { border-color: var(--primary); background: #eef2ff; }
        .tpl-icon { font-size: 24px; display: block; margin-bottom: 5px; }
        .tpl-name { font-weight: bold; font-size: 14px; }

    </style>
</head>
<body>

<div id="loadingBar"></div>
<div id="processingMsg">
    <div class="spinner"></div>
    <h3 style="color:#1f2937; margin:0;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...</h3>
    <p id="procTxt" style="color:#6b7280; margin-top:10px;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</p>
</div>

<!-- Container Ù…Ø®ÙÛŒ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø¹Ú©Ø³ (Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ Ùˆ ÙÛŒÚ©Ø³ Ø´Ø¯Ù‡) -->
<div id="print-area" class="export-mode">
    <div class="print-header">
        <div class="print-title" style="text-align: right;">
            <h1 id="printTitleDisplay">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</h1>
        </div>
        <div class="print-meta">
            <div id="printUserDisplay">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <span id="printUserText"></span>
            </div>
            <div id="printDateDisplay">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                <span id="printDateText"></span>
            </div>
        </div>
    </div>

    <div class="print-grid-top">
        <div class="print-box">
            <h4>Ù†Ú©Ø§Øª Ùˆ Ø§Ù„Ø²Ø§Ù…Ø§Øª</h4>
            <ul class="print-items" id="printReqList"></ul>
        </div>
        <div class="print-box">
            <h4>Ú†Ú©â€ŒÙ„ÛŒØ³Øª</h4>
            <ul class="print-items" id="printChkList"></ul>
        </div>
    </div>

    <div id="printTableContainer" class="print-table-container"></div>

    <div class="print-footer" id="printFooter" style="display:none;">
        <h5 style="margin:0 0 10px 0; font-size:24px;">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§:</h5>
        <div class="print-note-text" id="printNoteText"></div>
    </div>
</div>

<!-- Container Ù…Ø®ØµÙˆØµ Ú†Ø§Ù¾ PDF (Ù„ÛŒØ³Øª Ø³Ø§Ø¯Ù‡) -->
<div id="print-list-view">
    <div class="pdf-header">
        <h1 id="pdfTitle">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</h1>
        <div class="pdf-meta">Ú©Ø§Ø±Ø¨Ø±: <span id="pdfUser"></span> | ØªØ§Ø±ÛŒØ® Ú†Ø§Ù¾: <span id="pdfDate"></span></div>
    </div>
    
    <div class="pdf-extras-grid">
        <div>
            <h3>Ù†Ú©Ø§Øª:</h3>
            <ul id="pdfReqList"></ul>
        </div>
        <div>
            <h3>Ú†Ú©â€ŒÙ„ÛŒØ³Øª:</h3>
            <ul id="pdfChkList"></ul>
        </div>
    </div>

    <div id="pdfScheduleContainer">
        <!-- Ù„ÛŒØ³Øª Ø±ÙˆØ²Ù‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒØ´ÙˆØ¯ -->
    </div>
    
    <div class="pdf-footer">
        <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</strong> <span id="pdfNote"></span>
    </div>
</div>


<!-- Main Toolbar -->
<div class="toolbar no-print">
    <div class="toolbar-header">
        <div class="brand" id="pageBrandTitle">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ PRO
        </div>
        <button class="btn mode-toggle" id="selectModeBtn" onclick="toggleSelectMode()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
            <span id="modeText">Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„</span>
        </button>
    </div>

    <div class="input-group">
        <input type="text" id="headerTitleInput" class="input-modern" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ)" oninput="updateHeader(this.value)">
        <input type="text" id="userNameInput" class="input-modern" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§ (Ø¨Ø±Ø§ÛŒ Ú†Ø§Ù¾)" oninput="updateUserName(this.value)">
    </div>

    <div class="toolbar-header">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <!-- Ø¯Ú©Ù…Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ -->
            <button class="btn btn-purple" onclick="openModal('templatesModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡
            </button>
            
            <button class="btn btn-orange" onclick="openModal('extrasModal'); renderExtras();">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Ø§Ù„Ø²Ø§Ù…Ø§Øª / Ù„ÛŒØ³Øª
            </button>
            <button class="btn btn-dark" onclick="openModal('noteModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
            </button>
            <button class="btn btn-teal" onclick="openStats()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>
                Ø¢Ù…Ø§Ø±
            </button>
        </div>
        <div style="flex:1"></div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn btn-blue" onclick="openShareModal()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                Ø§Ø´ØªØ±Ø§Ú©
            </button>
            <button class="btn btn-primary" onclick="downloadAsImage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                ÙØ§ÛŒÙ„
            </button>
            <button class="btn btn-dark" onclick="document.getElementById('fileInput').click()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ
            </button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
            <button class="btn btn-dark" onclick="printAppList()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Ú†Ø§Ù¾ (Ù„ÛŒØ³Øª)
            </button>
            <button class="btn btn-danger" onclick="clearAll()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                Ø­Ø°Ù
            </button>
        </div>
    </div>
</div>

<!-- Main Table -->
<div class="planner-wrapper" id="mainTableWrapper">
    <table id="plannerTable">
        <thead><tr id="tableHeader"><th>Ø²Ù…Ø§Ù†</th></tr></thead>
        <tbody id="plannerBody"></tbody>
    </table>
</div>

<!-- Modals -->

<!-- Share Choice -->
<div class="modal-overlay" id="shareModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ</h3><button class="close-btn" onclick="closeModal('shareModal')">&times;</button></div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-blue" onclick="executeShare('image')" style="justify-content:center;">Ø§Ø±Ø³Ø§Ù„ ØªØµÙˆÛŒØ± (PNG)</button>
            <button class="btn btn-success" onclick="executeShare('json')" style="justify-content:center;">Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)</button>
        </div>
    </div>
</div>

<!-- Templates Modal (Ø¬Ø¯ÛŒØ¯) -->
<div class="modal-overlay" id="templatesModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ Ø¢Ù…Ø§Ø¯Ù‡</h3><button class="close-btn" onclick="closeModal('templatesModal')">&times;</button></div>
        <p style="font-size:13px; color:gray;">Ø¨Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù‡Ø± Ù…ÙˆØ±Ø¯ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ù„ÛŒ Ù¾Ø§Ú© Ùˆ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>
        <div class="template-grid">
            <div class="template-card" onclick="applyTemplate('student')"><span class="tpl-icon">ğŸ“</span><span class="tpl-name">Ø¯Ø§Ù†Ø´Ø¬ÙˆÛŒÛŒ/Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ²ÛŒ</span></div>
            <div class="template-card" onclick="applyTemplate('employee')"><span class="tpl-icon">ğŸ’¼</span><span class="tpl-name">Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ/Ø§Ø¯Ø§Ø±ÛŒ</span></div>
            <div class="template-card" onclick="applyTemplate('flexible')"><span class="tpl-icon">ğŸ§©</span><span class="tpl-name">Ø´Ù†Ø§ÙˆØ± Ùˆ Ù…Ù†Ø¹Ø·Ù</span></div>
            <div class="template-card" onclick="applyTemplate('healthy')"><span class="tpl-icon">ğŸ¥—</span><span class="tpl-name">Ø²Ù†Ø¯Ú¯ÛŒ Ø³Ø§Ù„Ù… Ùˆ ÙˆØ±Ø²Ø´</span></div>
        </div>
    </div>
</div>

<!-- Copy Modal -->
<div class="modal-overlay" id="copyModal">
    <div class="modal">
        <div class="modal-header"><h3>Ú©Ù¾ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ <span id="copySourceLabel" style="color:var(--primary)"></span></h3><button class="close-btn" onclick="closeModal('copyModal')">&times;</button></div>
        <div style="font-size:13px; color:var(--text-muted);">Ø±ÙˆØ²Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ø¢Ù†â€ŒÙ‡Ø§ Ú©Ù¾ÛŒ Ø´ÙˆØ¯:</div>
        <div id="copyTargetList" class="copy-list"></div>
        <button class="btn btn-primary" style="justify-content:center; margin-top:10px;" onclick="executeCopy()">ØªØ§ÛŒÛŒØ¯ Ùˆ Ú©Ù¾ÛŒ</button>
    </div>
</div>

<!-- Single Copy -->
<div class="modal-overlay" id="singleCopyModal">
    <div class="modal">
        <div class="modal-header"><h3>Ú©Ù¾ÛŒ Ø§ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª Ø¨Ù‡...</h3><button class="close-btn" onclick="closeModal('singleCopyModal')">&times;</button></div>
        <div id="singleCopyTargetList" class="copy-list"></div>
    </div>
</div>

<!-- Extras -->
<div class="modal-overlay" id="extrasModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø§Ù„Ø²Ø§Ù…Ø§Øª Ùˆ Ù„ÛŒØ³Øª</h3><button class="close-btn" onclick="closeModal('extrasModal')">&times;</button></div>
        <div style="display:flex; gap:10px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
            <button class="btn btn-purple" style="flex:1; justify-content:center;" onclick="switchTab('req')">ğŸ”¸ Ù†Ú©Ø§Øª</button>
            <button class="btn btn-dark" style="flex:1; justify-content:center;" onclick="switchTab('chk')">â–«ï¸ Ú†Ú©â€ŒÙ„ÛŒØ³Øª</button>
        </div>
        <div id="tab-req">
            <div style="display:flex; gap:8px; margin-top:10px;"><input type="text" id="reqInput" class="input-modern" placeholder="Ù†Ú©ØªÙ‡ Ø¬Ø¯ÛŒØ¯..."><button class="btn btn-success" onclick="addItem('req')">+</button></div>
            <ul class="extras-list" id="reqListUi" style="margin-top:10px;"></ul>
        </div>
        <div id="tab-chk" style="display:none">
            <div style="display:flex; gap:8px; margin-top:10px;"><input type="text" id="chkInput" class="input-modern" placeholder="Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯..."><button class="btn btn-success" onclick="addItem('chk')">+</button></div>
            <ul class="extras-list" id="chkListUi" style="margin-top:10px;"></ul>
        </div>
    </div>
</div>

<!-- Task -->
<div class="modal-overlay" id="taskModal">
    <div class="modal">
        <div class="modal-header"><h3>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„ÛŒØª</h3><button class="close-btn" onclick="closeModal('taskModal')">&times;</button></div>
        <input type="hidden" id="taskId"><input type="hidden" id="taskDay">
        <div><label class="form-label">Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹</label><select id="inpStart" class="input-modern" onchange="updateEndOptions()"></select></div>
        <div><label class="form-label">Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="inpName" class="input-modern" autofocus></div>
        <div><label class="form-label">Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù†</label><select id="inpEnd" class="input-modern"></select></div>
        <div><label class="form-label">Ø±Ù†Ú¯</label><div class="color-options" id="colorPalette"></div><input type="color" id="customColor" style="margin-top:10px; width:100%; height:40px; border:none; border-radius:10px; cursor:pointer;"></div>
        <div style="display:flex; justify-content:space-between; margin-top:10px; flex-wrap:wrap; gap:8px;">
            <button class="btn btn-danger" id="btnDeleteTask" onclick="deleteTask()" style="display:none">Ø­Ø°Ù</button>
            <button class="btn btn-teal" id="btnCopyTask" onclick="openSingleCopyModal()" style="display:none">Ú©Ù¾ÛŒ Ø¨Ù‡...</button>
            <div style="flex:1"></div>
            <button class="btn btn-dark" onclick="closeModal('taskModal')">Ù„ØºÙˆ</button>
            <button class="btn btn-primary" onclick="saveTask()">Ø«Ø¨Øª</button>
        </div>
    </div>
</div>

<!-- Note -->
<div class="modal-overlay" id="noteModal">
    <div class="modal">
        <div class="modal-header"><h3>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§</h3><button class="close-btn" onclick="closeModal('noteModal')">&times;</button></div>
        <textarea id="noteText" class="input-modern" rows="10"></textarea>
        <div style="display:flex; align-items:center; gap:8px; font-size:13px;">
            <input type="checkbox" id="notePrintCheck" style="width:18px; height:18px; accent-color:var(--primary);"> <label for="notePrintCheck">Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ Ú†Ø§Ù¾</label>
        </div>
        <div style="display:flex; justify-content:flex-end;"><button class="btn btn-success" onclick="saveNote()">Ø°Ø®ÛŒØ±Ù‡</button></div>
    </div>
</div>

<!-- Stats -->
<div class="modal-overlay" id="statsModal">
    <div class="modal">
        <div class="modal-header"><h3>Ø¢Ù…Ø§Ø±</h3><button class="close-btn" onclick="closeModal('statsModal')">&times;</button></div>
        <div class="chart-container" id="chartArea" style="display:flex; justify-content:center; margin-bottom:10px;"></div>
        <div class="chart-legend" id="chartLegend" style="display:flex; flex-wrap:wrap; gap:10px; justify-content:center;"></div>
    </div>
</div>

<script>
    const DAYS = [
        {id:'sat', l:'Ø´Ù†Ø¨Ù‡'}, {id:'sun', l:'ÛŒÚ©Ø´Ù†Ø¨Ù‡'}, {id:'mon', l:'Ø¯ÙˆØ´Ù†Ø¨Ù‡'},
        {id:'tue', l:'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡'}, {id:'wed', l:'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡'}, {id:'thu', l:'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡'}, {id:'fri', l:'Ø¬Ù…Ø¹Ù‡'}
    ];
    // Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ù‡ Ø±ÙˆØ² Ø´Ø¯Ù‡ Ø¨Ù‡ Ù¾Ø§Ù„Øª Ù…Ø¯Ø±Ù†
    const COLORS = ['#4f46e5', '#10b981', '#ef4444', '#f97316', '#8b5cf6', '#06b6d4', '#ec4899', '#64748b'];
    const TIMELINE = [];
    for(let h=0; h<24; h++) for(let m=0; m<60; m+=15) TIMELINE.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
    TIMELINE.push("24:00");

    // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡
    const TEMPLATE_DATA = {
        student: [
            {day:'sat',s:'08:00',d:6,n:'Ù…Ø¯Ø±Ø³Ù‡/Ú©Ù„Ø§Ø³',c:'#4f46e5'}, {day:'sat',s:'14:00',d:2,n:'Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª',c:'#f97316'}, {day:'sat',s:'16:00',d:4,n:'Ù…Ø·Ø§Ù„Ø¹Ù‡',c:'#10b981'},
            {day:'sun',s:'08:00',d:6,n:'Ù…Ø¯Ø±Ø³Ù‡/Ú©Ù„Ø§Ø³',c:'#4f46e5'}, {day:'mon',s:'08:00',d:6,n:'Ù…Ø¯Ø±Ø³Ù‡/Ú©Ù„Ø§Ø³',c:'#4f46e5'}, {day:'tue',s:'08:00',d:6,n:'Ù…Ø¯Ø±Ø³Ù‡/Ú©Ù„Ø§Ø³',c:'#4f46e5'}, {day:'wed',s:'08:00',d:6,n:'Ù…Ø¯Ø±Ø³Ù‡/Ú©Ù„Ø§Ø³',c:'#4f46e5'}
        ],
        employee: [
            {day:'sat',s:'07:30',d:18,n:'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ',c:'#64748b'}, {day:'sat',s:'17:00',d:4,n:'Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª',c:'#8b5cf6'},
            {day:'sun',s:'07:30',d:18,n:'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ',c:'#64748b'}, {day:'mon',s:'07:30',d:18,n:'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ',c:'#64748b'}, {day:'tue',s:'07:30',d:18,n:'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ',c:'#64748b'}, {day:'wed',s:'07:30',d:18,n:'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ',c:'#64748b'}
        ],
        flexible: [
            {day:'sat',s:'09:00',d:4,n:'Ø¨Ù„ÙˆÚ© Ú©Ø§Ø±ÛŒ Ø§ÙˆÙ„',c:'#06b6d4'}, {day:'sat',s:'14:00',d:4,n:'Ø¨Ù„ÙˆÚ© Ú©Ø§Ø±ÛŒ Ø¯ÙˆÙ…',c:'#06b6d4'},
            {day:'mon',s:'10:00',d:4,n:'Ø¨Ù„ÙˆÚ© Ú©Ø§Ø±ÛŒ Ø§ÙˆÙ„',c:'#06b6d4'}, {day:'wed',s:'09:00',d:4,n:'Ø¨Ù„ÙˆÚ© Ú©Ø§Ø±ÛŒ Ø§ÙˆÙ„',c:'#06b6d4'}
        ],
        healthy: [
            {day:'sat',s:'06:00',d:2,n:'ÙˆØ±Ø²Ø´ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒ',c:'#10b981'}, {day:'sat',s:'22:00',d:8,n:'Ø®ÙˆØ§Ø¨ Ú©Ø§ÙÛŒ',c:'#4f46e5'},
            {day:'sun',s:'06:00',d:2,n:'ÙˆØ±Ø²Ø´ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒ',c:'#10b981'}, {day:'mon',s:'18:00',d:4,n:'Ø¨Ø§Ø´Ú¯Ø§Ù‡',c:'#ef4444'}
        ]
    };

    let appData = {
        tasks: [], header: "", userName: "", note: {text:"", print:false},
        reqs: [{t:"Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…ÙˆØ± Ù…Ø§Ù„ÛŒ", s:true}],
        chks: [{t:"Ø®Ø±ÛŒØ¯ Ù‡ÙØªÚ¯ÛŒ", s:true, c:false}]
    };

    let isSelect=false, isDrag=false, selStart=null, selCurr=null;
    let pendingCopySource = null; 
    let currentEditingTask = null;

    function showLoader(msg) { 
        document.getElementById('procTxt').innerText = msg || 'Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´';
        document.getElementById('processingMsg').style.display = 'flex'; 
    }
    function hideLoader() { document.getElementById('processingMsg').style.display = 'none'; }
    function showBar() { document.getElementById('loadingBar').style.display = 'block'; }
    function hideBar() { document.getElementById('loadingBar').style.display = 'none'; }

    function init() {
        const saved = localStorage.getItem('finalProPlannerV10');
        if(saved) {
            try {
                const d = JSON.parse(saved);
                if(Array.isArray(d)) appData.tasks = d; else appData = {...appData, ...d};
            } catch(e){}
        }

        updateHeader(appData.header || "");
        document.getElementById('userNameInput').value = appData.userName || "";
        
        const startSel = document.getElementById('inpStart');
        TIMELINE.slice(0, -1).forEach(t => startSel.add(new Option(t, t)));

        const pal = document.getElementById('colorPalette');
        COLORS.forEach(c => {
            const dot = document.createElement('div');
            dot.className='color-dot'; dot.style.background=c;
            dot.onclick=()=>{
                document.getElementById('customColor').value=c;
                document.querySelectorAll('.color-dot').forEach(el=>el.classList.remove('active'));
                dot.classList.add('active');
            };
            pal.appendChild(dot);
        });

        renderHeader(); renderTable(); setupTouch();
    }

    function renderHeader() {
        const tr = document.getElementById('tableHeader');
        while(tr.children.length>1) tr.removeChild(tr.lastChild);
        DAYS.forEach(d=>{
            const th=document.createElement('th');
            th.innerHTML=`<div style="display:flex;justify-content:center;gap:5px;align-items:center; flex-direction:column;">
                ${d.l}
                <span class="copy-col-btn" onclick="openCopyModal('${d.id}')" title="Ú©Ù¾ÛŒ Ú©Ù„ Ø±ÙˆØ²">
                    Ú©Ù¾ÛŒ
                </span>
            </div>`;
            tr.appendChild(th);
        });
    }

    function renderTable() {
        const b = document.getElementById('plannerBody'); b.innerHTML='';
        const occ = {}; DAYS.forEach(d=>occ[d.id]=new Array(TIMELINE.length).fill(false));

        for(let idx=0; idx < TIMELINE.length - 1; idx++) {
            const time = TIMELINE[idx];
            const nextTime = TIMELINE[idx+1];
            const tr = document.createElement('tr');
            const tdTime = document.createElement('td'); 
            tdTime.innerText = `${time}`; 
            tr.appendChild(tdTime);

            DAYS.forEach(day => {
                if(occ[day.id][idx]) return;
                const task = appData.tasks.find(t=>t.day===day.id && t.startStr===time);

                if(task) {
                    const td = document.createElement('td');
                    td.rowSpan = task.duration; td.className='task-cell';
                    // Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø¬Ø¯ÙˆÙ„ (Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø­Ø°Ù Ø´Ø¯Ù‡ØŒ ÙÙ‚Ø· Ø¨Ù„Ø§Ú© Ø¯Ø§Ø®Ù„ÛŒ Ø±Ù†Ú¯ Ø¯Ø§Ø±Ø¯)
                    const endIdx = idx + task.duration;
                    const endStr = TIMELINE[endIdx];
                    // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¨Ù„Ø§Ú© Ø¯Ø§Ø®Ù„ÛŒ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ¨Ø§ÛŒÛŒ Ø¨ÛŒØ´ØªØ±
                    td.innerHTML=`
                        <div class="task-inner-block" style="background-color:${task.color}">
                            <span class="task-time-range">${task.startStr} - ${endStr}</span>
                            <span class="task-title">${task.name}</span>
                        </div>`;
                    td.onclick=(e)=>{e.stopPropagation(); openTaskModal(task);};
                    td.draggable=true;
                    td.ondragstart=(e)=>{e.dataTransfer.setData('tid', task.id);};
                    tr.appendChild(td);
                    for(let i=1; i<task.duration; i++) if(idx+i<TIMELINE.length) occ[day.id][idx+i]=true;
                } else {
                    const td = document.createElement('td');
                    td.className='empty-cell'; td.dataset.d=day.id; td.dataset.i=idx;
                    td.ondragover=(e)=>e.preventDefault();
                    td.ondrop=(e)=>handleDrop(e, day.id, time);
                    tr.appendChild(td);
                }
            });
            b.appendChild(tr);
        }
    }

    // Function to apply templates (Feature Added)
    function applyTemplate(type) {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ù„ÛŒ Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ùˆ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.")) return;
        showBar();
        const tpl = TEMPLATE_DATA[type];
        if(tpl) {
            // ØªÙˆÙ„ÛŒØ¯ Ø´Ù†Ø§Ø³Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ ØªØ³Ú©â€ŒÙ‡Ø§
            appData.tasks = tpl.map(t => ({...t, id: Date.now() + Math.random(), duration: t.d || 4})); 
            saveData();
            renderTable();
            closeModal('templatesModal');
        }
        hideBar();
    }

    function updateEndOptions() {
        const startVal = document.getElementById('inpStart').value;
        const sIdx = TIMELINE.indexOf(startVal);
        const endSel = document.getElementById('inpEnd');
        endSel.innerHTML = '';
        for (let i = sIdx + 1; i < TIMELINE.length; i++) {
            const time = TIMELINE[i];
            const duration = i - sIdx;
            let durationText = "";
            const totalMin = duration * 15;
            if(totalMin < 60) durationText = `${totalMin} Ø¯Ù‚ÛŒÙ‚Ù‡`;
            else {
                const h = Math.floor(totalMin/60);
                const m = totalMin%60;
                durationText = `${h} Ø³Ø§Ø¹Øª` + (m>0 ? ` Ùˆ ${m} Ø¯Ù‚ÛŒÙ‚Ù‡` : "");
            }
            endSel.add(new Option(`${time} | ${durationText}`, duration));
        }
    }

    function preparePrintDOM() {
        document.getElementById('printTitleDisplay').innerText = appData.header || "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ";
        document.getElementById('printUserText').innerText = appData.userName ? `Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±: ${appData.userName}` : "Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±: ...";
        document.getElementById('printDateText').innerText = `ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}`;

        const rL = document.getElementById('printReqList'); rL.innerHTML='';
        appData.reqs.filter(x=>x.s).forEach(x => rL.innerHTML+=`<li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg> ${x.t}</li>`);
        
        const cL = document.getElementById('printChkList'); cL.innerHTML='';
        appData.chks.filter(x=>x.s).forEach(x => {
            const icon = x.c ? 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>` : 
                `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect></svg>`;
            cL.innerHTML+=`<li>${icon} ${x.t}</li>`;
        });

        const tblCont = document.getElementById('printTableContainer');
        tblCont.innerHTML = '';
        const originalTable = document.getElementById('plannerTable');
        if(originalTable) {
            const clone = originalTable.cloneNode(true);
            // Ø¯Ø± Ø­Ø§Ù„Øª Ø¹Ú©Ø³ØŒ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒÙ… Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ø§Ø´Ù†Ø¯ØŒ Ù¾Ø³ Ø¯Ø³Øª Ù†Ù…ÛŒâ€ŒØ²Ù†ÛŒÙ… Ø¨Ù‡ Ø§Ø³ØªØ§ÛŒÙ„ clone Ø´Ø¯Ù‡
            tblCont.appendChild(clone);
        }

        const ftr = document.getElementById('printFooter');
        if(appData.note.print && appData.note.text) {
            ftr.style.display = 'block';
            document.getElementById('printNoteText').innerText = appData.note.text;
        } else { ftr.style.display = 'none'; }
    }

    // PDF List View Logic (New Feature for Print)
    function printAppList() {
        const pTitle = document.getElementById('pdfTitle');
        const pUser = document.getElementById('pdfUser');
        const pDate = document.getElementById('pdfDate');
        const pNote = document.getElementById('pdfNote');
        const pReq = document.getElementById('pdfReqList');
        const pChk = document.getElementById('pdfChkList');
        const pCont = document.getElementById('pdfScheduleContainer');

        pTitle.innerText = appData.header || "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ";
        pUser.innerText = appData.userName || "---";
        pDate.innerText = new Date().toLocaleDateString('fa-IR');
        pNote.innerText = appData.note.text || "Ù†Ø¯Ø§Ø±Ø¯";

        pReq.innerHTML = ""; appData.reqs.forEach(r => pReq.innerHTML += `<li>${r.t}</li>`);
        pChk.innerHTML = ""; appData.chks.forEach(c => pChk.innerHTML += `<li>[${c.c?'x':' '}] ${c.t}</li>`);

        pCont.innerHTML = "";
        DAYS.forEach(day => {
            const tasks = appData.tasks.filter(t => t.day === day.id).sort((a,b) => TIMELINE.indexOf(a.startStr) - TIMELINE.indexOf(b.startStr));
            if(tasks.length > 0) {
                let html = `<div class="pdf-day-block"><div class="pdf-day-title">${day.l}</div>`;
                tasks.forEach(t => {
                    const eIdx = TIMELINE.indexOf(t.startStr) + t.duration;
                    const end = TIMELINE[eIdx] || "End";
                    html += `<div class="pdf-task-row">
                        <div class="pdf-time">${t.startStr} - ${end}</div>
                        <div class="pdf-name">${t.name}</div>
                    </div>`;
                });
                html += `</div>`;
                pCont.innerHTML += html;
            }
        });

        window.print();
    }

    function openShareModal() { document.getElementById('shareModal').style.display = 'flex'; }
    async function executeShare(type) {
        closeModal('shareModal');
        if (type === 'json') shareBackupFile();
        else if (type === 'image') downloadAsImage(); // Reuse image function
    }

    async function shareBackupFile() {
        showLoader("Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„...");
        if(document.getElementById('noteText')) appData.note.text = document.getElementById('noteText').value;
        setTimeout(async () => {
            const jsonStr = JSON.stringify(appData, null, 2);
            const fileName = `${appData.header || 'backup'}.json`;
            const file = new File([jsonStr], fileName, {type: "application/json"});
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try { await navigator.share({ files: [file], title: 'Backup' }); } catch (error) {}
            } else { exportData(); }
            hideLoader();
        }, 500);
    }

    function downloadAsImage() {
        showLoader("ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ± Ø¨Ø§ Ú©ÛŒÙÛŒØª...");
        const element = document.getElementById('print-area');
        preparePrintDOM();
        element.style.display = 'block';
        element.style.position = 'absolute'; element.style.top = '0'; element.style.left = '-9999px';
        
        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø®Ø§Øµ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø¨Ø±ÛŒØ¯Ù‡ Ø´Ø¯Ù† Ù…ØªÙ†
        setTimeout(() => {
            html2canvas(element, { 
                scale: 2, 
                useCORS: true, 
                width: 2000, 
                windowWidth: 2000,
                onclone: (doc) => {
                    // Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø§Ø¹Ù…Ø§Ù„ ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ú©Ø§Ù†ÙˆØ§Ø³
                    const el = doc.getElementById('print-area');
                    el.style.display = 'block';
                }
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `${appData.header || 'Plan'}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                element.style.display = 'none'; hideLoader();
            });
        }, 1000);
    }

    function toggleExtraVis(type, i) {
        if(type==='req') appData.reqs[i].s = !appData.reqs[i].s;
        else appData.chks[i].s = !appData.chks[i].s;
        saveData(); renderExtras();
    }

    function handleDrop(e, day, time) {
        e.preventDefault(); const tid=e.dataTransfer.getData('tid');
        const task=appData.tasks.find(t=>t.id==tid); if(!task)return;
        const sIdx=TIMELINE.indexOf(time);
        if(sIdx+task.duration >= TIMELINE.length) return alert("Ø²Ù…Ø§Ù† Ù†Ø§Ú©Ø§ÙÛŒ");
        const conf=appData.tasks.some(t=>{if(t.id==tid || t.day!==day)return false; const tS=TIMELINE.indexOf(t.startStr); return (sIdx<tS+t.duration && sIdx+task.duration>tS);});
        if(!conf) { task.day=day; task.startStr=time; saveData(); renderTable(); } else alert("ØªØ¯Ø§Ø®Ù„!");
    }

    function toggleSelectMode() {
        isSelect=!isSelect;
        const btn=document.getElementById('selectModeBtn'); const txt=document.getElementById('modeText');
        if(isSelect) {document.body.classList.add('selection-mode'); btn.classList.add('active'); txt.innerText="Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ø§Ù„";}
        else {document.body.classList.remove('selection-mode'); btn.classList.remove('active'); txt.innerText="Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„"; clearSel();}
    }
    function setupTouch() {
        const t=document.getElementById('plannerTable');
        const start=(e)=>{if(!isSelect)return; const c=e.target.closest('td.empty-cell'); if(!c)return; e.preventDefault(); isDrag=true; selStart={d:c.dataset.d, i:parseInt(c.dataset.i)}; selCurr={...selStart}; highlight();};
        const move=(e)=>{if(!isDrag)return; const el=document.elementFromPoint(e.clientX||e.touches[0].clientX, e.clientY||e.touches[0].clientY); if(!el)return; const c=el.closest('td.empty-cell'); if(c&&c.dataset.d===selStart.d){selCurr={d:selStart.d, i:parseInt(c.dataset.i)}; highlight();}};
        const end=()=>{if(!isDrag)return; isDrag=false; if(selStart&&selCurr){const s=Math.min(selStart.i,selCurr.i), dur=Math.max(selStart.i,selCurr.i)-s+1; openTaskModal(null,{d:selStart.d,s:TIMELINE[s],dur});} clearSel();};
        t.addEventListener('mousedown',start); t.addEventListener('touchstart',start,{passive:false});
        window.addEventListener('mousemove',move); window.addEventListener('touchmove',move,{passive:false});
        window.addEventListener('mouseup',end); window.addEventListener('touchend',end);
    }
    function highlight(){document.querySelectorAll('.selected-cell').forEach(e=>e.classList.remove('selected-cell')); if(!selStart||!selCurr)return; const s=Math.min(selStart.i,selCurr.i), e=Math.max(selStart.i,selCurr.i); for(let i=s;i<=e;i++) {const td=document.querySelector(`td.empty-cell[data-d="${selStart.d}"][data-i="${i}"]`); if(td)td.classList.add('selected-cell');}}
    function clearSel(){selStart=null; selCurr=null; document.querySelectorAll('.selected-cell').forEach(e=>e.classList.remove('selected-cell'));}

    function openTaskModal(task, fresh) {
        openModal('taskModal'); const del=document.getElementById('btnDeleteTask');
        const startEl = document.getElementById('inpStart');
        const endEl = document.getElementById('inpEnd');
        const copyBtn = document.getElementById('btnCopyTask');
        if(task) {
            currentEditingTask = task;
            document.getElementById('taskId').value=task.id; document.getElementById('taskDay').value=task.day;
            startEl.value=task.startStr;
            updateEndOptions();
            endEl.value = task.duration;
            document.getElementById('inpName').value=task.name;
            document.getElementById('customColor').value=task.color;
            del.style.display='block';
            copyBtn.style.display='block';
        } else {
            currentEditingTask = null;
            document.getElementById('taskId').value=''; document.getElementById('taskDay').value=fresh.d;
            startEl.value=fresh.s;
            updateEndOptions();
            endEl.value = fresh.dur;
            document.getElementById('inpName').value='';
            document.getElementById('customColor').value='#4f46e5';
            del.style.display='none';
            copyBtn.style.display='none';
        }
    }
    function saveTask() {
        const id=document.getElementById('taskId').value, day=document.getElementById('taskDay').value;
        const name=document.getElementById('inpName').value.trim();
        const color=document.getElementById('customColor').value;
        const startVal = document.getElementById('inpStart').value;
        const durVal = parseInt(document.getElementById('inpEnd').value);
        if(!name) return alert("Ù†Ø§Ù… Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª");
        const sIdx = TIMELINE.indexOf(startVal);
        if(sIdx + durVal >= TIMELINE.length) return alert("Ø²Ù…Ø§Ù† Ù†Ø§Ù…Ø¹ØªØ¨Ø±");
        const conf=appData.tasks.some(t=>{
            if(t.id==id||t.day!==day)return false; 
            const tS=TIMELINE.indexOf(t.startStr); 
            return (sIdx<tS+t.duration && sIdx+durVal>tS);
        });
        if(conf) return alert("ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ");
        if(id){const ix=appData.tasks.findIndex(t=>t.id==id); if(ix!==-1) appData.tasks[ix]={...appData.tasks[ix],name,startStr:startVal,duration:durVal,color};}
        else appData.tasks.push({id:Date.now(),day,startStr:startVal,duration:durVal,name,color});
        saveData(); renderTable(); closeModal('taskModal');
    }
    function deleteTask(){const id=document.getElementById('taskId').value; if(confirm("Ø­Ø°ÙØŸ")){appData.tasks=appData.tasks.filter(t=>t.id!=id); saveData(); renderTable(); closeModal('taskModal');}}

    function switchTab(t){document.getElementById('tab-req').style.display=t==='req'?'block':'none'; document.getElementById('tab-chk').style.display=t==='chk'?'block':'none';}
    
    function renderExtras() {
        const rL=document.getElementById('reqListUi'); rL.innerHTML='';
        appData.reqs.forEach((r,i)=>{
            rL.innerHTML+=`
            <li class="extra-row">
                <div class="extra-content">ğŸ”¸ ${r.t}</div>
                <div class="extra-controls">
                    <button class="btn btn-danger" style="padding:4px 8px; font-size:10px;" onclick="delEx('req',${i})">Ø­Ø°Ù</button>
                    <button class="btn btn-dark" style="padding:4px 8px; font-size:10px;" onclick="toggleExtraVis('req',${i})">${r.s?'Ú†Ø´Ù…':'Ù…Ø®ÙÛŒ'}</button>
                </div>
            </li>`;
        });
        const cL=document.getElementById('chkListUi'); cL.innerHTML='';
        appData.chks.forEach((c,i)=>{
            cL.innerHTML+=`
            <li class="extra-row">
                <div class="extra-content">
                    <div class="custom-chk ${c.c?'checked':''}" onclick="togChk(${i})">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </div>
                    ${c.t}
                </div>
                <div class="extra-controls">
                    <button class="btn btn-danger" style="padding:4px 8px; font-size:10px;" onclick="delEx('chk',${i})">Ø­Ø°Ù</button>
                    <button class="btn btn-dark" style="padding:4px 8px; font-size:10px;" onclick="toggleExtraVis('chk',${i})">${c.s?'Ú†Ø´Ù…':'Ù…Ø®ÙÛŒ'}</button>
                </div>
            </li>`;
        });
    }

    function addItem(t){const i=document.getElementById(t+'Input'); if(i.value){if(t==='req')appData.reqs.push({t:i.value,s:true}); else appData.chks.push({t:i.value,s:true,c:false}); i.value=''; saveData(); renderExtras();}}
    function delEx(t,i){if(t==='req')appData.reqs.splice(i,1); else appData.chks.splice(i,1); saveData(); renderExtras();}
    function togChk(i){appData.chks[i].c=!appData.chks[i].c; saveData(); renderExtras();}
    
    function saveNote(){
        appData.note.text=document.getElementById('noteText').value; 
        appData.note.print=document.getElementById('notePrintCheck').checked; 
        saveData(); closeModal('noteModal');
    }
    
    function openStats(){
        openModal('statsModal'); const a=document.getElementById('chartArea'), l=document.getElementById('chartLegend');
        a.innerHTML=''; l.innerHTML=''; const s={}; let tot=0;
        appData.tasks.forEach(t=>{s[t.color]=(s[t.color]||0)+t.duration; tot+=t.duration;});
        if(tot===0){a.innerHTML='Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª'; return;}
        let g=[], curr=0;
        Object.keys(s).forEach(c=>{const d=(s[c]/tot)*360; g.push(`${c} ${curr}deg ${curr+d}deg`); curr+=d; l.innerHTML+=`<div style="font-size:12px;display:flex;align-items:center;gap:4px;"><div style="width:12px;height:12px;border-radius:50%;background:${c}"></div> ${((s[c]*15)/60).toFixed(1)}h</div>`;});
        const ch=document.createElement('div'); ch.style.width='180px'; ch.style.height='180px'; ch.style.borderRadius='50%'; ch.style.background=`conic-gradient(${g.join(', ')})`; a.appendChild(ch);
    }

    function openCopyModal(sourceId) {
        pendingCopySource = sourceId;
        const sourceDay = DAYS.find(d => d.id === sourceId);
        document.getElementById('copySourceLabel').innerText = sourceDay.l;
        const list = document.getElementById('copyTargetList');
        list.innerHTML = '';
        DAYS.filter(d => d.id !== sourceId).forEach(d => {
            list.innerHTML += `<label class="copy-item"><input type="checkbox" value="${d.id}" class="copy-checkbox">${d.l}</label>`;
        });
        openModal('copyModal');
    }

    function executeCopy() {
        const checkboxes = document.querySelectorAll('.copy-checkbox:checked');
        if(checkboxes.length === 0) { alert("Ù„Ø·ÙØ§Ù‹ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ø±ÙˆØ² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯."); return; }
        const targetIds = Array.from(checkboxes).map(cb => cb.value);
        if(!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) return;
        closeModal('copyModal'); showBar();
        setTimeout(() => {
            const sourceTasks = appData.tasks.filter(t => t.day === pendingCopySource);
            appData.tasks = appData.tasks.filter(t => !targetIds.includes(t.day));
            targetIds.forEach(targetId => {
                sourceTasks.forEach(t => { appData.tasks.push({ ...t, id: Date.now() + Math.random(), day: targetId }); });
            });
            saveData(); renderTable(); hideBar();
        }, 300);
    }

    function openSingleCopyModal() {
        if(!currentEditingTask) return;
        closeModal('taskModal');
        const list = document.getElementById('singleCopyTargetList'); list.innerHTML = '';
        DAYS.forEach(d => {
            if (d.id !== currentEditingTask.day) {
                list.innerHTML += `<label class="copy-item" onclick="executeSingleCopy('${d.id}')"><span style="flex:1">${d.l}</span><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></label>`;
            }
        });
        document.getElementById('singleCopyModal').style.display = 'flex';
    }

    function executeSingleCopy(targetDayId) {
        if(!currentEditingTask) return;
        const t = currentEditingTask;
        const sIdx = TIMELINE.indexOf(t.startStr);
        const conflict = appData.tasks.some(existing => {
            if (existing.day !== targetDayId) return false;
            const existStartIdx = TIMELINE.indexOf(existing.startStr);
            return (sIdx < existStartIdx + existing.duration && sIdx + t.duration > existStartIdx);
        });
        if (conflict) { alert(`Ø¯Ø± Ø±ÙˆØ² Ù…Ù‚ØµØ¯ ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯.`); return; }
        appData.tasks.push({ ...t, id: Date.now() + Math.random(), day: targetDayId });
        saveData(); renderTable(); closeModal('singleCopyModal'); showBar(); setTimeout(hideBar, 300);
    }

    function openModal(id){document.getElementById(id).style.display='flex'; if(id==='noteModal'){document.getElementById('noteText').value=appData.note.text; document.getElementById('notePrintCheck').checked=appData.note.print;}}
    function closeModal(id){document.getElementById(id).style.display='none';}
    function saveData(){localStorage.setItem('finalProPlannerV10', JSON.stringify(appData));}
    
    function updateHeader(v){
        appData.header=v; document.title = v || "Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ"; 
        document.getElementById('headerTitleInput').value = v;
        saveData();
    }
    function updateUserName(v){appData.userName=v; saveData();}
    function clearAll(){if(confirm("Ø­Ø°Ù Ú©Ø§Ù…Ù„ØŸ")){localStorage.removeItem('finalProPlannerV10'); location.reload();}}
    
    function exportData(){
        const b=new Blob([JSON.stringify(appData, null, 2)],{type:'application/json'}); 
        const a=document.createElement('a'); 
        a.href=URL.createObjectURL(b); 
        a.download=`${appData.header || 'plan'}.json`; 
        a.click();
    }
    
    function importData(i){const f=i.files[0]; const r=new FileReader(); r.onload=e=>{try{const d=JSON.parse(e.target.result); if(d.tasks||Array.isArray(d)){if(Array.isArray(d))appData.tasks=d; else appData=d; saveData(); location.reload();}}catch(x){alert("ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±");}}; if(f)r.readAsText(f);}

    init();
</script>

</body>
</html>
