<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ² Ø¬Ø§Ù…Ø¹ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</title>
    <style>
        :root {
            --primary: #2563eb;
            --bg: #f1f5f9;
            --border: #cbd5e1;
            --surface: #ffffff;
            --text: #1e293b;
            --hover: #e2e8f0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            font-size: 13px;
        }

        /* --- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± --- */
        .toolbar {
            background: var(--surface);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--border);
        }

        .btn-group {
            display: flex;
            gap: 10px;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            transition: 0.2s;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-print { background-color: #475569; }
        .btn-save { background-color: #059669; }
        .btn-load { background-color: #0891b2; }
        .btn-clear { background-color: #dc2626; }
        .btn-save-modal { background-color: var(--primary); }
        .btn-cancel { background-color: #94a3b8; }

        button:hover { opacity: 0.9; transform: translateY(-1px); }

        /* --- Ø¬Ø¯ÙˆÙ„ --- */
        .table-container {
            background: var(--surface);
            border-radius: 10px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            overflow-x: auto;
            position: relative;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Ø¹Ø±Ø¶ Ø«Ø§Ø¨Øª Ø¨Ø±Ø§ÛŒ Ù†Ø¸Ù… */
        }

        th {
            background-color: #1e293b;
            color: white;
            padding: 12px;
            position: sticky;
            top: 0;
            z-index: 20;
            border: 1px solid #334155;
        }

        /* Ø³ØªÙˆÙ† Ø³Ø§Ø¹Øª */
        th:first-child, td:first-child {
            width: 70px;
            background-color: #f8fafc;
            color: #64748b;
            font-weight: bold;
            font-size: 11px;
            z-index: 30; /* Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² Ø¨Ù‚ÛŒÙ‡ */
            position: sticky;
            right: 0; /* Ú†Ø³Ø¨ÛŒØ¯Ù† Ø¨Ù‡ Ø±Ø§Ø³Øª Ø¯Ø± Ø§Ø³Ú©Ø±ÙˆÙ„ */
        }

        td {
            border: 1px solid var(--border);
            text-align: center;
            height: 30px; /* Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø±Ø¨Ø¹ Ø³Ø§Ø¹Øª */
            vertical-align: middle;
            padding: 0;
            transition: background 0.1s;
        }

        /* Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù„ÛŒ */
        td.empty-cell:hover {
            background-color: #e0f2fe;
            cursor: pointer;
        }

        /* Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø± Ø´Ø¯Ù‡ */
        td.task-cell {
            color: white;
            cursor: pointer;
            box-sizing: border-box;
            padding: 5px;
            border-radius: 0; /* Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ù†Ø¨Ø§ÛŒØ¯ Ú¯Ø±Ø¯ Ø¨Ø§Ø´Ø¯ ØªØ§ Ø®Ø·ÙˆØ· Ù¾Ø±ÛŒÙ†Øª ÙˆØµÙ„ Ø´ÙˆÙ†Ø¯ */
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1); /* Ù…Ø±Ø² Ù†Ø§Ø²Ú© */
            font-size: 12px;
        }

        td.task-cell:hover {
            filter: brightness(1.1);
            z-index: 5;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .task-content {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .task-time { font-size: 10px; opacity: 0.9; margin-top: 2px; }

        /* --- Ù…ÙˆØ¯Ø§Ù„ (Ù¾Ù†Ø¬Ø±Ù‡ Ù¾Ø§Ù¾ Ø¢Ù¾) --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 350px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal h3 { margin: 0; color: var(--text); border-bottom: 1px solid #eee; padding-bottom: 10px; }

        .form-group { display: flex; flex-direction: column; gap: 5px; }
        .form-group label { font-size: 11px; font-weight: bold; color: #64748b; }
        
        .modal input, .modal select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        /* --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÛŒÙ†Øª --- */
        @media print {
            @page {
                size: A4 landscape; /* Ø§ÙÙ‚ÛŒ */
                margin: 10mm;
            }
            body { background: white; padding: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print, .toolbar, .modal-overlay { display: none !important; }
            .table-container { box-shadow: none; overflow: visible; }
            
            table { border: 2px solid black; font-size: 10px; }
            th { background-color: #ddd !important; color: black !important; border: 1px solid black; }
            td { border: 1px solid #666; }
            
            /* Ø§Ø¬Ø¨Ø§Ø± Ú†Ø§Ù¾ Ø±Ù†Ú¯â€ŒÙ‡Ø§ */
            td.task-cell {
                border: 1px solid #000 !important;
                color: black !important; /* Ù…ØªÙ† Ù…Ø´Ú©ÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¨Ù‡ØªØ± Ø¯Ø± Ù¾Ø±ÛŒÙ†Øª */
            }
            /* Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù…ØªÙ† Ø³ÙÛŒØ¯ Ø¨Ù…Ø§Ù†Ø¯ØŒ Ø®Ø· Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ */
        }
    </style>
</head>
<body>

    <!-- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± Ø¨Ø§Ù„Ø§ -->
    <div class="toolbar no-print">
        <div style="font-weight:bold; font-size:16px;">ğŸ“… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</div>
        <div class="btn-group">
            <button class="btn-save" onclick="exportData()">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾</button>
            <button class="btn-load" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
            <button class="btn-print" onclick="window.print()">ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª</button>
            <button class="btn-clear" onclick="clearAll()">ğŸ—‘ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
        </div>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ -->
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Ø³Ø§Ø¹Øª</th>
                    <th>Ø´Ù†Ø¨Ù‡</th>
                    <th>ÛŒÚ©Ø´Ù†Ø¨Ù‡</th>
                    <th>Ø¯ÙˆØ´Ù†Ø¨Ù‡</th>
                    <th>Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</th>
                    <th>Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</th>
                    <th>Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</th>
                    <th>Ø¬Ù…Ø¹Ù‡</th>
                </tr>
            </thead>
            <tbody id="plannerBody">
                <!-- ØªÙˆØ³Ø· JS Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </tbody>
        </table>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§ÙØ²ÙˆØ¯Ù†/ÙˆÛŒØ±Ø§ÛŒØ´ -->
    <div class="modal-overlay" id="modal">
        <div class="modal">
            <h3 id="modalTitle">Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª</h3>
            <input type="hidden" id="taskId"> <!-- Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ -->
            
            <!-- Ø§ÛŒÙ† ÙÛŒÙ„Ø¯Ù‡Ø§ ÙÙ‚Ø· Ø®ÙˆØ§Ù†Ø¯Ù†ÛŒ Ù‡Ø³ØªÙ†Ø¯ ØªØ§ Ú©Ø§Ø±Ø¨Ø± Ú¯ÛŒØ¬ Ù†Ø´ÙˆØ¯ØŒ ÛŒØ§ Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± -->
            <div class="form-group">
                <label>Ø±ÙˆØ² Ùˆ Ø³Ø§Ø¹Øª Ø´Ø±ÙˆØ¹:</label>
                <div style="display:flex; gap:5px;">
                    <select id="inpDay" disabled style="background:#f1f5f9; flex:1">
                        <option value="sat">Ø´Ù†Ø¨Ù‡</option><option value="sun">ÛŒÚ©Ø´Ù†Ø¨Ù‡</option>
                        <option value="mon">Ø¯ÙˆØ´Ù†Ø¨Ù‡</option><option value="tue">Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡</option>
                        <option value="wed">Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡</option><option value="thu">Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡</option>
                        <option value="fri">Ø¬Ù…Ø¹Ù‡</option>
                    </select>
                    <select id="inpStart" style="flex:1"></select> <!-- Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ± -->
                </div>
            </div>

            <div class="form-group">
                <label>Ù†Ø§Ù… ÙØ¹Ø§Ù„ÛŒØª:</label>
                <input type="text" id="inpName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ú©Ù„Ø§Ø³ Ø²Ø¨Ø§Ù†" autofocus>
            </div>

            <div class="form-group">
                <label>Ù…Ø¯Øª Ø²Ù…Ø§Ù†:</label>
                <select id="inpDuration">
                    <option value="1">15 Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="2">30 Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="3">45 Ø¯Ù‚ÛŒÙ‚Ù‡</option>
                    <option value="4" selected>1 Ø³Ø§Ø¹Øª</option>
                    <option value="5">1:15 Ø³Ø§Ø¹Øª</option>
                    <option value="6">1:30 Ø³Ø§Ø¹Øª</option>
                    <option value="8">2 Ø³Ø§Ø¹Øª</option>
                    <option value="12">3 Ø³Ø§Ø¹Øª</option>
                    <option value="16">4 Ø³Ø§Ø¹Øª</option>
                </select>
            </div>

            <div class="form-group">
                <label>Ø±Ù†Ú¯ Ø¨Ø±Ú†Ø³Ø¨:</label>
                <input type="color" id="inpColor" value="#3b82f6" style="height:40px; width:100%; padding:2px;">
            </div>

            <div class="modal-actions">
                <button class="btn-clear" type="button" id="btnDelete" onclick="deleteTask()" style="display:none;">Ø­Ø°Ù</button>
                <div style="flex:1"></div>
                <button class="btn-cancel" onclick="closeModal()">Ù„ØºÙˆ</button>
                <button class="btn-save-modal" onclick="saveTask()">Ø«Ø¨Øª</button>
            </div>
        </div>
    </div>

    <script>
        // --- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ ---
        const DAYS = ['sat', 'sun', 'mon', 'tue', 'wed', 'thu', 'fri'];
        const TIMELINE = [];
        
        // ØªÙˆÙ„ÛŒØ¯ Ø¨Ø§Ø²Ù‡â€ŒÙ‡Ø§ÛŒ Û±Ûµ Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ
        for(let h=0; h<24; h++){
            for(let m=0; m<60; m+=15){
                TIMELINE.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);
            }
        }

        // Ø¯ÛŒØªØ§Ø¨ÛŒØ³: Ø¢Ø±Ø§ÛŒÙ‡â€ŒØ§ÛŒ Ø§Ø² Ø¢Ø¨Ø¬Ú©Øªâ€ŒÙ‡Ø§ 
        // { id, day, startStr, duration, name, color }
        let tasks = JSON.parse(localStorage.getItem('masterPlanner')) || [];

        // --- ØªÙˆØ§Ø¨Ø¹ Ø§Ø¬Ø±Ø§ÛŒÛŒ ---
        function init() {
            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øª Ø³Ø§Ø¹Øª Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
            const startSel = document.getElementById('inpStart');
            TIMELINE.forEach(t => {
                startSel.add(new Option(t, t));
            });
            render();
        }

        // Ø±Ù†Ø¯Ø± Ø¬Ø¯ÙˆÙ„ (Ù…ØºØ² Ø§ØµÙ„ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡)
        function render() {
            const tbody = document.getElementById('plannerBody');
            tbody.innerHTML = '';

            // Ù…Ø§ØªØ±ÛŒØ³ Ø¨Ø±Ø§ÛŒ Ø±Ø¯ÛŒØ§Ø¨ÛŒ Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø± Ø´Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ rowspan)
            // occupied[dayIndex][timeIndex] = true/false
            const occupied = {};
            DAYS.forEach(d => occupied[d] = new Array(TIMELINE.length).fill(false));

            TIMELINE.forEach((timeStr, tIndex) => {
                const tr = document.createElement('tr');
                
                // 1. Ø³ØªÙˆÙ† Ø³Ø§Ø¹Øª
                const tdTime = document.createElement('td');
                tdTime.innerText = timeStr;
                tr.appendChild(tdTime);

                // 2. Ø³ØªÙˆÙ† Ø±ÙˆØ²Ù‡Ø§
                DAYS.forEach(day => {
                    // Ø§Ú¯Ø± Ø§ÛŒÙ† Ø®Ø§Ù†Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ ØªÙˆØ³Ø· ÛŒÚ© ØªØ³Ú© Ø¨Ø§Ù„Ø§â€ŒØ¯Ø³ØªÛŒ Ø§Ø´ØºØ§Ù„ Ø´Ø¯Ù‡ØŒ Ø±Ù†Ø¯Ø± Ù†Ú©Ù† (skip)
                    if (occupied[day][tIndex]) return;

                    // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ ØªØ³Ú© Ø¯Ø± Ø§ÛŒÙ† Ù†Ù‚Ø·Ù‡ Ø´Ø±ÙˆØ¹
                    const task = tasks.find(t => t.day === day && t.startStr === timeStr);

                    if (task) {
                        // Ø³Ø§Ø®Øª Ø³Ù„ÙˆÙ„ ØªØ³Ú©
                        const td = document.createElement('td');
                        td.rowSpan = task.duration;
                        td.className = 'task-cell';
                        td.style.backgroundColor = task.color;
                        
                        // Ù…Ø­ØªÙˆØ§ÛŒ Ø¯Ø§Ø®Ù„ Ø³Ù„ÙˆÙ„
                        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Øª Ù¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
                        const endIdx = tIndex + task.duration;
                        const endStr = endIdx < TIMELINE.length ? TIMELINE[endIdx] : "24:00";

                        td.innerHTML = `
                            <div class="task-content">
                                <div style="font-weight:bold">${task.name}</div>
                                <div class="task-time">${timeStr} - ${endStr}</div>
                            </div>
                        `;
                        
                        // Ø§ÛŒÙˆÙ†Øª Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
                        td.onclick = () => openModal(day, timeStr, task);

                        tr.appendChild(td);

                        // Ø¹Ù„Ø§Ù…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ±ÛŒÙ† Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ø§Ø´ØºØ§Ù„ Ø´Ø¯Ù‡
                        for(let i=1; i < task.duration; i++) {
                            if (tIndex + i < TIMELINE.length) {
                                occupied[day][tIndex + i] = true;
                            }
                        }
                    } else {
                        // Ø³Ø§Ø®Øª Ø³Ù„ÙˆÙ„ Ø®Ø§Ù„ÛŒ
                        const td = document.createElement('td');
                        td.className = 'empty-cell';
                        td.onclick = () => openModal(day, timeStr, null); // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ø§ÙØ²ÙˆØ¯Ù†
                        tr.appendChild(td);
                    }
                });

                tbody.appendChild(tr);
            });
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¯Ø§Ù„ (Ù¾Ù†Ø¬Ø±Ù‡) ---
        function openModal(day, startTime, task) {
            const modal = document.getElementById('modal');
            const title = document.getElementById('modalTitle');
            const btnDelete = document.getElementById('btnDelete');
            
            // Ø±ÛŒØ³Øª ÙØ±Ù…
            document.getElementById('inpDay').value = day;
            document.getElementById('inpStart').value = startTime;

            if (task) {
                // Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´
                title.innerText = "ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ¹Ø§Ù„ÛŒØª";
                document.getElementById('taskId').value = task.id;
                document.getElementById('inpName').value = task.name;
                document.getElementById('inpDuration').value = task.duration;
                document.getElementById('inpColor').value = task.color;
                btnDelete.style.display = 'block';
            } else {
                // Ø­Ø§Ù„Øª Ø§ÙØ²ÙˆØ¯Ù†
                title.innerText = "Ø§ÙØ²ÙˆØ¯Ù† ÙØ¹Ø§Ù„ÛŒØª Ø¬Ø¯ÛŒØ¯";
                document.getElementById('taskId').value = '';
                document.getElementById('inpName').value = '';
                document.getElementById('inpDuration').value = '4'; // Ù¾ÛŒØ´ÙØ±Ø¶ 1 Ø³Ø§Ø¹Øª
                document.getElementById('inpColor').value = '#3b82f6';
                btnDelete.style.display = 'none';
            }

            modal.style.display = 'flex';
            document.getElementById('inpName').focus();
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        function saveTask() {
            const id = document.getElementById('taskId').value;
            const day = document.getElementById('inpDay').value;
            const startStr = document.getElementById('inpStart').value;
            const duration = parseInt(document.getElementById('inpDuration').value);
            const name = document.getElementById('inpName').value.trim();
            const color = document.getElementById('inpColor').value;

            if (!name) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙØ¹Ø§Ù„ÛŒØª Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.");

            // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¯Ø§Ø®Ù„
            // ÙØ±Ù…ÙˆÙ„: Ø§Ú¯Ø± (StartA < EndB) Ùˆ (EndA > StartB) ØªØ¯Ø§Ø®Ù„ Ø§Ø³Øª.
            const startIdx = TIMELINE.indexOf(startStr);
            const endIdx = startIdx + duration;

            // Ú†Ú© Ú©Ø±Ø¯Ù† Ø¨Ø§ Ù‡Ù…Ù‡ ØªØ³Ú©â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± (Ø¨Ø¬Ø² Ø®ÙˆØ¯ ØªØ³Ú© Ø¯Ø± Ø­Ø§Ù„ ÙˆÛŒØ±Ø§ÛŒØ´)
            const hasConflict = tasks.some(t => {
                if (t.id == id) return false; // Ø®ÙˆØ¯Ø´ Ø±Ø§ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ø¨Ú¯ÛŒØ±
                if (t.day !== day) return false; // Ø±ÙˆØ² Ø¯ÛŒÚ¯Ø±
                
                const tStartIdx = TIMELINE.indexOf(t.startStr);
                const tEndIdx = tStartIdx + t.duration;

                return (startIdx < tEndIdx && endIdx > tStartIdx);
            });

            if (hasConflict) {
                alert("Ø®Ø·Ø§: Ø¯Ø± Ø§ÛŒÙ† Ø³Ø§Ø¹Øª Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯!");
                return;
            }

            if (id) {
                // Ø¢Ù¾Ø¯ÛŒØª ØªØ³Ú© Ù…ÙˆØ¬ÙˆØ¯
                const idx = tasks.findIndex(t => t.id == id);
                if (idx !== -1) {
                    tasks[idx] = { ...tasks[idx], day, startStr, duration, name, color };
                }
            } else {
                // ØªØ³Ú© Ø¬Ø¯ÛŒØ¯
                tasks.push({
                    id: Date.now(),
                    day, startStr, duration, name, color
                });
            }

            saveData();
            render();
            closeModal();
        }

        function deleteTask() {
            const id = document.getElementById('taskId').value;
            if (id && confirm("Ø¢ÛŒØ§ Ø§ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
                tasks = tasks.filter(t => t.id != id);
                saveData();
                render();
                closeModal();
            }
        }

        // --- Ø°Ø®ÛŒØ±Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ ---
        function saveData() {
            localStorage.setItem('masterPlanner', JSON.stringify(tasks));
        }

        function clearAll() {
            if (confirm("ØªÙ…Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ú¯Ø´Øª Ù†ÛŒØ³Øª!")) {
                tasks = [];
                saveData();
                render();
            }
        }

        function exportData() {
            const str = JSON.stringify(tasks);
            const blob = new Blob([str], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "planner_backup.json";
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if(Array.isArray(data)) {
                        if(confirm("Ø¢ÛŒØ§ Ø¨Ú©â€ŒØ¢Ù¾ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ¹Ù„ÛŒ Ø´ÙˆØ¯ØŸ")) {
                            tasks = data;
                            saveData();
                            render();
                        }
                    } else { alert("ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª"); }
                } catch(err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø¨ÛŒØ±ÙˆÙ†
        window.onclick = (e) => {
            if (e.target == document.getElementById('modal')) closeModal();
        }

        init();
    </script>
</body>
</html>
