 <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>برنامه ریزی جدولی منظم</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f5f6fa;
            --border: #bdc3c7;
            --cell-height: 25px;
        }

        body {
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            font-size: 12px;
        }

        /* --- پنل تنظیمات --- */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: flex-end;
            flex-wrap: wrap;
            border-top: 5px solid var(--accent);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label { margin-bottom: 5px; font-weight: bold; color: #555; }

        input, select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            min-width: 120px;
        }
        
        /* استایل گزینه های غیرفعال در سلکت */
        option:disabled {
            background-color: #eee;
            color: #aaa;
        }

        button {
            padding: 9px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            font-family: inherit;
        }

        .btn-add { background: var(--accent); }
        .btn-add:hover { background: #2980b9; }
        .btn-print { background: var(--primary); }
        .btn-clear { background: #c0392b; }

        /* --- جدول برنامه --- */
        .schedule-wrapper {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* عرض ثابت ستون ها */
        }

        th, td {
            border: 1px solid var(--border);
            text-align: center;
            padding: 0;
            overflow: hidden;
            word-wrap: break-word;
        }

        th {
            background-color: var(--primary);
            color: white;
            padding: 10px;
            position: sticky;
            top: 0;
            z-index: 10;
            width: 13%; /* تقسیم بین 7 روز + ستون ساعت */
        }
        
        /* ستون اول (ساعت) */
        th:first-child, td:first-child {
            width: 60px;
            background-color: #ecf0f1;
            font-weight: bold;
            font-size: 10px;
            color: #7f8c8d;
        }

        td {
            height: var(--cell-height);
            transition: background 0.2s;
            font-size: 11px;
            vertical-align: middle;
        }

        /* سلول‌های خالی قابل هاور */
        td:not(:first-child):not(.filled-cell):hover {
            background-color: #f0f8ff;
        }

        /* سلول پر شده */
        .filled-cell {
            background-color: #e3f2fd;
            color: #000;
            cursor: pointer;
            border-left: 4px solid var(--accent);
            box-sizing: border-box;
            padding: 5px;
            font-weight: bold;
        }
        
        .filled-cell:hover {
            background-color: #bbdefb;
        }

        /* --- پرینت --- */
        @media print {
            @page {
                size: A4 landscape; /* اجبار به افقی برای جا شدن هفته */
                margin: 1cm;
            }

            body {
                background: white;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .controls, .no-print {
                display: none;
            }

            .schedule-wrapper {
                box-shadow: none;
                overflow: visible;
            }

            table {
                font-size: 10px;
                border: 2px solid #000;
            }
            
            th {
                background-color: #ccc !important;
                color: black !important;
                border: 1px solid #000;
            }

            td {
                border: 1px solid #666;
                height: 20px; /* کاهش ارتفاع برای جا شدن در صفحه */
            }

            .filled-cell {
                background-color: #eee !important;
                border: 1px solid #000;
                border-left: 5px solid #000 !important;
            }
        }
    </style>
</head>
<body>

<div class="controls no-print">
    <div class="input-group">
        <label>عنوان فعالیت</label>
        <input type="text" id="inpName" placeholder="مثلا: ورزش">
    </div>
    
    <div class="input-group">
        <label>روز هفته</label>
        <select id="inpDay" onchange="updateTimeOptions()">
            <option value="sat">شنبه</option>
            <option value="sun">یکشنبه</option>
            <option value="mon">دوشنبه</option>
            <option value="tue">سه‌شنبه</option>
            <option value="wed">چهارشنبه</option>
            <option value="thu">پنج‌شنبه</option>
            <option value="fri">جمعه</option>
        </select>
    </div>

    <div class="input-group">
        <label>ساعت شروع</label>
        <select id="inpStart"></select>
    </div>

    <div class="input-group">
        <label>ساعت پایان</label>
        <select id="inpEnd"></select>
    </div>

    <div class="input-group" style="flex-direction: row; gap: 10px; align-items: flex-end;">
        <button class="btn-add" onclick="addTask()">+ ثبت در برنامه</button>
        <button class="btn-print" onclick="window.print()">چاپ برنامه</button>
        <button class="btn-clear" onclick="clearData()">حذف همه</button>
    </div>
</div>

<div class="schedule-wrapper">
    <table id="plannerTable">
        <thead>
            <tr>
                <th>ساعت</th>
                <th>شنبه</th>
                <th>یکشنبه</th>
                <th>دوشنبه</th>
                <th>سه‌شنبه</th>
                <th>چهارشنبه</th>
                <th>پنج‌شنبه</th>
                <th>جمعه</th>
            </tr>
        </thead>
        <tbody id="plannerBody">
            <!-- سطرها با جاوااسکریپت ساخته می‌شوند -->
        </tbody>
    </table>
</div>

<script>
    // تنظیمات
    const daysOrder = ['sat', 'sun', 'mon', 'tue', 'wed', 'thu', 'fri'];
    const timeIntervals = []; // تمام بازه های 15 دقیقه ای
    
    // دیتابیس اصلی: { 'sat': { '08:00': { name: 'Gym', duration: 4 } } }
    // duration تعداد بلاک‌های 15 دقیقه‌ای است
    let schedule = JSON.parse(localStorage.getItem('tablePlannerDB')) || {};

    // تولید بازه های زمانی 00:00 تا 23:45
    for(let h=0; h<24; h++) {
        for(let m=0; m<60; m+=15) {
            let time = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
            timeIntervals.push(time);
        }
    }

    function init() {
        populateSelects();
        renderTable();
        updateTimeOptions(); // آپدیت اولیه برای غیرفعال کردن تایم های پر
    }

    function populateSelects() {
        const startSel = document.getElementById('inpStart');
        const endSel = document.getElementById('inpEnd');
        
        // پاک کردن قبلی ها
        startSel.innerHTML = '';
        endSel.innerHTML = '';

        timeIntervals.forEach(t => {
            startSel.add(new Option(t, t));
        });
        
        // برای پایان، از 00:15 شروع میشه تا 24:00 (فرضی 00:00 روز بعد)
        const endTimes = [...timeIntervals.slice(1), "24:00"]; // 00:00 بعدی رو دستی هندل میکنیم
        endTimes.forEach(t => {
            endSel.add(new Option(t, t));
        });
        
        // پیشفرض
        startSel.value = "08:00";
        endSel.value = "09:00";
    }

    // --- منطق هوشمند غیرفعال سازی ---
    function updateTimeOptions() {
        const day = document.getElementById('inpDay').value;
        const startSel = document.getElementById('inpStart');
        
        // ریست کردن همه آپشن ها به حالت فعال
        Array.from(startSel.options).forEach(opt => {
            opt.disabled = false;
            opt.text = opt.value; // برگرداندن متن اصلی
        });

        // اگر دیتایی برای این روز هست
        if (schedule[day]) {
            // پیمایش تمام تسک های این روز
            Object.keys(schedule[day]).forEach(startTime => {
                const task = schedule[day][startTime];
                const startIndex = timeIntervals.indexOf(startTime);
                
                // غیرفعال کردن تایم هایی که اشغال شده اند
                // از شروع تسک تا پایان تسک (duration)
                for(let i=0; i < task.duration; i++) {
                    const blockedIndex = startIndex + i;
                    if(blockedIndex < timeIntervals.length) {
                        const timeStr = timeIntervals[blockedIndex];
                        // پیدا کردن آپشن در سلکت
                        for (let opt of startSel.options) {
                            if (opt.value === timeStr) {
                                opt.disabled = true;
                                opt.text = timeStr + " (پر است)";
                            }
                        }
                    }
                }
            });
        }
    }

    // --- رندر جدول ---
    function renderTable() {
        const tbody = document.getElementById('plannerBody');
        tbody.innerHTML = '';

        // ماتریس وضعیت برای هندل کردن rowspan
        // skipMap['sat'][5] = true یعنی در ستون شنبه، سطر پنجم رندر نشود چون سطر قبلی rowspan داشته
        let skipMap = {}; 
        daysOrder.forEach(d => skipMap[d] = {});

        // حلقه روی تمام زمان ها (سطرها)
        timeIntervals.forEach((time, rowIndex) => {
            const tr = document.createElement('tr');
            
            // 1. ستون اول: ساعت
            const tdTime = document.createElement('td');
            tdTime.innerText = time;
            tr.appendChild(tdTime);

            // 2. ستون های روزها
            daysOrder.forEach(day => {
                // اگر قبلا دستور داده شده که این خانه رد شود (بخاطر rowspan بالا)
                if (skipMap[day][rowIndex]) {
                    return; // هیچ td نمی‌سازیم (جای خالی پر شده توسط بالایی)
                }

                const td = document.createElement('td');
                
                // آیا در این روز و این ساعت تسکی شروع می‌شود؟
                if (schedule[day] && schedule[day][time]) {
                    const task = schedule[day][time];
                    
                    td.innerText = task.name;
                    td.rowSpan = task.duration; // ادغام سلول ها به پایین
                    td.className = 'filled-cell';
                    td.onclick = () => deleteTask(day, time);
                    td.title = `حذف: ${task.name}`;

                    // علامت گذاری سلول های بعدی برای رد شدن
                    for(let i=1; i < task.duration; i++) {
                        skipMap[day][rowIndex + i] = true;
                    }
                } else {
                    // سلول خالی
                    td.innerHTML = '&nbsp;';
                }
                
                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    }

    // --- افزودن تسک ---
    function addTask() {
        const name = document.getElementById('inpName').value;
        const day = document.getElementById('inpDay').value;
        const start = document.getElementById('inpStart').value;
        const end = document.getElementById('inpEnd').value;

        if(!name) return alert("نام فعالیت را وارد کنید");
        if(start >= end && end !== "00:00") return alert("ساعت پایان اشتباه است"); // هندل کردن ساده

        const startIdx = timeIntervals.indexOf(start);
        let endIdx = timeIntervals.indexOf(end);
        if(end === "24:00") endIdx = timeIntervals.length;

        const duration = endIdx - startIdx;
        
        if (duration <= 0) return alert("بازه زمانی نامعتبر");

        // چک تداخل نهایی (علاوه بر UI)
        if (checkOverlap(day, startIdx, duration)) {
            return alert("تداخل! بخشی از این زمان قبلا پر شده است.");
        }

        // ذخیره
        if (!schedule[day]) schedule[day] = {};
        
        schedule[day][start] = {
            name: name,
            duration: duration
        };

        saveData();
        renderTable();
        updateTimeOptions(); // بروزرسانی لیست ساعت‌ها
    }

    function checkOverlap(day, startIdx, duration) {
        if (!schedule[day]) return false;
        
        // تبدیل همه تسک های روز به بازه های اشغال شده
        let occupiedIndices = new Set();
        Object.keys(schedule[day]).forEach(tTime => {
            const tStartIdx = timeIntervals.indexOf(tTime);
            const tDuration = schedule[day][tTime].duration;
            for(let i=0; i<tDuration; i++) occupiedIndices.add(tStartIdx + i);
        });

        // چک کردن بازه جدید
        for(let i=0; i<duration; i++) {
            if (occupiedIndices.has(startIdx + i)) return true;
        }
        return false;
    }

    function deleteTask(day, time) {
        if(confirm("آیا این فعالیت حذف شود؟")) {
            delete schedule[day][time];
            saveData();
            renderTable();
            updateTimeOptions();
        }
    }

    function clearData() {
        if(confirm("تمام برنامه پاک شود؟")) {
            localStorage.removeItem('tablePlannerDB');
            schedule = {};
            renderTable();
            updateTimeOptions();
        }
    }

    function saveData() {
        localStorage.setItem('tablePlannerDB', JSON.stringify(schedule));
    }

    init();

</script>

</body>
</html>
