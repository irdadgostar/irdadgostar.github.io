<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ Ø¬Ø§Ù…Ø¹ (Ù†Ø³Ø®Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾ÛŒØ´Ø±ÙØªÙ‡)</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --border: #cbd5e1;
            --text: #334155;
            --select-bg: #bfdbfe; /* Ø±Ù†Ú¯ Ø§Ù†ØªØ®Ø§Ø¨ Ù…Ø­Ø¯ÙˆØ¯Ù‡ */
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 15px;
            color: var(--text);
            font-size: 13px;
            padding-bottom: 100px;
            -webkit-tap-highlight-color: transparent; /* Ø­Ø°Ù Ù‡Ø§ÛŒÙ„Ø§ÛŒØª Ø¢Ø¨ÛŒ Ù¾ÛŒØ´ÙØ±Ø¶ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }

        /* --- Ù‡Ø¯Ø± Ù¾Ø±ÛŒÙ†Øª (ÙÙ‚Ø· Ø¯Ø± Ù¾Ø±ÛŒÙ†Øª Ø¯ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯) --- */
        #print-header-display { display: none; }

        /* --- Ù†ÙˆØ§Ø± Ø§Ø¨Ø²Ø§Ø± --- */
        .toolbar {
            background: var(--surface);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            margin-bottom: 15px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toolbar-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .toolbar-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-top: 5px;
            font-family: inherit;
        }

        /* Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        button {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            font-size: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            white-space: nowrap;
        }

        .btn-primary { background-color: var(--primary); }
        .btn-success { background-color: #10b981; }
        .btn-danger { background-color: #ef4444; }
        .btn-dark { background-color: #475569; }
        .btn-note { background-color: #f59e0b; }
        
        /* Ø¯Ú©Ù…Ù‡ Ø³ÙˆÛŒÛŒÚ† Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ */
        .mode-switch {
            background-color: #e2e8f0;
            color: #334155;
            border: 1px solid #cbd5e1;
        }
        .mode-switch.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary-dark);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- Ø¬Ø¯ÙˆÙ„ --- */
        .table-wrapper {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            overflow: auto; /* Ø§Ø³Ú©Ø±ÙˆÙ„ */
            position: relative;
            border: 1px solid var(--border);
            max-height: 80vh;
            overscroll-behavior: contain; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            min-width: 800px; /* Ø­Ø¯Ø§Ù‚Ù„ Ø¹Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        }

        thead { position: sticky; top: 0; z-index: 20; }

        th {
            background-color: #1e293b;
            color: white;
            padding: 10px;
            border: 1px solid #334155;
            font-size: 12px;
            user-select: none;
        }

        /* Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ø¯Ø± Ù‡Ø¯Ø± */
        .copy-day-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 5px;
            cursor: pointer;
            font-size: 10px;
            color: white;
        }
        .copy-day-btn:hover { background: rgba(255,255,255,0.4); }

        th:first-child, td:first-child {
            width: 60px;
            background-color: #f8fafc;
            color: #64748b;
            font-weight: bold;
            font-size: 10px;
            position: sticky;
            right: 0;
            z-index: 30;
            border-left: 2px solid #cbd5e1;
            text-align: center;
        }

        td {
            border: 1px solid #e2e8f0;
            text-align: center;
            height: 25px; /* Ø§Ø±ØªÙØ§Ø¹ Ù‡Ø± Ø±Ø¨Ø¹ Ø³Ø§Ø¹Øª */
            padding: 0;
            vertical-align: middle;
            touch-action: auto; /* Ù¾ÛŒØ´ÙØ±Ø¶ */
        }

        /* --- Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ --- */
        /* ÙˆÙ‚ØªÛŒ Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ø§Ù„ Ø§Ø³ØªØŒ Ø§Ø³Ú©Ø±ÙˆÙ„ Ø±ÙˆÛŒ Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø¨ØªÙˆØ§Ù† Ø¯Ø±Ú¯ Ú©Ø±Ø¯ */
        body.selection-mode td.empty-cell {
            touch-action: none; 
            cursor: crosshair;
        }

        td.selected-range {
            background-color: var(--select-bg) !important;
        }

        /* --- ØªØ³Ú©â€ŒÙ‡Ø§ --- */
        td.task-cell {
            color: white;
            padding: 2px;
            font-size: 11px;
            border-bottom: 1px solid rgba(255,255,255,0.3);
            box-sizing: border-box;
            position: relative;
            cursor: pointer;
            overflow: hidden;
        }
        
        .task-inner {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center;
            pointer-events: none;
        }

        /* --- Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§ --- */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal h3 { margin: 0 0 10px 0; border-bottom: 1px solid #eee; padding-bottom: 8px; }
        
        .form-label { font-size: 11px; font-weight: bold; color: #64748b; margin-bottom: 4px; display: block; }
        input, select, textarea {
            width: 100%; padding: 10px; border: 1px solid #cbd5e1;
            border-radius: 8px; font-family: inherit; box-sizing: border-box;
        }
        
        .color-palette { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .color-swatch {
            width: 25px; height: 25px; border-radius: 50%; cursor: pointer;
            border: 2px solid #fff; box-shadow: 0 0 0 1px #cbd5e1;
        }

        /* --- Ù¾Ø±ÛŒÙ†Øª --- */
        @media print {
            @page { size: A4 landscape; margin: 5mm; }
            body { background: white; padding: 0; }
            .no-print, .toolbar, .copy-day-btn { display: none !important; }
            
            #print-header-display {
                display: block;
                text-align: center;
                font-size: 20px;
                font-weight: bold;
                margin-bottom: 10px;
                border-bottom: 2px solid #000;
                padding-bottom: 5px;
            }

            .table-wrapper { box-shadow: none; border: none; overflow: visible; max-height: none; }
            table { border: 2px solid #000; font-size: 10px; width: 100%; }
            thead { display: table-header-group; }
            tr { page-break-inside: avoid; }
            th { background-color: #ddd !important; color: black !important; border: 1px solid #000; }
            td { border: 1px solid #666; height: 20px; }
            td.task-cell { border: 1px solid #000 !important; color: black !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body id="mainBody">

    <!-- Ù‡Ø¯Ø± Ù…Ø®ØµÙˆØµ Ù¾Ø±ÛŒÙ†Øª -->
    <div id="print-header-display"></div>

    <div class="toolbar no-print">
        <div class="toolbar-row">
            <div style="font-weight:bold; display:flex; align-items:center; gap:5px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
            </div>
            
            <!-- Ø¯Ú©Ù…Ù‡ Ù…Ù‡Ù… Ø³ÙˆÛŒÛŒÚ† Ø­Ø§Ù„Øª -->
            <button class="mode-switch" id="selectionModeBtn" onclick="toggleSelectionMode()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l7.586 7.586"></path><circle cx="11" cy="11" r="2"></circle></svg>
                <span id="modeText">Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„</span> (Ø¨Ø±Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø¨Ø²Ù†ÛŒØ¯)
            </button>
        </div>

        <div class="toolbar-row">
            <input type="text" id="printHeaderInput" class="toolbar-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„Ø§ÛŒ ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾Ø±ÛŒÙ†Øª (Ù…Ø«Ù„Ø§: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÙ‡ Ø§ÙˆÙ„ Ù…Ù‡Ø±)" oninput="updatePrintHeader(this.value)">
        </div>

        <div class="toolbar-row">
            <button class="btn-note" onclick="openNotepad()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
            </button>
            
            <div style="flex:1"></div>

            <button class="btn-success" onclick="exportData()">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ú©â€ŒØ¢Ù¾</button>
            <button class="btn-primary" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ</button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
            <button class="btn-dark" onclick="window.print()">ğŸ–¨ Ù¾Ø±ÛŒÙ†Øª</button>
            <button class="btn-danger" onclick="clearAll()">ğŸ—‘ Ø­Ø°Ù</button>
        </div>
    </div>

    <div class="table-wrapper">
        <table id="plannerTable">
            <thead>
                <tr id="tableHeaderRow">
                    <th>Ø³Ø§Ø¹Øª</th>
                    <!-- Ù‡Ø¯Ø±Ù‡Ø§ ØªÙˆØ³Ø· JS Ø³Ø§Ø®ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ ØªØ§ Ø¯Ú©Ù…Ù‡ Ú©Ù¾ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù†Ø¯ -->
                </tr>
            </thead>
            <tbody id="plannerBody"></tbody>
        </table>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÙØ¹Ø§Ù„ÛŒØª -->
    <div class="modal-overlay" id="taskModal">
        <div class="modal">
            <h3>Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„ÛŒØª</h3>
            <input type="hidden" id="taskId">
            <input type="hidden" id="taskDay">
            <input type="hidden" id="taskStartStr">
            
            <div>
                <span class="form-label">Ø²Ù…Ø§Ù†:</span>
                <div id="timeDisplay" style="font-size:12px; color:#666; margin-bottom:5px;"></div>
            </div>

            <div>
                <span class="form-label">Ù†Ø§Ù… ÙØ¹Ø§Ù„ÛŒØª:</span>
                <input type="text" id="inpName" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙˆØ±Ø²Ø´" autofocus>
            </div>

            <div>
                <span class="form-label">Ù…Ø¯Øª Ø²Ù…Ø§Ù† (ØªØ¹Ø¯Ø§Ø¯ Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§ÛŒ 15 Ø¯Ù‚ÛŒÙ‚Ù‡â€ŒØ§ÛŒ):</span>
                <select id="inpDuration">
                    <!-- Ø¨Ø§ JS Ù¾Ø± Ù…ÛŒØ´ÙˆØ¯ -->
                </select>
            </div>

            <div>
                <span class="form-label">Ø±Ù†Ú¯:</span>
                <div class="color-palette">
                    <div class="color-swatch" style="background:#3b82f6" onclick="setColor('#3b82f6')"></div>
                    <div class="color-swatch" style="background:#10b981" onclick="setColor('#10b981')"></div>
                    <div class="color-swatch" style="background:#ef4444" onclick="setColor('#ef4444')"></div>
                    <div class="color-swatch" style="background:#f59e0b" onclick="setColor('#f59e0b')"></div>
                    <div class="color-swatch" style="background:#8b5cf6" onclick="setColor('#8b5cf6')"></div>
                    <div class="color-swatch" style="background:#64748b" onclick="setColor('#64748b')"></div>
                    <input type="color" id="inpColor" value="#3b82f6" style="margin-right:auto">
                </div>
            </div>

            <div style="display:flex; justify-content:space-between; margin-top:10px;">
                <button class="btn-danger" id="btnDelete" onclick="deleteTask()" style="display:none">Ø­Ø°Ù</button>
                <div style="flex:1"></div>
                <button class="btn-dark" onclick="closeModal('taskModal')" style="margin-left:5px;">Ù„ØºÙˆ</button>
                <button class="btn-primary" onclick="saveTask()">Ø°Ø®ÛŒØ±Ù‡</button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª -->
    <div class="modal-overlay" id="noteModal">
        <div class="modal">
            <h3>Ø¯ÙØªØ±Ú†Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</h3>
            <textarea id="notepadArea" rows="10" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø®ÙˆØ¯ Ø±Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
            <div style="display:flex; justify-content:flex-end;">
                <button class="btn-primary" onclick="saveNoteAndClose()">Ø°Ø®ÛŒØ±Ù‡ Ùˆ Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>

    <script>
        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ ---
        const DAYS = [
            { id: 'sat', label: 'Ø´Ù†Ø¨Ù‡' }, { id: 'sun', label: 'ÛŒÚ©Ø´Ù†Ø¨Ù‡' },
            { id: 'mon', label: 'Ø¯ÙˆØ´Ù†Ø¨Ù‡' }, { id: 'tue', label: 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡' },
            { id: 'wed', label: 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡' }, { id: 'thu', label: 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡' },
            { id: 'fri', label: 'Ø¬Ù…Ø¹Ù‡' }
        ];
        
        const TIMELINE = [];
        for(let h=0; h<24; h++) for(let m=0; m<60; m+=15) 
            TIMELINE.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`);

        // Ø¢Ø¨Ø¬Ú©Øª Ø§ØµÙ„ÛŒ Ø¯ÛŒØªØ§
        let appData = {
            tasks: [],
            notes: "",
            printHeader: ""
        };

        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨
        let isSelectionMode = false;
        let isDragging = false;
        let selectionStart = null; // { day, index }
        let selectionCurrent = null;

        // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
        function init() {
            // Ù„ÙˆØ¯ Ø¯ÛŒØªØ§
            const saved = localStorage.getItem('ultraPlannerV1');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ù†Ø³Ø®Ù‡ Ù‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ (Ø§Ú¯Ø± Ø¢Ø±Ø§ÛŒÙ‡ Ø¨ÙˆØ¯ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Ú©Ù†)
                    if (Array.isArray(parsed)) {
                        appData.tasks = parsed;
                    } else {
                        appData = parsed;
                    }
                } catch(e) { console.error("Data Load Error", e); }
            }

            // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ UI
            document.getElementById('notepadArea').value = appData.notes || "";
            document.getElementById('printHeaderInput').value = appData.printHeader || "";
            updatePrintHeader(appData.printHeader || "");

            // Ù¾Ø± Ú©Ø±Ø¯Ù† Ø³Ù„Ú©Øª Ù…Ø¯Øª Ø²Ù…Ø§Ù†
            const durSel = document.getElementById('inpDuration');
            for(let i=1; i<=32; i++) {
                let txt = "";
                if (i*15 < 60) txt = (i*15) + " Ø¯Ù‚ÛŒÙ‚Ù‡";
                else {
                    const h = Math.floor((i*15)/60);
                    const m = (i*15)%60;
                    txt = h + " Ø³Ø§Ø¹Øª" + (m>0 ? " Ùˆ " + m + " Ø¯Ù‚ÛŒÙ‚Ù‡" : "");
                }
                durSel.add(new Option(txt, i));
            }

            renderHeader();
            renderTable();
            setupPointerEvents();
        }

        // --- Ø±Ù†Ø¯Ø±ÛŒÙ†Ú¯ ---
        function renderHeader() {
            const tr = document.getElementById('tableHeaderRow');
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‡Ù…Ù‡ Ø¨Ø¬Ø² Ø³ØªÙˆÙ† Ø§ÙˆÙ„
            while(tr.children.length > 1) tr.removeChild(tr.lastChild);

            DAYS.forEach(day => {
                const th = document.createElement('th');
                th.innerHTML = `
                    <div style="display:flex; align-items:center; justify-content:center; gap:5px;">
                        <button class="copy-day-btn" onclick="copyDay('${day.id}')" title="Ú©Ù¾ÛŒ Ú©Ø±Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÛŒÙ† Ø±ÙˆØ²">ğŸ“‹</button>
                        ${day.label}
                    </div>
                `;
                tr.appendChild(th);
            });
        }

        function renderTable() {
            const tbody = document.getElementById('plannerBody');
            tbody.innerHTML = '';
            
            // Ù†Ù‚Ø´Ù‡ Ø§Ø´ØºØ§Ù„ Ø¨ÙˆØ¯Ù† Ø®Ø§Ù†Ù‡â€ŒÙ‡Ø§
            const occupied = {}; 
            DAYS.forEach(d => occupied[d.id] = new Array(TIMELINE.length).fill(false));

            TIMELINE.forEach((timeStr, tIndex) => {
                const tr = document.createElement('tr');
                
                // Ø³ØªÙˆÙ† Ø³Ø§Ø¹Øª
                const tdTime = document.createElement('td');
                tdTime.innerText = timeStr;
                tr.appendChild(tdTime);

                DAYS.forEach(day => {
                    if (occupied[day.id][tIndex]) return;

                    const task = appData.tasks.find(t => t.day === day.id && t.startStr === timeStr);

                    if (task) {
                        const td = document.createElement('td');
                        td.rowSpan = task.duration;
                        td.className = 'task-cell';
                        td.style.backgroundColor = task.color;
                        
                        // Ù…Ø­ØªÙˆØ§
                        const endIdx = tIndex + task.duration;
                        const endStr = endIdx < TIMELINE.length ? TIMELINE[endIdx] : "24:00";
                        td.innerHTML = `<div class="task-inner"><b>${task.name}</b></div>`;
                        
                        // Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´
                        td.onclick = (e) => {
                            e.stopPropagation(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†ØªØ®Ø§Ø¨ Ø³Ù„ÙˆÙ„ Ø²ÛŒØ±ÛŒÙ†
                            openTaskModal(task);
                        };

                        tr.appendChild(td);
                        // Ù¾Ø± Ú©Ø±Ø¯Ù† Ù…Ø§ØªØ±ÛŒØ³ Ø§Ø´ØºØ§Ù„
                        for(let i=1; i < task.duration; i++) 
                            if (tIndex + i < TIMELINE.length) occupied[day.id][tIndex + i] = true;

                    } else {
                        // Ø³Ù„ÙˆÙ„ Ø®Ø§Ù„ÛŒ
                        const td = document.createElement('td');
                        td.className = 'empty-cell';
                        td.dataset.day = day.id;
                        td.dataset.index = tIndex;
                        tr.appendChild(td);
                    }
                });
                tbody.appendChild(tr);
            });
        }

        // --- Ø³ÛŒØ³ØªÙ… Ø§Ù†ØªØ®Ø§Ø¨ Ùˆ ØªØ§Ú† (Ù‡Ø³ØªÙ‡ Ø§ØµÙ„ÛŒ Ø¬Ø¯ÛŒØ¯) ---
        function toggleSelectionMode() {
            isSelectionMode = !isSelectionMode;
            const btn = document.getElementById('selectionModeBtn');
            const txt = document.getElementById('modeText');
            const body = document.body;

            if (isSelectionMode) {
                btn.classList.add('active');
                txt.innerText = "âœï¸ Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙˆØ´Ù†";
                body.classList.add('selection-mode');
            } else {
                btn.classList.remove('active');
                txt.innerText = "Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„";
                body.classList.remove('selection-mode');
                clearSelection();
            }
        }

        function setupPointerEvents() {
            const table = document.getElementById('plannerTable');
            
            // Ø´Ø±ÙˆØ¹ Ù„Ù…Ø³
            table.addEventListener('pointerdown', (e) => {
                if (!isSelectionMode) return;
                const cell = e.target.closest('td.empty-cell');
                if (!cell) return;
                
                e.preventDefault(); // Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³Ú©Ø±ÙˆÙ„
                isDragging = true;
                const day = cell.dataset.day;
                const idx = parseInt(cell.dataset.index);
                
                selectionStart = { day, index: idx };
                selectionCurrent = { day, index: idx };
                highlightSelection();
                
                // Ú©Ù¾Ú†Ø± Ú©Ø±Ø¯Ù† Ù¾ÙˆÛŒÙ†ØªØ± Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ø±Ú¯ Ø­ØªÛŒ Ø§Ú¯Ø± Ø§Ø² Ø§Ù„Ù…Ø§Ù† Ø®Ø§Ø±Ø¬ Ø´Ø¯
                cell.setPointerCapture(e.pointerId);
            });

            // Ø­Ø±Ú©Øª Ù„Ù…Ø³
            table.addEventListener('pointermove', (e) => {
                if (!isDragging || !isSelectionMode) return;
                e.preventDefault();

                // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø§Ù„Ù…Ø§Ù† Ø²ÛŒØ± Ø§Ù†Ú¯Ø´Øª
                const element = document.elementFromPoint(e.clientX, e.clientY);
                if (!element) return;
                
                const cell = element.closest('td.empty-cell');
                if (cell && cell.dataset.day === selectionStart.day) {
                    const idx = parseInt(cell.dataset.index);
                    // ÙÙ‚Ø· Ø¯Ø± Ù‡Ù…Ø§Ù† Ø±ÙˆØ² Ø§Ø¬Ø§Ø²Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø§Ø±ÛŒÙ…
                    selectionCurrent = { day: selectionStart.day, index: idx };
                    highlightSelection();
                }
            });

            // Ù¾Ø§ÛŒØ§Ù† Ù„Ù…Ø³
            table.addEventListener('pointerup', (e) => {
                if (!isDragging) return;
                isDragging = false;
                if (selectionStart && selectionCurrent) {
                    finalizeSelection();
                }
            });
        }

        function highlightSelection() {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ù‚Ø¨Ù„ÛŒ Ù‡Ø§
            document.querySelectorAll('.selected-range').forEach(el => el.classList.remove('selected-range'));

            if (!selectionStart || !selectionCurrent) return;

            const start = Math.min(selectionStart.index, selectionCurrent.index);
            const end = Math.max(selectionStart.index, selectionCurrent.index);
            const day = selectionStart.day;

            // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ Ùˆ Ø±Ù†Ú¯ Ú©Ø±Ø¯Ù†
            for (let i = start; i <= end; i++) {
                const selector = `td.empty-cell[data-day="${day}"][data-index="${i}"]`;
                const el = document.querySelector(selector);
                if (el) el.classList.add('selected-range');
            }
        }

        function clearSelection() {
            document.querySelectorAll('.selected-range').forEach(el => el.classList.remove('selected-range'));
            selectionStart = null;
            selectionCurrent = null;
        }

        function finalizeSelection() {
            const startIdx = Math.min(selectionStart.index, selectionCurrent.index);
            const endIdx = Math.max(selectionStart.index, selectionCurrent.index);
            const duration = endIdx - startIdx + 1;
            const day = selectionStart.day;
            const startStr = TIMELINE[startIdx];

            // Ú†Ú© Ú©Ø±Ø¯Ù† ØªØ¯Ø§Ø®Ù„ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
            // (Ø¢ÛŒØ§ Ø¯Ø± Ø¨ÛŒÙ† Ø³Ù„ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ØŒ ØªØ³Ú©ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯ Ú©Ù‡ Ø±Ù†Ø¯Ø± Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŸ)
            // Ú†ÙˆÙ† Ù…Ø§ ÙÙ‚Ø· Ø±ÙˆÛŒ empty-cell Ù‡Ø§ Ø¯Ø±Ú¯ Ù…ÛŒÚ©Ù†ÛŒÙ…ØŒ Ø§Ø­ØªÙ…Ø§Ù„ ØªØ¯Ø§Ø®Ù„ Ú©Ù… Ø§Ø³Øª Ø§Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù†:
            // Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ø±ÙˆÛŒ ÛŒÚ© ØªØ³Ú© Ø±Ø¯ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¢Ù† ØªØ³Ú© selected-range Ù†Ù…ÛŒÚ¯ÛŒØ±Ø¯.
            // Ù¾Ø³ Ù…Ø§ ÙÙ‚Ø· ØªØ¹Ø¯Ø§Ø¯ selected-range Ù‡Ø§ Ø±Ø§ Ù…ÛŒØ´Ù…Ø§Ø±ÛŒÙ….
            const selectedCount = document.querySelectorAll('.selected-range').length;
            
            // Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù…ÙˆØ¯Ø§Ù„
            openTaskModal(null, { day, startStr, duration: selectedCount }); // duration ÙˆØ§Ù‚Ø¹ÛŒ
            
            clearSelection();
        }


        // --- Ù…Ù†Ø·Ù‚ Ú©Ù¾ÛŒ Ø±ÙˆØ² Ø¨Ù‡ Ø±ÙˆØ² ---
        function copyDay(sourceDayId) {
            const sourceDayLabel = DAYS.find(d => d.id === sourceDayId).label;
            const targetLabel = prompt(`Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÙˆØ² ${sourceDayLabel} Ø±Ø§ Ø¯Ø± Ú©Ø¯Ø§Ù… Ø±ÙˆØ² Ú©Ù¾ÛŒ Ú©Ù†Ù…ØŸ\n(Ù†Ø§Ù… Ø±ÙˆØ² Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯: Ø´Ù†Ø¨Ù‡ØŒ ÛŒÚ©Ø´Ù†Ø¨Ù‡ØŒ Ø¯ÙˆØ´Ù†Ø¨Ù‡...)`);
            
            if (!targetLabel) return;
            
            const targetDayObj = DAYS.find(d => d.label === targetLabel.trim());
            if (!targetDayObj) return alert("Ø±ÙˆØ² ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.");
            
            const targetDayId = targetDayObj.id;
            if (targetDayId === sourceDayId) return alert("Ù…Ø¨Ø¯Ø§ Ùˆ Ù…Ù‚ØµØ¯ ÛŒÚ©ÛŒ Ø§Ø³Øª.");

            if(!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡Ø§ÛŒ Ù‚Ø¨Ù„ÛŒ ${targetLabel} Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ùˆ Ø¨Ø§ ${sourceDayLabel} Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.`)) return;

            // 1. Ø­Ø°Ù ØªÙ…Ø§Ù… ØªØ³Ú© Ù‡Ø§ÛŒ Ø±ÙˆØ² Ù…Ù‚ØµØ¯
            appData.tasks = appData.tasks.filter(t => t.day !== targetDayId);

            // 2. Ú©Ù¾ÛŒ ØªØ³Ú© Ù‡Ø§ÛŒ Ù…Ø¨Ø¯Ø§
            const sourceTasks = appData.tasks.filter(t => t.day === sourceDayId);
            sourceTasks.forEach(t => {
                appData.tasks.push({
                    ...t,
                    id: Date.now() + Math.random(), // Ø¢ÛŒØ¯ÛŒ Ø¬Ø¯ÛŒØ¯
                    day: targetDayId
                });
            });

            saveData();
            renderTable();
        }

        // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ (CRUD) ---
        function openTaskModal(existingTask, newSelection = null) {
            const modal = document.getElementById('taskModal');
            const btnDelete = document.getElementById('btnDelete');
            
            if (existingTask) {
                document.getElementById('taskId').value = existingTask.id;
                document.getElementById('taskDay').value = existingTask.day;
                document.getElementById('taskStartStr').value = existingTask.startStr;
                document.getElementById('inpName').value = existingTask.name;
                document.getElementById('inpDuration').value = existingTask.duration;
                document.getElementById('inpColor').value = existingTask.color;
                
                document.getElementById('timeDisplay').innerText = 
                    `${getDayLabel(existingTask.day)} | Ø´Ø±ÙˆØ¹: ${existingTask.startStr}`;
                
                btnDelete.style.display = 'block';
            } else if (newSelection) {
                document.getElementById('taskId').value = '';
                document.getElementById('taskDay').value = newSelection.day;
                document.getElementById('taskStartStr').value = newSelection.startStr;
                document.getElementById('inpName').value = '';
                document.getElementById('inpDuration').value = newSelection.duration;
                document.getElementById('inpColor').value = '#3b82f6';
                
                document.getElementById('timeDisplay').innerText = 
                    `${getDayLabel(newSelection.day)} | Ø´Ø±ÙˆØ¹: ${newSelection.startStr}`;
                
                btnDelete.style.display = 'none';
            }

            document.getElementById('taskModal').style.display = 'flex';
            document.getElementById('inpName').focus();
        }

        function saveTask() {
            const id = document.getElementById('taskId').value;
            const day = document.getElementById('taskDay').value;
            const startStr = document.getElementById('taskStartStr').value;
            const name = document.getElementById('inpName').value;
            const duration = parseInt(document.getElementById('inpDuration').value);
            const color = document.getElementById('inpColor').value;

            if (!name) return alert("Ù†Ø§Ù… ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª");

            // Ø¨Ø±Ø±Ø³ÛŒ ØªØ¯Ø§Ø®Ù„
            const startIdx = TIMELINE.indexOf(startStr);
            const endIdx = startIdx + duration;
            
            if (endIdx > TIMELINE.length) return alert("Ø²Ù…Ø§Ù† Ø§Ø² Ù¾Ø§ÛŒØ§Ù† Ø±ÙˆØ² Ø¨ÛŒØ±ÙˆÙ† Ù…ÛŒâ€ŒØ²Ù†Ø¯");

            const conflict = appData.tasks.some(t => {
                if (t.id == id || t.day !== day) return false;
                const tS = TIMELINE.indexOf(t.startStr);
                const tE = tS + t.duration;
                return (startIdx < tE && endIdx > tS);
            });

            if (conflict) return alert("ØªØ¯Ø§Ø®Ù„ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±!");

            if (id) {
                const idx = appData.tasks.findIndex(t => t.id == id);
                if (idx !== -1) appData.tasks[idx] = { ...appData.tasks[idx], name, duration, color };
            } else {
                appData.tasks.push({ id: Date.now(), day, startStr, duration, name, color });
            }

            saveData();
            renderTable();
            closeModal('taskModal');
        }

        function deleteTask() {
            const id = document.getElementById('taskId').value;
            if(confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
                appData.tasks = appData.tasks.filter(t => t.id != id);
                saveData();
                renderTable();
                closeModal('taskModal');
            }
        }

        // --- ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ùˆ Ù‡Ø¯Ø± ---
        function openNotepad() {
            document.getElementById('noteModal').style.display = 'flex';
        }
        function saveNoteAndClose() {
            appData.notes = document.getElementById('notepadArea').value;
            saveData();
            closeModal('noteModal');
        }
        function updatePrintHeader(val) {
            appData.printHeader = val;
            document.getElementById('print-header-display').innerText = val;
            saveData();
        }

        // --- Ø¹Ù…ÙˆÙ…ÛŒ ---
        function saveData() {
            localStorage.setItem('ultraPlannerV1', JSON.stringify(appData));
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function setColor(c) { document.getElementById('inpColor').value = c; }
        
        function getDayLabel(id) { return DAYS.find(d => d.id === id).label; }

        function clearAll() {
            if(confirm("Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
                appData = { tasks: [], notes: "", printHeader: "" };
                saveData();
                location.reload();
            }
        }

        function exportData() {
            const blob = new Blob([JSON.stringify(appData)], {type: "application/json"});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = "planner_backup.json";
            a.click();
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const d = JSON.parse(e.target.result);
                    if (d.tasks || Array.isArray(d)) {
                         // Ù‡Ù†Ø¯Ù„ Ú©Ø±Ø¯Ù† ÙˆØ±Ú˜Ù† Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
                         if(Array.isArray(d)) appData.tasks = d;
                         else appData = d;
                         
                         saveData();
                         location.reload();
                    }
                } catch(er){ alert("ÙØ§ÛŒÙ„ Ø®Ø±Ø§Ø¨ Ø§Ø³Øª"); }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
