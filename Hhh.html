<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ù…Ø¯Ø±Ù†</title>
    <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #4f46e5;       /* Ø±Ù†Ú¯ Ø§ØµÙ„ÛŒ Ù…Ø¯Ø±Ù† */
            --primary-light: #818cf8;
            --primary-dark: #3730a3;
            --secondary: #10b981;     /* Ø±Ù†Ú¯ Ù…ÙˆÙÙ‚ÛŒØª */
            --accent: #f59e0b;        /* Ø±Ù†Ú¯ ØªØ§Ú©ÛŒØ¯ */
            --danger: #ef4444;        /* Ø±Ù†Ú¯ Ø®Ø·Ø± */
            --dark: #0f172a;
            --gray: #64748b;
            --bg-body: #f1f5f9;
            --bg-surface: #ffffff;
            --border-radius: 16px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            --font-family: 'Vazirmatn', system-ui, sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-body);
            margin: 0;
            padding: 20px;
            color: var(--dark);
            font-size: 14px;
            padding-bottom: 100px;
        }

        /* --- UI Components --- */
        
        /* Loading */
        #loadingBar {
            position: fixed; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
            background-size: 200% 100%; z-index: 99999; display: none;
            animation: loadingAnim 1.5s infinite linear;
        }
        @keyframes loadingAnim { 0% {background-position: 100% 0;} 100% {background-position: -100% 0;} }

        #processingMsg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 99998;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top-color: var(--primary);
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to {transform: rotate(360deg);} }

        /* --- Header & Toolbar --- */
        .app-header {
            background: var(--bg-surface);
            border-radius: var(--border-radius);
            padding: 24px;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }

        .header-top {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;
        }

        .brand-section {
            display: flex; align-items: center; gap: 12px;
        }
        .brand-icon {
            width: 48px; height: 48px; background: var(--primary); color: white;
            border-radius: 12px; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .brand-text h1 { margin: 0; font-size: 22px; font-weight: 900; color: var(--dark); letter-spacing: -0.5px; }
        .brand-text p { margin: 2px 0 0 0; font-size: 12px; color: var(--gray); }

        .user-inputs {
            display: flex; gap: 10px; flex: 1; justify-content: flex-end; max-width: 600px; flex-wrap: wrap;
        }
        .input-modern {
            padding: 12px 16px; border: 2px solid #f1f5f9; border-radius: 12px;
            font-family: inherit; background: #f8fafc; transition: 0.3s; flex: 1; min-width: 200px; font-weight: 500;
        }
        .input-modern:focus { background: #fff; border-color: var(--primary); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1); }

        .toolbar-actions {
            display: flex; flex-wrap: wrap; gap: 12px; align-items: center; border-top: 1px solid #f1f5f9; padding-top: 20px;
        }
        
        /* Action Groups */
        .action-group {
            display: flex; gap: 8px; align-items: center; background: #f8fafc; padding: 6px; border-radius: 14px; border: 1px solid #e2e8f0;
        }
        .action-divider { width: 1px; height: 30px; background: #e2e8f0; margin: 0 10px; }

        /* Buttons */
        .btn {
            padding: 10px 16px; border: none; border-radius: 10px; cursor: pointer;
            font-family: inherit; font-weight: 700; font-size: 13px; color: white;
            display: flex; align-items: center; gap: 8px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.05); }
        .btn:active { transform: translateY(0); }
        .btn svg { width: 18px; height: 18px; stroke-width: 2.2px; }

        .btn-primary { background: linear-gradient(135deg, #4f46e5, #4338ca); box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2); }
        .btn-success { background: linear-gradient(135deg, #10b981, #059669); box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2); }
        .btn-danger { background: linear-gradient(135deg, #ef4444, #dc2626); box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .btn-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-dark { background: linear-gradient(135deg, #334155, #1e293b); }
        .btn-ghost { background: transparent; color: var(--gray); border: 1px solid transparent; }
        .btn-ghost:hover { background: #e2e8f0; color: var(--dark); box-shadow: none; transform: none; }
        
        .btn-toggle {
            background: #e2e8f0; color: var(--gray); border: 1px solid #cbd5e1;
        }
        .btn-toggle.active {
            background: var(--primary); color: white; border-color: transparent;
        }

        /* --- Planner Table --- */
        .planner-container {
            background: var(--bg-surface); border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg); overflow: hidden; border: 1px solid #e2e8f0;
            position: relative; min-height: 600px;
        }
        .table-scroll { overflow: auto; max-height: 75vh; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; min-width: 1000px; table-layout: fixed; }
        
        thead th {
            background: #1e293b; color: white; padding: 15px; position: sticky; top: 0; z-index: 20;
            font-size: 14px; text-align: center; border-bottom: 4px solid var(--primary);
        }
        /* Corner Cell */
        thead th:first-child { 
            width: 90px; z-index: 30; left: 0; background: #0f172a; 
            border-left: 1px solid #334155;
        }

        /* Copy Button in Header */
        .day-header-content { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .copy-day-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            border-radius: 6px; padding: 2px 8px; font-size: 11px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 4px; color: #cbd5e1;
        }
        .copy-day-btn:hover { background: var(--secondary); color: white; border-color: transparent; }

        /* Time Column */
        tbody td:first-child {
            background: #f8fafc; color: var(--gray); font-weight: 700; font-size: 12px;
            position: sticky; right: 0; z-index: 10; border-left: 2px solid #e2e8f0;
            text-align: center; padding: 5px; width: 90px;
        }

        tbody td {
            border-bottom: 1px solid #f1f5f9; border-left: 1px solid #f1f5f9;
            height: 45px; padding: 0; vertical-align: top; position: relative;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover td { background-color: #f8fafc; }

        /* Task Cell Styling */
        .task-block {
            position: absolute; top: 1px; left: 1px; right: 1px; bottom: 1px;
            border-radius: 8px; padding: 6px 8px;
            color: white; font-size: 12px; cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; justify-content: center;
            transition: transform 0.1s, box-shadow 0.2s;
            overflow: hidden; z-index: 5;
        }
        .task-block:hover { transform: scale(1.02); box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 10; }
        
        .task-time { font-size: 10px; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 4px; display: inline-block; margin-bottom: 2px; width: fit-content; }
        .task-name { font-weight: 700; line-height: 1.3; font-size: 13px; white-space: normal; }

        /* Empty Cell Interaction */
        .empty-slot { width: 100%; height: 100%; cursor: cell; transition: 0.1s; }
        body.selection-mode .empty-slot:hover { background-color: #e0e7ff; }
        .selected-highlight { background-color: #c7d2fe !important; }

        /* --- Modals --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.6); z-index: 1000; backdrop-filter: blur(4px);
            justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.show { opacity: 1; }
        
        .modal-box {
            background: white; width: 90%; max-width: 480px; border-radius: 20px;
            padding: 24px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            transform: translateY(20px); transition: transform 0.3s; display: flex; flex-direction: column; gap: 16px;
            max-height: 85vh; overflow-y: auto;
        }
        .modal-overlay.show .modal-box { transform: translateY(0); }

        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        .modal-title { font-size: 18px; font-weight: 800; color: var(--dark); display: flex; align-items: center; gap: 8px; }
        .modal-close { background: none; border: none; font-size: 24px; color: var(--gray); cursor: pointer; padding: 0; line-height: 1; }
        
        /* Template Grid */
        .template-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .template-card {
            background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 15px;
            cursor: pointer; transition: 0.2s; text-align: center;
        }
        .template-card:hover { border-color: var(--primary); background: #eef2ff; }
        .template-icon { font-size: 24px; margin-bottom: 8px; display: block; }
        .template-name { font-weight: 700; color: var(--dark); display: block; }
        .template-desc { font-size: 11px; color: var(--gray); margin-top: 4px; display: block; }

        /* Form Elements */
        .form-label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px; color: var(--dark); }
        .color-picker-grid { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px; }
        .color-circle { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .color-circle:hover { transform: scale(1.1); }
        .color-circle.active { border-color: var(--dark); transform: scale(1.1); box-shadow: 0 0 0 2px white inset; }

        /* --- EXPORT & PRINT STYLES (HIDDEN FROM UI) --- */
        
        /* Image Export Container (Off-screen) */
        #image-export-area {
            position: absolute; top: 0; left: -9999px; width: 1600px; /* Fixed Width for Quality */
            background: white; padding: 40px; border-radius: 0;
            font-family: 'Vazirmatn', sans-serif;
            direction: rtl; display: none;
        }
        .export-header { text-align: center; margin-bottom: 30px; border-bottom: 3px solid var(--primary); padding-bottom: 20px; }
        .export-title { font-size: 36px; font-weight: 900; color: var(--primary-dark); margin: 0; }
        .export-meta { display: flex; justify-content: space-between; margin-top: 10px; font-size: 18px; color: var(--gray); font-weight: 600; }
        
        .export-table { width: 100%; border-collapse: collapse; border: 2px solid #0f172a; table-layout: fixed; }
        .export-table th { background: #1e293b; color: white; padding: 12px; font-size: 16px; border: 1px solid #0f172a; }
        .export-table td { border: 1px solid #cbd5e1; height: 35px; padding: 0; vertical-align: top; background: white; }
        .export-table td:first-child { background: #f1f5f9; color: #0f172a; font-weight: bold; text-align: center; width: 100px; vertical-align: middle; border-left: 2px solid #0f172a; }
        
        .export-task {
            margin: 2px; padding: 4px; border-radius: 4px; color: white; text-align: center;
            box-shadow: none; font-size: 14px; display: flex; flex-direction: column; justify-content: center; height: calc(100% - 4px);
        }
        .export-task-time { font-size: 12px; background: rgba(0,0,0,0.2); border-radius: 3px; display: inline-block; margin: 0 auto 2px auto; padding: 1px 5px; }
        
        .export-footer { margin-top: 30px; display: flex; gap: 20px; }
        .export-box { flex: 1; border: 2px dashed #cbd5e1; border-radius: 12px; padding: 15px; background: #f8fafc; }
        .export-box h4 { margin: 0 0 10px 0; color: var(--dark); font-size: 18px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }

        /* --- PRINT MEDIA (PDF - LIST VIEW) --- */
        @media print {
            @page { size: A4 portrait; margin: 10mm; }
            body { background: white; padding: 0; margin: 0; color: black; }
            
            /* Hide UI Elements */
            .app-header, .toolbar-actions, .planner-container, #loadingBar, #processingMsg, .modal-overlay { display: none !important; }
            
            /* Show Simple Print View */
            #print-simple-view { display: block !important; font-family: 'Vazirmatn', sans-serif; }
            
            .print-header-simple { text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; }
            .print-header-simple h1 { font-size: 24px; margin: 0; }
            .print-header-simple p { font-size: 14px; margin: 5px 0 0 0; color: #444; }
            
            .day-block-print { margin-bottom: 15px; page-break-inside: avoid; border: 1px solid #ccc; border-radius: 8px; overflow: hidden; }
            .day-title-print { background: #eee; padding: 8px 12px; font-weight: bold; font-size: 16px; border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; }
            .task-list-print { list-style: none; padding: 0; margin: 0; }
            .task-item-print { display: flex; padding: 8px 12px; border-bottom: 1px dotted #ddd; align-items: baseline; }
            .task-item-print:last-child { border-bottom: none; }
            .time-print { font-weight: bold; width: 110px; flex-shrink: 0; font-size: 13px; font-family: monospace; }
            .name-print { font-size: 14px; flex-grow: 1; }
            
            .print-extras { margin-top: 30px; border-top: 2px solid black; padding-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        }

        #print-simple-view { display: none; } /* Hidden normally */
    </style>
</head>
<body>

<div id="loadingBar"></div>
<div id="processingMsg">
    <div class="spinner"></div>
    <h3 style="margin:0;">Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...</h3>
    <p id="procTxt" style="color:#64748b; margin-top:10px;">Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´</p>
</div>

<!-- Header & Toolbar -->
<header class="app-header">
    <div class="header-top">
        <div class="brand-section">
            <div class="brand-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
            </div>
            <div class="brand-text">
                <h1>Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ² Ù‡ÙØªÚ¯ÛŒ PRO</h1>
                <p>Ù…Ø¯ÛŒØ±ÛŒØª Ø²Ù…Ø§Ù† Ù‡ÙˆØ´Ù…Ù†Ø¯ Ùˆ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</p>
            </div>
        </div>
        <div class="user-inputs">
            <input type="text" id="headerTitleInput" class="input-modern" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ (Ù…Ø«Ù„Ø§Ù‹: Ø¨Ø±Ù†Ø§Ù…Ù‡ Ú©Ù†Ú©ÙˆØ±)" oninput="updateHeader(this.value)">
            <input type="text" id="userNameInput" class="input-modern" placeholder="Ù†Ø§Ù… ØµØ§Ø­Ø¨ Ø§Ø«Ø±" oninput="updateUserName(this.value)">
        </div>
    </div>

    <div class="toolbar-actions">
        <!-- Tools -->
        <div class="action-group">
            <button class="btn btn-purple" onclick="openModal('templatesModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡
            </button>
            <button class="btn btn-warning" onclick="openModal('extrasModal'); renderExtras();">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
                Ø§Ù„Ø²Ø§Ù…Ø§Øª / Ú†Ú©â€ŒÙ„ÛŒØ³Øª
            </button>
            <button class="btn btn-dark" onclick="openModal('noteModal')">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                ÛŒØ§Ø¯Ø¯Ø§Ø´Øª
            </button>
        </div>

        <div class="action-divider"></div>

        <!-- Mode -->
        <div class="action-group">
            <button class="btn btn-toggle" id="selectModeBtn" onclick="toggleSelectMode()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                <span id="modeText">Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„</span>
            </button>
        </div>

        <div style="flex:1"></div>

        <!-- Output Actions -->
        <div class="action-group">
            <button class="btn btn-primary" onclick="downloadAsImage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± (PNG)
            </button>
            <button class="btn btn-dark" onclick="printApp()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Ú†Ø§Ù¾ (PDF Ø³Ø§Ø¯Ù‡)
            </button>
            <button class="btn btn-success" onclick="exportData()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Ø°Ø®ÛŒØ±Ù‡ ÙØ§ÛŒÙ„
            </button>
             <button class="btn btn-ghost" onclick="document.getElementById('fileInput').click()" title="Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ ÙØ§ÛŒÙ„">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
            </button>
            <input type="file" id="fileInput" hidden onchange="importData(this)">
            <button class="btn btn-danger" onclick="clearAll()" title="Ø­Ø°Ù Ú©Ù„">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
        </div>
    </div>
</header>

<!-- Main Table Wrapper -->
<div class="planner-container">
    <div class="table-scroll" id="mainTableScroll">
        <table id="plannerTable">
            <thead>
                <tr id="tableHeader">
                    <th>Ø²Ù…Ø§Ù†</th>
                    <!-- Days will be injected here -->
                </tr>
            </thead>
            <tbody id="plannerBody">
                <!-- Rows will be injected here -->
            </tbody>
        </table>
    </div>
</div>

<!-- ================= MODALS ================= -->

<!-- Templates Modal (New Feature) -->
<div class="modal-overlay" id="templatesModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline></svg>
                Ø§Ù†ØªØ®Ø§Ø¨ Ù‚Ø§Ù„Ø¨ Ø¢Ù…Ø§Ø¯Ù‡
            </div>
            <button class="modal-close" onclick="closeModal('templatesModal')">&times;</button>
        </div>
        <p style="color:var(--gray); margin-top:0;">ÛŒÚ©ÛŒ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø²ÛŒØ± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯. ØªÙˆØ¬Ù‡ Ú©Ù†ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.</p>
        <div class="template-grid">
            <div class="template-card" onclick="applyTemplate('student')">
                <span class="template-icon">ğŸ“</span>
                <span class="template-name">Ø¯Ø§Ù†Ø´â€ŒØ¢Ù…ÙˆØ² / Ø¯Ø§Ù†Ø´Ø¬Ùˆ</span>
                <span class="template-desc">ØªØ¹Ø§Ø¯Ù„ Ø¯Ø±Ø³ Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª</span>
            </div>
            <div class="template-card" onclick="applyTemplate('employee')">
                <span class="template-icon">ğŸ’¼</span>
                <span class="template-name">Ú©Ø§Ø±Ù…Ù†Ø¯ / Ø´Ø§ØºÙ„</span>
                <span class="template-desc">Ø³Ø§Ø¹Ø§Øª Ø§Ø¯Ø§Ø±ÛŒ Ù…Ù†Ø¸Ù…</span>
            </div>
            <div class="template-card" onclick="applyTemplate('healthy')">
                <span class="template-icon">ğŸ§˜â€â™‚ï¸</span>
                <span class="template-name">Ø²Ù†Ø¯Ú¯ÛŒ Ø³Ø§Ù„Ù…</span>
                <span class="template-desc">ÙˆØ±Ø²Ø´ØŒ Ø®ÙˆØ§Ø¨ Ùˆ ØªØºØ°ÛŒÙ‡</span>
            </div>
            <div class="template-card" onclick="applyTemplate('konkur')">
                <span class="template-icon">ğŸ“š</span>
                <span class="template-name">ÙˆÛŒÚ˜Ù‡ Ú©Ù†Ú©ÙˆØ±ÛŒ</span>
                <span class="template-desc">Ù…Ø·Ø§Ù„Ø¹Ù‡ ÙØ´Ø±Ø¯Ù‡ Ø¨Ø§ Ù…Ø±ÙˆØ±</span>
            </div>
        </div>
    </div>
</div>

<!-- Task Modal -->
<div class="modal-overlay" id="taskModal">
    <div class="modal-box">
        <div class="modal-header">
            <div class="modal-title">Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„ÛŒØª</div>
            <button class="modal-close" onclick="closeModal('taskModal')">&times;</button>
        </div>
        <input type="hidden" id="taskId"><input type="hidden" id="taskDay">
        
        <div><label class="form-label">Ø¹Ù†ÙˆØ§Ù† ÙØ¹Ø§Ù„ÛŒØª</label><input type="text" id="inpName" class="input-modern" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ù…Ø·Ø§Ù„Ø¹Ù‡ Ø±ÛŒØ§Ø¶ÛŒ" autofocus></div>
        
        <div style="display:flex; gap:10px;">
            <div style="flex:1"><label class="form-label">Ø´Ø±ÙˆØ¹</label><select id="inpStart" class="input-modern" onchange="updateEndOptions()"></select></div>
            <div style="flex:1"><label class="form-label">Ù…Ø¯Øª / Ù¾Ø§ÛŒØ§Ù†</label><select id="inpEnd" class="input-modern"></select></div>
        </div>

        <div>
            <label class="form-label">Ø±Ù†Ú¯ Ø¨Ø±Ú†Ø³Ø¨</label>
            <div class="color-picker-grid" id="colorPalette"></div>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px; padding-top:15px; border-top:1px solid #f1f5f9;">
            <button class="btn btn-danger" id="btnDeleteTask" onclick="deleteTask()" style="display:none">Ø­Ø°Ù</button>
            <div style="flex:1"></div>
            <button class="btn btn-primary" onclick="saveTask()">Ø«Ø¨Øª ÙØ¹Ø§Ù„ÛŒØª</button>
        </div>
    </div>
</div>

<!-- Extras Modal -->
<div class="modal-overlay" id="extrasModal">
    <div class="modal-box">
        <div class="modal-header"><div class="modal-title">Ø§Ù„Ø²Ø§Ù…Ø§Øª Ùˆ Ú†Ú©â€ŒÙ„ÛŒØ³Øª</div><button class="modal-close" onclick="closeModal('extrasModal')">&times;</button></div>
        
        <div style="display:flex; background:#f1f5f9; padding:4px; border-radius:10px; margin-bottom:15px;">
            <button class="btn btn-ghost" id="tabReqBtn" style="flex:1; justify-content:center;" onclick="switchTab('req')">ğŸ”¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…</button>
            <button class="btn btn-ghost" id="tabChkBtn" style="flex:1; justify-content:center;" onclick="switchTab('chk')">â–«ï¸ Ú†Ú©â€ŒÙ„ÛŒØ³Øª</button>
        </div>

        <div id="tab-req">
            <div style="display:flex; gap:8px;"><input type="text" id="reqInput" class="input-modern" placeholder="Ù†Ú©ØªÙ‡ Ø¬Ø¯ÛŒØ¯..."><button class="btn btn-success" onclick="addItem('req')">+</button></div>
            <ul id="reqListUi" style="list-style:none; padding:0; margin-top:10px; max-height:200px; overflow-y:auto;"></ul>
        </div>
        <div id="tab-chk" style="display:none">
            <div style="display:flex; gap:8px;"><input type="text" id="chkInput" class="input-modern" placeholder="Ù…ÙˆØ±Ø¯ Ø¬Ø¯ÛŒØ¯..."><button class="btn btn-success" onclick="addItem('chk')">+</button></div>
            <ul id="chkListUi" style="list-style:none; padding:0; margin-top:10px; max-height:200px; overflow-y:auto;"></ul>
        </div>
    </div>
</div>

<!-- Note Modal -->
<div class="modal-overlay" id="noteModal">
    <div class="modal-box">
        <div class="modal-header"><div class="modal-title">ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒ</div><button class="modal-close" onclick="closeModal('noteModal')">&times;</button></div>
        <textarea id="noteText" class="input-modern" rows="8" placeholder="Ù‡Ø± Ú†ÛŒØ²ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
        <div style="display:flex; justify-content:flex-end; margin-top:10px;"><button class="btn btn-success" onclick="saveNote()">Ø°Ø®ÛŒØ±Ù‡</button></div>
    </div>
</div>

<!-- Copy Modal -->
<div class="modal-overlay" id="copyModal">
    <div class="modal-box">
        <div class="modal-header"><div class="modal-title">Ú©Ù¾ÛŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ <span id="copySourceLabel" style="color:var(--primary); margin-right:5px;"></span></div><button class="modal-close" onclick="closeModal('copyModal')">&times;</button></div>
        <p style="font-size:13px; color:var(--gray);">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§ÛŒÙ† Ø±ÙˆØ² Ø±Ø§ Ø¨Ù‡ Ú©Ø¯Ø§Ù… Ø±ÙˆØ²Ù‡Ø§ Ú©Ù¾ÛŒ Ú©Ù†Ù…ØŸ</p>
        <div id="copyTargetList" style="display:flex; flex-direction:column; gap:8px;"></div>
        <button class="btn btn-primary" style="margin-top:15px; justify-content:center;" onclick="executeCopy()">Ø§Ù†Ø¬Ø§Ù… Ú©Ù¾ÛŒ</button>
    </div>
</div>

<!-- ================= OFF-SCREEN RENDER AREAS ================= -->

<!-- 1. Image Export Container (Fixed Size & Layout for html2canvas) -->
<div id="image-export-area">
    <div class="export-header">
        <h1 class="export-title" id="expTitle">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</h1>
        <div class="export-meta">
            <span id="expUser"></span>
            <span id="expDate"></span>
        </div>
    </div>
    
    <div style="display:flex; gap:20px; margin-bottom:20px;">
        <div class="export-box" id="expReqBox" style="display:none"><h4>Ù†Ú©Ø§Øª Ùˆ Ø§Ù„Ø²Ø§Ù…Ø§Øª</h4><ul id="expReqList" style="padding-right:20px;"></ul></div>
        <div class="export-box" id="expChkBox" style="display:none"><h4>Ú†Ú©â€ŒÙ„ÛŒØ³Øª</h4><ul id="expChkList" style="padding-right:20px;"></ul></div>
    </div>

    <table class="export-table">
        <thead id="expThead"></thead>
        <tbody id="expTbody"></tbody>
    </table>

    <div class="export-footer" id="expFooter" style="display:none">
        <div class="export-box" style="width:100%">
            <h4>ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§:</h4>
            <div id="expNoteText" style="white-space: pre-wrap; line-height:1.6;"></div>
        </div>
    </div>
</div>

<!-- 2. Print Simple View (Visible only in Print Mode) -->
<div id="print-simple-view">
    <div class="print-header-simple">
        <h1 id="printSimpleTitle">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ</h1>
        <p>Ú©Ø§Ø±Ø¨Ø±: <span id="printSimpleUser"></span> | ØªØ§Ø±ÛŒØ® Ú†Ø§Ù¾: <span id="printSimpleDate"></span></p>
    </div>
    
    <div id="printSimpleListContainer"></div>
    
    <div class="print-extras">
        <div>
            <h3>Ù†Ú©Ø§Øª:</h3>
            <ul id="printSimpleReqs"></ul>
        </div>
        <div>
            <h3>Ú†Ú©â€ŒÙ„ÛŒØ³Øª:</h3>
            <ul id="printSimpleChks"></ul>
        </div>
    </div>
    <div style="margin-top:20px; border-top:1px solid #ddd; padding-top:10px;">
        <strong>ÛŒØ§Ø¯Ø¯Ø§Ø´Øª:</strong> <span id="printSimpleNote"></span>
    </div>
</div>


<!-- ================= LOGIC ================= -->
<script>
    // --- CONSTANTS ---
    const DAYS = [
        {id:'sat', l:'Ø´Ù†Ø¨Ù‡'}, {id:'sun', l:'ÛŒÚ©Ø´Ù†Ø¨Ù‡'}, {id:'mon', l:'Ø¯ÙˆØ´Ù†Ø¨Ù‡'},
        {id:'tue', l:'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡'}, {id:'wed', l:'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡'}, {id:'thu', l:'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡'}, {id:'fri', l:'Ø¬Ù…Ø¹Ù‡'}
    ];
    const TIMELINE = [];
    for(let h=6; h<24; h++) { // Start from 6 AM for better view
        TIMELINE.push(`${String(h).padStart(2,'0')}:00`);
        TIMELINE.push(`${String(h).padStart(2,'0')}:30`);
    }
    TIMELINE.push("24:00"); // End

    const COLORS = [
        '#4f46e5', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#64748b'
    ];

    const TEMPLATES = {
        student: [
            {day:'sat', s:'07:00', d:2, n:'Ø¨ÛŒØ¯Ø§Ø± Ø´Ø¯Ù† Ùˆ ØµØ¨Ø­Ø§Ù†Ù‡', c:'#10b981'},
            {day:'sat', s:'08:00', d:6, n:'Ù…Ø¯Ø±Ø³Ù‡ / Ú©Ù„Ø§Ø³', c:'#4f46e5'},
            {day:'sat', s:'11:00', d:1, n:'Ø²Ù†Ú¯ ØªÙØ±ÛŒØ­', c:'#f59e0b'},
            {day:'sat', s:'14:00', d:2, n:'Ù†Ø§Ù‡Ø§Ø± Ùˆ Ø§Ø³ØªØ±Ø§Ø­Øª', c:'#ef4444'},
            {day:'sat', s:'16:00', d:3, n:'Ø§Ù†Ø¬Ø§Ù… ØªÚ©Ø§Ù„ÛŒÙ', c:'#8b5cf6'},
            {day:'sat', s:'19:00', d:2, n:'Ø²Ù…Ø§Ù† Ø¢Ø²Ø§Ø¯ / Ø´Ø§Ù…', c:'#06b6d4'},
            {day:'sat', s:'22:00', d:1, n:'Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ±Ø¯Ø§', c:'#64748b'},
            {day:'sat', s:'23:00', d:2, n:'Ø®ÙˆØ§Ø¨', c:'#0f172a'}
        ],
        employee: [
            {day:'sat', s:'06:30', d:2, n:'Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ùˆ ØµØ¨Ø­Ø§Ù†Ù‡', c:'#f59e0b'},
            {day:'sat', s:'08:00', d:16, n:'Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ', c:'#4f46e5'}, // 8 hours (16 * 30min)
            {day:'sat', s:'16:00', d:2, n:'Ù…Ø³ÛŒØ± Ø¨Ø±Ú¯Ø´Øª', c:'#64748b'},
            {day:'sat', s:'17:00', d:2, n:'Ø§Ø³ØªØ±Ø§Ø­Øª Ùˆ Ú†Ø§ÛŒ', c:'#10b981'},
            {day:'sat', s:'19:00', d:2, n:'ÙˆÙ‚Øª Ø¨Ø§ Ø®Ø§Ù†ÙˆØ§Ø¯Ù‡', c:'#ec4899'},
            {day:'sat', s:'23:00', d:2, n:'Ø®ÙˆØ§Ø¨', c:'#0f172a'}
        ],
        healthy: [
            {day:'sat', s:'06:00', d:2, n:'ÛŒÙˆÚ¯Ø§ / ÙˆØ±Ø²Ø´ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒ', c:'#10b981'},
            {day:'sat', s:'07:00', d:2, n:'ØµØ¨Ø­Ø§Ù†Ù‡ Ø³Ø§Ù„Ù…', c:'#f59e0b'},
            {day:'sat', s:'13:00', d:2, n:'Ù†Ø§Ù‡Ø§Ø± Ø±Ú˜ÛŒÙ…ÛŒ', c:'#ef4444'},
            {day:'sat', s:'17:00', d:2, n:'Ø¨Ø§Ø´Ú¯Ø§Ù‡ / Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ±ÙˆÛŒ', c:'#4f46e5'},
            {day:'sat', s:'21:00', d:1, n:'Ù…Ø·Ø§Ù„Ø¹Ù‡', c:'#8b5cf6'},
            {day:'sat', s:'22:30', d:3, n:'Ø®ÙˆØ§Ø¨ Ú©Ø§ÙÛŒ', c:'#0f172a'}
        ],
        konkur: [
            {day:'sat', s:'06:00', d:3, n:'Ø¨ÛŒØ¯Ø§Ø± Ø¨Ø§Ø´ Ùˆ ØµØ¨Ø­Ø§Ù†Ù‡', c:'#f59e0b'},
            {day:'sat', s:'07:30', d:3, n:'Ø¨Ù„Ø§Ú© Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Û± (Ø§Ø®ØªØµØ§ØµÛŒ)', c:'#4f46e5'},
            {day:'sat', s:'09:00', d:1, n:'Ø§Ø³ØªØ±Ø§Ø­Øª', c:'#10b981'},
            {day:'sat', s:'09:30', d:3, n:'Ø¨Ù„Ø§Ú© Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Û²', c:'#4f46e5'},
            {day:'sat', s:'11:00', d:1, n:'Ø§Ø³ØªØ±Ø§Ø­Øª', c:'#10b981'},
            {day:'sat', s:'11:30', d:3, n:'Ø¨Ù„Ø§Ú© Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Û³', c:'#4f46e5'},
            {day:'sat', s:'13:00', d:3, n:'Ù†Ø§Ù‡Ø§Ø± Ùˆ Ù†Ù…Ø§Ø²', c:'#ef4444'},
            {day:'sat', s:'15:00', d:3, n:'Ø¨Ù„Ø§Ú© Ù…Ø·Ø§Ù„Ø¹Ø§ØªÛŒ Û´', c:'#8b5cf6'},
            {day:'sat', s:'17:00', d:3, n:'ØªØ³Øª Ø²Ù†ÛŒ Ø³Ø±Ø¹ØªÛŒ', c:'#ec4899'},
            {day:'sat', s:'23:00', d:2, n:'Ø®ÙˆØ§Ø¨', c:'#0f172a'}
        ]
    };

    // --- STATE ---
    let appData = {
        tasks: [], header: "", userName: "", note: "",
        reqs: [], chks: []
    };
    let isSelect=false, isDrag=false, selStart=null, selCurr=null, currentEditingTask = null, pendingCopySource = null;

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('proPlannerData');
        if(saved) {
            try { appData = JSON.parse(saved); } catch(e){ console.error(e); }
        }

        updateHeader(appData.header || "");
        document.getElementById('userNameInput').value = appData.userName || "";
        document.getElementById('noteText').value = appData.note || "";

        // Fill Time Selects
        const sSel = document.getElementById('inpStart');
        TIMELINE.slice(0,-1).forEach(t => sSel.add(new Option(t, t)));

        // Fill Color Palette
        const pal = document.getElementById('colorPalette');
        COLORS.forEach(c => {
            const d = document.createElement('div');
            d.className='color-circle'; d.style.background=c;
            d.onclick=()=>{
                document.querySelectorAll('.color-circle').forEach(x=>x.classList.remove('active'));
                d.classList.add('active');
            };
            pal.appendChild(d);
        });

        renderHeader();
        renderTable();
        setupEvents();
    }

    // --- RENDERERS ---
    function renderHeader() {
        const r = document.getElementById('tableHeader');
        while(r.children.length > 1) r.removeChild(r.lastChild);
        DAYS.forEach(d => {
            const th = document.createElement('th');
            th.innerHTML = `
                <div class="day-header-content">
                    <span>${d.l}</span>
                    <button class="copy-day-btn" onclick="openCopyModal('${d.id}')">
                        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        Ú©Ù¾ÛŒ
                    </button>
                </div>`;
            r.appendChild(th);
        });
    }

    function renderTable() {
        const b = document.getElementById('plannerBody'); b.innerHTML='';
        const occupancy = {}; 
        DAYS.forEach(d => occupancy[d.id] = new Array(TIMELINE.length).fill(false));

        for(let idx=0; idx < TIMELINE.length - 1; idx++) {
            const time = TIMELINE[idx];
            const tr = document.createElement('tr');
            
            // Time Column
            const tdTime = document.createElement('td');
            tdTime.innerText = time;
            tr.appendChild(tdTime);

            DAYS.forEach(day => {
                if(occupancy[day.id][idx]) return; // Slot already taken

                const task = appData.tasks.find(t => t.day === day.id && t.startStr === time);

                if(task) {
                    const td = document.createElement('td');
                    td.rowSpan = task.duration;
                    
                    // Inner Block
                    const block = document.createElement('div');
                    block.className = 'task-block';
                    block.style.backgroundColor = task.color;
                    
                    // Calculate End Time
                    const endIdx = idx + task.duration;
                    const endTime = TIMELINE[endIdx] || "End";
                    
                    block.innerHTML = `
                        <span class="task-time">${time} - ${endTime}</span>
                        <span class="task-name">${task.name}</span>
                    `;
                    block.onclick = (e) => { e.stopPropagation(); openTaskModal(task); };
                    
                    td.appendChild(block);
                    tr.appendChild(td);

                    // Mark slots as occupied
                    for(let k=1; k < task.duration; k++) {
                        if(idx+k < TIMELINE.length) occupancy[day.id][idx+k] = true;
                    }

                } else {
                    // Empty Slot
                    const td = document.createElement('td');
                    td.className = 'empty-slot';
                    td.dataset.day = day.id;
                    td.dataset.idx = idx;
                    tr.appendChild(td);
                }
            });
            b.appendChild(tr);
        }
    }

    // --- TEMPLATE LOGIC ---
    function applyTemplate(type) {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¨Ø±Ù†Ø§Ù…Ù‡ ÙØ¹Ù„ÛŒ Ø´Ù…Ø§ Ù¾Ø§Ú© Ø´Ø¯Ù‡ Ùˆ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆØ¯.")) return;
        
        showLoader("Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¹Ù…Ø§Ù„ Ù‚Ø§Ù„Ø¨...");
        const tpl = TEMPLATES[type];
        if(!tpl) return;

        // Clear current tasks
        appData.tasks = [];

        // Apply logic: Expand template for all days if needed, or just copy sample data
        // For simplicity, we copy the sample 'sat' schedule to ALL days except Friday (weekend)
        // Or keep it simple: Copy the sample structure to Saturday, then user can copy.
        // BETTER UX: Populate Sat-Wed with the template, maybe Thu/Fri lighter.
        
        // Let's populate Sat-Thu with the template.
        const workDays = ['sat','sun','mon','tue','wed','thu'];
        
        workDays.forEach(dId => {
            tpl.forEach(item => {
                appData.tasks.push({
                    id: Date.now() + Math.random(),
                    day: dId,
                    startStr: item.s,
                    duration: item.d,
                    name: item.n,
                    color: item.c
                });
            });
        });

        saveData();
        renderTable();
        closeModal('templatesModal');
        setTimeout(hideLoader, 800);
    }

    // --- TASK MANAGEMENT ---
    function updateEndOptions() {
        const sVal = document.getElementById('inpStart').value;
        const sIdx = TIMELINE.indexOf(sVal);
        const eSel = document.getElementById('inpEnd');
        eSel.innerHTML = '';
        
        for(let i = sIdx + 1; i < TIMELINE.length; i++) {
            const dur = i - sIdx;
            const min = dur * 30;
            const h = Math.floor(min / 60);
            const m = min % 60;
            let txt = (h > 0 ? `${h} Ø³Ø§Ø¹Øª` : "") + (m > 0 ? ` ${m} Ø¯Ù‚ÛŒÙ‚Ù‡` : "");
            eSel.add(new Option(`${TIMELINE[i]} (${txt})`, dur));
        }
    }

    function openTaskModal(task, freshData) {
        openModal('taskModal');
        const delBtn = document.getElementById('btnDeleteTask');
        
        // Reset Color Selection
        document.querySelectorAll('.color-circle').forEach(c => c.classList.remove('active'));

        if(task) {
            currentEditingTask = task;
            document.getElementById('taskId').value = task.id;
            document.getElementById('taskDay').value = task.day;
            document.getElementById('inpName').value = task.name;
            document.getElementById('inpStart').value = task.startStr;
            updateEndOptions();
            document.getElementById('inpEnd').value = task.duration;
            
            // Set Color
            const colDiv = Array.from(document.querySelectorAll('.color-circle')).find(d => 
                // Convert rgb to hex if needed or direct compare
                rgb2hex(d.style.backgroundColor) === task.color || d.style.backgroundColor === task.color
            );
            if(colDiv) colDiv.classList.add('active');
            
            delBtn.style.display = 'block';
        } else {
            currentEditingTask = null;
            document.getElementById('taskId').value = '';
            document.getElementById('taskDay').value = freshData ? freshData.day : 'sat';
            document.getElementById('inpName').value = '';
            document.getElementById('inpStart').value = freshData ? freshData.start : TIMELINE[0];
            updateEndOptions();
            document.getElementById('inpEnd').value = freshData ? freshData.dur : 2; // Default 1 hour
            
            // Default Color
            document.querySelector('.color-circle').classList.add('active');
            delBtn.style.display = 'none';
        }
    }

    function saveTask() {
        const id = document.getElementById('taskId').value;
        const day = document.getElementById('taskDay').value;
        const name = document.getElementById('inpName').value.trim();
        const start = document.getElementById('inpStart').value;
        const dur = parseInt(document.getElementById('inpEnd').value);
        
        const activeCol = document.querySelector('.color-circle.active');
        const color = activeCol ? rgb2hex(activeCol.style.backgroundColor) : COLORS[0];

        if(!name) return alert("Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… ÙØ¹Ø§Ù„ÛŒØª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");

        // Conflict Check
        const sIdx = TIMELINE.indexOf(start);
        const conflict = appData.tasks.some(t => {
            if(t.day !== day) return false;
            if(id && t.id == id) return false; // Ignore self
            const tStart = TIMELINE.indexOf(t.startStr);
            return (sIdx < tStart + t.duration) && (sIdx + dur > tStart);
        });

        if(conflict) return alert("ØªØ¯Ø§Ø®Ù„ Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø§ ÙØ¹Ø§Ù„ÛŒØª Ø¯ÛŒÚ¯Ø±!");

        if(id) {
            // Edit
            const tIndex = appData.tasks.findIndex(t => t.id == id);
            if(tIndex > -1) {
                appData.tasks[tIndex] = { ...appData.tasks[tIndex], name, startStr: start, duration: dur, color };
            }
        } else {
            // New
            appData.tasks.push({ id: Date.now(), day, startStr: start, duration: dur, name, color });
        }

        saveData();
        renderTable();
        closeModal('taskModal');
    }

    function deleteTask() {
        if(!confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) return;
        const id = document.getElementById('taskId').value;
        appData.tasks = appData.tasks.filter(t => t.id != id);
        saveData();
        renderTable();
        closeModal('taskModal');
    }

    // --- COPY LOGIC ---
    function openCopyModal(srcId) {
        pendingCopySource = srcId;
        const dayName = DAYS.find(d => d.id === srcId).l;
        document.getElementById('copySourceLabel').innerText = dayName;
        
        const list = document.getElementById('copyTargetList');
        list.innerHTML = '';
        DAYS.forEach(d => {
            if(d.id !== srcId) {
                list.innerHTML += `
                    <label style="display:flex; align-items:center; gap:8px; padding:8px; background:#f8fafc; border-radius:8px; cursor:pointer;">
                        <input type="checkbox" value="${d.id}" class="copy-chk">
                        ${d.l}
                    </label>
                `;
            }
        });
        openModal('copyModal');
    }

    function executeCopy() {
        const targets = Array.from(document.querySelectorAll('.copy-chk:checked')).map(c => c.value);
        if(targets.length === 0) return alert("Ø±ÙˆØ² Ù…Ù‚ØµØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯");

        if(!confirm("ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ù‡Ø§ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ù¾Ø§Ú© Ùˆ Ø¨Ø§ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ")) return;

        const srcTasks = appData.tasks.filter(t => t.day === pendingCopySource);
        
        // Remove existing tasks in targets
        appData.tasks = appData.tasks.filter(t => !targets.includes(t.day));

        // Add copied tasks
        targets.forEach(tgt => {
            srcTasks.forEach(t => {
                appData.tasks.push({
                    ...t,
                    id: Date.now() + Math.random(),
                    day: tgt
                });
            });
        });

        saveData();
        renderTable();
        closeModal('copyModal');
    }

    // --- EXTRAS & NOTES ---
    function renderExtras() {
        const rl = document.getElementById('reqListUi'); rl.innerHTML='';
        const cl = document.getElementById('chkListUi'); cl.innerHTML='';
        
        appData.reqs.forEach((r,i) => {
            rl.innerHTML += `<li style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
                <span>${r}</span>
                <button class="btn-ghost" style="color:red; padding:2px;" onclick="delExtra('req',${i})">&times;</button>
            </li>`;
        });
        appData.chks.forEach((c,i) => {
            cl.innerHTML += `<li style="display:flex; align-items:center; gap:8px; padding:5px; border-bottom:1px solid #eee;">
                <input type="checkbox" ${c.done?'checked':''} onchange="toggleChk(${i})">
                <span style="${c.done?'text-decoration:line-through; opacity:0.6':''}">${c.text}</span>
                <button class="btn-ghost" style="color:red; padding:2px; margin-right:auto;" onclick="delExtra('chk',${i})">&times;</button>
            </li>`;
        });
    }
    function addItem(type) {
        const inp = document.getElementById(type+'Input');
        if(!inp.value.trim()) return;
        if(type==='req') appData.reqs.push(inp.value.trim());
        else appData.chks.push({text:inp.value.trim(), done:false});
        inp.value=''; saveData(); renderExtras();
    }
    function delExtra(type, i) {
        if(type==='req') appData.reqs.splice(i,1);
        else appData.chks.splice(i,1);
        saveData(); renderExtras();
    }
    function toggleChk(i) {
        appData.chks[i].done = !appData.chks[i].done;
        saveData(); renderExtras();
    }
    function switchTab(t) {
        document.getElementById('tab-req').style.display = t==='req'?'block':'none';
        document.getElementById('tab-chk').style.display = t==='chk'?'block':'none';
        document.getElementById('tabReqBtn').style.background = t==='req'?'#e2e8f0':'transparent';
        document.getElementById('tabChkBtn').style.background = t==='chk'?'#e2e8f0':'transparent';
    }

    function saveNote() {
        appData.note = document.getElementById('noteText').value;
        saveData(); closeModal('noteModal');
    }

    // --- INTERACTION (DRAG SELECT) ---
    function toggleSelectMode() {
        isSelect = !isSelect;
        const btn = document.getElementById('selectModeBtn');
        const txt = document.getElementById('modeText');
        if(isSelect) {
            btn.classList.add('active');
            txt.innerText = 'Ø­Ø§Ù„Øª Ø§Ù†ØªØ®Ø§Ø¨ ÙØ¹Ø§Ù„';
            document.body.classList.add('selection-mode');
        } else {
            btn.classList.remove('active');
            txt.innerText = 'Ø­Ø§Ù„Øª Ø§Ø³Ú©Ø±ÙˆÙ„';
            document.body.classList.remove('selection-mode');
        }
    }
    
    function setupEvents() {
        const table = document.getElementById('plannerTable');
        
        const getCell = (e) => {
            // Touch or Mouse
            const clientX = e.clientX || (e.touches && e.touches[0].clientX);
            const clientY = e.clientY || (e.touches && e.touches[0].clientY);
            const el = document.elementFromPoint(clientX, clientY);
            return el ? el.closest('td.empty-slot') : null;
        }

        const start = (e) => {
            if(!isSelect) return;
            const cell = getCell(e);
            if(cell) {
                // e.preventDefault(); // Prevent scrolling on touch if in select mode
                isDrag = true;
                selStart = { d: cell.dataset.day, i: parseInt(cell.dataset.idx) };
                selCurr = selStart;
                drawSelection();
            }
        };

        const move = (e) => {
            if(!isDrag) return;
            const cell = getCell(e);
            if(cell && cell.dataset.day === selStart.d) {
                selCurr = { d: cell.dataset.day, i: parseInt(cell.dataset.idx) };
                drawSelection();
            }
        };

        const end = () => {
            if(!isDrag) return;
            isDrag = false;
            // Open modal if selection is valid
            if(selStart && selCurr) {
                const s = Math.min(selStart.i, selCurr.i);
                const e = Math.max(selStart.i, selCurr.i);
                const dur = e - s + 1;
                openTaskModal(null, { day: selStart.d, start: TIMELINE[s], dur: dur });
            }
            clearSelection();
        };

        // Events
        table.addEventListener('mousedown', start);
        window.addEventListener('mousemove', move);
        window.addEventListener('mouseup', end);
        
        table.addEventListener('touchstart', (e)=>{ if(isSelect) e.preventDefault(); start(e); }, {passive:false});
        window.addEventListener('touchmove', move, {passive:false});
        window.addEventListener('touchend', end);
    }

    function drawSelection() {
        document.querySelectorAll('.selected-highlight').forEach(e => e.classList.remove('selected-highlight'));
        if(!selStart || !selCurr) return;
        const s = Math.min(selStart.i, selCurr.i);
        const e = Math.max(selStart.i, selCurr.i);
        for(let i=s; i<=e; i++) {
            const td = document.querySelector(`td.empty-slot[data-day="${selStart.d}"][data-idx="${i}"]`);
            if(td) td.classList.add('selected-highlight');
        }
    }
    function clearSelection() {
        selStart=null; selCurr=null;
        document.querySelectorAll('.selected-highlight').forEach(e => e.classList.remove('selected-highlight'));
    }


    // --- EXPORT & PRINT (Engineered) ---

    // 1. Image Download Logic
    function downloadAsImage() {
        showLoader("Ø¯Ø± Ø­Ø§Ù„ Ø±Ù†Ø¯Ø± ØªØµÙˆÛŒØ± Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§...");
        
        // Populate hidden export container
        const c = document.getElementById('image-export-area');
        document.getElementById('expTitle').innerText = appData.header || 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ';
        document.getElementById('expUser').innerText = appData.userName ? `Ù†Ø§Ù…: ${appData.userName}` : '';
        document.getElementById('expDate').innerText = `ØªØ§Ø±ÛŒØ®: ${new Date().toLocaleDateString('fa-IR')}`;
        
        // Extras
        const rqBox = document.getElementById('expReqBox');
        const ckBox = document.getElementById('expChkBox');
        const rqL = document.getElementById('expReqList'); rqL.innerHTML='';
        const ckL = document.getElementById('expChkList'); ckL.innerHTML='';
        
        if(appData.reqs.length){ rqBox.style.display='block'; appData.reqs.forEach(r=>rqL.innerHTML+=`<li>${r}</li>`); } 
        else rqBox.style.display='none';
        
        if(appData.chks.length){ ckBox.style.display='block'; appData.chks.forEach(x=>ckL.innerHTML+=`<li>${x.done?'â˜‘':'â˜'} ${x.text}</li>`); }
        else ckBox.style.display='none';

        // Table Generation (Table-based for image stability)
        const thead = document.getElementById('expThead'); thead.innerHTML = '';
        const tbody = document.getElementById('expTbody'); tbody.innerHTML = '';
        
        // Header
        let hRow = '<tr><th>Ø²Ù…Ø§Ù†</th>';
        DAYS.forEach(d => hRow += `<th>${d.l}</th>`);
        hRow += '</tr>';
        thead.innerHTML = hRow;

        // Body
        const occ = {}; DAYS.forEach(d => occ[d.id] = new Array(TIMELINE.length).fill(false));
        
        for(let i=0; i<TIMELINE.length-1; i++) {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td style="font-family:'Vazirmatn';">${TIMELINE[i]}</td>`;
            
            DAYS.forEach(d => {
                if(occ[d.id][i]) return;
                const task = appData.tasks.find(t => t.day === d.id && t.startStr === TIMELINE[i]);
                
                if(task) {
                    const td = document.createElement('td');
                    td.rowSpan = task.duration;
                    td.style.backgroundColor = task.color;
                    td.style.border = '1px solid #0f172a'; // Strong border for image
                    td.innerHTML = `
                        <div class="export-task">
                            <span class="export-task-time" style="font-family:'Vazirmatn';">${task.startStr}</span>
                            <span style="font-weight:bold; font-size:16px;">${task.name}</span>
                        </div>`;
                    tr.appendChild(td);
                    for(let k=1; k<task.duration; k++) occ[d.id][i+k] = true;
                } else {
                    tr.appendChild(document.createElement('td'));
                }
            });
            tbody.appendChild(tr);
        }

        // Notes
        const ft = document.getElementById('expFooter');
        if(appData.note) { ft.style.display='flex'; document.getElementById('expNoteText').innerText = appData.note; }
        else ft.style.display='none';

        // Display temporarily
        c.style.display = 'block';

        // Capture
        setTimeout(() => {
            html2canvas(c, {
                scale: 2, // High DPI
                useCORS: true,
                backgroundColor: '#ffffff'
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `plan-${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                c.style.display = 'none';
                hideLoader();
            }).catch(e => {
                alert('Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ ØªØµÙˆÛŒØ±');
                console.error(e);
                c.style.display = 'none';
                hideLoader();
            });
        }, 500); // Wait for DOM render
    }

    // 2. Print Logic (The Simple List)
    function printApp() {
        // Generate Simple List View
        const c = document.getElementById('printSimpleListContainer');
        c.innerHTML = '';
        
        document.getElementById('printSimpleTitle').innerText = appData.header || 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ';
        document.getElementById('printSimpleUser').innerText = appData.userName || '-';
        document.getElementById('printSimpleDate').innerText = new Date().toLocaleDateString('fa-IR');
        document.getElementById('printSimpleNote').innerText = appData.note || 'Ù†Ø¯Ø§Ø±Ø¯';

        // Extras
        const rl = document.getElementById('printSimpleReqs'); rl.innerHTML='';
        appData.reqs.forEach(r => rl.innerHTML+=`<li>${r}</li>`);
        const cl = document.getElementById('printSimpleChks'); cl.innerHTML='';
        appData.chks.forEach(x => cl.innerHTML+=`<li>[${x.done?'x':' '}] ${x.text}</li>`);

        // Loop Days
        DAYS.forEach(d => {
            // Filter tasks for this day and sort by time
            const dayTasks = appData.tasks
                .filter(t => t.day === d.id)
                .sort((a,b) => TIMELINE.indexOf(a.startStr) - TIMELINE.indexOf(b.startStr));
            
            // Only show day if it has tasks (Optional: remove check to show empty days)
            // Showing all days for completeness
            const div = document.createElement('div');
            div.className = 'day-block-print';
            
            let tasksHtml = '';
            if(dayTasks.length === 0) {
                tasksHtml = '<li style="padding:10px; color:#777; font-style:italic;">Ø¨Ø¯ÙˆÙ† ÙØ¹Ø§Ù„ÛŒØª</li>';
            } else {
                dayTasks.forEach(t => {
                    // Calculate end time
                    const sIdx = TIMELINE.indexOf(t.startStr);
                    const eIdx = sIdx + t.duration;
                    const endStr = TIMELINE[eIdx] || '...';
                    
                    tasksHtml += `
                        <li class="task-item-print">
                            <span class="time-print">${t.startStr} ØªØ§ ${endStr}</span>
                            <span class="name-print">${t.name}</span>
                        </li>
                    `;
                });
            }

            div.innerHTML = `
                <div class="day-title-print">
                    <span>${d.l}</span>
                    <span style="font-weight:normal; font-size:12px;">${dayTasks.length} ÙØ¹Ø§Ù„ÛŒØª</span>
                </div>
                <ul class="task-list-print">${tasksHtml}</ul>
            `;
            c.appendChild(div);
        });

        // Trigger Print
        window.print();
    }

    // --- DATA UTILS ---
    function updateHeader(v) { appData.header = v; document.title = v || 'Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù‡ÙØªÚ¯ÛŒ'; saveData(); }
    function updateUserName(v) { appData.userName = v; saveData(); }
    function saveData() { localStorage.setItem('proPlannerData', JSON.stringify(appData)); }
    function clearAll() { if(confirm("Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§ØªØŸ")) { localStorage.removeItem('proPlannerData'); location.reload(); } }
    
    function exportData() {
        const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(b);
        a.download = 'weekly-plan-backup.json';
        a.click();
    }
    
    function importData(inp) {
        const f = inp.files[0];
        if(!f) return;
        const r = new FileReader();
        r.onload = (e) => {
            try {
                appData = JSON.parse(e.target.result);
                saveData();
                location.reload();
            } catch(x) { alert("ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø±"); }
        };
        r.readAsText(f);
    }

    function openModal(id) { 
        document.getElementById(id).style.display = 'flex'; 
        setTimeout(()=>document.getElementById(id).classList.add('show'), 10);
    }
    function closeModal(id) { 
        document.getElementById(id).classList.remove('show');
        setTimeout(()=>document.getElementById(id).style.display = 'none', 300);
    }
    function showLoader(txt) { document.getElementById('loadingBar').style.display='block'; document.getElementById('processingMsg').style.display='flex'; document.getElementById('procTxt').innerText=txt; }
    function hideLoader() { document.getElementById('loadingBar').style.display='none'; document.getElementById('processingMsg').style.display='none'; }
    function rgb2hex(rgb) {
        if (!rgb) return '#000000';
        if (rgb.startsWith('#')) return rgb;
        const rgbMatch = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
        if (!rgbMatch) return rgb; 
        function hex(x) { return ("0" + parseInt(x).toString(16)).slice(-2); }
        return "#" + hex(rgbMatch[1]) + hex(rgbMatch[2]) + hex(rgbMatch[3]);
    }

    // Run
    init();

</script>
</body>
</html>
