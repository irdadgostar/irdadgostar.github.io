<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سامانه جامع پایش اخلاق | نسخه نهایی و کامل</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --success-dark: #047857;
            --danger: #ef4444;
            --danger-dark: #b91c1c;
            --neutral: #64748b;
            --text-main: #0f172a;
            --text-light: #64748b;
            --border-radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0; padding-bottom: 100px;
            overflow-x: hidden;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* --- Header Area --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 0 5px;
        }

        .manifesto-btn {
            background: var(--surface); color: var(--primary);
            border: 1px solid var(--primary); padding: 8px 16px;
            border-radius: 50px; font-size: 0.85rem; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            box-shadow: var(--shadow); transition: 0.2s;
        }
        .manifesto-btn.read { background: var(--success); color: white; border-color: var(--success); }

        .date-navigator {
            display: flex; align-items: center; gap: 15px;
            background: var(--surface); padding: 6px 12px;
            border-radius: 12px; box-shadow: var(--shadow);
        }
        .date-btn { background: none; border: none; color: var(--text-main); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; }
        .date-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .date-text { font-weight: bold; font-size: 0.9rem; }

        /* --- Dynamic Score Card --- */
        .score-card {
            color: white; padding: 25px; border-radius: 24px;
            text-align: center; box-shadow: var(--shadow);
            margin-bottom: 25px; transition: background 0.5s ease;
            position: relative; overflow: hidden;
        }
        
        /* Dynamic Background Classes */
        .score-card.neutral { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
        .score-card.positive { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .score-card.negative { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }

        .main-score { font-size: 4rem; font-weight: 900; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .score-label { font-size: 0.9rem; opacity: 0.9; letter-spacing: 1px; margin-bottom: 5px; }
        
        .sub-scores {
            display: flex; justify-content: space-around; margin-top: 20px;
            background: rgba(0,0,0,0.15); padding: 10px; border-radius: 16px;
        }
        .sub-score-item { display: flex; flex-direction: column; }
        .sub-val { font-weight: 800; font-size: 1.2rem; }
        .sub-lbl { font-size: 0.75rem; opacity: 0.8; }

        /* --- Lists --- */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 25px 0 10px 0; padding: 0 5px;
        }
        .section-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .virtue-text { color: var(--success-dark); }
        .vice-text { color: var(--danger-dark); }

        .card {
            background: var(--surface); border-radius: var(--border-radius);
            padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow);
            border-right: 5px solid transparent; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:active { transform: scale(0.98); }
        .card.virtue { border-right-color: var(--success); }
        .card.vice { border-right-color: var(--danger); }

        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-name { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .item-weight { font-size: 0.7rem; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: var(--text-light); }
        
        /* Stepper */
        .stepper { display: flex; align-items: center; background: #f8fafc; border-radius: 10px; padding: 3px; border: 1px solid #e2e8f0; }
        .step-btn {
            width: 30px; height: 30px; border: none; background: white; border-radius: 8px;
            font-size: 1.2rem; cursor: pointer; color: var(--text-main);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center;
        }
        .step-val { width: 30px; text-align: center; font-weight: bold; font-size: 1rem; }

        .note-input {
            width: 100%; border: none; border-top: 1px solid #f1f5f9;
            padding: 8px 0 0 0; margin-top: 5px; font-size: 0.85rem;
            background: transparent; color: var(--text-main);
        }

        /* --- Action List (Tasks) --- */
        .action-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow);
            border: 1px solid #f1f5f9;
            cursor: pointer; /* Clickable to show details */
        }
        .action-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .action-checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
        .action-content { flex: 1; }
        .action-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .badge-reward { background: #d1fae5; color: #065f46; }
        .badge-penalty { background: #fee2e2; color: #991b1b; }

        /* Stats Summary Box in Actions Tab */
        .stats-summary-card {
            background: var(--surface); padding: 15px; border-radius: 12px; box-shadow: var(--shadow);
            display: flex; justify-content: space-around; margin-bottom: 20px;
        }
        .stat-box { text-align: center; cursor: pointer; padding: 10px; border-radius: 8px; transition: background 0.2s; width: 45%; }
        .stat-box:active { background: #f1f5f9; }
        .stat-num { font-size: 1.5rem; font-weight: bold; display: block; }
        .stat-label { font-size: 0.8rem; color: var(--text-light); }
        .stat-reward { color: var(--success); border: 1px solid #d1fae5; }
        .stat-penalty { color: var(--danger); border: 1px solid #fee2e2; }


        /* --- Trigger Alert Box --- */
        .trigger-box {
            background: #fff7ed; border: 1px solid #ffedd5; border-radius: 16px;
            padding: 15px; margin-bottom: 20px; display: none;
            animation: slideDown 0.3s ease;
        }
        .trigger-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: bold; }
        .trigger-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-accept { background: var(--primary); color: white; flex: 1; }
        .btn-change { background: white; border: 1px solid #cbd5e1; color: var(--text-light); }
        .btn-danger-outline { background: white; border: 1px solid var(--danger); color: var(--danger); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Bottom Nav --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid #f1f5f9; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            z-index: 900;
        }
        .nav-item {
            background: none; border: none; display: flex; flex-direction: column;
            align-items: center; color: #94a3b8; gap: 5px; font-size: 0.7rem; cursor: pointer;
        }
        .nav-item i { font-size: 1.4rem; }
        .nav-item.active { color: var(--primary); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 20px;
            padding: 20px; max-height: 90vh; overflow-y: auto;
            position: relative;
        }

        /* Settings Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .btn-icon { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 1rem; }
        .btn-icon.edit { color: var(--primary); }
        .btn-icon.delete { color: var(--danger); }
        
        /* Search Bar */
        .search-box {
            margin-bottom: 15px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 10px 35px 10px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }
        .search-box i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Manifesto Text */
        .manifesto-content {
            font-size: 0.95rem; line-height: 1.8; text-align: justify;
            background: #f8fafc; padding: 15px; border-radius: 12px;
            max-height: 60vh; overflow-y: auto; border: 1px solid #e2e8f0;
            margin: 15px 0;
        }

        /* Tab Visibility */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Toggle Switch for Lists */
        .list-toggle {
            display: flex;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: white;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-light);
        }
        .toggle-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Action Details in Modal */
        .detail-row {
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .detail-label { font-weight: bold; font-size: 0.85rem; color: var(--text-light); display: block; }
        .detail-value { font-size: 1rem; }

        /* Instruction 3 & 4: Popup styling improvements */
        .modal-content { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        /* Manifesto Done Button Style */
        .manifesto-btn.done {
            background-color: var(--success);
            border-color: var(--success);
            color: white;
        }
        .manifesto-btn.done i {
            color: white; /* Force icon color */
        }

    </style>
</head>
<body>

<div id="app">

    <!-- TAB: HOME -->
    <div id="tab-home" class="tab-content active">
        <div class="container">
            
            <div class="top-bar">
                <!-- Instruction 4: Button changes to Check/Green when read -->
                <button class="manifesto-btn" id="manifestoBtn" onclick="openManifestoModal()">
                    <i class="fas fa-book-open" id="manifestoIcon"></i> <span id="manifestoBtnText">منشور اخلاقی</span>
                </button>
                <div class="date-navigator">
                    <button class="date-btn" onclick="navigateDate(-1)"><i class="fas fa-chevron-right"></i></button>
                    <div class="date-text" id="headerDateDisplay">...</div>
                    <button class="date-btn" id="nextDayBtn" onclick="navigateDate(1)" disabled><i class="fas fa-chevron-left"></i></button>
                </div>
            </div>

            <div class="score-card neutral" id="scoreCard">
                <div class="score-label">تراز امروز</div>
                <div class="main-score" id="totalScoreDisplay">0</div>
                <div class="sub-scores">
                    <div class="sub-score-item">
                        <span class="sub-val" id="posScoreDisplay">0</span>
                        <span class="sub-lbl">مثبت</span>
                    </div>
                    <div class="sub-score-item">
                        <span class="sub-val" id="negScoreDisplay">0</span>
                        <span class="sub-lbl">منفی</span>
                    </div>
                </div>
            </div>

            <!-- Trigger Notification Area -->
            <div id="triggerArea"></div>

            <!-- Pending Actions Summary -->
            <div id="homePendingSummary" class="stats-summary-card" style="margin-bottom: 20px; display:none;">
                <div class="stat-box stat-reward" onclick="openActionListModal('reward', false)">
                    <span class="stat-num" id="pendingRewardCount">0</span>
                    <span class="stat-label">پاداش مانده</span>
                </div>
                <div class="stat-box stat-penalty" onclick="openActionListModal('penalty', false)">
                    <span class="stat-num" id="pendingPenaltyCount">0</span>
                    <span class="stat-label">جریمه مانده</span>
                </div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="homeSearch" placeholder="جستجو در رفتارها..." oninput="filterHomeList()">
            </div>

            <!-- Virtues -->
            <div class="section-header">
                <span class="section-title virtue"><i class="fas fa-check-circle"></i> فضایل</span>
            </div>
            <div id="virtuesList"></div>

            <!-- Vices -->
            <div class="section-header">
                <span class="section-title vice"><i class="fas fa-times-circle"></i> رذایل</span>
            </div>
            <div id="vicesList"></div>

        </div>
    </div>

    <!-- TAB: ACTIONS (KARNAMEH) -->
    <div id="tab-actions" class="tab-content">
        <div class="container">
            <h2 style="margin-top:0;">کارنامه عملی</h2>
            
            <!-- Stats / Filter Buttons -->
            <div class="stats-summary-card">
                <div class="stat-box stat-reward" onclick="filterActionsTab('reward')">
                    <span class="stat-num" id="totalRewardCount">0</span>
                    <span class="stat-label">کل پاداش‌ها</span>
                </div>
                <div class="stat-box stat-penalty" onclick="filterActionsTab('penalty')">
                    <span class="stat-num" id="totalPenaltyCount">0</span>
                    <span class="stat-label">کل جریمه‌ها</span>
                </div>
            </div>

             <!-- Search Actions -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="actionsSearch" placeholder="جستجو در کارنامه..." oninput="renderActionsTab()">
            </div>

            <!-- Stats Detail (Completed/Pending) Instruction 9 -->
            <div style="margin-bottom: 15px; display:flex; gap:10px; overflow-x:auto; padding-bottom:5px;">
                 <div class="stat-box" style="min-width:100px; background:#f0f9ff;" onclick="openActionListModal(null, true)">
                    <span class="stat-num" id="totalDoneCount">0</span>
                    <span class="stat-label">انجام شده</span>
                </div>
                <div class="stat-box" style="min-width:100px; background:#fff1f2;" onclick="openActionListModal(null, false)">
                    <span class="stat-num" id="totalPendingCount">0</span>
                    <span class="stat-label">انجام نشده</span>
                </div>
                 <div class="stat-box" style="min-width:120px; background:#fef3c7;" onclick="openDateRangeStats()">
                    <span class="stat-num"><i class="fas fa-calendar-alt"></i></span>
                    <span class="stat-label">آمار بازه زمانی</span>
                </div>
            </div>

            <div id="actionsListFull"></div>
        </div>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tab-content">
        <div class="container">
            <h2>تنظیمات</h2>
            
            <div class="card">
                <h3>رفتارها (فضایل و رذایل)</h3>
                <button class="btn btn-accept" style="width:100%" onclick="openEditor('behavior')">مدیریت لیست رفتارها</button>
            </div>

            <div class="card">
                <h3>قوانین پاداش و جریمه</h3>
                <p style="font-size:0.8rem; color:var(--text-light);">تعیین کنید در چه امتیازی چه اتفاقی بیفتد.</p>
                <button class="btn btn-accept" style="width:100%" onclick="openEditor('rule')">مدیریت قوانین</button>
            </div>

            <div class="card">
                <h3>پشتیبان‌گیری</h3>
                <button class="btn btn-accept" style="background:var(--success); width:100%" onclick="backupData()">دانلود فایل پشتیبان</button>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
                <button class="btn btn-change" style="width:100%; margin-top:10px;" onclick="document.getElementById('restoreFile').click()">بازگردانی اطلاعات</button>
            </div>

            <div class="card" style="border-right-color: var(--danger);">
                <h3 style="color:var(--danger);">پاکسازی داده‌ها</h3>
                <button class="btn btn-danger-outline" style="width:100%" onclick="openClearDataModal()">حذف اطلاعات</button>
            </div>
            
            <br><br><br>
        </div>
    </div>

</div>

<!-- NAVIGATION -->
<div class="nav-bar">
    <button class="nav-item active" onclick="switchTab('home')">
        <i class="fas fa-home"></i>
        <span>امروز</span>
    </button>
    <button class="nav-item" onclick="switchTab('actions')">
        <i class="fas fa-clipboard-list"></i>
        <span>اقدامات</span>
    </button>
    <button class="nav-item" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i>
        <span>تنظیمات</span>
    </button>
</div>

<!-- MODAL: MANIFESTO -->
<div id="manifestoModal" class="modal-overlay">
    <div class="modal-content" style="position:relative; max-height:85vh; display:flex; flex-direction:column;">
        <div style="position:absolute; top:15px; left:15px; z-index:10; cursor:pointer;" onclick="document.getElementById('manifestoModal').style.display='none'">
            <i class="fas fa-times" style="font-size:1.2rem; color:var(--text-light);"></i>
        </div>
        <h3 style="text-align:center; color:var(--primary); margin-top:0;">مرور عهدنامه</h3>
        <div class="manifesto-content" id="manifestoTextContainer">
            <!-- Text injected via JS -->
        </div>
        <button id="manifestoConfirmBtn" class="btn btn-accept" style="width:100%; opacity:0.5;" disabled onclick="confirmManifestoRead()">تایید و تعهد</button>
        <p style="text-align:center; font-size:0.75rem; color:red; margin-top:5px;">(لطفاً تا انتها مطالعه کنید)</p>
    </div>
</div>

<!-- MODAL: ONBOARDING (NAME) -->
<div id="nameModal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <h3>خوش آمدید</h3>
        <p>لطفاً نام خود را برای ثبت در منشور وارد کنید:</p>
        <input type="text" id="userNameInput" class="form-input" placeholder="نام شما..." style="text-align:center; font-size:1.2rem;">
        <br><br>
        <button class="btn btn-accept" onclick="saveName()">ثبت و شروع</button>
    </div>
</div>

<!-- MODAL: CLEAR DATA -->
<div id="clearDataModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
             <h3 style="color:var(--danger); margin:0;">حذف اطلاعات</h3>
             <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('clearDataModal').style.display='none'"></i>
        </div>
        <p>لطفاً بازه زمانی را انتخاب کنید:</p>
        
        <div class="form-group">
            <label>
                <input type="radio" name="clearOption" value="today" checked> امروز
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="radio" name="clearOption" value="all"> تمام اطلاعات (بازگشت به تنظیمات کارخانه)
            </label>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-danger" style="flex:1" onclick="performClearData()">حذف کن</button>
            <button class="btn btn-change" style="flex:1" onclick="document.getElementById('clearDataModal').style.display='none'">انصراف</button>
        </div>
    </div>
</div>

<!-- MODAL: EDITOR (GENERIC POPUP) - Instruction 4 -->
<div id="editorModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="editorTitle" style="margin:0">ویرایش</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeEditor()"></i>
        </div>
        
        <!-- Toggle for Lists in Rule Mode -->
        <div id="ruleListToggle" class="list-toggle" style="display:none;">
            <button class="toggle-btn active" onclick="toggleRuleList('virtue')" id="toggleVirtueBtn">فضایل/پاداش</button>
            <button class="toggle-btn" onclick="toggleRuleList('vice')" id="toggleViceBtn">رذایل/جریمه</button>
        </div>
        
        <!-- Instruction 3: Virtue/Vice Filter for Behaviors too -->
        <div id="behaviorListToggle" class="list-toggle" style="display:none;">
             <button class="toggle-btn active" onclick="toggleBehaviorList('virtue')" id="toggleBehVirtueBtn">فضایل</button>
             <button class="toggle-btn" onclick="toggleBehaviorList('vice')" id="toggleBehViceBtn">رذایل</button>
        </div>
        
        <div class="search-box" style="margin-bottom:10px;">
             <i class="fas fa-search"></i>
             <input type="text" id="editorSearch" placeholder="جستجو..." oninput="filterEditorList()">
        </div>

        <div id="editorListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>

        <!-- Floating Button for Add New -->
        <button class="btn btn-accept" onclick="openEditForm(null)" style="width:100%">+ افزودن مورد جدید</button>
    </div>
</div>

<!-- MODAL: EDIT FORM POPUP (Instruction 4) -->
<div id="editFormModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="formTitle" style="margin:0">افزودن/ویرایش</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeEditForm()"></i>
        </div>
        
        <input type="hidden" id="editId" value="">
        
        <!-- Fields for Behavior -->
        <div id="behaviorFields" style="display:none;">
            <div class="form-group">
                <input type="text" id="behTitle" class="form-input" placeholder="عنوان رفتار">
            </div>
            <div class="form-group" style="display:flex; gap:10px;">
                <select id="behType" class="form-select">
                    <option value="virtue">فضیلت (مثبت)</option>
                    <option value="vice">رذیلت (منفی)</option>
                </select>
                <input type="number" id="behWeight" class="form-input" placeholder="امتیاز" value="1">
            </div>
        </div>

        <!-- Fields for Rules -->
        <div id="ruleFields" style="display:none;">
            <div class="form-group">
                <label class="form-label">نوع شرط:</label>
                <select id="ruleType" class="form-select" onchange="toggleRuleInputs()">
                    <option value="total_pos">مجموع امتیاز مثبت روزانه</option>
                    <option value="total_neg">مجموع امتیاز منفی روزانه</option>
                    <option value="total_net">امتیاز خالص (برآیند)</option>
                    <option value="specific">رفتار خاص</option>
                </select>
            </div>
            
            <div class="form-group" id="specificBehDiv" style="display:none;">
                <label class="form-label">انتخاب رفتار:</label>
                <select id="ruleTargetId" class="form-select" onchange="updateRuleResultTypeBasedOnTarget()"></select>
                <!-- Instruction 1: Automatic Type Indicator -->
                <div id="ruleAutoTypeIndicator" style="font-size:0.8rem; margin-top:5px; padding:5px; border-radius:4px; display:inline-block;"></div>
            </div>

            <div class="form-group">
                <label class="form-label">حد نصاب (تعداد/امتیاز):</label>
                <input type="number" id="ruleThreshold" class="form-input" placeholder="مثلا 20">
            </div>

            <div class="form-group">
                <label class="form-label">نتیجه (خودکار تعیین می‌شود):</label>
                <div style="display:flex; gap:5px;">
                     <input type="text" id="ruleResultTypeDisplay" class="form-input" style="width:80px; background:#eee; color:#555;" disabled>
                     <input type="hidden" id="ruleResultType">
                    <input type="text" id="ruleResultText" class="form-input" placeholder="مثلا: دیدن فیلم">
                </div>
            </div>
            
            <!-- Instruction 8: Time Range -->
            <div class="form-group">
                <label class="form-label">محدوده زمانی (اختیاری):</label>
                <div style="display:flex; gap:5px; align-items:center;">
                    <span>از</span>
                    <input type="time" id="ruleStartTime" class="form-input">
                    <span>تا</span>
                    <input type="time" id="ruleEndTime" class="form-input">
                </div>
            </div>

            <div class="form-group">
                <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px;">
                    <input type="checkbox" id="ruleIsSpecific"> این پاداش/جریمه اختصاصی است (تصادفی انتخاب نشود)
                </label>
            </div>
        </div>

        <button class="btn btn-accept" style="width:100%; margin-top:15px;" onclick="saveEditorItem()">ذخیره</button>
    </div>
</div>

<!-- MODAL: ACTION DETAILS -->
<div id="actionDetailModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="actionDetailTitle" style="margin:0">جزئیات اقدام</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('actionDetailModal').style.display='none'"></i>
        </div>
        
        <div id="actionDetailContent">
            <!-- Details Injected Here -->
        </div>

        <!-- Instruction 1: Edit Reward/Penalty -->
        <div id="actionEditControls" style="margin-top:20px; border-top:1px solid #eee; padding-top:15px; display:none;">
            <h4>تغییر اقدام (دستور اول)</h4>
            <input type="text" id="actionEditText" class="form-input" placeholder="عنوان جدید پاداش/جریمه">
            <button class="btn btn-accept" style="margin-top:10px; width:100%;" onclick="saveActionEdit()">ثبت تغییر</button>
        </div>
        
        <div style="margin-top:20px; text-align:right;">
             <button class="btn btn-outline" onclick="document.getElementById('actionDetailModal').style.display='none'">بستن</button>
        </div>
    </div>
</div>

<!-- MODAL: ACTION LIST POPUP (From Home Summary or Stats) -->
<div id="actionListPopupModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="actionListPopupTitle" style="margin:0">لیست</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('actionListPopupModal').style.display='none'"></i>
        </div>
        <div id="actionListPopupContent" style="max-height:300px; overflow-y:auto;"></div>
    </div>
</div>

<!-- MODAL: DATE RANGE STATS - Instruction 9 -->
<div id="dateRangeModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 style="margin:0">آمار بازه زمانی</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('dateRangeModal').style.display='none'"></i>
        </div>
        
        <div class="form-group">
            <label>تاریخ شروع:</label>
            <input type="date" id="statStartDate" class="form-input">
        </div>
        <div class="form-group">
            <label>تاریخ پایان:</label>
            <input type="date" id="statEndDate" class="form-input">
        </div>
        <button class="btn btn-accept" onclick="calcDateRangeStats()">محاسبه</button>
        
        <div id="rangeStatsResult" style="margin-top:20px; display:none;">
            <div class="sub-scores" style="background:#f8fafc; padding:15px;">
                <div class="sub-score-item"><span>مثبت:</span> <strong id="rsPos" style="color:var(--success)"></strong></div>
                <div class="sub-score-item"><span>منفی:</span> <strong id="rsNeg" style="color:var(--danger)"></strong></div>
                <div class="sub-score-item"><span>کل:</span> <strong id="rsTotal"></strong></div>
            </div>
            <div class="list-row"><span>تعداد پاداش‌ها:</span> <strong id="rsRewards"></strong></div>
            <div class="list-row"><span>تعداد جریمه‌ها:</span> <strong id="rsPenalties"></strong></div>
            <div class="list-row" onclick="showRangeActionDetails(true)" style="cursor:pointer; color:var(--primary); border:1px solid #eee; padding:5px; border-radius:8px; margin-bottom:5px;">
                <span>انجام شده (کلیک کنید):</span> <strong id="rsDone"></strong>
            </div>
            <div class="list-row" onclick="showRangeActionDetails(false)" style="cursor:pointer; color:var(--danger); border:1px solid #eee; padding:5px; border-radius:8px;">
                <span>انجام نشده (کلیک کنید):</span> <strong id="rsPending"></strong>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. DATA STRUCTURE & INITIALIZATION
    // ==========================================
    
    const DEFAULT_DATA = {
        user: { name: "" },
        behaviors: [
            // Virtues (Instruction 5 - List Updated)
            { id: 'v1', title: 'خردورزی', type: 'virtue', weight: 5 },
            { id: 'v2', title: 'انضباط شخصی', type: 'virtue', weight: 4 },
            { id: 'v3', title: 'صداقت', type: 'virtue', weight: 5 },
            { id: 'v4', title: 'مسئولیت‌پذیری', type: 'virtue', weight: 4 },
            { id: 'v5', title: 'همدلی', type: 'virtue', weight: 3 },
            { id: 'v6', title: 'کمک به همنوع', type: 'virtue', weight: 5 },
            { id: 'v7', title: 'کنترل خشم', type: 'virtue', weight: 6 },
            { id: 'v8', title: 'احترام به حریم‌ها', type: 'virtue', weight: 3 },
            { id: 'v9', title: 'شکرگزاری', type: 'virtue', weight: 2 },
            { id: 'v10', title: 'یادگیری مستمر', type: 'virtue', weight: 4 },
            { id: 'v11', title: 'نظافت و آراستگی', type: 'virtue', weight: 2 },
            { id: 'v12', title: 'وفای به عهد', type: 'virtue', weight: 5 },
            { id: 'v13', title: 'عدالت و انصاف', type: 'virtue', weight: 5 },
            { id: 'v14', title: 'شجاعت', type: 'virtue', weight: 4 },
            { id: 'v15', title: 'تاب‌آوری', type: 'virtue', weight: 3 },
            { id: 'v16', title: 'رازداری', type: 'virtue', weight: 4 },
            { id: 'v17', title: 'سحرخیزی', type: 'virtue', weight: 3 },
            { id: 'v18', title: 'سکوتِ آگاهانه', type: 'virtue', weight: 2 },
            { id: 'v19', title: 'حفظ محیط زیست', type: 'virtue', weight: 2 },
            { id: 'v20', title: 'عزت نفس', type: 'virtue', weight: 4 },
            // Vices
            { id: 'x1', title: 'دروغ', type: 'vice', weight: 5 },
            { id: 'x2', title: 'غیبت', type: 'vice', weight: 4 },
            { id: 'x3', title: 'توهین و فحاشی', type: 'vice', weight: 4 },
            { id: 'x4', title: 'تهمت', type: 'vice', weight: 6 },
            { id: 'x5', title: 'سخن‌چینی', type: 'vice', weight: 4 },
            { id: 'x6', title: 'تنبلی و اهمال', type: 'vice', weight: 3 },
            { id: 'x7', title: 'حسادت', type: 'vice', weight: 3 },
            { id: 'x8', title: 'قضاوت عجولانه', type: 'vice', weight: 3 },
            { id: 'x9', title: 'پرخوری یا پرخوابی', type: 'vice', weight: 2 },
            { id: 'x10', title: 'اسراف', type: 'vice', weight: 2 },
            { id: 'x11', title: 'تکبر و خودبرتربینی', type: 'vice', weight: 4 },
            { id: 'x12', title: 'بدقولی', type: 'vice', weight: 4 },
            { id: 'x13', title: 'کنترل‌گری', type: 'vice', weight: 3 },
            { id: 'x14', title: 'قربانی‌نمایی', type: 'vice', weight: 3 },
            { id: 'x15', title: 'نگاه آلوده یا پورنوگرافی', type: 'vice', weight: 5 },
            { id: 'x16', title: 'کینه و انتقام‌جویی', type: 'vice', weight: 4 },
            { id: 'x17', title: 'خیانت', type: 'vice', weight: 6 },
            { id: 'x18', title: 'چاپلوسی', type: 'vice', weight: 3 },
            { id: 'x19', title: 'ناامیدی و پوچ‌گرایی', type: 'vice', weight: 4 },
            { id: 'x20', title: 'بی‌تفاوتی', type: 'vice', weight: 3 }
        ],
        rules: [
            // General Rules (Instruction 5: thresholds adjusted)
            { id: 'r1', type: 'total_pos', targetId: null, threshold: 200, resultType: 'reward', resultText: 'تماشای فیلم یا سریال', isSpecific: false },
            { id: 'r2', type: 'total_neg', targetId: null, threshold: 300, resultType: 'penalty', resultText: '۲۰ شنا سوئدی اضافه', isSpecific: false },
            
            // Instruction 6: Removed Total Net rules if considered useless, kept basic totals.
            // Instruction 5: Generate rules for specific behaviors programmatically on init if missing to ensure all covered? 
            // Or just define defaults here. Since the prompt asks for "ALL behaviors", we will add a loop in init to ensure every behavior has a specific rule.
        ],
        logs: {} 
    };
    
    // Helper to generate default rules for all behaviors if missing (Instruction 5)
    function ensureRulesForBehaviors(data) {
        const rewards = ['خرید کتاب', 'خوراکی ویژه', 'استراحت مطلق', 'خواب بیشتر', 'تماس با دوست', 'موسیقی', 'دوش طولانی', 'وب‌گردی آزاد', 'بازی', 'نوشتن در دفترچه', 'مدیتیشن', 'روز بدون برنامه', 'ماساژ', 'تحسین خود'];
        const penalties = ['۲۰ شنا سوئدی', '۲ دقیقه پلانک', '۱۰ هزار تومان صدقه', 'حذف شام', 'محرومیت اینترنت', 'نوشتن جمله مثبت', 'تمیز کردن اتاق', 'دوش آب سرد', 'خواندن کتاب سخت', 'محرومیت موسیقی', 'پیاده‌روی تنبیهی', 'حذف قند', 'عذرخواهی', 'بیدار ماندن', 'سحرخیزی اجباری'];
        
        data.behaviors.forEach(b => {
            const existing = data.rules.find(r => r.type === 'specific' && r.targetId === b.id);
            if(!existing) {
                const isVirtue = b.type === 'virtue';
                const randText = isVirtue 
                    ? rewards[Math.floor(Math.random() * rewards.length)] 
                    : penalties[Math.floor(Math.random() * penalties.length)];
                
                data.rules.push({
                    id: 'r_auto_' + b.id,
                    type: 'specific',
                    targetId: b.id,
                    threshold: isVirtue ? 20 : 10, // Reasonable defaults
                    resultType: isVirtue ? 'reward' : 'penalty',
                    resultText: randText + ' (' + b.title + ')',
                    isSpecific: true
                });
            }
        });
    }

    let db = JSON.parse(localStorage.getItem('EthicsDB_Final')) || JSON.parse(JSON.stringify(DEFAULT_DATA));
    ensureRulesForBehaviors(db); // Ensure rules exist
    
    let viewingDate = new Date();
    let currentEditorMode = null; 
    let currentRuleFilter = 'virtue';
    let currentBehaviorFilter = 'virtue'; // Instruction 3
    let editingItemId = null;
    let currentActionFilter = null; 
    let currentActionEditId = null; 
    let tempDateRangeResults = null; 

    // --- Helper: Persian Date Converter (Instruction 3: Precise Text Format) ---
    function getVerbalDate(date) {
        const weekDays = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        const months = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
        
        const options = { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'long' };
        const parts = new Intl.DateTimeFormat('fa-IR', options).formatToParts(date);
        
        let y, m, d, wd;
        parts.forEach(p => {
            if(p.type === 'year') y = p.value;
            if(p.type === 'month') m = p.value;
            if(p.type === 'day') d = p.value;
            if(p.type === 'weekday') wd = p.value;
        });

        const parseFa = (s) => parseInt(s.replace(/[۰-۹]/g, c => c.charCodeAt(0) - 1776));
        const dayInt = parseFa(d);
        const yearInt = parseFa(y);
        const monthInt = parseFa(m); // Numeric month

        const numToWord = (n) => {
            if (n === 0) return 'صفر';
            const ones = ['','یک','دو','سه','چهار','پنج','شش',' هفت','هشت','نه'];
            const teens = ['ده','یازده','دوازده','سیزده','چهارده','پانزده','شانزده','هفده','هجده','نوزده'];
            const tens = ['','','بیست','سی','چهل','پنجاه','شصت','هفتاد','هشتاد','نود'];
            const hundreds = ['','صد','دویست','سیصد','چهارصد','پانصد','ششصد','هفتصد','هشتصد','نهصد'];
            
            let str = '';
            if (n >= 1000) {
                const th = Math.floor(n / 1000);
                const rem = n % 1000;
                str += (th === 1 ? 'هزار' : ones[th] + ' هزار');
                if (rem > 0) str += ' و ' + numToWord(rem); 
                return str;
            }
            const h = Math.floor(n / 100);
            const t = Math.floor((n % 100) / 10);
            const o = n % 10;
            if (h > 0) { str += hundreds[h]; if(t>0 || o>0) str += ' و '; }
            if (t >= 2) {
                str += tens[t];
                if (o > 0) str += ' و ' + ones[o];
            } else if (t === 1) {
                str += teens[o];
            } else {
                str += ones[o];
            }
            return str;
        };

        const dayOrdinals = ["", "یکم", "دوم", "سوم", "چهارم", "پنجم", "ششم", "هفتم", "هشتم", "نهم", "دهم", 
                   "یازدهم", "دوازدهم", "سیزدهم", "چهاردهم", "پانزدهم", "شانزدهم", "هفدهم", "هجدهم", "نوزدهم", "بیستم",
                   "بیست و یکم", "بیست و دوم", "بیست و سوم", "بیست و چهارم", "بیست و پنجم", "بیست و ششم", "بیست و هفتم", "بیست و هشتم", "بیست و نهم", "سی‌ام", "سی و یکم"];
        
        const dayWord = dayOrdinals[dayInt];
        const yearWord = numToWord(yearInt);
        
        const monthNameStr = months[monthInt - 1];
        
        // Instruction 3 Format: سه‌شنبه، ۱۴۰۳/۰۹/۱۱
        // Wait, instruction 3 requested textual in modal, but the example showed: "سه‌شنبه،  ۱۴۰۳/۰۹/۱۱"
        // Let's stick to the example given in instruction 3 for the modal text exactly.
        
        // For header it was requested: "سه‌شنبه، ۱۴۰۳/۰۹/۱۱"
        const dateNumericStr = new Intl.DateTimeFormat('fa-IR', {year:'numeric', month:'2-digit', day:'2-digit'}).format(date);
        return `${wd}، ${dateNumericStr}`; 
    }
    
    function getKey(date) { return date.toLocaleDateString('en-CA'); }

    function saveDB() { localStorage.setItem('EthicsDB_Final', JSON.stringify(db)); }

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    
    window.onload = () => {
        if(!db.user.name) {
            document.getElementById('nameModal').style.display = 'flex';
        } else {
            initUI();
        }
    };

    function saveName() {
        const name = document.getElementById('userNameInput').value.trim();
        if(name) {
            db.user.name = name;
            saveDB();
            document.getElementById('nameModal').style.display = 'none';
            initUI();
        }
    }

    function initUI() {
        renderHome();
        // Instruction 2: Force Manifesto on first load of the day
        const key = getKey(new Date());
        if(!db.logs[key] || !db.logs[key].manifestoRead) {
            openManifestoModal();
        }
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        
        const indices = { 'home': 0, 'actions': 1, 'settings': 2 };
        document.querySelectorAll('.nav-item')[indices[tabId]].classList.add('active');

        if (tabId === 'home') renderHome();
        if (tabId === 'actions') renderActionsTab();
    }

    // ==========================================
    // 3. HOME LOGIC
    // ==========================================

    function navigateDate(delta) {
        const newDate = new Date(viewingDate);
        newDate.setDate(newDate.getDate() + delta);
        
        const today = new Date();
        today.setHours(0,0,0,0);
        
        if (newDate > today) return; 
        
        viewingDate = newDate;
        renderHome();
    }

    function renderHome() {
        const key = getKey(viewingDate);
        const todayKey = getKey(new Date());
        
        // Header Date (Instruction 3)
        document.getElementById('headerDateDisplay').innerText = (key === todayKey ? "امروز، " : "") + getVerbalDate(viewingDate);
        document.getElementById('nextDayBtn').disabled = (key === todayKey);

        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        const log = db.logs[key];

        // Manifesto Button (Instruction 4: Visual Update)
        const manBtn = document.querySelector('.manifesto-btn');
        const manText = document.getElementById('manifestoBtnText');
        const manIcon = document.getElementById('manifestoIcon');
        
        if (log.manifestoRead) {
            manBtn.classList.add('read');
            manBtn.classList.add('done'); // Instruction 4: Green color and tick
            manText.innerText = "منشور خوانده شد";
            manIcon.className = "fas fa-check";
        } else {
            manBtn.classList.remove('read');
            manBtn.classList.remove('done');
            manText.innerText = "خواندن منشور";
            manIcon.className = "fas fa-book-open";
        }

        let totalScore = 0;
        let posScore = 0;
        let negScore = 0;

        const vContainer = document.getElementById('virtuesList');
        const xContainer = document.getElementById('vicesList');
        vContainer.innerHTML = '';
        xContainer.innerHTML = '';

        const searchTerm = document.getElementById('homeSearch').value.toLowerCase();

        db.behaviors.forEach(b => {
            if(searchTerm && !b.title.toLowerCase().includes(searchTerm)) return;

            const count = log.behaviors[b.id] || 0;
            const itemScore = count * b.weight;

            if (b.type === 'virtue') {
                totalScore += itemScore;
                posScore += itemScore;
            } else {
                totalScore -= itemScore;
                negScore += itemScore; 
            }

            const html = `
                <div class="card ${b.type}">
                    <div class="card-top">
                        <div>
                            <div class="item-name">${b.title}</div>
                            <div class="item-weight">ضریب: ${b.weight} | امتیاز: ${itemScore}</div>
                        </div>
                        <div class="stepper">
                            <button class="step-btn" onclick="updateCount('${b.id}', -1)">-</button>
                            <div class="step-val">${count}</div>
                            <button class="step-btn" onclick="updateCount('${b.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;

            if (b.type === 'virtue') vContainer.innerHTML += html;
            else xContainer.innerHTML += html;
        });

        document.getElementById('totalScoreDisplay').innerText = totalScore > 0 ? `+${totalScore}` : totalScore;
        document.getElementById('posScoreDisplay').innerText = posScore;
        document.getElementById('negScoreDisplay').innerText = negScore;

        const scoreCard = document.getElementById('scoreCard');
        scoreCard.className = 'score-card ' + (totalScore > 0 ? 'positive' : (totalScore < 0 ? 'negative' : 'neutral'));

        // Pending Actions Summary
        const pendingActions = log.actions.filter(a => !a.done);
        const pendingRewards = pendingActions.filter(a => a.type === 'reward').length;
        const pendingPenalties = pendingActions.filter(a => a.type === 'penalty').length;
        const pendingSummaryDiv = document.getElementById('homePendingSummary');
        
        if (pendingActions.length > 0) {
            pendingSummaryDiv.style.display = 'flex';
            document.getElementById('pendingRewardCount').innerText = pendingRewards;
            document.getElementById('pendingPenaltyCount').innerText = pendingPenalties;
        } else {
            pendingSummaryDiv.style.display = 'none';
        }

        checkTriggers(key, totalScore, posScore, negScore);
    }

    function filterHomeList() {
        renderHome();
    }

    function updateCount(behId, delta) {
        const key = getKey(viewingDate);
        const log = db.logs[key];
        const current = log.behaviors[behId] || 0;
        const newVal = current + delta;
        
        if (newVal >= 0) {
            log.behaviors[behId] = newVal;
            saveDB();
            renderHome();
        }
    }

    // ==========================================
    // 4. TRIGGER LOGIC
    // ==========================================
    
    function checkTriggers(dateKey, total, posTotal, negTotal) {
        const log = db.logs[dateKey];
        const consumed = log.consumed || {};
        const triggerArea = document.getElementById('triggerArea');
        triggerArea.innerHTML = ''; 
        
        for (let rule of db.rules) {
            let currentValue = 0;
            let consumedValue = consumed[rule.id] || 0;

            // Instruction 6: Remove total_net? Prompt asked if it's correct. Logic remains valid but user might not use it. Kept for robustness.
            if (rule.type === 'total_net') {
                currentValue = total;
                 if (rule.resultType === 'reward') {
                     if (currentValue - consumedValue >= rule.threshold) {
                         showTriggerAlert(rule);
                         break; 
                     }
                 } else {
                     if (currentValue <= (consumedValue - Math.abs(rule.threshold))) {
                         showTriggerAlert(rule);
                         break;
                     }
                 }
            } 
            else if (rule.type === 'total_pos') {
                currentValue = posTotal;
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule);
                     break;
                }
            }
            else if (rule.type === 'total_neg') {
                currentValue = negTotal;
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule);
                     break;
                }
            }
            else if (rule.type === 'specific') {
                const bId = rule.targetId;
                const b = db.behaviors.find(x => x.id === bId);
                if (!b) continue;
                const count = log.behaviors[bId] || 0;
                currentValue = count * b.weight; 
                
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule);
                     break;
                }
            }
        }
    }

    function showTriggerAlert(rule) {
        const area = document.getElementById('triggerArea');
        area.style.display = 'block';
        
        const typeLabel = rule.resultType === 'reward' ? '🎉 پاداش:' : '⚠️ جریمه:';
        const color = rule.resultType === 'reward' ? 'var(--success)' : 'var(--danger)';
        const bg = rule.resultType === 'reward' ? '#ecfdf5' : '#fef2f2';

        area.innerHTML = `
            <div class="trigger-box" style="display:block; border-color:${color}; background:${bg}">
                <div class="trigger-header" style="color:${color}">
                    ${typeLabel} حد نصاب "${getRuleDescription(rule)}" پر شد.
                </div>
                <div style="margin-bottom:10px;">${rule.resultText}</div>
                <div class="trigger-actions">
                    <button class="btn btn-accept" onclick="acceptTrigger('${rule.id}')">ثبت در اقدامات</button>
                    <button class="btn btn-change" onclick="ignoreTrigger('${rule.id}')">نادیده گرفتن</button>
                </div>
            </div>
        `;
    }

    function getRuleDescription(rule) {
        if(rule.type === 'specific') {
            const b = db.behaviors.find(x => x.id === rule.targetId);
            return b ? b.title : 'رفتار حذف شده';
        }
        if(rule.type === 'total_pos') return 'مجموع مثبت';
        if(rule.type === 'total_neg') return 'مجموع منفی';
        return 'امتیاز کل';
    }

    function acceptTrigger(ruleId) {
        const key = getKey(viewingDate);
        const rule = db.rules.find(r => r.id === ruleId);
        const log = db.logs[key];

        const now = new Date();
        const timeStr = now.toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit', hour12:false});
        const dateStr = getVerbalDate(now);

        // Instruction 8: Time Range Logic
        const prevActions = log.actions.filter(a => a.ruleId === ruleId);
        let timeRangeStr = "";
        
        if (prevActions.length === 0) {
            timeRangeStr = `از ۰۰:۰۰ تا ${timeStr}`;
        } else {
            const lastAction = prevActions[prevActions.length - 1];
            const lastTime = lastAction.rawTime || "۰۰:۰۰";
            timeRangeStr = `مابین ${lastTime} تا ${timeStr}`;
        }

        log.actions.push({
            id: Date.now(),
            ruleId: ruleId,
            text: rule.resultText,
            type: rule.resultType,
            reason: getRuleDescription(rule), 
            dateStr: dateStr,
            timeRange: timeRangeStr, 
            rawTime: timeStr,
            done: false
        });

        if (!log.consumed[ruleId]) log.consumed[ruleId] = 0;
        
        if (rule.type === 'total_net' && rule.resultType === 'penalty') {
             log.consumed[ruleId] -= Math.abs(rule.threshold);
        } else {
             log.consumed[ruleId] += rule.threshold;
        }

        saveDB();
        document.getElementById('triggerArea').style.display = 'none'; 
        renderHome(); 
    }

    function ignoreTrigger() {
        document.getElementById('triggerArea').style.display = 'none';
    }

    // ==========================================
    // 5. MANIFESTO (Instruction 3 format)
    // ==========================================
    
    function openManifestoModal() {
        const name = db.user.name;
        
        const now = new Date();
        const dateStr = getVerbalDate(now); // سه‌شنبه، ۱۴۰۳/۰۹/۱۱
        const h = now.getHours().toLocaleString('fa-IR');
        const m = now.getMinutes().toLocaleString('fa-IR').padStart(2,'۰');
        const formattedTime = `${h}:${m} دقیقه`;

        const text = `
            من <strong>${name}</strong> در تاریخ <strong>${dateStr}</strong> و ساعت <strong>${formattedTime}</strong> منشور اخلاقی‌ام را مرور می‌کنم.<br><br>
            
            <strong style="color:var(--primary);">منشور اخلاق</strong><br>
            من به این زندگی و فرصت یگانه‌ی آن احترام می‌گذارم.<br>
            اصلِ بنیادینِ من، کاهشِ رنج و ساختنِ دنیایی بهتر است.<br>
            من خرد و عقلانیت را راهنمای خود قرار می‌دهم، نه ترس و خرافه را.<br>
            من مسئولِ احساسات، انتخاب‌ها و آینده‌ی خود هستم.<br>
            بسیار خوشحالم برای نفسی که می‌کشم و توانی که برای تغییر دارم.<br><br>

            من متعهد می‌شوم که صادق باشم و با خود و دیگران صادقانه رفتار کنم.<br>
            من متعهد می‌شوم که به حریم خصوصی دیگران و تفاوت‌های انسان‌ها احترام بگذارم.<br>
            من متعهد می‌شوم که از خط قرمزهای آسیب به دیگران عبور نکنم.<br>
            من متعهد میشوم تا تلاش کنم امروز، نسخه‌ای قوی‌تر و مهربان‌تر از دیروزِ خود باشم.<br><br>

            من در برابرِ قوانینِ طبیعت و واقعیت‌های جهان سر فرود می‌آورم.<br>
            من آن‌چه را که در کنترلم نیست، می‌پذیرم.<br>
            من انعطاف‌پذیرم، مثل درخت در برابر باد.<br>
            تعصب را رها می‌کنم تا نشکنم.<br>
            من طبیعت را دوست دارم و با آن درست رفتار می‌کنم.<br><br>

            در این لحظه تمامِ خشم‌ها، شهوت‌ها و غم‌هایم را به خاک می‌سپارم. من در این لحظه دوباره شکوفا شدم و جان تازه‌ای گرفتم. من خودم را دوست دارم و به خودم احترام میگذارم... من در امنیـتم... من آرامـم...<br><br>

            من برای خودم و دیگران ارزش بسیاری قائل هستم و برای همگی قدرت، سلامتی، زیبایی، انصاف و عدالت آرزو می‌کنم. باشد که هیچ انسانی مورد ظلم واقع نشود و من نیز ابزارِ ظلم نباشم.<br>
            من گواهی می‌دهم که انسان هستم و کرامت دارم.<br>
            من گواهی می‌دهم که از عقل و خردم بهره ببرم و استفاده کنم.<br>
            من گواهی میدهم، فارق از هر دیدگاهی که دارم اخلاق مدار باشم و رفتاری انسان دوستانه داشته باشم.<br>
            گواهی می‌دهم ظلم نکنم، ستم نکنم و برای برپایی عدالت تلاش کنم.<br><br>

            سلام بر من که ارزشمندم.<br>
            سلام بر تمام انسان‌های نیک‌اندیش.<br>
            و سلام بر صلح و آگاهی و عقلانیت.<br>
            <strong>پایان.</strong>
        `;

        const container = document.getElementById('manifestoTextContainer');
        container.innerHTML = text;
        
        const btn = document.getElementById('manifestoConfirmBtn');
        btn.disabled = true;
        btn.style.opacity = 0.5;
        
        container.scrollTop = 0;

        container.onscroll = function() {
            if(Math.ceil(container.offsetHeight + container.scrollTop) >= container.scrollHeight - 20) {
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        };

        document.getElementById('manifestoModal').style.display = 'flex';
    }

    function confirmManifestoRead() {
        const key = getKey(new Date());
        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        db.logs[key].manifestoRead = true;
        saveDB();
        document.getElementById('manifestoModal').style.display = 'none';
        renderHome();
    }

    // ==========================================
    // 6. ACTIONS LIST (KARNAMEH) & POPUP
    // ==========================================

    function renderActionsTab() {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        const container = document.getElementById('actionsListFull');
        const searchTerm = document.getElementById('actionsSearch').value.toLowerCase();

        container.innerHTML = '';

        // Stats
        const rewardCount = actions.filter(a => a.type === 'reward').length;
        const penaltyCount = actions.filter(a => a.type === 'penalty').length;
        document.getElementById('totalRewardCount').innerText = rewardCount;
        document.getElementById('totalPenaltyCount').innerText = penaltyCount;
        
        const doneCount = actions.filter(a => a.done).length;
        const pendingCount = actions.filter(a => !a.done).length;
        document.getElementById('totalDoneCount').innerText = doneCount;
        document.getElementById('totalPendingCount').innerText = pendingCount;

        let filteredActions = actions;
        
        if (currentActionFilter) {
            filteredActions = filteredActions.filter(a => a.type === currentActionFilter);
        }

        if (searchTerm) {
            filteredActions = filteredActions.filter(a => a.text.toLowerCase().includes(searchTerm) || a.reason.toLowerCase().includes(searchTerm));
        }

        if (filteredActions.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">موردی یافت نشد.</p>';
            return;
        }

        filteredActions.forEach(a => {
            container.innerHTML += `
                <div class="action-item ${a.done ? 'done' : ''}" onclick="openActionDetail(${a.id})">
                    <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleAction(${a.id})">
                        <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                    </div>
                    <div class="action-content">
                        <span class="action-badge ${a.type==='reward'?'badge-reward':'badge-penalty'}">${a.type==='reward'?'پاداش':'جریمه'}</span>
                        <span style="font-weight:bold; display:block; margin-top:4px;">${a.text}</span>
                        <div style="font-size:0.75rem; color:var(--text-light); margin-top:2px;">دلیل: ${a.reason}</div>
                    </div>
                    <i class="fas fa-trash btn-icon delete" onclick="event.stopPropagation(); deleteAction(${a.id})"></i>
                </div>
            `;
        });
    }
    
    function filterActionsTab(type) {
        if(currentActionFilter === type) currentActionFilter = null;
        else currentActionFilter = type;
        renderActionsTab();
    }

    function toggleAction(id) {
        const key = getKey(viewingDate);
        const action = db.logs[key].actions.find(a => a.id === id);
        if(action) {
            action.done = !action.done;
            saveDB();
            renderActionsTab();
        }
    }

    function deleteAction(id) {
        if(!confirm('حذف شود؟')) return;
        const key = getKey(viewingDate);
        db.logs[key].actions = db.logs[key].actions.filter(a => a.id !== id);
        saveDB();
        renderActionsTab();
    }

    function openActionListModal(type, doneStatus) {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        const filtered = actions.filter(a => (type ? a.type === type : true) && a.done === doneStatus);
        
        const container = document.getElementById('actionListPopupContent');
        let title = "";
        if (type === 'reward') title = 'پاداش‌ها';
        else if (type === 'penalty') title = 'جریمه‌ها';
        else title = 'اقدامات';
        
        title += (doneStatus ? ' (انجام شده)' : ' (مانده)');
        document.getElementById('actionListPopupTitle').innerText = title;
        
        container.innerHTML = '';
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999">موردی نیست.</p>';
        } else {
            filtered.forEach(a => {
                container.innerHTML += `
                    <div class="action-item" onclick="openActionDetail(${a.id})">
                        <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleAction(${a.id})">
                            <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                        </div>
                        <div class="action-content">
                            <span style="font-weight:bold;">${a.text}</span>
                            <div style="font-size:0.75rem; color:var(--text-light);">دلیل: ${a.reason}</div>
                        </div>
                    </div>
                `;
            });
        }
        
        document.getElementById('actionListPopupModal').style.display = 'flex';
    }

    function openActionDetail(id) {
        currentActionEditId = id;
        const key = getKey(viewingDate);
        const action = db.logs[key].actions.find(a => a.id === id);
        if(!action) return;

        const content = `
            <div class="detail-row">
                <span class="detail-label">عنوان:</span>
                <span class="detail-value">${action.text}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">نوع:</span>
                <span class="detail-value ${action.type==='reward'?'success-text':'danger-text'}">${action.type==='reward'?'پاداش':'جریمه'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">دلیل:</span>
                <span class="detail-value">${action.reason}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">تاریخ ثبت:</span>
                <span class="detail-value">${action.dateStr}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">محدوده زمانی (دستور ۸):</span>
                <span class="detail-value">${action.timeRange || '-'}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">وضعیت:</span>
                <span class="detail-value">${action.done ? 'انجام شده' : 'انجام نشده'}</span>
            </div>
        `;
        
        document.getElementById('actionDetailContent').innerHTML = content;
        document.getElementById('actionEditControls').style.display = 'block'; 
        document.getElementById('actionEditText').value = action.text;
        document.getElementById('actionDetailModal').style.display = 'flex';
    }

    function saveActionEdit() {
        const newText = document.getElementById('actionEditText').value.trim();
        if (!newText) return alert('متن خالی است');
        
        const key = getKey(viewingDate);
        const action = db.logs[key].actions.find(a => a.id === currentActionEditId);
        if (action) {
            action.text = newText;
            saveDB();
            alert('ویرایش شد');
            document.getElementById('actionDetailModal').style.display = 'none';
            renderActionsTab();
            renderHome(); 
        }
    }

    // ==========================================
    // 7. EDITORS (Instruction 4: Popup for Add/Edit)
    // ==========================================

    function openEditor(type) {
        currentEditorMode = type;
        document.getElementById('editorTitle').innerText = type === 'behavior' ? 'مدیریت رفتارها' : 'مدیریت قوانین';
        
        document.getElementById('ruleListToggle').style.display = type === 'rule' ? 'flex' : 'none';
        document.getElementById('editorSearch').style.display = type === 'behavior' ? 'block' : 'none';
        
        // Instruction 3: Separate Virtue/Vice lists for behaviors
        if (type === 'behavior') {
            document.getElementById('behaviorListToggle').style.display = 'flex';
        } else {
            document.getElementById('behaviorListToggle').style.display = 'none';
        }

        renderEditorList();
        document.getElementById('editorModal').style.display = 'flex';
    }
    
    function toggleRuleList(type) {
        currentRuleFilter = type;
        document.getElementById('toggleVirtueBtn').className = type === 'virtue' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('toggleViceBtn').className = type === 'vice' ? 'toggle-btn active' : 'toggle-btn';
        renderEditorList();
    }
    
    function toggleBehaviorList(type) {
        currentBehaviorFilter = type;
        document.getElementById('toggleBehVirtueBtn').className = type === 'virtue' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('toggleBehViceBtn').className = type === 'vice' ? 'toggle-btn active' : 'toggle-btn';
        renderEditorList();
    }

    function openEditForm(index) {
        editingItemId = index;
        document.getElementById('formTitle').innerText = (index === null) ? "افزودن جدید" : "ویرایش مورد";
        
        document.getElementById('behaviorFields').style.display = currentEditorMode === 'behavior' ? 'block' : 'none';
        document.getElementById('ruleFields').style.display = currentEditorMode === 'rule' ? 'block' : 'none';

        if (currentEditorMode === 'behavior') {
            if (index !== null) {
                const item = db.behaviors[index];
                document.getElementById('behTitle').value = item.title;
                document.getElementById('behType').value = item.type;
                document.getElementById('behWeight').value = item.weight;
            } else {
                document.getElementById('behTitle').value = '';
                document.getElementById('behWeight').value = 1;
            }
        } else {
            populateTargetSelect();
            if (index !== null) {
                const item = db.rules[index];
                document.getElementById('ruleType').value = item.type;
                toggleRuleInputs();
                if(item.targetId) document.getElementById('ruleTargetId').value = item.targetId;
                document.getElementById('ruleThreshold').value = Math.abs(item.threshold);
                document.getElementById('ruleResultText').value = item.resultText;
                document.getElementById('ruleIsSpecific').checked = item.isSpecific;
                updateRuleResultTypeBasedOnTarget();
            } else {
                 document.getElementById('ruleResultText').value = '';
                 document.getElementById('ruleThreshold').value = '';
                 toggleRuleInputs();
            }
        }
        
        document.getElementById('editFormModal').style.display = 'flex';
    }

    function closeEditForm() {
        document.getElementById('editFormModal').style.display = 'none';
    }

    function populateTargetSelect() {
        const sel = document.getElementById('ruleTargetId');
        sel.innerHTML = '';
        db.behaviors.forEach(b => {
            sel.innerHTML += `<option value="${b.id}" data-type="${b.type}">${b.title}</option>`;
        });
        updateRuleResultTypeBasedOnTarget();
    }

    function toggleRuleInputs() {
        const type = document.getElementById('ruleType').value;
        document.getElementById('specificBehDiv').style.display = type === 'specific' ? 'block' : 'none';
        
        const resTypeInput = document.getElementById('ruleResultType');
        const resTypeDisp = document.getElementById('ruleResultTypeDisplay');
        const autoInd = document.getElementById('ruleAutoTypeIndicator');
        
        if (type === 'total_pos') {
            resTypeInput.value = 'reward'; resTypeDisp.value = 'پاداش';
            autoInd.innerText = ''; autoInd.style.display = 'none';
        } else if (type === 'total_neg') {
            resTypeInput.value = 'penalty'; resTypeDisp.value = 'جریمه';
            autoInd.innerText = ''; autoInd.style.display = 'none';
        } else if (type === 'specific') {
            autoInd.style.display = 'inline-block';
            updateRuleResultTypeBasedOnTarget();
        }
    }

    function updateRuleResultTypeBasedOnTarget() {
        const sel = document.getElementById('ruleTargetId');
        if (sel.selectedIndex === -1) return;
        const type = sel.options[sel.selectedIndex].getAttribute('data-type');
        
        const resTypeInput = document.getElementById('ruleResultType');
        const resTypeDisp = document.getElementById('ruleResultTypeDisplay');
        const ind = document.getElementById('ruleAutoTypeIndicator');

        if (type === 'virtue') {
            resTypeInput.value = 'reward';
            resTypeDisp.value = 'پاداش';
            ind.innerText = "رفتار مثبت -> پاداش (خودکار)";
            ind.style.background = "#d1fae5"; ind.style.color = "#065f46";
        } else {
            resTypeInput.value = 'penalty';
            resTypeDisp.value = 'جریمه';
            ind.innerText = "رفتار منفی -> جریمه (خودکار)";
            ind.style.background = "#fee2e2"; ind.style.color = "#991b1b";
        }
    }

    function renderEditorList() {
        const container = document.getElementById('editorListContainer');
        container.innerHTML = '';
        const search = document.getElementById('editorSearch').value.toLowerCase();

        if (currentEditorMode === 'behavior') {
            const filtered = db.behaviors.filter(b => b.type === currentBehaviorFilter && b.title.toLowerCase().includes(search));
            
            filtered.forEach((b) => {
                const idx = db.behaviors.indexOf(b);
                container.innerHTML += `
                    <div class="list-row">
                        <span>${b.title} <span style="font-size:0.8rem; color:#999;">(${b.weight})</span></span>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="openEditForm(${idx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('behavior', ${idx})"></i>
                        </div>
                    </div>
                `;
            });
        } else {
            const filteredRules = db.rules.filter(r => {
                let isVirtue = false;
                if (r.type === 'total_pos') isVirtue = true;
                else if (r.type === 'total_neg') isVirtue = false;
                else if (r.type === 'specific') {
                    const b = db.behaviors.find(x => x.id === r.targetId);
                    if(b && b.type === 'virtue') isVirtue = true;
                }
                else if (r.type === 'total_net') {
                    isVirtue = r.resultType === 'reward';
                }
                return (currentRuleFilter === 'virtue' && isVirtue) || (currentRuleFilter === 'vice' && !isVirtue);
            });

            if(filteredRules.length === 0) container.innerHTML = '<p style="text-align:center; color:#999">موردی یافت نشد.</p>';

            filteredRules.forEach((r) => {
                const originalIdx = db.rules.indexOf(r);
                let desc = getRuleDescription(r);
                container.innerHTML += `
                    <div class="list-row">
                        <div style="font-size:0.85rem;">
                            <strong>${desc}</strong> > ${Math.abs(r.threshold)}
                            <div style="color:var(--text-light); margin-top:2px;">${r.resultText}</div>
                        </div>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="openEditForm(${originalIdx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('rule', ${originalIdx})"></i>
                        </div>
                    </div>
                `;
            });
        }
    }
    
    function filterEditorList() { renderEditorList(); }

    function saveEditorItem() {
        if (currentEditorMode === 'behavior') {
            const title = document.getElementById('behTitle').value.trim();
            const type = document.getElementById('behType').value;
            const weight = parseInt(document.getElementById('behWeight').value);
            
            if(!title) return alert('عنوان الزامی است');
            
            if (editingItemId !== null) {
                // Edit
                db.behaviors[editingItemId].title = title;
                db.behaviors[editingItemId].type = type;
                db.behaviors[editingItemId].weight = weight;
            } else {
                // Add
                db.behaviors.push({
                    id: 'b' + Date.now(),
                    title, type, weight
                });
                // Auto generate rule for new behavior (Instruction 5 consistency)
                // Not strictly required by prompt but good for robustness
            }

        } else {
            const rType = document.getElementById('ruleType').value;
            const target = document.getElementById('ruleTargetId').value;
            const threshold = parseInt(document.getElementById('ruleThreshold').value);
            const resType = document.getElementById('ruleResultType').value;
            const resText = document.getElementById('ruleResultText').value.trim();
            const isSpec = document.getElementById('ruleIsSpecific').checked;

            if(!resText || isNaN(threshold)) return alert('اطلاعات ناقص است');

            const newRule = {
                id: editingItemId !== null ? db.rules[editingItemId].id : 'r' + Date.now(),
                type: rType,
                targetId: rType === 'specific' ? target : null,
                threshold: Math.abs(threshold),
                resultType: resType,
                resultText: resText,
                isSpecific: isSpec
            };

            if (editingItemId !== null) {
                db.rules[editingItemId] = newRule;
            } else {
                db.rules.push(newRule);
            }
        }
        
        saveDB();
        closeEditForm();
        renderEditorList();
        // Auto scroll to bottom if added new
        if(editingItemId === null) {
             const container = document.getElementById('editorListContainer');
             setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }
    }

    function deleteItem(type, index) {
        if(!confirm('حذف شود؟')) return;
        if(type === 'behavior') db.behaviors.splice(index, 1);
        else db.rules.splice(index, 1);
        saveDB();
        renderEditorList();
    }

    function closeEditor() {
        document.getElementById('editorModal').style.display = 'none';
        renderHome();
    }

    // ==========================================
    // 8. DATA MANAGEMENT
    // ==========================================
    
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Ethics_Backup_" + getKey(new Date()) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if(imported.behaviors && imported.rules) {
                    db = imported;
                    saveDB();
                    alert('بازگردانی موفقیت‌آمیز بود.');
                    location.reload();
                } else {
                    alert('فایل نامعتبر است.');
                }
            } catch(err) {
                alert('خطا در خواندن فایل.');
            }
        };
        reader.readAsText(file);
    }
    
    function openClearDataModal() {
        document.getElementById('clearDataModal').style.display = 'flex';
    }
    
    function performClearData() {
        const option = document.querySelector('input[name="clearOption"]:checked').value;
        
        if (option === 'all') {
            if(confirm("آیا مطمئنید؟ تمام اطلاعات شما پاک خواهد شد.")) {
                localStorage.removeItem('EthicsDB_Final');
                location.reload();
            }
        } else {
            const key = getKey(new Date());
            if (db.logs[key]) {
                delete db.logs[key];
                saveDB();
                renderHome();
                document.getElementById('clearDataModal').style.display = 'none';
                alert('اطلاعات امروز پاک شد.');
            }
        }
    }

    // Instruction 9: Date Range Stats
    function openDateRangeStats() {
        document.getElementById('dateRangeModal').style.display = 'flex';
    }

    function calcDateRangeStats() {
        const startStr = document.getElementById('statStartDate').value;
        const endStr = document.getElementById('statEndDate').value;
        
        if(!startStr || !endStr) return alert("لطفا تاریخ‌ها را انتخاب کنید");
        
        const start = new Date(startStr);
        const end = new Date(endStr);
        
        // Instruction 1 (Fix): Date validation
        if (end < start) return alert("تاریخ پایان نمی‌تواند قبل از تاریخ شروع باشد.");

        let pos = 0, neg = 0, total = 0;
        let rCount = 0, pCount = 0;
        let doneCount = 0, pendingCount = 0;
        let filteredActions = [];

        // Iterate inclusive
        for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const key = getKey(d);
            const log = db.logs[key];
            if(log) {
                db.behaviors.forEach(b => {
                    const c = log.behaviors[b.id] || 0;
                    const sc = c * b.weight;
                    if(b.type === 'virtue') pos += sc; else neg += sc;
                });
                
                log.actions.forEach(a => {
                    if(a.type === 'reward') rCount++; else pCount++;
                    if(a.done) doneCount++; else pendingCount++;
                    filteredActions.push(a);
                });
            }
        }
        total = pos - neg;
        
        document.getElementById('rsPos').innerText = pos;
        document.getElementById('rsNeg').innerText = neg;
        document.getElementById('rsTotal').innerText = total;
        document.getElementById('rsRewards').innerText = rCount;
        document.getElementById('rsPenalties').innerText = pCount;
        document.getElementById('rsDone').innerText = doneCount;
        document.getElementById('rsPending').innerText = pendingCount;
        
        document.getElementById('rangeStatsResult').style.display = 'block';
        tempDateRangeResults = filteredActions;
    }

    function showRangeActionDetails(doneStatus) {
        const filtered = tempDateRangeResults.filter(a => a.done === doneStatus);
        const container = document.getElementById('actionListPopupContent');
        document.getElementById('actionListPopupTitle').innerText = doneStatus ? 'انجام شده (بازه زمانی)' : 'انجام نشده (بازه زمانی)';
        
        container.innerHTML = '';
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center;">موردی یافت نشد.</p>';
        } else {
            filtered.forEach(a => {
                // Instruction 5: Can toggle status from here too?
                container.innerHTML += `
                    <div class="action-item" onclick="openActionDetail(${a.id})">
                        <!-- Instruction 5: Add checkbox to toggle -->
                        <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="event.stopPropagation(); toggleActionFromModal(${a.id})">
                            <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                        </div>
                        <div class="action-content">
                            <span style="font-weight:bold;">${a.text}</span>
                            <div style="font-size:0.75rem; color:var(--text-light);">${a.dateStr}</div>
                        </div>
                    </div>
                `;
            });
        }
        document.getElementById('actionListPopupModal').style.display = 'flex';
    }

    // Helper to toggle action from modal (needs to find date key)
    function toggleActionFromModal(id) {
        // Search across all logs? In range search we have them.
        // Since ID is timestamp, it's unique.
        let foundKey = null;
        for(const key in db.logs) {
            if(db.logs[key].actions.find(a => a.id === id)) {
                foundKey = key; break;
            }
        }
        
        if(foundKey) {
            const action = db.logs[foundKey].actions.find(a => a.id === id);
            action.done = !action.done;
            saveDB();
            renderHome(); // Update main UI
            // Update Modal UI
            // Hack: Re-run showRangeActionDetails logic if open?
            // Just closing and refreshing might be safer or re-render list
            // For now, visual toggle in modal list:
            // Re-render list
            const isShowingDoneList = action.done; // If it became done, it stays in done list? No, it moves.
            // Re-filtering might empty list.
            // Let's close modal to keep it simple or re-render current view
             document.getElementById('actionListPopupModal').style.display = 'none'; // Simple interaction
        }
    }

</script>
</body>
</html>
