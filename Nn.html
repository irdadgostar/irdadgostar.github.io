<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ù¾Ø§ÛŒØ´ Ø§Ø®Ù„Ø§Ù‚ | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f0f4f8;
            --surface: #ffffff;
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #1e293b;
            --text-light: #64748b;
            --border-radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0; padding-bottom: 90px;
            overflow-x: hidden;
        }

        /* --- Components --- */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .btn {
            border: none; border-radius: 12px; padding: 12px 20px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            transition: transform 0.1s; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; width: 100%; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 2px solid #e2e8f0; color: var(--text-light); }

        /* --- Header & Score --- */
        .header-card {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 25px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4);
            margin-bottom: 20px;
            position: relative;
        }
        .date-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; font-size: 0.9rem; opacity: 0.9; }
        .score-display { font-size: 3.5rem; font-weight: 900; line-height: 1; margin: 10px 0; }
        .manifesto-badge {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px;
            font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 5px;
        }
        .manifesto-badge.done { background: var(--success); }

        /* --- Behavior Cards --- */
        .section-title { font-size: 1.1rem; font-weight: 800; margin: 25px 0 10px 0; display: flex; align-items: center; gap: 8px; }
        .card {
            background: var(--surface); border-radius: var(--border-radius); padding: 15px;
            margin-bottom: 12px; box-shadow: var(--shadow); display: flex; flex-direction: column;
            border-right: 4px solid transparent;
        }
        .card.virtue { border-right-color: var(--success); }
        .card.vice { border-right-color: var(--danger); }
        
        .card-row { display: flex; justify-content: space-between; align-items: center; }
        .item-title { font-weight: 700; font-size: 1rem; }
        .item-desc { font-size: 0.75rem; color: var(--text-light); margin-top: 2px; }
        
        .stepper { background: #f1f5f9; border-radius: 10px; display: flex; align-items: center; padding: 2px; }
        .step-btn { width: 32px; height: 32px; border: none; background: white; border-radius: 8px; font-size: 1.2rem; cursor: pointer; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .step-val { width: 30px; text-align: center; font-weight: bold; }

        /* --- Action (Reward/Penalty) List --- */
        .action-item {
            background: var(--surface); border-radius: 12px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow); transition: opacity 0.3s;
        }
        .action-item.done { opacity: 0.6; text-decoration: line-through; }
        .action-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid var(--text-light);
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .action-checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
        .action-type { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; margin-right: auto; }
        .type-reward { background: #d1fae5; color: #065f46; }
        .type-penalty { background: #fee2e2; color: #991b1b; }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
            z-index: 1000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 24px;
            padding: 25px; max-height: 85vh; overflow-y: auto; position: relative;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Manifesto Specific */
        .manifesto-text {
            line-height: 1.8; text-align: justify; font-size: 0.95rem;
            border: 1px solid #e2e8f0; padding: 15px; border-radius: 12px;
            margin: 15px 0; max-height: 300px; overflow-y: auto;
            background: #f8fafc;
        }
        .manifesto-header { text-align: center; font-weight: bold; color: var(--primary); margin-bottom: 10px; }

        /* Bottom Nav */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            border-top-left-radius: 20px; border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05); z-index: 900;
        }
        .nav-btn {
            background: none; border: none; display: flex; flex-direction: column;
            align-items: center; color: var(--text-light); gap: 4px; font-size: 0.7rem; cursor: pointer;
        }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-btn.active { color: var(--primary); }

        /* Settings Inputs */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        .input-box { flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; }

    </style>
</head>
<body>

<!-- Main App -->
<div id="app" style="display:none;">
    
    <!-- Tab: Tracker -->
    <div id="tab-home" class="tab-view">
        <div class="container">
            <div class="header-card">
                <div class="manifesto-badge" onclick="openManifesto()">
                    <i class="fas fa-book-open"></i> <span id="manifestoStatusText">Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù†Ø´ÙˆØ±</span>
                </div>
                <div class="date-nav">
                    <i class="fas fa-chevron-right" onclick="changeDate(-1)"></i>
                    <span id="dateDisplay">...</span>
                    <i class="fas fa-chevron-left" onclick="changeDate(1)"></i>
                </div>
                <div style="font-size: 0.9rem; opacity: 0.8;">Ø§Ù…ØªÛŒØ§Ø² Ø§Ù…Ø±ÙˆØ²</div>
                <div class="score-display" id="dailyScore">0</div>
            </div>

            <!-- Action List Preview (Only showing pending) -->
            <div id="pendingActionsArea" style="display:none;">
                <div class="section-title" style="color: var(--warning);">
                    <i class="fas fa-clipboard-list"></i> Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡
                </div>
                <div id="pendingList"></div>
            </div>

            <div class="section-title virtue">
                <i class="fas fa-seedling"></i> ÙØ¶Ø§ÛŒÙ„ (Ø±Ø´Ø¯ Ø¯Ù‡Ù†Ø¯Ù‡)
            </div>
            <div id="virtuesList"></div>

            <div class="section-title vice">
                <i class="fas fa-ban"></i> Ø±Ø°Ø§ÛŒÙ„ (Ø¢Ø³ÛŒØ¨ Ø²Ù†Ù†Ø¯Ù‡)
            </div>
            <div id="vicesList"></div>
        </div>
    </div>

    <!-- Tab: Actions (Rewards/Penalties) -->
    <div id="tab-actions" class="tab-view" style="display:none;">
        <div class="container">
            <h2 style="margin-top:0;">Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…Ø¯Ù‡Ø§</h2>
            <p style="color:var(--text-light); font-size:0.9rem;">Ù„ÛŒØ³Øª Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§ Ùˆ Ø¬Ø±ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² Ø´Ù…Ø§. ØªÛŒÚ© Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø«Ø¨Øª Ø´ÙˆØ¯.</p>
            
            <div id="todayActionsList"></div>

            <div style="margin-top:30px; padding-top:20px; border-top:1px solid #e2e8f0;">
                <h3>Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø³ÛŒØ³ØªÙ…</h3>
                <div class="card">
                    <p id="suggestionText" style="text-align:center; color:var(--text-light);">Ø§Ù…ØªÛŒØ§Ø² Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø¨Ù‡ Ø­Ø¯ Ù†ØµØ§Ø¨ Ù†Ø±Ø³ÛŒØ¯Ù‡ Ø§Ø³Øª.</p>
                    <div id="suggestionButtons" style="display:none; gap:10px; margin-top:10px;">
                        <button class="btn btn-primary" onclick="acceptSuggestion()">Ø«Ø¨Øª Ø¯Ø± Ù„ÛŒØ³Øª Ø§Ù…Ø±ÙˆØ²</button>
                        <button class="btn btn-outline" onclick="generateSuggestion()">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¯ÛŒÚ¯Ø± ğŸ²</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab: Settings -->
    <div id="tab-settings" class="tab-view" style="display:none;">
        <div class="container">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…</h2>
            
            <div class="card">
                <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙØªØ§Ø±Ù‡Ø§</h3>
                <button class="btn btn-outline" onclick="openBehaviorEditor()">ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒØ³Øª ÙØ¶Ø§ÛŒÙ„/Ø±Ø°Ø§ÛŒÙ„</button>
            </div>

            <div class="card">
                <h3>Ø¨Ø§Ù†Ú© Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø¬Ø±ÛŒÙ…Ù‡</h3>
                <button class="btn btn-outline" onclick="openRewardPenaltyEditor()">ÙˆÛŒØ±Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù¾Ø§Ø¯Ø§Ø´/Ø¬Ø±ÛŒÙ…Ù‡</button>
            </div>

            <div class="card">
                <h3>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h3>
                <button class="btn btn-success" onclick="exportData()">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø³Ø®Ù‡ Ù¾Ø´ØªÛŒØ¨Ø§Ù† (JSON)</button>
                <input type="file" id="importFile" style="display:none" onchange="importData(this)">
                <button class="btn btn-outline" style="margin-top:10px;" onclick="document.getElementById('importFile').click()">Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>
            
            <br><br><br>
        </div>
    </div>

</div>

<!-- Bottom Nav -->
<div class="nav-bar" id="navBar" style="display:none;">
    <button class="nav-btn active" onclick="switchTab('home')">
        <i class="fas fa-home"></i> Ø®Ø§Ù†Ù‡
    </button>
    <button class="nav-btn" onclick="switchTab('actions')">
        <i class="fas fa-tasks"></i> Ø§Ù‚Ø¯Ø§Ù…Ø§Øª
    </button>
    <button class="nav-btn" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i> ØªÙ†Ø¸ÛŒÙ…Ø§Øª
    </button>
</div>

<!-- Modal: Onboarding (Name) -->
<div id="onboardingModal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <h2>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
        <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø¯Ø± Ù…Ù†Ø´ÙˆØ± Ø§Ø®Ù„Ø§Ù‚ÛŒ Ø«Ø¨Øª Ø´ÙˆØ¯.</p>
        <input type="text" id="userNameInput" class="input-box" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§..." style="width:100%; text-align:center; font-size:1.2rem;">
        <br><br>
        <button class="btn btn-primary" onclick="saveUserName()">Ø´Ø±ÙˆØ¹ Ø³ÙØ±</button>
    </div>
</div>

<!-- Modal: Manifesto -->
<div id="manifestoModal" class="modal-overlay">
    <div class="modal-content">
        <div class="manifesto-header">
            <h3>ØªØ¬Ø¯ÛŒØ¯ Ù…ÛŒØ«Ø§Ù‚ Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
            <div style="font-size:0.8rem; color:var(--text-light);" id="manifestoDate"></div>
        </div>
        <div class="manifesto-text" id="manifestoTextContent">
            <!-- Content injected via JS -->
        </div>
        <button id="manifestoBtn" class="btn btn-primary" disabled onclick="confirmManifesto()">Ø®ÙˆØ§Ù†Ø¯Ù… Ùˆ Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ…</button>
        <p style="font-size:0.7rem; color:red; text-align:center; margin-top:5px;">(Ù„Ø·ÙØ§Ù‹ ØªØ§ Ø§Ù†ØªÙ‡Ø§ Ø§Ø³Ú©Ø±ÙˆÙ„ Ú©Ù†ÛŒØ¯)</p>
    </div>
</div>

<!-- Modal: Editors -->
<div id="editorModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="editorTitle">ÙˆÛŒØ±Ø§ÛŒØ´</h3>
        <div id="editorList" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        <div class="input-group">
            <input type="text" id="editorInput" class="input-box" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯...">
            <!-- Extra inputs depending on type -->
            <input type="number" id="editorWeight" class="input-box" placeholder="Ø¶Ø±ÛŒØ¨" style="width:70px; display:none;">
            <select id="editorType" class="input-box" style="display:none;">
                <option value="virtue">ÙØ¶ÛŒÙ„Øª</option>
                <option value="vice">Ø±Ø°ÛŒÙ„Øª</option>
            </select>
            <button class="btn btn-success" onclick="editorAddItem()">+</button>
        </div>
        <button class="btn btn-outline" onclick="document.getElementById('editorModal').style.display='none'">Ø¨Ø³ØªÙ†</button>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const DEFAULT_DATA = {
        user: { name: "" },
        behaviors: [
            { id: 'v1', title: 'Ø®Ø±Ø¯ÙˆØ±Ø²ÛŒ Ùˆ Ù…Ø·Ø§Ù„Ø¹Ù‡', type: 'virtue', weight: 2 },
            { id: 'v2', title: 'Ø§Ù†Ø¶Ø¨Ø§Ø· Ø´Ø®ØµÛŒ (ÙˆØ±Ø²Ø´/Ø³Ø­Ø±Ø®ÛŒØ²ÛŒ)', type: 'virtue', weight: 2 },
            { id: 'v3', title: 'ØµØ¯Ø§Ù‚Øª Ùˆ Ø±Ø§Ø³ØªÛŒ', type: 'virtue', weight: 3 },
            { id: 'v4', title: 'Ú©Ù…Ú© Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù†', type: 'virtue', weight: 2 },
            { id: 'v5', title: 'Ú©Ù†ØªØ±Ù„ Ø®Ø´Ù… Ùˆ Ø³Ú©ÙˆØª', type: 'virtue', weight: 2 },
            { id: 'x1', title: 'Ø¯Ø±ÙˆØº', type: 'vice', weight: 3 },
            { id: 'x2', title: 'ØªÙ†Ø¨Ù„ÛŒ Ùˆ Ø§Ù‡Ù…Ø§Ù„', type: 'vice', weight: 1 },
            { id: 'x3', title: 'Ø¢Ø³ÛŒØ¨ Ú©Ù„Ø§Ù…ÛŒ/ÙÛŒØ²ÛŒÚ©ÛŒ', type: 'vice', weight: 3 },
            { id: 'x4', title: 'Ù‚Ø¶Ø§ÙˆØª Ùˆ ØºÛŒØ¨Øª', type: 'vice', weight: 2 },
            { id: 'x5', title: 'ØªÙˆØ¬ÛŒÙ‡ Ø§Ø´ØªØ¨Ø§Ù‡', type: 'vice', weight: 1 }
        ],
        rewardsList: [
            { text: 'Ø¯ÛŒØ¯Ù† ÛŒÚ© ÙÛŒÙ„Ù… Ø®ÙˆØ¨', threshold: 5 },
            { text: 'Ø®Ø±ÛŒØ¯ ÛŒÚ© Ú©ØªØ§Ø¨', threshold: 10 },
            { text: 'Ø®ÙˆØ±Ø¯Ù† ØºØ°Ø§ÛŒ Ù…Ø­Ø¨ÙˆØ¨', threshold: 5 },
            { text: 'ÛŒÚ© Ø³Ø§Ø¹Øª Ø§Ø³ØªØ±Ø§Ø­Øª Ù…Ø·Ù„Ù‚', threshold: 3 }
        ],
        penaltiesList: [
            { text: 'Û²Û° Ø´Ù†Ø§ Ø³ÙˆØ¦Ø¯ÛŒ', threshold: -3 },
            { text: 'Û±Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† ØµØ¯Ù‚Ù‡', threshold: -5 },
            { text: 'Ø­Ø°Ù Ø´Ø§Ù…', threshold: -5 },
            { text: 'Ù…Ø­Ø±ÙˆÙ…ÛŒØª Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª (Û± Ø³Ø§Ø¹Øª)', threshold: -3 }
        ],
        logs: {} 
    };

    // --- STATE ---
    let db = JSON.parse(localStorage.getItem('AMIR_ETHICS_DB')) || JSON.parse(JSON.stringify(DEFAULT_DATA));
    let viewingDate = new Date();
    let currentEditorType = ''; // 'behavior' or 'reward_penalty'

    // --- INIT ---
    window.onload = function() {
        if (!db.user.name) {
            document.getElementById('onboardingModal').style.display = 'flex';
        } else {
            initApp();
        }
    };

    function initApp() {
        document.getElementById('app').style.display = 'block';
        document.getElementById('navBar').style.display = 'flex';
        renderUI();
    }

    function saveUserName() {
        const name = document.getElementById('userNameInput').value.trim();
        if(name) {
            db.user.name = name;
            saveDB();
            document.getElementById('onboardingModal').style.display = 'none';
            initApp();
        }
    }

    function saveDB() {
        localStorage.setItem('AMIR_ETHICS_DB', JSON.stringify(db));
    }

    // --- DATE HELPERS ---
    function getDateKey(date) {
        return date.toLocaleDateString('en-CA'); // YYYY-MM-DD
    }

    function getPersianDateStr(date) {
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        return date.toLocaleDateString('fa-IR', options);
    }

    function numToPersian(n) {
        const farsiDigits = ['Û°', 'Û±', 'Û²', 'Û³', 'Û´', 'Ûµ', 'Û¶', 'Û·', 'Û¸', 'Û¹'];
        return n.toString().replace(/\d/g, x => farsiDigits[x]);
    }

    // --- MANIFESTO ---
    function openManifesto() {
        const todayKey = getDateKey(new Date());
        // Check if already read today? (Optional logic, currently allows re-reading)
        
        const now = new Date();
        const dateStr = getPersianDateStr(now);
        const timeStr = now.toLocaleTimeString('fa-IR', {hour: '2-digit', minute:'2-digit'});
        const name = db.user.name;

        document.getElementById('manifestoDate').innerText = dateStr;
        
        const text = `
Ù…Ù† <strong>${name}</strong> Ø¯Ø± ØªØ§Ø±ÛŒØ® <strong>${dateStr}</strong> Ùˆ Ø³Ø§Ø¹Øª <strong>${timeStr}</strong> Ù…Ù†Ø´ÙˆØ± Ø§Ø®Ù„Ø§Ù‚ÛŒâ€ŒØ§Ù… Ø±Ø§ Ù…Ø±ÙˆØ± Ù…ÛŒâ€ŒÚ©Ù†Ù….<br><br>
<span style="color:var(--primary); font-weight:bold;">Ù…Ù†Ø´ÙˆØ± Ø§Ø®Ù„Ø§Ù‚</span><br>
Ù…Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ø²Ù†Ø¯Ú¯ÛŒ Ùˆ ÙØ±ØµØª ÛŒÚ¯Ø§Ù†Ù‡â€ŒÛŒ Ø¢Ù† Ø§Ø­ØªØ±Ø§Ù… Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù….<br>
Ø§ØµÙ„Ù Ø¨Ù†ÛŒØ§Ø¯ÛŒÙ†Ù Ù…Ù†ØŒ Ú©Ø§Ù‡Ø´Ù Ø±Ù†Ø¬ Ùˆ Ø³Ø§Ø®ØªÙ†Ù Ø¯Ù†ÛŒØ§ÛŒÛŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª.<br>
Ù…Ù† Ø®Ø±Ø¯ Ùˆ Ø¹Ù‚Ù„Ø§Ù†ÛŒØª Ø±Ø§ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø®ÙˆØ¯ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ù…ØŒ Ù†Ù‡ ØªØ±Ø³ Ùˆ Ø®Ø±Ø§ÙÙ‡ Ø±Ø§.<br>
Ù…Ù† Ù…Ø³Ø¦ÙˆÙ„Ù Ø§Ø­Ø³Ø§Ø³Ø§ØªØŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ùˆ Ø¢ÛŒÙ†Ø¯Ù‡â€ŒÛŒ Ø®ÙˆØ¯ Ù‡Ø³ØªÙ….<br>
Ø¨Ø³ÛŒØ§Ø± Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ù†ÙØ³ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒÚ©Ø´Ù… Ùˆ ØªÙˆØ§Ù†ÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¯Ø§Ø±Ù….<br><br>
Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… Ú©Ù‡ ØµØ§Ø¯Ù‚ Ø¨Ø§Ø´Ù… Ùˆ Ø¨Ø§ Ø®ÙˆØ¯ Ùˆ Ø¯ÛŒÚ¯Ø±Ø§Ù† ØµØ§Ø¯Ù‚Ø§Ù†Ù‡ Ø±ÙØªØ§Ø± Ú©Ù†Ù….<br>
Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… Ú©Ù‡ Ø¨Ù‡ Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ùˆ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø³Ø§Ù†â€ŒÙ‡Ø§ Ø§Ø­ØªØ±Ø§Ù… Ø¨Ú¯Ø°Ø§Ø±Ù….<br>
Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… Ú©Ù‡ Ø§Ø² Ø®Ø· Ù‚Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¢Ø³ÛŒØ¨ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¹Ø¨ÙˆØ± Ù†Ú©Ù†Ù….<br>
Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… ØªØ§ ØªÙ„Ø§Ø´ Ú©Ù†Ù… Ø§Ù…Ø±ÙˆØ²ØŒ Ù†Ø³Ø®Ù‡â€ŒØ§ÛŒ Ù‚ÙˆÛŒâ€ŒØªØ± Ùˆ Ù…Ù‡Ø±Ø¨Ø§Ù†â€ŒØªØ± Ø§Ø² Ø¯ÛŒØ±ÙˆØ²Ù Ø®ÙˆØ¯ Ø¨Ø§Ø´Ù….<br><br>
Ù…Ù† Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø±Ù Ù‚ÙˆØ§Ù†ÛŒÙ†Ù Ø·Ø¨ÛŒØ¹Øª Ùˆ ÙˆØ§Ù‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬Ù‡Ø§Ù† Ø³Ø± ÙØ±ÙˆØ¯ Ù…ÛŒâ€ŒØ¢ÙˆØ±Ù….<br>
Ù…Ù† Ø¢Ù†â€ŒÚ†Ù‡ Ø±Ø§ Ú©Ù‡ Ø¯Ø± Ú©Ù†ØªØ±Ù„Ù… Ù†ÛŒØ³ØªØŒ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù….<br>
Ù…Ù† Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±Ù…ØŒ Ù…Ø«Ù„ Ø¯Ø±Ø®Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§Ø¯.<br>
ØªØ¹ØµØ¨ Ø±Ø§ Ø±Ù‡Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ù… ØªØ§ Ù†Ø´Ú©Ù†Ù….<br>
Ù…Ù† Ø·Ø¨ÛŒØ¹Øª Ø±Ø§ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ùˆ Ø¨Ø§ Ø¢Ù† Ø¯Ø±Ø³Øª Ø±ÙØªØ§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù….<br><br>
Ø¯Ø± Ø§ÛŒÙ† Ù„Ø­Ø¸Ù‡ ØªÙ…Ø§Ù…Ù Ø®Ø´Ù…â€ŒÙ‡Ø§ØŒ Ø´Ù‡ÙˆØªâ€ŒÙ‡Ø§ Ùˆ ØºÙ…â€ŒÙ‡Ø§ÛŒÙ… Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ú© Ù…ÛŒâ€ŒØ³Ù¾Ø§Ø±Ù…. Ù…Ù† Ø¯Ø± Ø§ÛŒÙ† Ù„Ø­Ø¸Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ú©ÙˆÙØ§ Ø´Ø¯Ù… Ùˆ Ø¬Ø§Ù† ØªØ§Ø²Ù‡â€ŒØ§ÛŒ Ú¯Ø±ÙØªÙ…. Ù…Ù† Ø®ÙˆØ¯Ù… Ø±Ø§ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ùˆ Ø¨Ù‡ Ø®ÙˆØ¯Ù… Ø§Ø­ØªØ±Ø§Ù… Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù…... Ù…Ù† Ø¯Ø± Ø§Ù…Ù†ÛŒÙ€ØªÙ…... Ù…Ù† Ø¢Ø±Ø§Ù…Ù€Ù…...<br><br>
Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ù… Ùˆ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø§Ø±Ø²Ø´ Ø¨Ø³ÛŒØ§Ø±ÛŒ Ù‚Ø§Ø¦Ù„ Ù‡Ø³ØªÙ… Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯ÛŒ Ù‚Ø¯Ø±ØªØŒ Ø³Ù„Ø§Ù…ØªÛŒØŒ Ø²ÛŒØ¨Ø§ÛŒÛŒØŒ Ø§Ù†ØµØ§Ù Ùˆ Ø¹Ø¯Ø§Ù„Øª Ø¢Ø±Ø²Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ù‡ÛŒÚ† Ø§Ù†Ø³Ø§Ù†ÛŒ Ù…ÙˆØ±Ø¯ Ø¸Ù„Ù… ÙˆØ§Ù‚Ø¹ Ù†Ø´ÙˆØ¯ Ùˆ Ù…Ù† Ù†ÛŒØ² Ø§Ø¨Ø²Ø§Ø±Ù Ø¸Ù„Ù… Ù†Ø¨Ø§Ø´Ù….<br><br>
Ù…Ù† Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ú©Ù‡ Ø§Ù†Ø³Ø§Ù† Ù‡Ø³ØªÙ… Ùˆ Ú©Ø±Ø§Ù…Øª Ø¯Ø§Ø±Ù….<br>
Ù…Ù† Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ú©Ù‡ Ø§Ø² Ø¹Ù‚Ù„ Ùˆ Ø®Ø±Ø¯Ù… Ø¨Ù‡Ø±Ù‡ Ø¨Ø¨Ø±Ù… Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù….<br>
Ù…Ù† Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù…ØŒ ÙØ§Ø±Øº Ø§Ø² Ù‡Ø± Ø¯ÛŒØ¯Ú¯Ø§Ù‡ÛŒ Ú©Ù‡ Ø¯Ø§Ø±Ù… Ø§Ø®Ù„Ø§Ù‚â€ŒÙ…Ø¯Ø§Ø± Ø¨Ø§Ø´Ù… Ùˆ Ø±ÙØªØ§Ø±ÛŒ Ø§Ù†Ø³Ø§Ù†â€ŒØ¯ÙˆØ³ØªØ§Ù†Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù….<br>
Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ø¸Ù„Ù… Ù†Ú©Ù†Ù…ØŒ Ø³ØªÙ… Ù†Ú©Ù†Ù… Ùˆ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù¾Ø§ÛŒÛŒ Ø¹Ø¯Ø§Ù„Øª ØªÙ„Ø§Ø´ Ú©Ù†Ù….<br><br>
Ø³Ù„Ø§Ù… Ø¨Ø± Ù…Ù† Ú©Ù‡ Ø§Ø±Ø²Ø´Ù…Ù†Ø¯Ù….<br>
Ø³Ù„Ø§Ù… Ø¨Ø± ØªÙ…Ø§Ù… Ø§Ù†Ø³Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù†ÛŒÚ©â€ŒØ§Ù†Ø¯ÛŒØ´.<br>
Ùˆ Ø³Ù„Ø§Ù… Ø¨Ø± ØµÙ„Ø­ Ùˆ Ø¢Ú¯Ø§Ù‡ÛŒ Ùˆ Ø¹Ù‚Ù„Ø§Ù†ÛŒØª.<br>
<strong>Ù¾Ø§ÛŒØ§Ù†.</strong>
        `;
        
        const container = document.getElementById('manifestoTextContent');
        container.innerHTML = text;
        
        // Scroll Logic
        const btn = document.getElementById('manifestoBtn');
        btn.disabled = true;
        btn.innerText = "Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯...";
        
        container.onscroll = function() {
            if (container.offsetHeight + container.scrollTop >= container.scrollHeight - 10) {
                btn.disabled = false;
                btn.innerText = "Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ…";
            }
        };

        document.getElementById('manifestoModal').style.display = 'flex';
    }

    function confirmManifesto() {
        const key = getDateKey(new Date()); // Always marks today
        if (!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false };
        
        db.logs[key].manifestoRead = true;
        saveDB();
        document.getElementById('manifestoModal').style.display = 'none';
        renderUI();
    }

    // --- CORE LOGIC ---

    function changeDate(offset) {
        viewingDate.setDate(viewingDate.getDate() + offset);
        renderUI();
    }

    function renderUI() {
        const key = getDateKey(viewingDate);
        const todayKey = getDateKey(new Date());
        const isToday = key === todayKey;

        document.getElementById('dateDisplay').innerText = isToday ? "Ø§Ù…Ø±ÙˆØ²" : getPersianDateStr(viewingDate);

        // Ensure log structure
        if (!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false };
        const dayLog = db.logs[key];

        // Manifesto Badge
        const manBadge = document.querySelector('.manifesto-badge');
        if (dayLog.manifestoRead) {
            manBadge.classList.add('done');
            document.getElementById('manifestoStatusText').innerText = "Ù…Ù†Ø´ÙˆØ± Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯";
        } else {
            manBadge.classList.remove('done');
            document.getElementById('manifestoStatusText').innerText = "Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù†Ø´ÙˆØ±";
        }

        // Render Behaviors & Score
        let score = 0;
        const vContainer = document.getElementById('virtuesList');
        const xContainer = document.getElementById('vicesList');
        vContainer.innerHTML = '';
        xContainer.innerHTML = '';

        db.behaviors.forEach(b => {
            const count = dayLog.behaviors[b.id] || 0;
            
            if (b.type === 'virtue') score += (count * b.weight);
            else score -= (count * b.weight);

            const html = `
                <div class="card ${b.type}">
                    <div class="card-row">
                        <div>
                            <div class="item-title">${b.title}</div>
                            <div class="item-desc">Ø¶Ø±ÛŒØ¨ Ø§Ø«Ø±: ${b.weight}</div>
                        </div>
                        <div class="stepper">
                            <button class="step-btn" onclick="updateCount('${b.id}', -1)">-</button>
                            <div class="step-val">${count}</div>
                            <button class="step-btn" onclick="updateCount('${b.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;
            
            if(b.type === 'virtue') vContainer.innerHTML += html;
            else xContainer.innerHTML += html;
        });

        document.getElementById('dailyScore').innerText = score;
        
        // Check Thresholds for Suggestions (Only if Today)
        if (isToday) {
            checkSuggestions(score);
        }

        // Render Actions (Pending & Done)
        renderActions(dayLog.actions, isToday);
    }

    function updateCount(id, delta) {
        const key = getDateKey(viewingDate);
        if (!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false };
        
        const current = db.logs[key].behaviors[id] || 0;
        const newVal = current + delta;
        
        if (newVal >= 0) {
            db.logs[key].behaviors[id] = newVal;
            saveDB();
            renderUI();
        }
    }

    // --- ACTIONS (Rewards/Penalties) ---

    let currentSuggestion = null;

    function checkSuggestions(score) {
        const suggestionText = document.getElementById('suggestionText');
        const buttons = document.getElementById('suggestionButtons');
        
        // Simple logic: Suggest something based on score polarity
        let pool = [];
        let type = '';

        if (score >= 5) {
            type = 'reward';
            pool = db.rewardsList.filter(r => r.threshold <= score);
            if(pool.length === 0) pool = db.rewardsList; // fallback
        } else if (score <= -3) {
            type = 'penalty';
            pool = db.penaltiesList.filter(p => p.threshold >= score); // logic: -5 <= -3
            if(pool.length === 0) pool = db.penaltiesList;
        }

        if (type) {
            // Pick random
            if (!currentSuggestion || currentSuggestion.type !== type) {
                const item = pool[Math.floor(Math.random() * pool.length)];
                currentSuggestion = { ...item, type: type };
            }
            
            const color = type === 'reward' ? 'var(--success)' : 'var(--danger)';
            suggestionText.innerHTML = `<strong style="color:${color}">${type === 'reward' ? 'Ù¾Ø§Ø¯Ø§Ø´ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:' : 'Ø¬Ø±ÛŒÙ…Ù‡ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ:'}</strong> <br> ${currentSuggestion.text}`;
            buttons.style.display = 'flex';
        } else {
            currentSuggestion = null;
            suggestionText.innerText = "Ø§Ù…ØªÛŒØ§Ø² ÙØ¹Ù„ÛŒ Ø¯Ø± Ù…Ø­Ø¯ÙˆØ¯Ù‡ Ø®Ù†Ø«ÛŒ Ø§Ø³Øª. Ø§Ø¯Ø§Ù…Ù‡ Ø¯Ù‡ÛŒØ¯...";
            buttons.style.display = 'none';
        }
    }

    function generateSuggestion() {
        currentSuggestion = null; // Force reset
        renderUI(); // Will trigger checkSuggestions
    }

    function acceptSuggestion() {
        if (!currentSuggestion) return;
        const key = getDateKey(viewingDate);
        const action = {
            id: Date.now(),
            text: currentSuggestion.text,
            type: currentSuggestion.type,
            done: false
        };
        db.logs[key].actions.push(action);
        saveDB();
        renderUI();
        alert("Ø¯Ø± Ù„ÛŒØ³Øª Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø«Ø¨Øª Ø´Ø¯.");
    }

    function renderActions(actions, isToday) {
        // Two places to render: 
        // 1. Pending list in Home Tab (only pending)
        // 2. Full list in Actions Tab (all)

        const pendingContainer = document.getElementById('pendingList');
        const fullContainer = document.getElementById('todayActionsList');
        const pendingArea = document.getElementById('pendingActionsArea');

        pendingContainer.innerHTML = '';
        fullContainer.innerHTML = '';

        let pendingCount = 0;

        if (actions.length === 0) {
            fullContainer.innerHTML = '<p style="text-align:center; color:#ccc;">Ù‡ÛŒÚ† Ø§Ù‚Ø¯Ø§Ù…ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
        }

        actions.forEach(action => {
            const html = `
                <div class="action-item ${action.done ? 'done' : ''}">
                    <div class="action-checkbox ${action.done ? 'checked' : ''}" onclick="toggleAction(${action.id})">
                        <i class="fas fa-check" style="${action.done ? '' : 'display:none'}"></i>
                    </div>
                    <div style="flex:1;">
                        <span class="action-type ${action.type === 'reward' ? 'type-reward' : 'type-penalty'}">
                            ${action.type === 'reward' ? 'Ù¾Ø§Ø¯Ø§Ø´' : 'Ø¬Ø±ÛŒÙ…Ù‡'}
                        </span>
                        <span style="font-weight:bold;">${action.text}</span>
                    </div>
                    ${!action.done ? `<i class="fas fa-trash" style="color:#ccc; cursor:pointer;" onclick="deleteAction(${action.id})"></i>` : ''}
                </div>
            `;
            
            fullContainer.innerHTML += html;
            
            if (!action.done) {
                pendingContainer.innerHTML += html;
                pendingCount++;
            }
        });

        if (pendingCount > 0) pendingArea.style.display = 'block';
        else pendingArea.style.display = 'none';
    }

    function toggleAction(id) {
        const key = getDateKey(viewingDate);
        const action = db.logs[key].actions.find(a => a.id === id);
        if (action) {
            action.done = !action.done;
            saveDB();
            renderUI();
        }
    }

    function deleteAction(id) {
        if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
        const key = getDateKey(viewingDate);
        db.logs[key].actions = db.logs[key].actions.filter(a => a.id !== id);
        saveDB();
        renderUI();
    }

    // --- EDITORS ---

    function openBehaviorEditor() {
        currentEditorType = 'behavior';
        document.getElementById('editorTitle').innerText = "ÙˆÛŒØ±Ø§ÛŒØ´ Ø±ÙØªØ§Ø±Ù‡Ø§";
        document.getElementById('editorWeight').style.display = 'block';
        document.getElementById('editorType').style.display = 'block';
        renderEditorList();
        document.getElementById('editorModal').style.display = 'flex';
    }

    function openRewardPenaltyEditor() {
        currentEditorType = 'rp';
        document.getElementById('editorTitle').innerText = "ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø¬Ø±ÛŒÙ…Ù‡";
        document.getElementById('editorWeight').style.display = 'block'; // reusing for threshold
        document.getElementById('editorWeight').placeholder = "Ø­Ø¯Ù†ØµØ§Ø¨";
        document.getElementById('editorType').style.display = 'block';
        // Change options
        const select = document.getElementById('editorType');
        select.innerHTML = '<option value="reward">Ù¾Ø§Ø¯Ø§Ø´</option><option value="penalty">Ø¬Ø±ÛŒÙ…Ù‡</option>';
        
        renderEditorList();
        document.getElementById('editorModal').style.display = 'flex';
    }

    function renderEditorList() {
        const container = document.getElementById('editorList');
        container.innerHTML = '';

        if (currentEditorType === 'behavior') {
            db.behaviors.forEach((b, idx) => {
                container.innerHTML += `
                    <div class="action-item">
                        <span style="font-size:0.8rem; width:50px;">${b.type==='virtue'?'Ø®ÙˆØ¨':'Ø¨Ø¯'} (${b.weight})</span>
                        <span style="flex:1">${b.title}</span>
                        <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="removeEditorItem('behavior', ${idx})"></i>
                    </div>
                `;
            });
        } else {
            // Rewards
            container.innerHTML += '<h4>Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§</h4>';
            db.rewardsList.forEach((r, idx) => {
                container.innerHTML += `
                    <div class="action-item">
                        <span style="font-size:0.8rem; width:30px;">>${r.threshold}</span>
                        <span style="flex:1">${r.text}</span>
                        <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="removeEditorItem('reward', ${idx})"></i>
                    </div>
                `;
            });
            // Penalties
            container.innerHTML += '<h4>Ø¬Ø±ÛŒÙ…Ù‡â€ŒÙ‡Ø§</h4>';
            db.penaltiesList.forEach((p, idx) => {
                container.innerHTML += `
                    <div class="action-item">
                        <span style="font-size:0.8rem; width:30px;"><${p.threshold}</span>
                        <span style="flex:1">${p.text}</span>
                        <i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="removeEditorItem('penalty', ${idx})"></i>
                    </div>
                `;
            });
        }
    }

    function editorAddItem() {
        const title = document.getElementById('editorInput').value;
        const weight = parseInt(document.getElementById('editorWeight').value);
        const type = document.getElementById('editorType').value;

        if (!title || isNaN(weight)) { alert('Ù„Ø·ÙØ§ Ø¹Ù†ÙˆØ§Ù† Ùˆ Ø¹Ø¯Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }

        if (currentEditorType === 'behavior') {
            db.behaviors.push({
                id: Date.now().toString(),
                title: title,
                type: type,
                weight: weight
            });
        } else {
            if (type === 'reward') db.rewardsList.push({ text: title, threshold: weight });
            else db.penaltiesList.push({ text: title, threshold: weight }); // Users usually input negative for penalty threshold e.g -5
        }
        saveDB();
        renderEditorList();
        document.getElementById('editorInput').value = '';
    }

    function removeEditorItem(type, index) {
        if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
        if (type === 'behavior') db.behaviors.splice(index, 1);
        else if (type === 'reward') db.rewardsList.splice(index, 1);
        else db.penaltiesList.splice(index, 1);
        saveDB();
        renderEditorList();
    }

    // --- TAB SWITCHING ---
    function switchTab(tabId) {
        document.querySelectorAll('.tab-view').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).style.display = 'block';
        
        // Find button index based on id to highlight
        const map = { 'home': 0, 'actions': 1, 'settings': 2 };
        document.querySelectorAll('.nav-btn')[map[tabId]].classList.add('active');
    }

    // --- EXPORT/IMPORT ---
    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Ethics_Backup_" + getDateKey(new Date()) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function importData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.user && imported.logs) {
                    db = imported;
                    saveDB();
                    alert("Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯.");
                    location.reload();
                } else {
                    alert("ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
                }
            } catch(err) { alert("Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„"); }
        };
        reader.readAsText(file);
    }

</script>
</body>
</html>
