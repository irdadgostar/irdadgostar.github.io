            <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>سامانه جامع پایش اخلاق | نسخه نهایی اصلاح شده</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #16a34a;
            --success-light: #dcfce7;
            --danger: #dc2626;
            --danger-light: #fee2e2;
            --text-main: #1e293b;
            --text-light: #64748b;
            --border-radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
    
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0; padding-bottom: 120px;
            overflow-x: hidden;
            transition: background 0.3s;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* --- Header --- */
        .top-bar { display: flex; gap: 10px; margin-bottom: 20px; height: 45px; }
        
        .manifesto-btn {
            flex: 1; background: var(--surface); color: var(--primary);
            border: 1px solid var(--primary); border-radius: 12px;
            font-size: 0.85rem; font-weight: 800;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            cursor: pointer; box-shadow: var(--shadow); transition: 0.2s;
        }
        .manifesto-btn.read { background: var(--success); color: white; border-color: var(--success); }

        .date-navigator {
            flex: 1.2; display: flex; align-items: center; justify-content: space-between;
            background: var(--surface); padding: 0 5px; border-radius: 12px;
            box-shadow: var(--shadow); border: 1px solid #e2e8f0;
        }
        .date-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; padding: 0 12px; height: 100%; color: var(--text-main); }
        .date-btn:disabled { opacity: 0.3; }
        .date-text { font-weight: 800; font-size: 0.8rem; }

        /* --- Score Card --- */
        .score-card {
            color: white; padding: 25px; border-radius: 24px; text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); margin-bottom: 25px;
            position: relative; overflow: hidden; transition: background 0.5s;
        }
        .score-card.neutral { background: linear-gradient(135deg, #64748b, #475569); }
        .score-card.positive { background: linear-gradient(135deg, #10b981, #059669); }
        .score-card.negative { background: linear-gradient(135deg, #ef4444, #b91c1c); }

        .main-score { font-size: 3.5rem; font-weight: 900; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .score-label { font-size: 0.9rem; opacity: 0.9; margin-bottom: 5px; letter-spacing: 1px; }
        
        .sub-scores {
            display: flex; justify-content: space-around; margin-top: 20px;
            background: rgba(0,0,0,0.15); padding: 10px; border-radius: 16px;
        }
        .sub-score-item { display: flex; flex-direction: column; }
        .sub-val { font-weight: 800; font-size: 1.1rem; }
        .sub-lbl { font-size: 0.75rem; opacity: 0.9; }

        /* --- Cards --- */
        .section-header { display: flex; align-items: center; margin: 30px 0 15px 0; padding: 0 5px; }
        .section-title { font-size: 1.1rem; font-weight: 900; display: flex; align-items: center; gap: 8px; }
        .virtue-text { color: var(--success-dark); }
        .vice-text { color: var(--danger-dark); }

        .modern-card {
            background: var(--surface); border-radius: 20px; margin-bottom: 16px;
            box-shadow: var(--shadow); display: flex; align-items: stretch;
            overflow: hidden; transition: 0.2s; min-height: 100px;
            border: 1px solid transparent; position: relative; z-index: 1;
        }
        .modern-card:active { transform: scale(0.98); }

        /* Card Button Styling */
        .card-btn {
            width: 60px; border: none; cursor: pointer; display: flex;
            align-items: center; justify-content: center; font-size: 1.4rem;
            color: white; transition: filter 0.2s;
        }
        .card-btn:active { filter: brightness(0.9); }

        /* Virtue Styling */
        .virtue.modern-card { border-right: 4px solid var(--success); }
        .virtue .card-btn.minus { background: #e2e8f0; color: #94a3b8; } /* Undo Good */
        .virtue .card-btn.plus { background: var(--success); color: white; } /* Do Good */

        /* Vice Styling (Reversed Logic as requested) */
        .vice.modern-card { border-right: 4px solid var(--danger); }
        .vice .card-btn.minus { background: #dcfce7; color: var(--success-dark); } /* Undo Bad (Good!) */
        .vice .card-btn.plus { background: var(--danger); color: white; } /* Do Bad */

        /* Visual Feedback Classes (Card Only) */
        .card-flash-green { animation: flashGreen 0.4s ease; border-color: var(--success) !important; }
        .card-flash-red { animation: flashRed 0.4s ease; border-color: var(--danger) !important; }

        @keyframes flashGreen { 0% { background: #fff; } 50% { background: #f0fdf4; } 100% { background: #fff; } }
        @keyframes flashRed { 0% { background: #fff; } 50% { background: #fef2f2; } 100% { background: #fff; } }

        /* Content */
        .card-info {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 10px 5px; text-align: center;
            border-top: 1px solid #f1f5f9; border-bottom: 1px solid #f1f5f9;
        }
        .card-title { font-weight: 800; font-size: 1rem; color: var(--text-main); margin-bottom: 6px; }
        .card-meta { display: flex; gap: 6px; flex-wrap: wrap; justify-content: center; }
        .stat-pill {
            font-size: 0.75rem; padding: 3px 10px; border-radius: 8px;
            background: #f1f5f9; color: var(--text-light); font-weight: bold;
        }
        .stat-pill.count { background: var(--text-main); color: white; }

        .next-threshold {
            font-size: 0.7rem; margin-top: 8px; padding: 4px 10px;
            border-radius: 50px; font-weight: bold; display: inline-flex; align-items: center; gap: 5px;
        }
        .next-threshold.reward { background: #ecfdf5; color: #15803d; border: 1px solid #bbf7d0; }
        .next-threshold.penalty { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        /* --- Global Animations --- */
        /* Screen Red Overlay */
        .screen-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.2); z-index: 9000; pointer-events: none;
            opacity: 0; transition: opacity 0.2s;
        }
        .screen-overlay.active { opacity: 1; }
        
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* Particles (Confetti) */
        .confetti {
            position: fixed; width: 8px; height: 8px;
            background-color: #f00; pointer-events: none; z-index: 9999;
            opacity: 0;
        }
        @keyframes flyOut {
            0% { transform: translate(0,0) scale(1) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0) rotate(var(--rot)); opacity: 0; }
        }

        /* --- Settings Grid --- */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .setting-card {
            background: white; border-radius: 20px; padding: 20px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; gap: 10px; box-shadow: var(--shadow);
            cursor: pointer; aspect-ratio: 1; border: 1px solid transparent; transition: 0.2s;
        }
        .setting-card:active { transform: scale(0.96); }
        .setting-card i { font-size: 2rem; color: var(--primary); }
        .setting-card span { font-weight: bold; font-size: 0.9rem; color: var(--text-main); }
        .setting-card.danger { border-color: #fee2e2; }
        .setting-card.danger i { color: var(--danger); }

        /* --- Action List --- */
        .action-item {
            background: white; border-radius: 14px; padding: 15px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow);
            border: 1px solid #f1f5f9; cursor: pointer;
        }
        .action-checkbox {
            width: 24px; height: 24px; border-radius: 8px; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            color: white; transition: 0.2s;
        }
        .action-checkbox.checked { background: var(--success); border-color: var(--success); }
        .badge-reward { background: #dcfce7; color: #166534; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }
        .badge-penalty { background: #fee2e2; color: #991b1b; padding: 3px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: bold; }

        /* --- Trigger Box --- */
        .trigger-box {
            background: #fff7ed; border: 1px solid #ffedd5; border-radius: 16px;
            padding: 15px; margin-bottom: 20px; display: none;
            animation: slideDown 0.3s ease;
        }
        .trigger-actions { display: flex; gap: 10px; margin-top: 10px; }
        .btn { padding: 10px; border-radius: 10px; border: none; cursor: pointer; font-weight: bold; flex: 1; }
        .btn-accept { background: var(--primary); color: white; }
        .btn-change { background: white; border: 1px solid #cbd5e1; }
        .btn-danger-outline { border: 1px solid var(--danger); color: var(--danger); background: white; }
        
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Navbar --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid #f1f5f9; box-shadow: 0 -4px 20px rgba(0,0,0,0.03); z-index: 1000;
        }
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; color: #94a3b8; gap: 5px; font-size: 0.75rem; cursor: pointer; }
        .nav-item i { font-size: 1.4rem; }
        .nav-item.active { color: var(--primary); }

        /* --- Modals --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 20px;
            padding: 20px; max-height: 85vh; overflow-y: auto; box-shadow: var(--shadow);
        }
        /* Specific Z-Indices */
        #manifestoModal { z-index: 2100; }
        #actionListPopupModal { z-index: 2200; }
        #actionDetailModal { z-index: 2300; }

        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 12px 40px 12px 12px; border: 1px solid #e2e8f0; border-radius: 12px; font-family: inherit; }
        .search-box i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #94a3b8; }

        .manifesto-text { line-height: 2; text-align: justify; background: #f8fafc; padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0; margin: 15px 0; max-height: 60vh; overflow-y: auto; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Stats Summary */
        .stats-row { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .stat-tile { min-width: 100px; padding: 10px; border-radius: 12px; text-align: center; cursor: pointer; flex: 1; }
        .stat-tile strong { display: block; font-size: 1.4rem; }
        
        .list-toggle { display: flex; margin-bottom: 15px; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; }
        .toggle-btn { flex: 1; padding: 10px; border: none; background: white; cursor: pointer; }
        .toggle-btn.active { background: var(--primary); color: white; }

        .form-input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 10px; margin-bottom: 10px; font-family: inherit; }
        .detail-row { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #f1f5f9; }
    </style>
</head>
<body>

<!-- Overlay for Penalty -->
<div id="penaltyOverlay" class="screen-overlay"></div>

<div id="app">

<!-- TAB: HOME -->
<div id="tab-home" class="tab-content active">
    <div class="container">
        
        <div class="top-bar">
            <button class="manifesto-btn" onclick="openManifestoModal()">
                <i class="fas fa-book-open" id="manifestoIcon"></i> <span id="manifestoBtnText">منشور اخلاقی</span>
            </button>
            <div class="date-navigator">
                <button class="date-btn" onclick="navigateDate(-1)"><i class="fas fa-chevron-right"></i></button>
                <div class="date-text" id="headerDateDisplay">...</div>
                <button class="date-btn" id="nextDayBtn" onclick="navigateDate(1)" disabled><i class="fas fa-chevron-left"></i></button>
            </div>
        </div>

        <div class="score-card neutral" id="scoreCard">
            <div class="score-label">تراز امروز</div>
            <div class="main-score" id="totalScoreDisplay">0</div>
            <div class="sub-scores">
                <div class="sub-score-item">
                    <span class="sub-val" id="posScoreDisplay">0</span>
                    <span class="sub-lbl">مثبت</span>
                </div>
                <div class="sub-score-item">
                    <span class="sub-val" id="negScoreDisplay">0</span>
                    <span class="sub-lbl">منفی</span>
                </div>
            </div>
        </div>

        <div id="triggerArea"></div>

        <div id="homePendingSummary" class="stats-summary-card" style="margin-bottom: 20px; display:none;">
            <div class="stat-box" style="color:var(--success-dark)" onclick="openActionListModal('reward', false)">
                <span class="stat-num" id="pendingRewardCount">0</span>
                <span class="stat-label">پاداش مانده</span>
            </div>
            <div class="stat-box" style="color:var(--danger-dark)" onclick="openActionListModal('penalty', false)">
                <span class="stat-num" id="pendingPenaltyCount">0</span>
                <span class="stat-label">جریمه مانده</span>
            </div>
        </div>

        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="homeSearch" placeholder="جستجو در رفتارها..." oninput="filterHomeList()">
        </div>

        <div class="section-header">
            <span class="section-title virtue"><i class="fas fa-check-circle"></i> فضایل</span>
        </div>
        <div id="virtuesList"></div>

        <div class="section-header">
            <span class="section-title vice"><i class="fas fa-times-circle"></i> رذایل</span>
        </div>
        <div id="vicesList"></div>

    </div>
</div>

<!-- TAB: ACTIONS -->
<div id="tab-actions" class="tab-content">
    <div class="container">
        <h2 style="margin-top:0;">کارنامه عملی</h2>
        
        <div class="stats-summary-card">
            <div class="stat-box" style="color:var(--success)" onclick="filterActionsTab('reward')">
                <span class="stat-num" id="totalRewardCount">0</span>
                <span class="stat-label">کل پاداش‌ها</span>
            </div>
            <div class="stat-box" style="color:var(--danger)" onclick="filterActionsTab('penalty')">
                <span class="stat-num" id="totalPenaltyCount">0</span>
                <span class="stat-label">کل جریمه‌ها</span>
            </div>
        </div>

        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="actionsSearch" placeholder="جستجو در کارنامه..." oninput="renderActionsTab()">
        </div>

        <div class="stats-row">
             <div class="stat-tile" style="background:#f0f9ff;" onclick="openActionListModal(null, true)">
                <strong id="totalDoneCount" style="color:#0369a1">0</strong>
                <span style="font-size:0.8rem; color:#0369a1">انجام شده</span>
            </div>
            <div class="stat-tile" style="background:#fff1f2;" onclick="openActionListModal(null, false)">
                <strong id="totalPendingCount" style="color:#be123c">0</strong>
                <span style="font-size:0.8rem; color:#be123c">انجام نشده</span>
            </div>
             <div class="stat-tile" style="background:#fef3c7;" onclick="openDateRangeStats()">
                <strong style="color:#b45309"><i class="fas fa-calendar-alt"></i></strong>
                <span style="font-size:0.8rem; color:#b45309">آمار بازه</span>
            </div>
        </div>

        <div id="actionsListFull"></div>
    </div>
</div>

<!-- TAB: SETTINGS -->
<div id="tab-settings" class="tab-content">
    <div class="container">
        <h2>تنظیمات</h2>
        <div class="settings-grid">
            <div class="setting-card" onclick="openEditor('behavior')">
                <i class="fas fa-list-check"></i>
                <span>مدیریت رفتارها</span>
            </div>
            <div class="setting-card" onclick="openEditor('rule')">
                <i class="fas fa-gavel"></i>
                <span>پیکربندی عواقب</span>
            </div>
            <div class="setting-card" onclick="openBackupModal()">
                <i class="fas fa-save"></i>
                <span>پشتیبان‌گیری</span>
            </div>
            <div class="setting-card danger" onclick="openClearDataModal()">
                <i class="fas fa-trash-alt"></i>
                <span>پاکسازی</span>
            </div>
        </div>
        <br><br><br>
    </div>
</div>
</div>

<!-- NAVIGATION -->
<div class="nav-bar">
    <button class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i><span>امروز</span></button>
    <button class="nav-item" onclick="switchTab('actions')"><i class="fas fa-clipboard-list"></i><span>اقدامات</span></button>
    <button class="nav-item" onclick="switchTab('settings')"><i class="fas fa-cog"></i><span>تنظیمات</span></button>
</div>

<!-- MODALS -->

<!-- Manifesto -->
<div id="manifestoModal" class="modal-overlay">
    <div class="modal-content">
        <div style="position:absolute; top:20px; left:20px; cursor:pointer;" onclick="document.getElementById('manifestoModal').style.display='none'">
            <i class="fas fa-times" style="font-size:1.2rem; color:#94a3b8;"></i>
        </div>
        <h3 style="text-align:center; color:var(--primary); margin-top:0;">مرور عهدنامه</h3>
        <div class="manifesto-text" id="manifestoTextContainer"></div>
        <button id="manifestoConfirmBtn" class="btn btn-accept" style="width:100%; opacity:0.5;" disabled onclick="confirmManifestoRead()">تایید و تعهد</button>
        <p style="text-align:center; font-size:0.75rem; color:red; margin-top:5px;">(لطفاً تا انتها مطالعه کنید)</p>
    </div>
</div>

<!-- Onboarding Name -->
<div id="nameModal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <h3>خوش آمدید</h3>
        <p>لطفاً نام خود را وارد کنید:</p>
        <input type="text" id="userNameInput" class="form-input" placeholder="نام شما..." style="text-align:center; font-size:1.2rem;">
        <br><br>
        <button class="btn btn-accept" style="width:100%" onclick="saveName()">ثبت و شروع</button>
    </div>
</div>

<!-- Clear Data -->
<div id="clearDataModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--danger)">حذف اطلاعات</h3>
        <p>بازه زمانی را انتخاب کنید:</p>
        <div class="form-group"><label><input type="radio" name="clearOption" value="today" checked> امروز</label></div>
        <div class="form-group"><label><input type="radio" name="clearOption" value="all"> کل اطلاعات (بازگشت به کارخانه)</label></div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-danger" onclick="performClearData()">حذف کن</button>
            <button class="btn btn-change" onclick="document.getElementById('clearDataModal').style.display='none'">انصراف</button>
        </div>
    </div>
</div>

<!-- Backup -->
<div id="backupModal" class="modal-overlay">
    <div class="modal-content">
        <h3>پشتیبان‌گیری</h3>
        <button class="btn btn-accept" style="width:100%; margin-bottom:15px;" onclick="backupData()">دانلود فایل پشتیبان</button>
        <div style="border-top:1px solid #eee; padding-top:15px;">
             <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
             <button class="btn btn-change" style="width:100%;" onclick="document.getElementById('restoreFile').click()">بازگردانی اطلاعات</button>
        </div>
        <button class="btn btn-danger-outline" style="width:100%; margin-top:15px;" onclick="document.getElementById('backupModal').style.display='none'">بستن</button>
    </div>
</div>

<!-- Editor List -->
<div id="editorModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="editorTitle" style="margin:0">ویرایش</h3>
            <i class="fas fa-times" style="cursor:pointer;" onclick="closeEditor()"></i>
        </div>
        <div id="ruleListToggle" class="list-toggle" style="display:none;">
            <button class="toggle-btn active" onclick="toggleRuleList('virtue')" id="toggleVirtueBtn">فضایل/پاداش</button>
            <button class="toggle-btn" onclick="toggleRuleList('vice')" id="toggleViceBtn">رذایل/جریمه</button>
        </div>
        <div class="search-box">
             <i class="fas fa-search"></i>
             <input type="text" id="editorSearch" placeholder="جستجو..." oninput="filterEditorList()">
        </div>
        <div id="editorListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>
        <button class="btn btn-accept" onclick="openEditForm(null)" style="width:100%">+ افزودن جدید</button>
    </div>
</div>

<!-- Edit Form -->
<div id="editFormModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="formTitle">افزودن/ویرایش</h3>
        <input type="hidden" id="editId">
        
        <div id="behaviorFields" style="display:none;">
            <input type="text" id="behTitle" class="form-input" placeholder="عنوان رفتار">
            <div style="display:flex; gap:10px;">
                <select id="behType" class="form-input">
                    <option value="virtue">فضیلت (مثبت)</option>
                    <option value="vice">رذیلت (منفی)</option>
                </select>
                <input type="number" id="behWeight" class="form-input" placeholder="امتیاز" value="1">
            </div>
        </div>

        <div id="ruleFields" style="display:none;">
            <label class="form-label">نوع شرط:</label>
            <select id="ruleType" class="form-input" onchange="toggleRuleInputs()">
                <option value="total_pos">مجموع امتیاز مثبت</option>
                <option value="total_neg">مجموع امتیاز منفی</option>
                <option value="total_net">امتیاز خالص (برآیند)</option>
                <option value="specific">رفتار خاص</option>
            </select>
            
            <div id="specificBehDiv" style="display:none; margin-top:10px;">
                <label class="form-label">انتخاب رفتار:</label>
                <select id="ruleTargetId" class="form-input" onchange="updateRuleResultTypeBasedOnTarget()"></select>
            </div>

            <div style="margin-top:10px;">
                <label class="form-label">حد نصاب:</label>
                <input type="number" id="ruleThreshold" class="form-input" placeholder="مثلا 20">
            </div>

            <div style="margin-top:10px;">
                <label class="form-label">نتیجه:</label>
                <div style="display:flex; gap:5px;">
                     <input type="text" id="ruleResultTypeDisplay" class="form-input" style="width:80px; background:#eee;" disabled>
                     <input type="hidden" id="ruleResultType">
                    <input type="text" id="ruleResultText" class="form-input" placeholder="مثلا: خرید کتاب">
                </div>
            </div>
            
            <div style="display:flex; gap:5px; align-items:center; margin-top:10px;">
                <span>از</span><input type="time" id="ruleStartTime" class="form-input">
                <span>تا</span><input type="time" id="ruleEndTime" class="form-input">
            </div>
            
            <label style="display:flex; align-items:center; gap:5px; margin-top:10px; font-size:0.8rem;">
                <input type="checkbox" id="ruleIsSpecific"> پاداش/جریمه اختصاصی (تصادفی انتخاب نشود)
            </label>
        </div>

        <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn btn-accept" onclick="saveEditorItem()">ذخیره</button>
            <button class="btn btn-change" onclick="document.getElementById('editFormModal').style.display='none'">لغو</button>
        </div>
    </div>
</div>

<!-- Action Detail -->
<div id="actionDetailModal" class="modal-overlay">
    <div class="modal-content">
        <h3 id="actionDetailTitle" style="margin-top:0">جزئیات</h3>
        <div id="actionDetailContent"></div>
        <div id="actionEditControls" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px; display:none;">
            <p style="font-weight:bold; margin-bottom:5px;">تغییر عنوان:</p>
            <input type="text" id="actionEditText" class="form-input">
            <button class="btn btn-accept" style="width:100%; margin-top:5px;" onclick="saveActionEdit()">ثبت تغییر</button>
        </div>
        <button class="btn btn-change" style="width:100%; margin-top:15px;" onclick="document.getElementById('actionDetailModal').style.display='none'">بستن</button>
    </div>
</div>

<!-- Action List Popup -->
<div id="actionListPopupModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="actionListPopupTitle" style="margin:0">لیست</h3>
            <i class="fas fa-times" style="cursor:pointer;" onclick="document.getElementById('actionListPopupModal').style.display='none'"></i>
        </div>
        <div id="actionListPopupContent"></div>
    </div>
</div>

<!-- Date Range Stats -->
<div id="dateRangeModal" class="modal-overlay">
    <div class="modal-content">
        <h3>آمار بازه زمانی</h3>
        <div class="form-group"><label>شروع:</label><input type="date" id="statStartDate" class="form-input"></div>
        <div class="form-group"><label>پایان:</label><input type="date" id="statEndDate" class="form-input"></div>
        <button class="btn btn-accept" style="width:100%" onclick="calcDateRangeStats()">محاسبه</button>
        
        <div id="rangeStatsResult" style="margin-top:20px; display:none;">
            <div class="sub-scores" style="background:#f8fafc; padding:10px;">
                <div class="sub-score-item"><span style="color:var(--success)">مثبت:</span><strong id="rsPos"></strong></div>
                <div class="sub-score-item"><span style="color:var(--danger)">منفی:</span><strong id="rsNeg"></strong></div>
                <div class="sub-score-item"><span>کل:</span><strong id="rsTotal"></strong></div>
            </div>
            <div class="list-row" onclick="showRangeActionDetails(true)" style="cursor:pointer; color:var(--primary);">
                <span>انجام شده:</span> <strong id="rsDone"></strong>
            </div>
            <div class="list-row" onclick="showRangeActionDetails(false)" style="cursor:pointer; color:var(--danger);">
                <span>انجام نشده:</span> <strong id="rsPending"></strong>
            </div>
        </div>
        <button class="btn btn-change" style="width:100%; margin-top:10px;" onclick="document.getElementById('dateRangeModal').style.display='none'">بستن</button>
    </div>
</div>

<script>
    // --- Data Initialization with REAL Concrete Rewards/Penalties ---
    const DEFAULT_DATA = {
        user: { name: "" },
        behaviors: [
            // Virtues
            { id: 'v1', title: 'خردورزی', type: 'virtue', weight: 5 },
            { id: 'v2', title: 'انضباط شخصی', type: 'virtue', weight: 4 },
            { id: 'v3', title: 'صداقت', type: 'virtue', weight: 5 },
            { id: 'v4', title: 'مسئولیت‌پذیری', type: 'virtue', weight: 4 },
            { id: 'v5', title: 'همدلی', type: 'virtue', weight: 3 },
            { id: 'v6', title: 'کمک به همنوع', type: 'virtue', weight: 5 },
            { id: 'v7', title: 'کنترل خشم', type: 'virtue', weight: 6 },
            { id: 'v8', title: 'احترام به حریم‌ها', type: 'virtue', weight: 3 },
            { id: 'v9', title: 'شکرگزاری', type: 'virtue', weight: 2 },
            { id: 'v10', title: 'یادگیری مستمر', type: 'virtue', weight: 4 },
            { id: 'v11', title: 'نظافت و آراستگی', type: 'virtue', weight: 2 },
            { id: 'v12', title: 'وفای به عهد', type: 'virtue', weight: 5 },
            { id: 'v13', title: 'عدالت و انصاف', type: 'virtue', weight: 5 },
            { id: 'v14', title: 'شجاعت', type: 'virtue', weight: 4 },
            { id: 'v15', title: 'تاب‌آوری', type: 'virtue', weight: 3 },
            { id: 'v16', title: 'رازداری', type: 'virtue', weight: 4 },
            { id: 'v17', title: 'سحرخیزی', type: 'virtue', weight: 3 },
            { id: 'v18', title: 'سکوتِ آگاهانه', type: 'virtue', weight: 2 },
            { id: 'v19', title: 'حفظ محیط زیست', type: 'virtue', weight: 2 },
            { id: 'v20', title: 'عزت نفس', type: 'virtue', weight: 4 },
            // Vices
            { id: 'x1', title: 'دروغ', type: 'vice', weight: 5 },
            { id: 'x2', title: 'غیبت', type: 'vice', weight: 4 },
            { id: 'x3', title: 'توهین و فحاشی', type: 'vice', weight: 4 },
            { id: 'x4', title: 'تهمت', type: 'vice', weight: 6 },
            { id: 'x5', title: 'سخن‌چینی', type: 'vice', weight: 4 },
            { id: 'x6', title: 'تنبلی و اهمال', type: 'vice', weight: 3 },
            { id: 'x7', title: 'حسادت', type: 'vice', weight: 3 },
            { id: 'x8', title: 'قضاوت عجولانه', type: 'vice', weight: 3 },
            { id: 'x9', title: 'پرخوری یا پرخوابی', type: 'vice', weight: 2 },
            { id: 'x10', title: 'اسراف', type: 'vice', weight: 2 },
            { id: 'x11', title: 'تکبر و خودبرتربینی', type: 'vice', weight: 4 },
            { id: 'x12', title: 'بدقولی', type: 'vice', weight: 4 },
            { id: 'x13', title: 'کنترل‌گری', type: 'vice', weight: 3 },
            { id: 'x14', title: 'قربانی‌نمایی', type: 'vice', weight: 3 },
            { id: 'x15', title: 'نگاه آلوده', type: 'vice', weight: 5 },
            { id: 'x16', title: 'کینه و انتقام‌جویی', type: 'vice', weight: 4 },
            { id: 'x17', title: 'خیانت', type: 'vice', weight: 6 },
            { id: 'x18', title: 'چاپلوسی', type: 'vice', weight: 3 },
            { id: 'x19', title: 'ناامیدی و پوچ‌گرایی', type: 'vice', weight: 4 },
            { id: 'x20', title: 'بی‌تفاوتی', type: 'vice', weight: 3 }
        ],
        rules: [
            // General
            { id: 'r_total_pos', type: 'total_pos', targetId: null, threshold: 200, resultType: 'reward', resultText: 'مشاهده فیلم سینمایی', isSpecific: false },
            { id: 'r_total_neg', type: 'total_neg', targetId: null, threshold: 300, resultType: 'penalty', resultText: '۲۰ دقیقه ورزش هوازی اضافه', isSpecific: false },
            
            // Concrete Rewards for Virtues
            { id: 'rv1', type: 'specific', targetId: 'v1', threshold: 25, resultType: 'reward', resultText: 'خرید یک جلد کتاب', isSpecific: true },
            { id: 'rv2', type: 'specific', targetId: 'v2', threshold: 20, resultType: 'reward', resultText: 'یک ساعت استراحت مطلق', isSpecific: true },
            { id: 'rv3', type: 'specific', targetId: 'v3', threshold: 25, resultType: 'reward', resultText: 'تماس با یک دوست قدیمی', isSpecific: true },
            { id: 'rv4', type: 'specific', targetId: 'v4', threshold: 20, resultType: 'reward', resultText: 'صرف غذای مورد علاقه', isSpecific: true },
            { id: 'rv5', type: 'specific', targetId: 'v5', threshold: 15, resultType: 'reward', resultText: 'خرید هدیه کوچک برای خود', isSpecific: true },
            { id: 'rv6', type: 'specific', targetId: 'v6', threshold: 25, resultType: 'reward', resultText: 'گردش در طبیعت', isSpecific: true },
            { id: 'rv7', type: 'specific', targetId: 'v7', threshold: 30, resultType: 'reward', resultText: 'ماساژ یا اسپا', isSpecific: true },
            { id: 'rv8', type: 'specific', targetId: 'v8', threshold: 15, resultType: 'reward', resultText: 'خرید اشتراک فرهنگی', isSpecific: true },
            { id: 'rv9', type: 'specific', targetId: 'v9', threshold: 10, resultType: 'reward', resultText: 'نوشیدن دمنوش گیاهی', isSpecific: true },
            { id: 'rv10', type: 'specific', targetId: 'v10', threshold: 20, resultType: 'reward', resultText: 'ثبت نام در یک دوره آموزشی', isSpecific: true },
            { id: 'rv11', type: 'specific', targetId: 'v11', threshold: 10, resultType: 'reward', resultText: 'خرید عطر یا خوشبوکننده', isSpecific: true },
            { id: 'rv12', type: 'specific', targetId: 'v12', threshold: 25, resultType: 'reward', resultText: 'یک روز بدون فضای مجازی', isSpecific: true },
            { id: 'rv13', type: 'specific', targetId: 'v13', threshold: 25, resultType: 'reward', resultText: 'کمک مالی به خیریه', isSpecific: true },
            { id: 'rv14', type: 'specific', targetId: 'v14', threshold: 20, resultType: 'reward', resultText: 'انجام یک کار هیجان‌انگیز', isSpecific: true },
            { id: 'rv15', type: 'specific', targetId: 'v15', threshold: 15, resultType: 'reward', resultText: 'مدیتیشن طولانی', isSpecific: true },
            { id: 'rv16', type: 'specific', targetId: 'v16', threshold: 20, resultType: 'reward', resultText: 'نوشتن خاطرات روزانه', isSpecific: true },
            { id: 'rv17', type: 'specific', targetId: 'v17', threshold: 15, resultType: 'reward', resultText: 'مشاهده طلوع خورشید', isSpecific: true },
            { id: 'rv18', type: 'specific', targetId: 'v18', threshold: 10, resultType: 'reward', resultText: 'یک ساعت سکوت کامل', isSpecific: true },
            { id: 'rv19', type: 'specific', targetId: 'v19', threshold: 10, resultType: 'reward', resultText: 'کاشت یک گیاه', isSpecific: true },
            { id: 'rv20', type: 'specific', targetId: 'v20', threshold: 20, resultType: 'reward', resultText: 'خرید لباس نو', isSpecific: true },

            // Concrete Penalties for Vices
            { id: 'rx1', type: 'specific', targetId: 'x1', threshold: 10, resultType: 'penalty', resultText: '۵۰ هزار تومان صدقه اجباری', isSpecific: true },
            { id: 'rx2', type: 'specific', targetId: 'x2', threshold: 8, resultType: 'penalty', resultText: 'عذرخواهی از فرد مورد نظر', isSpecific: true },
            { id: 'rx3', type: 'specific', targetId: 'x3', threshold: 8, resultType: 'penalty', resultText: '۲ ساعت سکوت اجباری', isSpecific: true },
            { id: 'rx4', type: 'specific', targetId: 'x4', threshold: 12, resultType: 'penalty', resultText: 'خواندن ۵۰ آیه قرآن/کتاب مقدس', isSpecific: true },
            { id: 'rx5', type: 'specific', targetId: 'x5', threshold: 8, resultType: 'penalty', resultText: 'تمیز کردن سرویس بهداشتی', isSpecific: true },
            { id: 'rx6', type: 'specific', targetId: 'x6', threshold: 9, resultType: 'penalty', resultText: 'بیداری یک ساعت زودتر فردا', isSpecific: true },
            { id: 'rx7', type: 'specific', targetId: 'x7', threshold: 9, resultType: 'penalty', resultText: 'تعریف از فرد مورد حسادت', isSpecific: true },
            { id: 'rx8', type: 'specific', targetId: 'x8', threshold: 9, resultType: 'penalty', resultText: 'نوشتن ۱۰ نکته مثبت فرد', isSpecific: true },
            { id: 'rx9', type: 'specific', targetId: 'x9', threshold: 6, resultType: 'penalty', resultText: 'حذف یک وعده غذایی (روزه)', isSpecific: true },
            { id: 'rx10', type: 'specific', targetId: 'x10', threshold: 6, resultType: 'penalty', resultText: '۲۰ هزار تومان جریمه مالی', isSpecific: true },
            { id: 'rx11', type: 'specific', targetId: 'x11', threshold: 12, resultType: 'penalty', resultText: 'انجام خدمات منزل برای خانواده', isSpecific: true },
            { id: 'rx12', type: 'specific', targetId: 'x12', threshold: 12, resultType: 'penalty', resultText: 'جبران مافات برای فرد', isSpecific: true },
            { id: 'rx13', type: 'specific', targetId: 'x13', threshold: 9, resultType: 'penalty', resultText: 'تمرین رها کردن کنترل به مدت یک روز', isSpecific: true },
            { id: 'rx14', type: 'specific', targetId: 'x14', threshold: 9, resultType: 'penalty', resultText: 'نوشتن ۵ مورد مسئولیت شخصی', isSpecific: true },
            { id: 'rx15', type: 'specific', targetId: 'x15', threshold: 10, resultType: 'penalty', resultText: '۱۰۰ بار استغفار/ذکر', isSpecific: true },
            { id: 'rx16', type: 'specific', targetId: 'x16', threshold: 12, resultType: 'penalty', resultText: 'دعای خیر برای دشمن', isSpecific: true },
            { id: 'rx17', type: 'specific', targetId: 'x17', threshold: 15, resultType: 'penalty', resultText: 'اعتراف و جبران خسارت', isSpecific: true },
            { id: 'rx18', type: 'specific', targetId: 'x18', threshold: 9, resultType: 'penalty', resultText: 'نقد سازنده خود در جمع', isSpecific: true },
            { id: 'rx19', type: 'specific', targetId: 'x19', threshold: 12, resultType: 'penalty', resultText: 'مطالعه کتاب امیدبخش', isSpecific: true },
            { id: 'rx20', type: 'specific', targetId: 'x20', threshold: 9, resultType: 'penalty', resultText: 'انجام یک کار داوطلبانه', isSpecific: true }
        ],
        logs: {} 
    };

    let db = JSON.parse(localStorage.getItem('EthicsDB_Final')) || JSON.parse(JSON.stringify(DEFAULT_DATA));
    let viewingDate = new Date();
    viewingDate.setHours(0,0,0,0);
    
    let currentEditorMode = null; 
    let currentRuleFilter = 'virtue';
    let editingItemId = null;
    let currentActionFilter = null; 
    let currentActionEditId = null; 
    let tempDateRangeResults = null; 

    // --- Helpers ---
    function getVerbalDate(date) {
        const weekDays = ['یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنج‌شنبه', 'جمعه', 'شنبه'];
        const months = ['فروردین','اردیبهشت','خرداد','تیر','مرداد','شهریور','مهر','آبان','آذر','دی','بهمن','اسفند'];
        const options = { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'long' };
        const parts = new Intl.DateTimeFormat('fa-IR', options).formatToParts(date);
        let y, m, d, wd;
        parts.forEach(p => { if(p.type==='year') y=p.value; if(p.type==='month') m=p.value; if(p.type==='day') d=p.value; if(p.type==='weekday') wd=p.value; });
        const parseFa = (s) => parseInt(s.replace(/[۰-۹]/g, c => c.charCodeAt(0) - 1776));
        const dayInt = parseFa(d);
        const yearInt = parseFa(y);
        const monthInt = parseFa(m); 
        const numToWord = (n) => {
            if (n === 0) return 'صفر';
            const ones = ['','یک','دو','سه','چهار','پنج','شش',' هفت','هشت','نه'];
            const teens = ['ده','یازده','دوازده','سیزده','چهارده','پانزده','شانزده','هفده','هجده','نوزده'];
            const tens = ['','','بیست','سی','چهل','پنجاه','شصت','هفتاد','هشتاد','نود'];
            const hundreds = ['','صد','دویست','سیصد','چهارصد','پانصد','ششصد','هفتصد','هشتصد','نهصد'];
            let str = '';
            if (n >= 1000) { const th = Math.floor(n/1000); const rem = n%1000; str += (th===1?'هزار':ones[th]+' هزار'); if(rem>0) str+=' و '+numToWord(rem); return str; }
            const h = Math.floor(n/100); const t = Math.floor((n%100)/10); const o = n%10;
            if (h>0) { str+=hundreds[h]; if(t>0||o>0) str+=' و '; }
            if (t>=2) { str+=tens[t]; if(o>0) str+=' و '+ones[o]; } else if (t===1) { str+=teens[o]; } else { str+=ones[o]; }
            return str;
        };
        const dayOrdinals = ["", "یکم", "دوم", "سوم", "چهارم", "پنجم", "ششم", "هفتم", "هشتم", "نهم", "دهم", "یازدهم", "دوازدهم", "سیزدهم", "چهاردهم", "پانزدهم", "شانزدهم", "هفدهم", "هجدهم", "نوزدهم", "بیستم", "بیست و یکم", "بیست و دوم", "بیست و سوم", "بیست و چهارم", "بیست و پنجم", "بیست و ششم", "بیست و هفتم", "بیست و هشتم", "بیست و نهم", "سی‌ام", "سی و یکم"];
        return `${wd}، ${dayOrdinals[dayInt]} ${months[monthInt-1]} ${numToWord(yearInt)}`;
    }
    
    function getHeaderDate(date) {
        return new Intl.DateTimeFormat('fa-IR', {weekday: 'long', year: 'numeric', month: '2-digit', day: '2-digit'}).format(date);
    }

    function getKey(date) { return date.toLocaleDateString('en-CA'); }
    function saveDB() { localStorage.setItem('EthicsDB_Final', JSON.stringify(db)); }

    // --- Init ---
    window.onload = () => {
        if(!db.user.name) document.getElementById('nameModal').style.display = 'flex';
        else initUI();
    };

    function saveName() {
        const name = document.getElementById('userNameInput').value.trim();
        if(name) { db.user.name = name; saveDB(); document.getElementById('nameModal').style.display = 'none'; initUI(); }
    }

    function initUI() {
        renderHome();
        const key = getKey(new Date());
        if(db.logs[key] && !db.logs[key].manifestoRead) openManifestoModal();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        const indices = { 'home': 0, 'actions': 1, 'settings': 2 };
        document.querySelectorAll('.nav-item')[indices[tabId]].classList.add('active');
        if (tabId === 'home') renderHome();
        if (tabId === 'actions') renderActionsTab();
    }

    // --- Core Logic ---
    function navigateDate(delta) {
        const newDate = new Date(viewingDate); newDate.setDate(newDate.getDate() + delta); newDate.setHours(0,0,0,0);
        const today = new Date(); today.setHours(0,0,0,0);
        if (newDate > today) return;
        viewingDate = newDate; renderHome();
    }

    function renderHome() {
        const key = getKey(viewingDate);
        document.getElementById('headerDateDisplay').innerText = getHeaderDate(viewingDate);
        document.getElementById('nextDayBtn').disabled = (key === getKey(new Date()));

        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        const log = db.logs[key];

        const manBtn = document.querySelector('.manifesto-btn');
        if (log.manifestoRead) { manBtn.classList.add('read'); document.getElementById('manifestoIcon').className = 'fas fa-check'; }
        else { manBtn.classList.remove('read'); document.getElementById('manifestoIcon').className = 'fas fa-book-open'; }

        let totalScore = 0, posScore = 0, negScore = 0;
        const vContainer = document.getElementById('virtuesList');
        const xContainer = document.getElementById('vicesList');
        vContainer.innerHTML = ''; xContainer.innerHTML = '';
        const search = document.getElementById('homeSearch').value.toLowerCase();

        db.behaviors.forEach(b => {
            if(search && !b.title.toLowerCase().includes(search)) return;
            const count = log.behaviors[b.id] || 0;
            const itemScore = count * b.weight;
            if (b.type === 'virtue') { totalScore += itemScore; posScore += itemScore; } else { totalScore -= itemScore; negScore += itemScore; }

            // Fix 4 & 6: Logic for next threshold
            let thresholdInfo = "";
            const rule = db.rules.find(r => r.type === 'specific' && r.targetId === b.id);
            if (rule) {
                 const consumed = log.consumed && log.consumed[rule.id] ? log.consumed[rule.id] : 0;
                 const nextTarget = consumed + rule.threshold;
                 const currentVal = count * b.weight;
                 const needed = nextTarget - currentVal;
                 if (needed > 0) {
                     const typeText = rule.resultType === 'reward' ? 'پاداش' : 'جریمه';
                     const typeClass = rule.resultType === 'reward' ? 'reward' : 'penalty';
                     thresholdInfo = `<div class="next-threshold ${typeClass}"><i class="fas fa-flag"></i> ${needed} امتیاز تا ${typeText}</div>`;
                 } else {
                     // If needed <= 0, it means a trigger is technically pending or active
                     thresholdInfo = `<div class="next-threshold" style="background:#eee; color:#666;">در انتظار ثبت...</div>`;
                 }
            }

            const html = `
                <div class="modern-card ${b.type}" id="card-${b.id}">
                    <button class="card-btn minus" onclick="updateCount('${b.id}', -1)"><i class="fas fa-minus"></i></button>
                    <div class="card-info">
                        <div class="card-title">${b.title}</div>
                        <div class="card-meta">
                            <span class="stat-pill">ضریب: ${b.weight}</span>
                            <span class="stat-pill count">مرتبه: ${count}</span>
                        </div>
                        ${thresholdInfo}
                    </div>
                    <button class="card-btn plus" onclick="updateCount('${b.id}', 1)"><i class="fas fa-plus"></i></button>
                </div>
            `;
            if (b.type === 'virtue') vContainer.innerHTML += html; else xContainer.innerHTML += html;
        });

        document.getElementById('totalScoreDisplay').innerText = totalScore > 0 ? `+${totalScore}` : totalScore;
        document.getElementById('posScoreDisplay').innerText = posScore;
        document.getElementById('negScoreDisplay').innerText = negScore;
        const scoreCard = document.getElementById('scoreCard');
        scoreCard.className = 'score-card ' + (totalScore > 0 ? 'positive' : (totalScore < 0 ? 'negative' : 'neutral'));

        // Pending
        const pActs = log.actions.filter(a => !a.done);
        document.getElementById('homePendingSummary').style.display = pActs.length > 0 ? 'flex' : 'none';
        document.getElementById('pendingRewardCount').innerText = pActs.filter(a => a.type === 'reward').length;
        document.getElementById('pendingPenaltyCount').innerText = pActs.filter(a => a.type === 'penalty').length;

        // Check triggers but DO NOT animate on render
        checkTriggers(key, totalScore, posScore, negScore, false); 
    }

    function filterHomeList() { renderHome(); }

    function updateCount(behId, delta) {
        const key = getKey(viewingDate);
        const log = db.logs[key];
        const current = log.behaviors[behId] || 0;
        const newVal = current + delta;
        
        // Card Flash Effect
        const beh = db.behaviors.find(b => b.id === behId);
        const card = document.getElementById(`card-${behId}`);
        if(card) {
            card.classList.remove('card-flash-green', 'card-flash-red');
            void card.offsetWidth;
            if (beh.type === 'virtue') card.classList.add('card-flash-green');
            else card.classList.add('card-flash-red');
        }

        if (newVal >= 0) {
            // Fix 1: Calculate BEFORE update
            let oldScoreTotal = 0, oldPos = 0, oldNeg = 0;
            let oldCounts = {...log.behaviors}; // snapshot
            
            // Calculate old totals
            db.behaviors.forEach(b => {
                const c = oldCounts[b.id] || 0;
                const s = c * b.weight;
                if(b.type==='virtue') { oldPos+=s; oldScoreTotal+=s; } else { oldNeg+=s; oldScoreTotal-=s; }
            });

            // Update
            log.behaviors[behId] = newVal;
            saveDB();

            // Calculate NEW totals
            let newScoreTotal = 0, newPos = 0, newNeg = 0;
            db.behaviors.forEach(b => {
                const c = log.behaviors[b.id] || 0;
                const s = c * b.weight;
                if(b.type==='virtue') { newPos+=s; newScoreTotal+=s; } else { newNeg+=s; newScoreTotal-=s; }
            });

            // Check Crossing Logic
            const result = checkTriggersCrossing(key, oldScoreTotal, oldPos, oldNeg, newScoreTotal, newPos, newNeg);
            
            if (result && result.triggeredNow) {
                if (result.type === 'reward') triggerConfetti(card);
                else triggerPenaltyEffect();
            }

            renderHome();
        }
    }

    // Fix 1 & 4: New Crossing Logic
    function checkTriggersCrossing(dateKey, oldT, oldP, oldN, newT, newP, newN) {
        const log = db.logs[dateKey];
        const consumed = log.consumed || {};
        
        for (let rule of db.rules) {
            let oldVal = 0, newVal = 0;
            let consumedVal = consumed[rule.id] || 0;
            
            // Determine Value based on type
            if (rule.type === 'total_net') {
                // For Net, logic is tricky because negative threshold. 
                // Reward: (newT - consumed >= thresh) AND (oldT - consumed < thresh)
                if (rule.resultType === 'reward') {
                    if ((newT - consumedVal >= rule.threshold) && (oldT - consumedVal < rule.threshold)) {
                        showTriggerAlert(rule); return {triggeredNow:true, type:'reward'};
                    }
                } else {
                    // Penalty: (newT <= consumed - abs(thresh)) AND (oldT > consumed - abs(thresh))
                    const target = consumedVal - Math.abs(rule.threshold);
                    if (newT <= target && oldT > target) {
                        showTriggerAlert(rule); return {triggeredNow:true, type:'penalty'};
                    }
                }
            }
            else {
                if (rule.type === 'total_pos') { oldVal = oldP; newVal = newP; }
                else if (rule.type === 'total_neg') { oldVal = oldN; newVal = newN; }
                else if (rule.type === 'specific') {
                    const b = db.behaviors.find(x => x.id === rule.targetId);
                    if (!b) continue;
                    const oldC = (dateKey === getKey(viewingDate)) ? (db.logs[dateKey].behaviors[b.id] - (newVal > oldVal ? 1 : -1)) : 0; // Approx back calc not needed, passed in args won't work for specific.
                    // Better: re-calc specific from counts passed implicitly? No.
                    // Recalculate specific old/new from logs is hard because log is updated.
                    // Use the fact that only ONE behavior changed.
                    const bId = rule.targetId;
                    const count = log.behaviors[bId] || 0;
                    newVal = count * b.weight;
                    // Predict old val: if we added 1, old was count-1.
                    // We don't know delta here easily without passing it.
                    // Simplified approach: Just check if we crossed NOW.
                    // Since we updated DB, newVal is current.
                    // We rely on the generic 'checkTriggers' to find ACTIVE triggers, but for ANIMATION we need to know if it JUST happened.
                    // Let's use the 'checkTriggers' standard logic but with a flag check? No.
                    // Let's use the fact that (newVal - consumed >= threshold) AND we know we just clicked.
                    // If (newVal - consumed == threshold) -> exact hit? No, weights might jump over.
                    // We need previous value.
                    // Let's recalculate oldVal for specific from the delta.
                    // This function needs refactoring to just check global triggers.
                }
            }
        }
        // Fallback to standard check for display, but for animation we need precise event.
        // Let's rely on standard check triggers to SHOW the box.
        // For animation, we return TRUE if a NEW box appeared.
        return checkTriggers(dateKey, newT, newP, newN, true); // Use the checkOnly mode
    }

    // Standard Check (Renders Box or Returns Status)
    function checkTriggers(dateKey, total, posTotal, negTotal, checkOnly) {
        const log = db.logs[dateKey];
        const consumed = log.consumed || {};
        const area = document.getElementById('triggerArea');
        if(!checkOnly) area.innerHTML = '';

        for (let rule of db.rules) {
            let cur = 0, cons = consumed[rule.id] || 0;
            let triggered = false;

            if (rule.type === 'total_net') {
                cur = total;
                if (rule.resultType === 'reward') { if(cur - cons >= rule.threshold) triggered=true; }
                else { if(cur <= (cons - Math.abs(rule.threshold))) triggered=true; }
            } else if (rule.type === 'total_pos') {
                cur = posTotal; if(cur - cons >= rule.threshold) triggered=true;
            } else if (rule.type === 'total_neg') {
                cur = negTotal; if(cur - cons >= rule.threshold) triggered=true;
            } else if (rule.type === 'specific') {
                const b = db.behaviors.find(x => x.id === rule.targetId);
                if(b) { cur = (log.behaviors[b.id]||0)*b.weight; if(cur - cons >= rule.threshold) triggered=true; }
            }

            if (triggered) {
                if (checkOnly) {
                    // Logic to detect if this is a "Fresh" trigger for animation
                    // If the difference is exactly roughly the weight (meaning we just crossed), or simply if a trigger exists and user just clicked.
                    // To prevent spamming on every click after passing:
                    // We need to know if we *just* crossed.
                    // Logic: (Current - Consumed >= Threshold) AND (Current - Consumed - Weight < Threshold).
                    // Approximation for animation:
                    let weight = 1; // min
                    if(rule.type==='specific') { const b=db.behaviors.find(x=>x.id===rule.targetId); if(b) weight=b.weight; }
                    
                    let diff = 0;
                    if(rule.type==='total_net' && rule.resultType==='penalty') diff = (cons - Math.abs(rule.threshold)) - cur;
                    else diff = cur - cons - rule.threshold;
                    
                    if (diff >= 0 && diff < Math.max(5, weight*2)) { 
                        return { triggeredNow: true, type: rule.resultType };
                    }
                    return null; 
                }
                showTriggerAlert(rule);
                break; // Show one at a time
            }
        }
        return null;
    }

    function showTriggerAlert(rule) {
        const area = document.getElementById('triggerArea');
        area.style.display = 'block';
        const isRew = rule.resultType === 'reward';
        const color = isRew ? 'var(--success)' : 'var(--danger)';
        const bg = isRew ? '#ecfdf5' : '#fef2f2';
        const title = isRew ? '🎉 تبریک! پاداش فعال شد:' : '⚠️ هشدار! حد نصاب جریمه:';
        
        area.innerHTML = `
            <div class="trigger-box" style="border-color:${color}; background:${bg}; display:block;">
                <div class="trigger-header" style="color:${color}">${title}</div>
                <div style="margin-bottom:10px; font-weight:bold;">${rule.resultText}</div>
                <div class="trigger-actions">
                    <button class="btn btn-accept" onclick="acceptTrigger('${rule.id}')">ثبت در اقدامات</button>
                    <button class="btn btn-change" onclick="ignoreTrigger()">نادیده گرفتن</button>
                </div>
            </div>
        `;
    }

    function acceptTrigger(ruleId) {
        const key = getKey(viewingDate);
        const rule = db.rules.find(r => r.id === ruleId);
        const log = db.logs[key];
        const now = new Date();
        const dateStr = getVerbalDate(now);
        const timeStr = now.toLocaleTimeString('fa-IR', {hour:'2-digit', minute:'2-digit', hour12:false});

        // Time range logic
        const prev = log.actions.filter(a => a.ruleId === ruleId);
        let timeRange = prev.length === 0 ? `از ۰۰:۰۰ تا ${timeStr}` : `مابین ${prev[prev.length-1].rawTime} تا ${timeStr}`;

        log.actions.push({
            id: Date.now(), ruleId: ruleId,
            text: rule.resultText, type: rule.resultType,
            reason: rule.type==='specific' ? db.behaviors.find(b=>b.id===rule.targetId)?.title : 'مجموع امتیاز',
            dateStr: dateStr, timeRange: timeRange, rawTime: timeStr, done: false
        });

        if (!log.consumed[ruleId]) log.consumed[ruleId] = 0;
        if (rule.type==='total_net' && rule.resultType==='penalty') log.consumed[ruleId] -= Math.abs(rule.threshold);
        else log.consumed[ruleId] += rule.threshold;

        saveDB();
        document.getElementById('triggerArea').style.display = 'none';
        renderHome();
    }

    function ignoreTrigger() { document.getElementById('triggerArea').style.display = 'none'; }

    // --- Animations ---
    function triggerConfetti(card) {
        if(!card) return;
        const rect = card.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f', 'gold'];
        
        for(let i=0; i<40; i++) {
            const el = document.createElement('div');
            el.className = 'confetti';
            el.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
            el.style.left = cx+'px'; el.style.top = cy+'px';
            const angle = Math.random()*Math.PI*2;
            const vel = 100 + Math.random()*200;
            const tx = Math.cos(angle)*vel;
            const ty = Math.sin(angle)*vel;
            const rot = Math.random()*360;
            el.style.setProperty('--tx', tx+'px'); el.style.setProperty('--ty', ty+'px'); el.style.setProperty('--rot', rot+'deg');
            document.body.appendChild(el);
            el.style.animation = 'flyOut 1s ease-out forwards';
            setTimeout(()=>el.remove(), 1000);
        }
    }

    function triggerPenaltyEffect() {
        document.body.classList.add('shake-screen');
        const ov = document.getElementById('penaltyOverlay');
        ov.classList.add('active');
        if(navigator.vibrate) navigator.vibrate(400);
        setTimeout(()=>{
            document.body.classList.remove('shake-screen');
            ov.classList.remove('active');
        }, 500);
    }

    // --- Actions ---
    function renderActionsTab() {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        const cont = document.getElementById('actionsListFull');
        cont.innerHTML = '';
        
        const rew = actions.filter(a=>a.type==='reward');
        const pen = actions.filter(a=>a.type==='penalty');
        document.getElementById('totalRewardCount').innerText = rew.length;
        document.getElementById('totalPenaltyCount').innerText = pen.length;
        document.getElementById('totalDoneCount').innerText = actions.filter(a=>a.done).length;
        document.getElementById('totalPendingCount').innerText = actions.filter(a=>!a.done).length;

        let filtered = actions;
        if(currentActionFilter) filtered = filtered.filter(a=>a.type===currentActionFilter);
        const s = document.getElementById('actionsSearch').value.toLowerCase();
        if(s) filtered = filtered.filter(a=>a.text.toLowerCase().includes(s));

        if(filtered.length===0) cont.innerHTML = '<p style="text-align:center; color:#999">موردی یافت نشد.</p>';
        
        filtered.forEach(a => {
            cont.innerHTML += `
                <div class="action-item" onclick="openActionDetail(${a.id})">
                    <div class="action-checkbox ${a.done?'checked':''}" onclick="event.stopPropagation(); toggleAction(${a.id})">
                        <i class="fas fa-check" style="${a.done?'':'display:none'}"></i>
                    </div>
                    <div class="action-content">
                        <span class="${a.type==='reward'?'badge-reward':'badge-penalty'}">${a.type==='reward'?'پاداش':'جریمه'}</span>
                        <div style="font-weight:bold; margin-top:5px;">${a.text}</div>
                        <div style="font-size:0.75rem; color:#64748b;">${a.reason} | ${a.rawTime}</div>
                    </div>
                    <i class="fas fa-trash btn-icon delete" onclick="event.stopPropagation(); deleteAction(${a.id})"></i>
                </div>
            `;
        });
    }

    function filterActionsTab(type) { currentActionFilter = (currentActionFilter===type)?null:type; renderActionsTab(); }
    function toggleAction(id) { 
        const key = getKey(viewingDate); 
        const act = db.logs[key]?.actions.find(a=>a.id===id); 
        if(act){ act.done=!act.done; saveDB(); renderActionsTab(); renderHome(); } 
    }
    function deleteAction(id) { 
        if(confirm('حذف شود؟')) { 
            const key = getKey(viewingDate); 
            db.logs[key].actions = db.logs[key].actions.filter(a=>a.id!==id); 
            saveDB(); renderActionsTab(); 
        } 
    }

    // --- Details Modal ---
    function openActionDetail(id) {
        currentActionEditId = id;
        let key = getKey(viewingDate);
        let action = db.logs[key]?.actions.find(a=>a.id===id);
        if(!action && tempDateRangeResults) {
            const t = tempDateRangeResults.find(a=>a.id===id);
            if(t) { key = t._dateKey; action = db.logs[key].actions.find(a=>a.id===id); }
        }
        if(!action) return;

        const content = `
            <div class="detail-row"><span class="detail-label">عنوان:</span><span class="detail-value">${action.text}</span></div>
            <div class="detail-row"><span class="detail-label">نوع:</span><span style="color:${action.type==='reward'?'var(--success)':'var(--danger)'}">${action.type==='reward'?'پاداش':'جریمه'}</span></div>
            <div class="detail-row"><span class="detail-label">علت:</span><span>${action.reason}</span></div>
            <div class="detail-row"><span class="detail-label">زمان:</span><span>${action.dateStr} - ${action.timeRange}</span></div>
            <div class="detail-row"><span class="detail-label">وضعیت:</span><span>${action.done?'انجام شده':'انجام نشده'}</span></div>
        `;
        document.getElementById('actionDetailContent').innerHTML = content;
        
        // Fix 5: Disable edit if done
        const editDiv = document.getElementById('actionEditControls');
        if (action.done) {
            editDiv.style.display = 'none';
        } else {
            editDiv.style.display = 'block';
            document.getElementById('actionEditText').value = action.text;
        }
        
        document.getElementById('actionDetailModal').style.display = 'flex';
    }

    function saveActionEdit() {
        const txt = document.getElementById('actionEditText').value.trim();
        if(!txt) return alert('خالی است');
        let key = getKey(viewingDate);
        let act = db.logs[key]?.actions.find(a=>a.id===currentActionEditId);
        if(!act && tempDateRangeResults) {
             const t = tempDateRangeResults.find(a=>a.id===currentActionEditId);
             if(t) { key = t._dateKey; act = db.logs[key].actions.find(a=>a.id===currentActionEditId); }
        }
        if(act) { act.text = txt; saveDB(); alert('ذخیره شد'); document.getElementById('actionDetailModal').style.display='none'; renderActionsTab(); renderHome(); }
    }

    // --- Editors ---
    function openEditor(t) { currentEditorMode = t; document.getElementById('editorModal').style.display='flex'; document.getElementById('ruleListToggle').style.display = t==='rule'?'flex':'none'; renderEditorList(); }
    function toggleRuleList(t) { currentRuleFilter = t; document.getElementById('toggleVirtueBtn').className = t==='virtue'?'toggle-btn active':'toggle-btn'; document.getElementById('toggleViceBtn').className = t==='vice'?'toggle-btn active':'toggle-btn'; renderEditorList(); }
    function closeEditor() { document.getElementById('editorModal').style.display='none'; renderHome(); }

    function renderEditorList() {
        const cont = document.getElementById('editorListContainer'); cont.innerHTML='';
        const s = document.getElementById('editorSearch').value.toLowerCase();
        
        if(currentEditorMode === 'behavior') {
            db.behaviors.filter(b=>(b.type===currentRuleFilter && b.title.toLowerCase().includes(s))).forEach((b, i)=>{
                const idx = db.behaviors.indexOf(b);
                cont.innerHTML += `
                    <div class="list-row">
                        <span>${b.title} <small>(${b.weight})</small></span>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="openEditForm(${idx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('behavior', ${idx})"></i>
                        </div>
                    </div>`;
            });
        } else {
            db.rules.filter(r=>{
                if(r.type==='specific') { const b=db.behaviors.find(x=>x.id===r.targetId); return b && b.type===currentRuleFilter; }
                if(currentRuleFilter==='virtue') return r.type==='total_pos' || (r.type==='total_net' && r.resultType==='reward');
                return r.type==='total_neg' || (r.type==='total_net' && r.resultType==='penalty');
            }).forEach(r=>{
                const idx = db.rules.indexOf(r);
                let title = r.type==='specific' ? db.behaviors.find(b=>b.id===r.targetId)?.title : (r.type==='total_pos'?'مجموع مثبت':(r.type==='total_neg'?'مجموع منفی':'امتیاز کل'));
                // Fix 6: Show weight in config
                let wInfo = "";
                if(r.type==='specific') { const b=db.behaviors.find(x=>x.id===r.targetId); if(b) wInfo = ` (ضریب: ${b.weight})`; }
                
                cont.innerHTML += `
                    <div class="list-row">
                        <div>
                            <strong>${title}${wInfo}</strong> > ${Math.abs(r.threshold)}
                            <div style="font-size:0.8rem; color:#666">${r.resultText}</div>
                        </div>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="openEditForm(${idx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('rule', ${idx})"></i>
                        </div>
                    </div>`;
            });
        }
    }

    function openEditForm(idx) {
        editingItemId = idx;
        document.getElementById('editFormModal').style.display='flex';
        document.getElementById('behaviorFields').style.display = currentEditorMode==='behavior'?'block':'none';
        document.getElementById('ruleFields').style.display = currentEditorMode==='rule'?'block':'none';
        
        if(currentEditorMode==='behavior') {
            if(idx!==null) { const b=db.behaviors[idx]; document.getElementById('behTitle').value=b.title; document.getElementById('behType').value=b.type; document.getElementById('behWeight').value=b.weight; }
            else { document.getElementById('behTitle').value=''; document.getElementById('behWeight').value=1; }
        } else {
            populateTargetSelect();
            if(idx!==null) {
                const r=db.rules[idx];
                document.getElementById('ruleType').value=r.type; toggleRuleInputs();
                if(r.targetId) document.getElementById('ruleTargetId').value=r.targetId;
                document.getElementById('ruleThreshold').value=Math.abs(r.threshold);
                document.getElementById('ruleResultText').value=r.resultText;
                updateRuleResultTypeBasedOnTarget();
            } else {
                document.getElementById('ruleThreshold').value=''; document.getElementById('ruleResultText').value='';
            }
        }
    }

    function populateTargetSelect() {
        const sel = document.getElementById('ruleTargetId'); sel.innerHTML='';
        db.behaviors.forEach(b=>{ sel.innerHTML+=`<option value="${b.id}" data-type="${b.type}">${b.title} (ضریب: ${b.weight})</option>`; });
        updateRuleResultTypeBasedOnTarget();
    }

    function saveEditorItem() {
        if(currentEditorMode==='behavior') {
            const t = document.getElementById('behTitle').value; const w = parseInt(document.getElementById('behWeight').value);
            const type = document.getElementById('behType').value;
            if(!t) return alert('عنوان؟');
            if(editingItemId!==null) { db.behaviors[editingItemId].title=t; db.behaviors[editingItemId].weight=w; db.behaviors[editingItemId].type=type; }
            else { db.behaviors.push({id:'b'+Date.now(), title:t, type:type, weight:w}); }
        } else {
            const rt = document.getElementById('ruleType').value;
            const th = parseInt(document.getElementById('ruleThreshold').value);
            const txt = document.getElementById('ruleResultText').value;
            if(!txt || isNaN(th)) return alert('ناقص');
            const nr = {
                id: editingItemId!==null?db.rules[editingItemId].id:'r'+Date.now(),
                type: rt,
                targetId: rt==='specific'?document.getElementById('ruleTargetId').value:null,
                threshold: Math.abs(th),
                resultType: document.getElementById('ruleResultType').value,
                resultText: txt,
                isSpecific: document.getElementById('ruleIsSpecific').checked
            };
            if(editingItemId!==null) db.rules[editingItemId]=nr; else db.rules.push(nr);
        }
        saveDB(); document.getElementById('editFormModal').style.display='none'; renderEditorList();
    }

    function deleteItem(mode, idx) {
        if(confirm('حذف؟')) { if(mode==='behavior') db.behaviors.splice(idx,1); else db.rules.splice(idx,1); saveDB(); renderEditorList(); }
    }

    // --- Misc Helpers ---
    function filterEditorList() { renderEditorList(); }
    function toggleRuleInputs() {
        const t = document.getElementById('ruleType').value;
        document.getElementById('specificBehDiv').style.display = t==='specific'?'block':'none';
        const resDisp = document.getElementById('ruleResultTypeDisplay');
        const resVal = document.getElementById('ruleResultType');
        if(t==='total_pos') { resDisp.value='پاداش'; resVal.value='reward'; }
        else if(t==='total_neg') { resDisp.value='جریمه'; resVal.value='penalty'; }
        else if(t==='specific') updateRuleResultTypeBasedOnTarget();
    }
    function updateRuleResultTypeBasedOnTarget() {
        const sel = document.getElementById('ruleTargetId');
        if(sel.selectedIndex<0) return;
        const type = sel.options[sel.selectedIndex].getAttribute('data-type');
        document.getElementById('ruleResultTypeDisplay').value = type==='virtue'?'پاداش':'جریمه';
        document.getElementById('ruleResultType').value = type==='virtue'?'reward':'penalty';
    }

    // --- Stats Lists ---
    function openActionListModal(type, done) {
        const key = getKey(viewingDate);
        const acts = db.logs[key]?.actions || [];
        const filtered = acts.filter(a=>(type?a.type===type:true) && a.done===done);
        const cont = document.getElementById('actionListPopupContent'); cont.innerHTML='';
        document.getElementById('actionListPopupTitle').innerText = (type==='reward'?'پاداش‌ها':type==='penalty'?'جریمه‌ها':'اقدامات') + (done?' (انجام شده)':' (مانده)');
        
        if(filtered.length===0) cont.innerHTML='<p style="text-align:center">خالی</p>';
        else filtered.forEach(a=>{
            cont.innerHTML += `<div class="action-item" onclick="openActionDetail(${a.id})">
                <div class="action-content"><strong>${a.text}</strong><div style="font-size:0.8rem; color:#666">${a.reason}</div></div>
            </div>`;
        });
        document.getElementById('actionListPopupModal').style.display='flex';
    }

</script>
</body>
</html>
