<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³Ø§Ù…Ø§Ù†Ù‡ Ø¬Ø§Ù…Ø¹ Ù¾Ø§ÛŒØ´ Ø§Ø®Ù„Ø§Ù‚ | Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ Ùˆ Ú©Ø§Ù…Ù„</title>
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-body: #f8fafc;
            --surface: #ffffff;
            --primary: #3b82f6;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --success-dark: #047857;
            --danger: #ef4444;
            --danger-dark: #b91c1c;
            --neutral: #64748b;
            --text-main: #0f172a;
            --text-light: #64748b;
            --border-radius: 16px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Vazirmatn', sans-serif;
            margin: 0; padding: 0; padding-bottom: 100px;
            overflow-x: hidden;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 15px; }

        /* --- Header Area --- */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding: 0 5px;
        }

        .manifesto-btn {
            background: var(--surface); color: var(--primary);
            border: 1px solid var(--primary); padding: 8px 16px;
            border-radius: 50px; font-size: 0.85rem; font-weight: bold;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
            box-shadow: var(--shadow); transition: 0.2s;
        }
        .manifesto-btn.read { background: var(--success); color: white; border-color: var(--success); }

        .date-navigator {
            display: flex; align-items: center; gap: 15px;
            background: var(--surface); padding: 6px 12px;
            border-radius: 12px; box-shadow: var(--shadow);
        }
        .date-btn { background: none; border: none; color: var(--text-main); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; }
        .date-btn:disabled { opacity: 0.3; cursor: not-allowed; }
        .date-text { font-weight: bold; font-size: 0.9rem; }

        /* --- Dynamic Score Card --- */
        .score-card {
            color: white; padding: 25px; border-radius: 24px;
            text-align: center; box-shadow: var(--shadow);
            margin-bottom: 25px; transition: background 0.5s ease;
            position: relative; overflow: hidden;
        }
        
        /* Dynamic Background Classes */
        .score-card.neutral { background: linear-gradient(135deg, #64748b 0%, #475569 100%); }
        .score-card.positive { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .score-card.negative { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); }

        .main-score { font-size: 4rem; font-weight: 900; line-height: 1; text-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .score-label { font-size: 0.9rem; opacity: 0.9; letter-spacing: 1px; margin-bottom: 5px; }
        
        .sub-scores {
            display: flex; justify-content: space-around; margin-top: 20px;
            background: rgba(0,0,0,0.15); padding: 10px; border-radius: 16px;
        }
        .sub-score-item { display: flex; flex-direction: column; }
        .sub-val { font-weight: 800; font-size: 1.2rem; }
        .sub-lbl { font-size: 0.75rem; opacity: 0.8; }

        /* --- Lists --- */
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin: 25px 0 10px 0; padding: 0 5px;
        }
        .section-title { font-size: 1.1rem; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .virtue-text { color: var(--success-dark); }
        .vice-text { color: var(--danger-dark); }

        .card {
            background: var(--surface); border-radius: var(--border-radius);
            padding: 16px; margin-bottom: 12px; box-shadow: var(--shadow);
            border-right: 5px solid transparent; position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:active { transform: scale(0.98); }
        .card.virtue { border-right-color: var(--success); }
        .card.vice { border-right-color: var(--danger); }

        .card-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .item-name { font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .item-weight { font-size: 0.7rem; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: var(--text-light); }
        
        /* Stepper */
        .stepper { display: flex; align-items: center; background: #f8fafc; border-radius: 10px; padding: 3px; border: 1px solid #e2e8f0; }
        .step-btn {
            width: 30px; height: 30px; border: none; background: white; border-radius: 8px;
            font-size: 1.2rem; cursor: pointer; color: var(--text-main);
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center;
        }
        .step-val { width: 30px; text-align: center; font-weight: bold; font-size: 1rem; }

        .note-input {
            width: 100%; border: none; border-top: 1px solid #f1f5f9;
            padding: 8px 0 0 0; margin-top: 5px; font-size: 0.85rem;
            background: transparent; color: var(--text-main);
        }

        /* --- Action List (Tasks) --- */
        .action-item {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            display: flex; align-items: center; gap: 12px; box-shadow: var(--shadow);
            border: 1px solid #f1f5f9;
        }
        .action-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #cbd5e1;
            display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0;
        }
        .action-checkbox.checked { background: var(--success); border-color: var(--success); color: white; }
        .action-content { flex: 1; }
        .action-badge { font-size: 0.7rem; padding: 2px 8px; border-radius: 4px; font-weight: bold; }
        .badge-reward { background: #d1fae5; color: #065f46; }
        .badge-penalty { background: #fee2e2; color: #991b1b; }

        /* --- Trigger Alert Box --- */
        .trigger-box {
            background: #fff7ed; border: 1px solid #ffedd5; border-radius: 16px;
            padding: 15px; margin-bottom: 20px; display: none;
            animation: slideDown 0.3s ease;
        }
        .trigger-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-weight: bold; }
        .trigger-actions { display: flex; gap: 10px; }
        .btn { padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
        .btn-accept { background: var(--primary); color: white; flex: 1; }
        .btn-change { background: white; border: 1px solid #cbd5e1; color: var(--text-light); }
        .btn-danger-outline { background: white; border: 1px solid var(--danger); color: var(--danger); }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Bottom Nav --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 12px 0;
            border-top: 1px solid #f1f5f9; box-shadow: 0 -4px 20px rgba(0,0,0,0.03);
            z-index: 900;
        }
        .nav-item {
            background: none; border: none; display: flex; flex-direction: column;
            align-items: center; color: #94a3b8; gap: 5px; font-size: 0.7rem; cursor: pointer;
        }
        .nav-item i { font-size: 1.4rem; }
        .nav-item.active { color: var(--primary); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(3px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 20px;
            padding: 20px; max-height: 90vh; overflow-y: auto;
        }

        /* Settings Forms */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-size: 0.9rem; font-weight: bold; }
        .form-input, .form-select { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; }
        .list-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
        .btn-icon { background: none; border: none; color: var(--text-light); cursor: pointer; font-size: 1rem; }
        .btn-icon.edit { color: var(--primary); }
        .btn-icon.delete { color: var(--danger); }
        
        /* Search Bar */
        .search-box {
            margin-bottom: 15px;
            position: relative;
        }
        .search-box input {
            width: 100%;
            padding: 10px 35px 10px 10px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-family: inherit;
        }
        .search-box i {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        /* Manifesto Text */
        .manifesto-content {
            font-size: 0.95rem; line-height: 1.8; text-align: justify;
            background: #f8fafc; padding: 15px; border-radius: 12px;
            max-height: 60vh; overflow-y: auto; border: 1px solid #e2e8f0;
            margin: 15px 0;
        }

        /* Tab Visibility */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Toggle Switch for Lists */
        .list-toggle {
            display: flex;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        .toggle-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: white;
            cursor: pointer;
            font-weight: bold;
            color: var(--text-light);
        }
        .toggle-btn.active {
            background: var(--primary);
            color: white;
        }
        
        /* Actions Summary Buttons */
        .action-summary {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .summary-btn {
            flex: 1;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: transform 0.1s;
        }
        .summary-btn:active { transform: scale(0.98); }
        .summary-count { font-size: 1.5rem; font-weight: 900; display: block; }
        .summary-label { font-size: 0.85rem; opacity: 0.8; }
        .text-reward { color: var(--success); }
        .text-penalty { color: var(--danger); }

        /* Action Details Modal Specifics */
        .action-detail-item {
            background: #f8fafc;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .action-detail-meta {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 4px;
        }

    </style>
</head>
<body>

<div id="app">

    <!-- TAB: HOME -->
    <div id="tab-home" class="tab-content active">
        <div class="container">
            
            <div class="top-bar">
                <button class="manifesto-btn" onclick="openManifestoModal()">
                    <i class="fas fa-book-open"></i> <span id="manifestoBtnText">Ù…Ù†Ø´ÙˆØ± Ø§Ø®Ù„Ø§Ù‚ÛŒ</span>
                </button>
                <div class="date-navigator">
                    <button class="date-btn" onclick="navigateDate(-1)"><i class="fas fa-chevron-right"></i></button>
                    <div class="date-text" id="headerDateDisplay">...</div>
                    <button class="date-btn" id="nextDayBtn" onclick="navigateDate(1)" disabled><i class="fas fa-chevron-left"></i></button>
                </div>
            </div>

            <div class="score-card neutral" id="scoreCard">
                <div class="score-label">ØªØ±Ø§Ø² Ø§Ù…Ø±ÙˆØ²</div>
                <div class="main-score" id="totalScoreDisplay">0</div>
                <div class="sub-scores">
                    <div class="sub-score-item">
                        <span class="sub-val" id="posScoreDisplay">0</span>
                        <span class="sub-lbl">Ù…Ø«Ø¨Øª</span>
                    </div>
                    <div class="sub-score-item">
                        <span class="sub-val" id="negScoreDisplay">0</span>
                        <span class="sub-lbl">Ù…Ù†ÙÛŒ</span>
                    </div>
                </div>
            </div>

            <!-- Trigger Notification Area -->
            <div id="triggerArea"></div>

            <!-- Pending Actions Summary (Modified per Instruction 1) -->
            <div id="homePendingSummary" class="action-summary" style="display:none;">
                <div class="summary-btn" onclick="openActionDetails('reward')">
                    <span class="summary-count text-reward" id="pendingRewardCount">0</span>
                    <span class="summary-label text-reward">Ù¾Ø§Ø¯Ø§Ø´ ÙØ¹Ø§Ù„</span>
                </div>
                <div class="summary-btn" onclick="openActionDetails('penalty')">
                    <span class="summary-count text-penalty" id="pendingPenaltyCount">0</span>
                    <span class="summary-label text-penalty">Ø¬Ø±ÛŒÙ…Ù‡ ÙØ¹Ø§Ù„</span>
                </div>
            </div>

            <!-- Search -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="homeSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø±ÙØªØ§Ø±Ù‡Ø§..." oninput="filterHomeList()">
            </div>

            <!-- Virtues -->
            <div class="section-header">
                <span class="section-title virtue"><i class="fas fa-check-circle"></i> ÙØ¶Ø§ÛŒÙ„</span>
            </div>
            <div id="virtuesList"></div>

            <!-- Vices -->
            <div class="section-header">
                <span class="section-title vice"><i class="fas fa-times-circle"></i> Ø±Ø°Ø§ÛŒÙ„</span>
            </div>
            <div id="vicesList"></div>

        </div>
    </div>

    <!-- TAB: ACTIONS -->
    <div id="tab-actions" class="tab-content">
        <div class="container">
            <h2 style="margin-top:0;">Ú©Ø§Ø±Ù†Ø§Ù…Ù‡ Ø¹Ù…Ù„ÛŒ</h2>
            <p style="color:var(--text-light); font-size:0.9rem;">Ù„ÛŒØ³Øª Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§ Ùˆ Ø¬Ø±ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ø±ÙˆØ².</p>
            
            <!-- Search for Actions (Instruction 2) -->
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="actionSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø§Ù‚Ø¯Ø§Ù…Ø§Øª..." oninput="filterActionList()">
            </div>

            <!-- Filter Toggles (Instruction 2) -->
            <div class="list-toggle" style="margin-bottom:20px;">
                <button class="toggle-btn active" onclick="filterActionType('all')" id="filterAllBtn">Ù‡Ù…Ù‡</button>
                <button class="toggle-btn" onclick="filterActionType('reward')" id="filterRewardBtn" style="color:var(--success)">Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§</button>
                <button class="toggle-btn" onclick="filterActionType('penalty')" id="filterPenaltyBtn" style="color:var(--danger)">Ø¬Ø±ÛŒÙ…Ù‡â€ŒÙ‡Ø§</button>
            </div>

            <div id="actionsListFull"></div>
        </div>
    </div>

    <!-- TAB: SETTINGS -->
    <div id="tab-settings" class="tab-content">
        <div class="container">
            <h2>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>
            
            <div class="card">
                <h3>Ø±ÙØªØ§Ø±Ù‡Ø§ (ÙØ¶Ø§ÛŒÙ„ Ùˆ Ø±Ø°Ø§ÛŒÙ„)</h3>
                <button class="btn btn-accept" style="width:100%" onclick="openEditor('behavior')">Ù…Ø¯ÛŒØ±ÛŒØª Ù„ÛŒØ³Øª Ø±ÙØªØ§Ø±Ù‡Ø§</button>
            </div>

            <div class="card">
                <h3>Ù‚ÙˆØ§Ù†ÛŒÙ† Ù¾Ø§Ø¯Ø§Ø´ Ùˆ Ø¬Ø±ÛŒÙ…Ù‡</h3>
                <p style="font-size:0.8rem; color:var(--text-light);">ØªØ¹ÛŒÛŒÙ† Ú©Ù†ÛŒØ¯ Ø¯Ø± Ú†Ù‡ Ø§Ù…ØªÛŒØ§Ø²ÛŒ Ú†Ù‡ Ø§ØªÙØ§Ù‚ÛŒ Ø¨ÛŒÙØªØ¯.</p>
                <button class="btn btn-accept" style="width:100%" onclick="openEditor('rule')">Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ†</button>
            </div>

            <div class="card">
                <h3>Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ</h3>
                <button class="btn btn-accept" style="background:var(--success); width:100%" onclick="backupData()">Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
                <input type="file" id="restoreFile" style="display:none" onchange="restoreData(this)">
                <button class="btn btn-change" style="width:100%; margin-top:10px;" onclick="document.getElementById('restoreFile').click()">Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>

            <div class="card" style="border-right-color: var(--danger);">
                <h3 style="color:var(--danger);">Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h3>
                <button class="btn btn-danger-outline" style="width:100%" onclick="openClearDataModal()">Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª</button>
            </div>
            
            <br><br><br>
        </div>
    </div>

</div>

<!-- NAVIGATION -->
<div class="nav-bar">
    <button class="nav-item active" onclick="switchTab('home')">
        <i class="fas fa-home"></i>
        <span>Ø§Ù…Ø±ÙˆØ²</span>
    </button>
    <button class="nav-item" onclick="switchTab('actions')">
        <i class="fas fa-clipboard-list"></i>
        <span>Ø§Ù‚Ø¯Ø§Ù…Ø§Øª</span>
    </button>
    <button class="nav-item" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i>
        <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
    </button>
</div>

<!-- MODAL: MANIFESTO -->
<div id="manifestoModal" class="modal-overlay">
    <div class="modal-content" style="position:relative; max-height:85vh; display:flex; flex-direction:column;">
        <div style="position:absolute; top:15px; left:15px; z-index:10; cursor:pointer;" onclick="document.getElementById('manifestoModal').style.display='none'">
            <i class="fas fa-times" style="font-size:1.2rem; color:var(--text-light);"></i>
        </div>
        <h3 style="text-align:center; color:var(--primary); margin-top:0;">Ù…Ø±ÙˆØ± Ø¹Ù‡Ø¯Ù†Ø§Ù…Ù‡</h3>
        <div class="manifesto-content" id="manifestoTextContainer">
            <!-- Text injected via JS -->
        </div>
        <button id="manifestoConfirmBtn" class="btn btn-accept" style="width:100%; opacity:0.5;" disabled onclick="confirmManifestoRead()">ØªØ§ÛŒÛŒØ¯ Ùˆ ØªØ¹Ù‡Ø¯</button>
        <p style="text-align:center; font-size:0.75rem; color:red; margin-top:5px;">(Ù„Ø·ÙØ§Ù‹ ØªØ§ Ø§Ù†ØªÙ‡Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯)</p>
    </div>
</div>

<!-- MODAL: ACTION DETAILS (HOME POPUP) -->
<div id="actionDetailsModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="actionDetailTitle" style="margin:0">Ø¬Ø²Ø¦ÛŒØ§Øª</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="document.getElementById('actionDetailsModal').style.display='none'"></i>
        </div>
        <div id="actionDetailList" style="max-height:400px; overflow-y:auto;"></div>
    </div>
</div>

<!-- MODAL: ONBOARDING (NAME) -->
<div id="nameModal" class="modal-overlay">
    <div class="modal-content" style="text-align:center;">
        <h3>Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h3>
        <p>Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¯Ø± Ù…Ù†Ø´ÙˆØ± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:</p>
        <input type="text" id="userNameInput" class="form-input" placeholder="Ù†Ø§Ù… Ø´Ù…Ø§..." style="text-align:center; font-size:1.2rem;">
        <br><br>
        <button class="btn btn-accept" onclick="saveName()">Ø«Ø¨Øª Ùˆ Ø´Ø±ÙˆØ¹</button>
    </div>
</div>

<!-- MODAL: CLEAR DATA -->
<div id="clearDataModal" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--danger)">Ø­Ø°Ù Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
        <p>Ù„Ø·ÙØ§Ù‹ Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:</p>
        
        <div class="form-group">
            <label>
                <input type="radio" name="clearOption" value="today" checked> Ø§Ù…Ø±ÙˆØ²
            </label>
        </div>
        <div class="form-group">
            <label>
                <input type="radio" name="clearOption" value="all"> ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª (Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ø§Ø±Ø®Ø§Ù†Ù‡)
            </label>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn btn-danger" style="flex:1" onclick="performClearData()">Ø­Ø°Ù Ú©Ù†</button>
            <button class="btn btn-change" style="flex:1" onclick="document.getElementById('clearDataModal').style.display='none'">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>
</div>

<!-- MODAL: EDITOR (GENERIC) -->
<div id="editorModal" class="modal-overlay">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h3 id="editorTitle" style="margin:0">ÙˆÛŒØ±Ø§ÛŒØ´</h3>
            <i class="fas fa-times" style="cursor:pointer; font-size:1.2rem;" onclick="closeEditor()"></i>
        </div>
        
        <!-- Toggle for Lists in Rule Mode -->
        <div id="ruleListToggle" class="list-toggle" style="display:none;">
            <button class="toggle-btn active" onclick="toggleRuleList('virtue')" id="toggleVirtueBtn">ÙØ¶Ø§ÛŒÙ„/Ù¾Ø§Ø¯Ø§Ø´</button>
            <button class="toggle-btn" onclick="toggleRuleList('vice')" id="toggleViceBtn">Ø±Ø°Ø§ÛŒÙ„/Ø¬Ø±ÛŒÙ…Ù‡</button>
        </div>
        
        <div class="search-box" style="margin-bottom:10px;">
             <i class="fas fa-search"></i>
             <input type="text" id="editorSearch" placeholder="Ø¬Ø³ØªØ¬Ùˆ..." oninput="filterEditorList()">
        </div>

        <div id="editorListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>

        <div style="border-top:1px solid #eee; padding-top:15px;">
            <h4 style="margin-top:0" id="formTitle">Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø¯ÛŒØ¯</h4>
            <input type="hidden" id="editId" value="">
            
            <!-- Fields for Behavior -->
            <div id="behaviorFields" style="display:none;">
                <div class="form-group">
                    <input type="text" id="behTitle" class="form-input" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø±ÙØªØ§Ø±">
                </div>
                <div class="form-group" style="display:flex; gap:10px;">
                    <select id="behType" class="form-select">
                        <option value="virtue">ÙØ¶ÛŒÙ„Øª (Ù…Ø«Ø¨Øª)</option>
                        <option value="vice">Ø±Ø°ÛŒÙ„Øª (Ù…Ù†ÙÛŒ)</option>
                    </select>
                    <input type="number" id="behWeight" class="form-input" placeholder="Ø§Ù…ØªÛŒØ§Ø²" value="1">
                </div>
            </div>

            <!-- Fields for Rules -->
            <div id="ruleFields" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Ù†ÙˆØ¹ Ø´Ø±Ø·:</label>
                    <select id="ruleType" class="form-select" onchange="toggleRuleInputs()">
                        <option value="total_pos">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø«Ø¨Øª Ø±ÙˆØ²Ø§Ù†Ù‡</option>
                        <option value="total_neg">Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø² Ù…Ù†ÙÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡</option>
                        <option value="total_net">Ø§Ù…ØªÛŒØ§Ø² Ø®Ø§Ù„Øµ (Ø¨Ø±Ø¢ÛŒÙ†Ø¯)</option>
                        <option value="specific">Ø±ÙØªØ§Ø± Ø®Ø§Øµ</option>
                    </select>
                </div>
                
                <div class="form-group" id="specificBehDiv" style="display:none;">
                    <label class="form-label">Ø§Ù†ØªØ®Ø§Ø¨ Ø±ÙØªØ§Ø±:</label>
                    <select id="ruleTargetId" class="form-select" onchange="updateRuleResultTypeBasedOnTarget()"></select>
                    <div id="ruleAutoTypeIndicator" style="font-size:0.8rem; margin-top:5px; padding:5px; border-radius:4px; display:inline-block;"></div>
                </div>

                <div class="form-group">
                    <label class="form-label">Ø­Ø¯ Ù†ØµØ§Ø¨ (ØªØ¹Ø¯Ø§Ø¯/Ø§Ù…ØªÛŒØ§Ø²):</label>
                    <input type="number" id="ruleThreshold" class="form-input" placeholder="Ù…Ø«Ù„Ø§ 20">
                </div>

                <div class="form-group">
                    <label class="form-label">Ù†ØªÛŒØ¬Ù‡ (Ù¾Ø§Ø¯Ø§Ø´/Ø¬Ø±ÛŒÙ…Ù‡):</label>
                    <div style="display:flex; gap:5px;">
                         <!-- Auto selected based on target/type but editable visually if needed, though logic dictates -->
                         <input type="text" id="ruleResultTypeDisplay" class="form-input" style="width:80px; background:#eee;" disabled>
                         <input type="hidden" id="ruleResultType">
                        <input type="text" id="ruleResultText" class="form-input" placeholder="Ù…Ø«Ù„Ø§: Ø¯ÛŒØ¯Ù† ÙÛŒÙ„Ù…">
                    </div>
                </div>
                <div class="form-group">
                    <label style="font-size:0.8rem; display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="ruleIsSpecific"> Ø§ÛŒÙ† Ù¾Ø§Ø¯Ø§Ø´/Ø¬Ø±ÛŒÙ…Ù‡ Ø§Ø®ØªØµØ§ØµÛŒ Ø§Ø³Øª (ØªØµØ§Ø¯ÙÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´ÙˆØ¯)
                    </label>
                </div>
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-accept" style="flex:1" onclick="saveEditorItem()">Ø°Ø®ÛŒØ±Ù‡</button>
                <button class="btn btn-change" style="display:none; flex:1" id="cancelEditBtn" onclick="resetEditorForm()">Ø§Ù†ØµØ±Ø§Ù</button>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 1. DATA STRUCTURE & INITIALIZATION
    // ==========================================
    
    const DEFAULT_DATA = {
        user: { name: "" },
        behaviors: [
            // Virtues
            { id: 'v1', title: 'Ø®Ø±Ø¯ÙˆØ±Ø²ÛŒ', type: 'virtue', weight: 5 },
            { id: 'v2', title: 'Ø§Ù†Ø¶Ø¨Ø§Ø· Ø´Ø®ØµÛŒ', type: 'virtue', weight: 4 },
            { id: 'v3', title: 'ØµØ¯Ø§Ù‚Øª', type: 'virtue', weight: 5 },
            { id: 'v4', title: 'Ù…Ø³Ø¦ÙˆÙ„ÛŒØªâ€ŒÙ¾Ø°ÛŒØ±ÛŒ', type: 'virtue', weight: 4 },
            { id: 'v5', title: 'Ù‡Ù…Ø¯Ù„ÛŒ', type: 'virtue', weight: 3 },
            { id: 'v6', title: 'Ú©Ù…Ú© Ø¨Ù‡ Ù‡Ù…Ù†ÙˆØ¹', type: 'virtue', weight: 5 },
            { id: 'v7', title: 'Ú©Ù†ØªØ±Ù„ Ø®Ø´Ù…', type: 'virtue', weight: 6 },
            { id: 'v8', title: 'Ø§Ø­ØªØ±Ø§Ù… Ø¨Ù‡ Ø­Ø±ÛŒÙ…â€ŒÙ‡Ø§', type: 'virtue', weight: 3 },
            { id: 'v9', title: 'Ø´Ú©Ø±Ú¯Ø²Ø§Ø±ÛŒ', type: 'virtue', weight: 2 },
            { id: 'v10', title: 'ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ù…Ø³ØªÙ…Ø±', type: 'virtue', weight: 4 },
            { id: 'v11', title: 'Ù†Ø¸Ø§ÙØª Ùˆ Ø¢Ø±Ø§Ø³ØªÚ¯ÛŒ', type: 'virtue', weight: 2 },
            { id: 'v12', title: 'ÙˆÙØ§ÛŒ Ø¨Ù‡ Ø¹Ù‡Ø¯', type: 'virtue', weight: 5 },
            { id: 'v13', title: 'Ø¹Ø¯Ø§Ù„Øª Ùˆ Ø§Ù†ØµØ§Ù', type: 'virtue', weight: 5 },
            { id: 'v14', title: 'Ø´Ø¬Ø§Ø¹Øª', type: 'virtue', weight: 4 },
            { id: 'v15', title: 'ØªØ§Ø¨â€ŒØ¢ÙˆØ±ÛŒ', type: 'virtue', weight: 3 },
            { id: 'v16', title: 'Ø±Ø§Ø²Ø¯Ø§Ø±ÛŒ', type: 'virtue', weight: 4 },
            { id: 'v17', title: 'Ø³Ø­Ø±Ø®ÛŒØ²ÛŒ', type: 'virtue', weight: 3 },
            { id: 'v18', title: 'Ø³Ú©ÙˆØªÙ Ø¢Ú¯Ø§Ù‡Ø§Ù†Ù‡', type: 'virtue', weight: 2 },
            { id: 'v19', title: 'Ø­ÙØ¸ Ù…Ø­ÛŒØ· Ø²ÛŒØ³Øª', type: 'virtue', weight: 2 },
            { id: 'v20', title: 'Ø¹Ø²Øª Ù†ÙØ³', type: 'virtue', weight: 4 },
            // Vices
            { id: 'x1', title: 'Ø¯Ø±ÙˆØº', type: 'vice', weight: 5 },
            { id: 'x2', title: 'ØºÛŒØ¨Øª', type: 'vice', weight: 4 },
            { id: 'x3', title: 'ØªÙˆÙ‡ÛŒÙ† Ùˆ ÙØ­Ø§Ø´ÛŒ', type: 'vice', weight: 4 },
            { id: 'x4', title: 'ØªÙ‡Ù…Øª', type: 'vice', weight: 6 },
            { id: 'x5', title: 'Ø³Ø®Ù†â€ŒÚ†ÛŒÙ†ÛŒ', type: 'vice', weight: 4 },
            { id: 'x6', title: 'ØªÙ†Ø¨Ù„ÛŒ Ùˆ Ø§Ù‡Ù…Ø§Ù„', type: 'vice', weight: 3 },
            { id: 'x7', title: 'Ø­Ø³Ø§Ø¯Øª', type: 'vice', weight: 3 },
            { id: 'x8', title: 'Ù‚Ø¶Ø§ÙˆØª Ø¹Ø¬ÙˆÙ„Ø§Ù†Ù‡', type: 'vice', weight: 3 },
            { id: 'x9', title: 'Ù¾Ø±Ø®ÙˆØ±ÛŒ ÛŒØ§ Ù¾Ø±Ø®ÙˆØ§Ø¨ÛŒ', type: 'vice', weight: 2 },
            { id: 'x10', title: 'Ø§Ø³Ø±Ø§Ù', type: 'vice', weight: 2 },
            { id: 'x11', title: 'ØªÚ©Ø¨Ø± Ùˆ Ø®ÙˆØ¯Ø¨Ø±ØªØ±Ø¨ÛŒÙ†ÛŒ', type: 'vice', weight: 4 },
            { id: 'x12', title: 'Ø¨Ø¯Ù‚ÙˆÙ„ÛŒ', type: 'vice', weight: 4 },
            { id: 'x13', title: 'Ú©Ù†ØªØ±Ù„â€ŒÚ¯Ø±ÛŒ', type: 'vice', weight: 3 },
            { id: 'x14', title: 'Ù‚Ø±Ø¨Ø§Ù†ÛŒâ€ŒÙ†Ù…Ø§ÛŒÛŒ', type: 'vice', weight: 3 },
            { id: 'x15', title: 'Ù†Ú¯Ø§Ù‡ Ø¢Ù„ÙˆØ¯Ù‡ ÛŒØ§ Ù¾ÙˆØ±Ù†ÙˆÚ¯Ø±Ø§ÙÛŒ', type: 'vice', weight: 5 },
            { id: 'x16', title: 'Ú©ÛŒÙ†Ù‡ Ùˆ Ø§Ù†ØªÙ‚Ø§Ù…â€ŒØ¬ÙˆÛŒÛŒ', type: 'vice', weight: 4 },
            { id: 'x17', title: 'Ø®ÛŒØ§Ù†Øª', type: 'vice', weight: 6 },
            { id: 'x18', title: 'Ú†Ø§Ù¾Ù„ÙˆØ³ÛŒ', type: 'vice', weight: 3 },
            { id: 'x19', title: 'Ù†Ø§Ø§Ù…ÛŒØ¯ÛŒ Ùˆ Ù¾ÙˆÚ†â€ŒÚ¯Ø±Ø§ÛŒÛŒ', type: 'vice', weight: 4 },
            { id: 'x20', title: 'Ø¨ÛŒâ€ŒØªÙØ§ÙˆØªÛŒ', type: 'vice', weight: 3 }
        ],
        rules: [
            // General Rules (Rewards)
            { id: 'r1', type: 'total_pos', targetId: null, threshold: 30, resultType: 'reward', resultText: 'ØªÙ…Ø§Ø´Ø§ÛŒ ÙÛŒÙ„Ù… ÛŒØ§ Ø³Ø±ÛŒØ§Ù„', isSpecific: false },
            { id: 'r2', type: 'total_pos', targetId: null, threshold: 50, resultType: 'reward', resultText: 'Ø®Ø±ÛŒØ¯ Ú©ØªØ§Ø¨', isSpecific: false },
            { id: 'r3', type: 'total_pos', targetId: null, threshold: 20, resultType: 'reward', resultText: 'Ø®ÙˆØ±Ø§Ú©ÛŒ ÙˆÛŒÚ˜Ù‡', isSpecific: false },
            { id: 'r4', type: 'total_pos', targetId: null, threshold: 40, resultType: 'reward', resultText: 'Ø§Ø³ØªØ±Ø§Ø­Øª Ù…Ø·Ù„Ù‚', isSpecific: false },
            { id: 'r5', type: 'total_pos', targetId: null, threshold: 60, resultType: 'reward', resultText: 'Ú¯Ø±Ø¯Ùˆ Ø§Ø¶Ø§ÙÙ‡ Ø¯Ø± ØµØ¨Ø­Ø§Ù†Ù‡', isSpecific: false },
            { id: 'r6', type: 'total_pos', targetId: null, threshold: 70, resultType: 'reward', resultText: 'Ø®ÙˆØ§Ø¨ Ø¨ÛŒØ´ØªØ±', isSpecific: false },
            { id: 'r7', type: 'total_pos', targetId: null, threshold: 25, resultType: 'reward', resultText: 'ØªÙ…Ø§Ø³ Ø¨Ø§ Ø¯ÙˆØ³Øª', isSpecific: false },
            { id: 'r8', type: 'total_pos', targetId: null, threshold: 15, resultType: 'reward', resultText: 'Ù…ÙˆØ³ÛŒÙ‚ÛŒ Ø¨Ø§ ØµØ¯Ø§ÛŒ Ø¨Ù„Ù†Ø¯', isSpecific: false },
            { id: 'r9', type: 'total_pos', targetId: null, threshold: 35, resultType: 'reward', resultText: 'Ø¯ÙˆØ´ Ø·ÙˆÙ„Ø§Ù†ÛŒ', isSpecific: false },
            { id: 'r10', type: 'total_pos', targetId: null, threshold: 45, resultType: 'reward', resultText: 'ÙˆØ¨â€ŒÚ¯Ø±Ø¯ÛŒ Ø¢Ø²Ø§Ø¯', isSpecific: false },
            
            // General Rules (Penalties)
            { id: 'p1', type: 'total_neg', targetId: null, threshold: 15, resultType: 'penalty', resultText: 'Û²Û° Ø´Ù†Ø§ Ø³ÙˆØ¦Ø¯ÛŒ Ø§Ø¶Ø§ÙÙ‡', isSpecific: false },
            { id: 'p2', type: 'total_neg', targetId: null, threshold: 20, resultType: 'penalty', resultText: 'Û² Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾Ù„Ø§Ù†Ú©', isSpecific: false },
            { id: 'p3', type: 'total_neg', targetId: null, threshold: 25, resultType: 'penalty', resultText: 'Û±Û° Ù‡Ø²Ø§Ø± ØªÙˆÙ…Ø§Ù† ØµØ¯Ù‚Ù‡', isSpecific: false },
            { id: 'p4', type: 'total_neg', targetId: null, threshold: 30, resultType: 'penalty', resultText: 'Ø­Ø°Ù ÙˆØ¹Ø¯Ù‡ Ø´Ø§Ù…', isSpecific: false },
            { id: 'p5', type: 'total_neg', targetId: null, threshold: 10, resultType: 'penalty', resultText: 'Ù…Ø­Ø±ÙˆÙ…ÛŒØª Ø§Ø² Ø§ÛŒÙ†ØªØ±Ù†Øª (Û² Ø³Ø§Ø¹Øª)', isSpecific: false },
            { id: 'p6', type: 'total_neg', targetId: null, threshold: 35, resultType: 'penalty', resultText: 'Ù†ÙˆØ´ØªÙ† Û±Û°Û° Ø¨Ø§Ø± Ø¬Ù…Ù„Ù‡ Ù…Ø«Ø¨Øª', isSpecific: false },
            { id: 'p7', type: 'total_neg', targetId: null, threshold: 40, resultType: 'penalty', resultText: 'ØªÙ…ÛŒØ² Ú©Ø±Ø¯Ù† Ú©Ø§Ù…Ù„ Ø§ØªØ§Ù‚', isSpecific: false },
            { id: 'p8', type: 'total_neg', targetId: null, threshold: 50, resultType: 'penalty', resultText: 'Ø¯ÙˆØ´ Ø¢Ø¨ Ø³Ø±Ø¯', isSpecific: false },
            { id: 'p9', type: 'total_neg', targetId: null, threshold: 45, resultType: 'penalty', resultText: 'Ø®ÙˆØ§Ù†Ø¯Ù† Û±Û° ØµÙØ­Ù‡ Ú©ØªØ§Ø¨ Ø³Ø®Øª', isSpecific: false },
            { id: 'p10', type: 'total_neg', targetId: null, threshold: 12, resultType: 'penalty', resultText: 'Ù…Ø­Ø±ÙˆÙ…ÛŒØª Ø§Ø² Ù…ÙˆØ³ÛŒÙ‚ÛŒ', isSpecific: false }
        ],
        logs: {} 
    };

    let db = JSON.parse(localStorage.getItem('EthicsDB_Final')) || JSON.parse(JSON.stringify(DEFAULT_DATA));
    let viewingDate = new Date();
    let currentEditorMode = null; 
    let currentRuleFilter = 'virtue';
    let editingItemId = null; 
    let currentActionFilter = 'all';

    // --- Helper: Persian Date Converter (Updated per Instruction 3) ---
    function getVerbalDate(date) {
        const weekDays = ['ÛŒÚ©Ø´Ù†Ø¨Ù‡', 'Ø¯ÙˆØ´Ù†Ø¨Ù‡', 'Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡', 'Ú†Ù‡Ø§Ø±Ø´Ù†Ø¨Ù‡', 'Ù¾Ù†Ø¬â€ŒØ´Ù†Ø¨Ù‡', 'Ø¬Ù…Ø¹Ù‡', 'Ø´Ù†Ø¨Ù‡'];
        const months = ['ÙØ±ÙˆØ±Ø¯ÛŒÙ†','Ø§Ø±Ø¯ÛŒØ¨Ù‡Ø´Øª','Ø®Ø±Ø¯Ø§Ø¯','ØªÛŒØ±','Ù…Ø±Ø¯Ø§Ø¯','Ø´Ù‡Ø±ÛŒÙˆØ±','Ù…Ù‡Ø±','Ø¢Ø¨Ø§Ù†','Ø¢Ø°Ø±','Ø¯ÛŒ','Ø¨Ù‡Ù…Ù†','Ø§Ø³ÙÙ†Ø¯'];
        
        const options = { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'long' };
        const parts = new Intl.DateTimeFormat('fa-IR', options).formatToParts(date);
        
        let y, m, d, wd;
        parts.forEach(p => {
            if(p.type === 'year') y = p.value;
            if(p.type === 'month') m = p.value;
            if(p.type === 'day') d = p.value;
            if(p.type === 'weekday') wd = p.value;
        });

        // Fix numeric string from fa to integer for conversion
        const parseFa = (s) => parseInt(s.replace(/[Û°-Û¹]/g, c => c.charCodeAt(0) - 1776));
        const dayInt = parseFa(d);
        const yearInt = parseFa(y);
        const monthInt = parseFa(m); // month index 1-12

        // Simple 1404 logic
        // Format: Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡ØŒ  Û±Û´Û°Û³/Û°Û¹/Û±Û±
        // The instruction asks for specific format:
        // "Ø³Ù‡â€ŒØ´Ù†Ø¨Ù‡ØŒ  Û±Û´Û°Û³/Û°Û¹/Û±Û±"
        // So we construct it manually with fa digits.
        
        const yStr = y;
        const mStr = m.padStart(2,'Û°'); // Ensure 2 digits
        const dStr = d.padStart(2,'Û°');
        
        return `${wd}ØŒ ${yStr}/${mStr}/${dStr}`;
    }

    function getKey(date) { return date.toLocaleDateString('en-CA'); }

    function saveDB() { localStorage.setItem('EthicsDB_Final', JSON.stringify(db)); }

    // ==========================================
    // 2. INITIALIZATION
    // ==========================================
    
    window.onload = () => {
        if(!db.user.name) {
            document.getElementById('nameModal').style.display = 'flex';
        } else {
            initUI();
        }
    };

    function saveName() {
        const name = document.getElementById('userNameInput').value.trim();
        if(name) {
            db.user.name = name;
            saveDB();
            document.getElementById('nameModal').style.display = 'none';
            initUI();
        }
    }

    function initUI() {
        renderHome();
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        
        document.getElementById('tab-' + tabId).classList.add('active');
        
        const indices = { 'home': 0, 'actions': 1, 'settings': 2 };
        document.querySelectorAll('.nav-item')[indices[tabId]].classList.add('active');

        if (tabId === 'home') renderHome();
        if (tabId === 'actions') renderActionsTab();
    }

    // ==========================================
    // 3. HOME LOGIC
    // ==========================================

    function navigateDate(delta) {
        const newDate = new Date(viewingDate);
        newDate.setDate(newDate.getDate() + delta);
        
        const today = new Date();
        today.setHours(0,0,0,0);
        
        if (newDate > today) return; 
        
        viewingDate = newDate;
        renderHome();
    }

    function renderHome() {
        const key = getKey(viewingDate);
        const todayKey = getKey(new Date());
        
        const dateNum = new Intl.DateTimeFormat('fa-IR').format(viewingDate);
        const weekDay = new Intl.DateTimeFormat('fa-IR', {weekday:'long'}).format(viewingDate);
        document.getElementById('headerDateDisplay').innerText = (key === todayKey ? "Ø§Ù…Ø±ÙˆØ²ØŒ " : "") + `${weekDay} ${dateNum}`;
        document.getElementById('nextDayBtn').disabled = (key === todayKey);

        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        const log = db.logs[key];

        const manBtn = document.querySelector('.manifesto-btn');
        const manText = document.getElementById('manifestoBtnText');
        if (log.manifestoRead) {
            manBtn.classList.add('read');
            manText.innerText = "Ù…Ù†Ø´ÙˆØ± Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯";
        } else {
            manBtn.classList.remove('read');
            manText.innerText = "Ø®ÙˆØ§Ù†Ø¯Ù† Ù…Ù†Ø´ÙˆØ±";
        }

        let totalScore = 0;
        let posScore = 0;
        let negScore = 0;

        const vContainer = document.getElementById('virtuesList');
        const xContainer = document.getElementById('vicesList');
        vContainer.innerHTML = '';
        xContainer.innerHTML = '';

        const searchTerm = document.getElementById('homeSearch').value.toLowerCase();

        db.behaviors.forEach(b => {
            if(searchTerm && !b.title.toLowerCase().includes(searchTerm)) return;

            const count = log.behaviors[b.id] || 0;
            const itemScore = count * b.weight;

            if (b.type === 'virtue') {
                totalScore += itemScore;
                posScore += itemScore;
            } else {
                totalScore -= itemScore;
                negScore += itemScore; 
            }

            const html = `
                <div class="card ${b.type}">
                    <div class="card-top">
                        <div>
                            <div class="item-name">${b.title}</div>
                            <div class="item-weight">Ø¶Ø±ÛŒØ¨: ${b.weight} | Ø§Ù…ØªÛŒØ§Ø²: ${itemScore}</div>
                        </div>
                        <div class="stepper">
                            <button class="step-btn" onclick="updateCount('${b.id}', -1)">-</button>
                            <div class="step-val">${count}</div>
                            <button class="step-btn" onclick="updateCount('${b.id}', 1)">+</button>
                        </div>
                    </div>
                </div>
            `;

            if (b.type === 'virtue') vContainer.innerHTML += html;
            else xContainer.innerHTML += html;
        });

        document.getElementById('totalScoreDisplay').innerText = totalScore > 0 ? `+${totalScore}` : totalScore;
        document.getElementById('posScoreDisplay').innerText = posScore;
        document.getElementById('negScoreDisplay').innerText = negScore;

        const scoreCard = document.getElementById('scoreCard');
        scoreCard.className = 'score-card ' + (totalScore > 0 ? 'positive' : (totalScore < 0 ? 'negative' : 'neutral'));

        // Pending Actions Summary (Instruction 1)
        const pendingDiv = document.getElementById('homePendingSummary');
        const actions = log.actions;
        const pendingReward = actions.filter(a => a.type === 'reward' && !a.done).length;
        const pendingPenalty = actions.filter(a => a.type === 'penalty' && !a.done).length;
        
        if (pendingReward > 0 || pendingPenalty > 0) {
            pendingDiv.style.display = 'flex';
            document.getElementById('pendingRewardCount').innerText = pendingReward;
            document.getElementById('pendingPenaltyCount').innerText = pendingPenalty;
        } else {
            pendingDiv.style.display = 'none';
        }

        checkTriggers(key, totalScore, posScore, negScore);
    }

    function filterHomeList() {
        renderHome();
    }

    function updateCount(behId, delta) {
        const key = getKey(viewingDate);
        const log = db.logs[key];
        const current = log.behaviors[behId] || 0;
        const newVal = current + delta;
        
        if (newVal >= 0) {
            log.behaviors[behId] = newVal;
            saveDB();
            renderHome();
        }
    }

    // ==========================================
    // 4. TRIGGER LOGIC (FIXED THRESHOLD)
    // ==========================================
    
    function checkTriggers(dateKey, total, posTotal, negTotal) {
        const log = db.logs[dateKey];
        const consumed = log.consumed || {};
        const triggerArea = document.getElementById('triggerArea');
        triggerArea.innerHTML = ''; 
        
        for (let rule of db.rules) {
            let currentValue = 0;
            let consumedValue = consumed[rule.id] || 0;

            if (rule.type === 'total_net') {
                currentValue = total;
                 if (rule.resultType === 'reward') {
                     if (currentValue - consumedValue >= rule.threshold) {
                         showTriggerAlert(rule, currentValue);
                         break; 
                     }
                 } else {
                     if (currentValue <= (consumedValue - Math.abs(rule.threshold))) {
                         showTriggerAlert(rule, currentValue);
                         break;
                     }
                 }
            } 
            else if (rule.type === 'total_pos') {
                currentValue = posTotal;
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule, currentValue);
                     break;
                }
            }
            else if (rule.type === 'total_neg') {
                currentValue = negTotal;
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule, currentValue);
                     break;
                }
            }
            else if (rule.type === 'specific') {
                const bId = rule.targetId;
                const b = db.behaviors.find(x => x.id === bId);
                if (!b) continue;
                const count = log.behaviors[bId] || 0;
                currentValue = count * b.weight; 
                
                if (currentValue - consumedValue >= rule.threshold) {
                     showTriggerAlert(rule, currentValue);
                     break;
                }
            }
        }
    }

    function showTriggerAlert(rule, triggerValue) {
        const area = document.getElementById('triggerArea');
        area.style.display = 'block';
        
        const typeLabel = rule.resultType === 'reward' ? 'ğŸ‰ Ù¾Ø§Ø¯Ø§Ø´:' : 'âš ï¸ Ø¬Ø±ÛŒÙ…Ù‡:';
        const color = rule.resultType === 'reward' ? 'var(--success)' : 'var(--danger)';
        const bg = rule.resultType === 'reward' ? '#ecfdf5' : '#fef2f2';
        
        // Reason construction (Instruction 3)
        let reason = '';
        if(rule.type === 'specific') {
            const b = db.behaviors.find(x => x.id === rule.targetId);
            reason = `Ø¨Ù‡ Ø¯Ù„ÛŒÙ„: ${b.title} (Ø§Ù…ØªÛŒØ§Ø² ${triggerValue})`;
        } else if(rule.type === 'total_pos') {
            reason = `Ø¨Ù‡ Ø¯Ù„ÛŒÙ„: Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø² Ù…Ø«Ø¨Øª (${triggerValue})`;
        } else if(rule.type === 'total_neg') {
            reason = `Ø¨Ù‡ Ø¯Ù„ÛŒÙ„: Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù…ØªÛŒØ§Ø² Ù…Ù†ÙÛŒ (${triggerValue})`;
        } else {
            reason = `Ø¨Ù‡ Ø¯Ù„ÛŒÙ„: ØªØ±Ø§Ø² Ú©Ù„ (${triggerValue})`;
        }

        area.innerHTML = `
            <div class="trigger-box" style="display:block; border-color:${color}; background:${bg}">
                <div class="trigger-header" style="color:${color}">
                    ${typeLabel} Ø­Ø¯ Ù†ØµØ§Ø¨ "${getRuleDescription(rule)}" Ù¾Ø± Ø´Ø¯.
                </div>
                <div style="margin-bottom:5px; font-weight:bold;">${rule.resultText}</div>
                <div style="margin-bottom:10px; font-size:0.8rem; color:var(--text-light);">${reason}</div>
                <div class="trigger-actions">
                    <button class="btn btn-accept" onclick="acceptTrigger('${rule.id}', '${reason}')">Ø«Ø¨Øª Ø¯Ø± Ø§Ù‚Ø¯Ø§Ù…Ø§Øª</button>
                    <button class="btn btn-change" onclick="ignoreTrigger('${rule.id}')">Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ†</button>
                </div>
            </div>
        `;
    }

    function getRuleDescription(rule) {
        if(rule.type === 'specific') {
            const b = db.behaviors.find(x => x.id === rule.targetId);
            return b ? b.title : 'Ø±ÙØªØ§Ø± Ø­Ø°Ù Ø´Ø¯Ù‡';
        }
        if(rule.type === 'total_pos') return 'Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø«Ø¨Øª';
        if(rule.type === 'total_neg') return 'Ù…Ø¬Ù…ÙˆØ¹ Ù…Ù†ÙÛŒ';
        return 'Ø§Ù…ØªÛŒØ§Ø² Ú©Ù„';
    }

    function acceptTrigger(ruleId, reasonText) {
        const key = getKey(viewingDate);
        const rule = db.rules.find(r => r.id === ruleId);
        const log = db.logs[key];

        // Save with Metadata (Instruction 3)
        log.actions.push({
            id: Date.now(),
            text: rule.resultText,
            type: rule.resultType,
            reason: reasonText,
            date: key,
            done: false
        });

        if (!log.consumed[ruleId]) log.consumed[ruleId] = 0;
        
        if (rule.type === 'total_net' && rule.resultType === 'penalty') {
             log.consumed[ruleId] -= Math.abs(rule.threshold);
        } else {
             log.consumed[ruleId] += rule.threshold;
        }

        saveDB();
        document.getElementById('triggerArea').style.display = 'none'; 
        renderHome(); 
    }

    function ignoreTrigger() {
        document.getElementById('triggerArea').style.display = 'none';
    }

    // ==========================================
    // 5. MANIFESTO (Instruction 2 & 3 fixed)
    // ==========================================
    
    function openManifestoModal() {
        const name = db.user.name;
        
        const now = new Date();
        const dateStr = getVerbalDate(now); // Fixed Format
        const h = now.getHours().toLocaleString('fa-IR');
        const m = now.getMinutes().toLocaleString('fa-IR').padStart(2,'Û°');
        const formattedTime = `${h}:${m} Ø¯Ù‚ÛŒÙ‚Ù‡`;

        const text = `
            Ù…Ù† <strong>${name}</strong> Ø¯Ø± ØªØ§Ø±ÛŒØ® <strong>${dateStr}</strong> Ùˆ Ø³Ø§Ø¹Øª <strong>${formattedTime}</strong> Ù…Ù†Ø´ÙˆØ± Ø§Ø®Ù„Ø§Ù‚ÛŒâ€ŒØ§Ù… Ø±Ø§ Ù…Ø±ÙˆØ± Ù…ÛŒâ€ŒÚ©Ù†Ù….<br><br>
            
            <strong style="color:var(--primary);">Ù…Ù†Ø´ÙˆØ± Ø§Ø®Ù„Ø§Ù‚</strong><br>
            Ù…Ù† Ø¨Ù‡ Ø§ÛŒÙ† Ø²Ù†Ø¯Ú¯ÛŒ Ùˆ ÙØ±ØµØª ÛŒÚ¯Ø§Ù†Ù‡â€ŒÛŒ Ø¢Ù† Ø§Ø­ØªØ±Ø§Ù… Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù….<br>
            Ø§ØµÙ„Ù Ø¨Ù†ÛŒØ§Ø¯ÛŒÙ†Ù Ù…Ù†ØŒ Ú©Ø§Ù‡Ø´Ù Ø±Ù†Ø¬ Ùˆ Ø³Ø§Ø®ØªÙ†Ù Ø¯Ù†ÛŒØ§ÛŒÛŒ Ø¨Ù‡ØªØ± Ø§Ø³Øª.<br>
            Ù…Ù† Ø®Ø±Ø¯ Ùˆ Ø¹Ù‚Ù„Ø§Ù†ÛŒØª Ø±Ø§ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø®ÙˆØ¯ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ù…ØŒ Ù†Ù‡ ØªØ±Ø³ Ùˆ Ø®Ø±Ø§ÙÙ‡ Ø±Ø§.<br>
            Ù…Ù† Ù…Ø³Ø¦ÙˆÙ„Ù Ø§Ø­Ø³Ø§Ø³Ø§ØªØŒ Ø§Ù†ØªØ®Ø§Ø¨â€ŒÙ‡Ø§ Ùˆ Ø¢ÛŒÙ†Ø¯Ù‡â€ŒÛŒ Ø®ÙˆØ¯ Ù‡Ø³ØªÙ….<br>
            Ø¨Ø³ÛŒØ§Ø± Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ø¨Ø±Ø§ÛŒ Ù†ÙØ³ÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒÚ©Ø´Ù… Ùˆ ØªÙˆØ§Ù†ÛŒ Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ø¯Ø§Ø±Ù….<br><br>

            Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… Ú©Ù‡ ØµØ§Ø¯Ù‚ Ø¨Ø§Ø´Ù… Ùˆ Ø¨Ø§ Ø®ÙˆØ¯ Ùˆ Ø¯ÛŒÚ¯Ø±Ø§Ù† ØµØ§Ø¯Ù‚Ø§Ù†Ù‡ Ø±ÙØªØ§Ø± Ú©Ù†Ù….<br>
            Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… Ú©Ù‡ Ø¨Ù‡ Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ùˆ ØªÙØ§ÙˆØªâ€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø³Ø§Ù†â€ŒÙ‡Ø§ Ø§Ø­ØªØ±Ø§Ù… Ø¨Ú¯Ø°Ø§Ø±Ù….<br>
            Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ… Ú©Ù‡ Ø§Ø² Ø®Ø· Ù‚Ø±Ù…Ø²Ù‡Ø§ÛŒ Ø¢Ø³ÛŒØ¨ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø¹Ø¨ÙˆØ± Ù†Ú©Ù†Ù….<br>
            Ù…Ù† Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒØ´ÙˆÙ… ØªØ§ ØªÙ„Ø§Ø´ Ú©Ù†Ù… Ø§Ù…Ø±ÙˆØ²ØŒ Ù†Ø³Ø®Ù‡â€ŒØ§ÛŒ Ù‚ÙˆÛŒâ€ŒØªØ± Ùˆ Ù…Ù‡Ø±Ø¨Ø§Ù†â€ŒØªØ± Ø§Ø² Ø¯ÛŒØ±ÙˆØ²Ù Ø®ÙˆØ¯ Ø¨Ø§Ø´Ù….<br><br>

            Ù…Ù† Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø±Ù Ù‚ÙˆØ§Ù†ÛŒÙ†Ù Ø·Ø¨ÛŒØ¹Øª Ùˆ ÙˆØ§Ù‚Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¬Ù‡Ø§Ù† Ø³Ø± ÙØ±ÙˆØ¯ Ù…ÛŒâ€ŒØ¢ÙˆØ±Ù….<br>
            Ù…Ù† Ø¢Ù†â€ŒÚ†Ù‡ Ø±Ø§ Ú©Ù‡ Ø¯Ø± Ú©Ù†ØªØ±Ù„Ù… Ù†ÛŒØ³ØªØŒ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù….<br>
            Ù…Ù† Ø§Ù†Ø¹Ø·Ø§Ùâ€ŒÙ¾Ø°ÛŒØ±Ù…ØŒ Ù…Ø«Ù„ Ø¯Ø±Ø®Øª Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ø¨Ø§Ø¯.<br>
            ØªØ¹ØµØ¨ Ø±Ø§ Ø±Ù‡Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ù… ØªØ§ Ù†Ø´Ú©Ù†Ù….<br>
            Ù…Ù† Ø·Ø¨ÛŒØ¹Øª Ø±Ø§ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ùˆ Ø¨Ø§ Ø¢Ù† Ø¯Ø±Ø³Øª Ø±ÙØªØ§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù….<br><br>

            Ø¯Ø± Ø§ÛŒÙ† Ù„Ø­Ø¸Ù‡ ØªÙ…Ø§Ù…Ù Ø®Ø´Ù…â€ŒÙ‡Ø§ØŒ Ø´Ù‡ÙˆØªâ€ŒÙ‡Ø§ Ùˆ ØºÙ…â€ŒÙ‡Ø§ÛŒÙ… Ø±Ø§ Ø¨Ù‡ Ø®Ø§Ú© Ù…ÛŒâ€ŒØ³Ù¾Ø§Ø±Ù…. Ù…Ù† Ø¯Ø± Ø§ÛŒÙ† Ù„Ø­Ø¸Ù‡ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø´Ú©ÙˆÙØ§ Ø´Ø¯Ù… Ùˆ Ø¬Ø§Ù† ØªØ§Ø²Ù‡â€ŒØ§ÛŒ Ú¯Ø±ÙØªÙ…. Ù…Ù† Ø®ÙˆØ¯Ù… Ø±Ø§ Ø¯ÙˆØ³Øª Ø¯Ø§Ø±Ù… Ùˆ Ø¨Ù‡ Ø®ÙˆØ¯Ù… Ø§Ø­ØªØ±Ø§Ù… Ù…ÛŒÚ¯Ø°Ø§Ø±Ù…... Ù…Ù† Ø¯Ø± Ø§Ù…Ù†ÛŒÙ€ØªÙ…... Ù…Ù† Ø¢Ø±Ø§Ù…Ù€Ù…...<br><br>

            Ù…Ù† Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ¯Ù… Ùˆ Ø¯ÛŒÚ¯Ø±Ø§Ù† Ø§Ø±Ø²Ø´ Ø¨Ø³ÛŒØ§Ø±ÛŒ Ù‚Ø§Ø¦Ù„ Ù‡Ø³ØªÙ… Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ú¯ÛŒ Ù‚Ø¯Ø±ØªØŒ Ø³Ù„Ø§Ù…ØªÛŒØŒ Ø²ÛŒØ¨Ø§ÛŒÛŒØŒ Ø§Ù†ØµØ§Ù Ùˆ Ø¹Ø¯Ø§Ù„Øª Ø¢Ø±Ø²Ùˆ Ù…ÛŒâ€ŒÚ©Ù†Ù…. Ø¨Ø§Ø´Ø¯ Ú©Ù‡ Ù‡ÛŒÚ† Ø§Ù†Ø³Ø§Ù†ÛŒ Ù…ÙˆØ±Ø¯ Ø¸Ù„Ù… ÙˆØ§Ù‚Ø¹ Ù†Ø´ÙˆØ¯ Ùˆ Ù…Ù† Ù†ÛŒØ² Ø§Ø¨Ø²Ø§Ø±Ù Ø¸Ù„Ù… Ù†Ø¨Ø§Ø´Ù….<br>
            Ù…Ù† Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ú©Ù‡ Ø§Ù†Ø³Ø§Ù† Ù‡Ø³ØªÙ… Ùˆ Ú©Ø±Ø§Ù…Øª Ø¯Ø§Ø±Ù….<br>
            Ù…Ù† Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ú©Ù‡ Ø§Ø² Ø¹Ù‚Ù„ Ùˆ Ø®Ø±Ø¯Ù… Ø¨Ù‡Ø±Ù‡ Ø¨Ø¨Ø±Ù… Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†Ù….<br>
            Ù…Ù† Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒØ¯Ù‡Ù…ØŒ ÙØ§Ø±Ù‚ Ø§Ø² Ù‡Ø± Ø¯ÛŒØ¯Ú¯Ø§Ù‡ÛŒ Ú©Ù‡ Ø¯Ø§Ø±Ù… Ø§Ø®Ù„Ø§Ù‚ Ù…Ø¯Ø§Ø± Ø¨Ø§Ø´Ù… Ùˆ Ø±ÙØªØ§Ø±ÛŒ Ø§Ù†Ø³Ø§Ù† Ø¯ÙˆØ³ØªØ§Ù†Ù‡ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ù….<br>
            Ú¯ÙˆØ§Ù‡ÛŒ Ù…ÛŒâ€ŒØ¯Ù‡Ù… Ø¸Ù„Ù… Ù†Ú©Ù†Ù…ØŒ Ø³ØªÙ… Ù†Ú©Ù†Ù… Ùˆ Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ù¾Ø§ÛŒÛŒ Ø¹Ø¯Ø§Ù„Øª ØªÙ„Ø§Ø´ Ú©Ù†Ù….<br><br>

            Ø³Ù„Ø§Ù… Ø¨Ø± Ù…Ù† Ú©Ù‡ Ø§Ø±Ø²Ø´Ù…Ù†Ø¯Ù….<br>
            Ø³Ù„Ø§Ù… Ø¨Ø± ØªÙ…Ø§Ù… Ø§Ù†Ø³Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù†ÛŒÚ©â€ŒØ§Ù†Ø¯ÛŒØ´.<br>
            Ùˆ Ø³Ù„Ø§Ù… Ø¨Ø± ØµÙ„Ø­ Ùˆ Ø¢Ú¯Ø§Ù‡ÛŒ Ùˆ Ø¹Ù‚Ù„Ø§Ù†ÛŒØª.<br>
            <strong>Ù¾Ø§ÛŒØ§Ù†.</strong>
        `;

        const container = document.getElementById('manifestoTextContainer');
        container.innerHTML = text;
        
        const btn = document.getElementById('manifestoConfirmBtn');
        btn.disabled = true;
        btn.style.opacity = 0.5;
        
        container.scrollTop = 0;

        container.onscroll = function() {
            if(Math.ceil(container.offsetHeight + container.scrollTop) >= container.scrollHeight - 20) {
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        };

        document.getElementById('manifestoModal').style.display = 'flex';
    }

    function confirmManifestoRead() {
        const key = getKey(new Date());
        if(!db.logs[key]) db.logs[key] = { behaviors: {}, actions: [], manifestoRead: false, consumed: {} };
        db.logs[key].manifestoRead = true;
        saveDB();
        document.getElementById('manifestoModal').style.display = 'none';
        renderHome();
    }

    // ==========================================
    // 6. ACTIONS LIST & DETAILS (Instruction 1 & 2 & 3)
    // ==========================================

    function openActionDetails(filterType) {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        // Filter for Pending only in Home popup
        const filtered = actions.filter(a => !a.done && (filterType === 'all' || a.type === filterType));
        
        const container = document.getElementById('actionDetailList');
        container.innerHTML = '';
        document.getElementById('actionDetailTitle').innerText = filterType === 'reward' ? 'Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡' : 'Ø¬Ø±ÛŒÙ…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø´Ø¯Ù‡';
        
        if(filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
        }

        filtered.forEach(a => {
             container.innerHTML += `
                <div class="action-detail-item">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span class="action-badge ${a.type==='reward'?'badge-reward':'badge-penalty'}">${a.type==='reward'?'Ù¾Ø§Ø¯Ø§Ø´':'Ø¬Ø±ÛŒÙ…Ù‡'}</span>
                        <span style="font-size:0.8rem; color:var(--text-light);">${a.date}</span>
                    </div>
                    <div style="font-weight:bold; margin:8px 0;">${a.text}</div>
                    <div class="action-detail-meta">${a.reason || 'Ø«Ø¨Øª Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø³ÛŒØ³ØªÙ…'}</div>
                </div>
            `;
        });
        
        document.getElementById('actionDetailsModal').style.display = 'flex';
    }

    function filterActionType(type) {
        currentActionFilter = type;
        // Update button styles
        document.getElementById('filterAllBtn').classList.remove('active');
        document.getElementById('filterRewardBtn').classList.remove('active');
        document.getElementById('filterPenaltyBtn').classList.remove('active');
        
        if(type === 'all') document.getElementById('filterAllBtn').classList.add('active');
        else if(type === 'reward') document.getElementById('filterRewardBtn').classList.add('active');
        else document.getElementById('filterPenaltyBtn').classList.add('active');

        renderActionsTab();
    }
    
    function filterActionList() { renderActionsTab(); }

    function renderActionsTab() {
        const key = getKey(viewingDate);
        const actions = db.logs[key]?.actions || [];
        const search = document.getElementById('actionSearch').value.toLowerCase();
        const container = document.getElementById('actionsListFull');
        container.innerHTML = '';

        const filtered = actions.filter(a => {
            if (currentActionFilter !== 'all' && a.type !== currentActionFilter) return false;
            if (search && !a.text.toLowerCase().includes(search)) return false;
            return true;
        });

        if (filtered.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#999;">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';
            return;
        }

        filtered.forEach(a => {
            container.innerHTML += `
                <div class="action-item ${a.done ? 'done' : ''}">
                    <div class="action-checkbox ${a.done ? 'checked' : ''}" onclick="toggleAction(${a.id})">
                        <i class="fas fa-check" style="${a.done ? '' : 'display:none'}"></i>
                    </div>
                    <div class="action-content">
                        <span class="action-badge ${a.type==='reward'?'badge-reward':'badge-penalty'}">${a.type==='reward'?'Ù¾Ø§Ø¯Ø§Ø´':'Ø¬Ø±ÛŒÙ…Ù‡'}</span>
                        <span style="font-weight:bold; display:block; margin-top:4px;">${a.text}</span>
                        <span style="font-size:0.75rem; color:var(--text-light); display:block; margin-top:2px;">${a.reason || ''}</span>
                    </div>
                    <i class="fas fa-trash btn-icon delete" onclick="deleteAction(${a.id})"></i>
                </div>
            `;
        });
    }

    function toggleAction(id) {
        const key = getKey(viewingDate);
        const action = db.logs[key].actions.find(a => a.id === id);
        if(action) {
            action.done = !action.done;
            saveDB();
            renderActionsTab();
            renderHome(); // Update home summary
        }
    }

    function deleteAction(id) {
        if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
        const key = getKey(viewingDate);
        db.logs[key].actions = db.logs[key].actions.filter(a => a.id !== id);
        saveDB();
        renderActionsTab();
        renderHome();
    }

    // ==========================================
    // 7. EDITORS (Full CRUD & Instruction 4)
    // ==========================================

    function openEditor(type) {
        currentEditorMode = type;
        document.getElementById('editorTitle').innerText = type === 'behavior' ? 'Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙØªØ§Ø±Ù‡Ø§' : 'Ù…Ø¯ÛŒØ±ÛŒØª Ù‚ÙˆØ§Ù†ÛŒÙ†';
        
        document.getElementById('ruleListToggle').style.display = type === 'rule' ? 'flex' : 'none';
        document.getElementById('editorSearch').style.display = type === 'behavior' ? 'block' : 'none';

        document.getElementById('behaviorFields').style.display = type === 'behavior' ? 'block' : 'none';
        document.getElementById('ruleFields').style.display = type === 'rule' ? 'block' : 'none';
        
        resetEditorForm(); 

        if(type === 'rule') {
            populateTargetSelect();
            toggleRuleInputs();
        }
        
        renderEditorList();
        document.getElementById('editorModal').style.display = 'flex';
    }
    
    function toggleRuleList(type) {
        currentRuleFilter = type;
        document.getElementById('toggleVirtueBtn').className = type === 'virtue' ? 'toggle-btn active' : 'toggle-btn';
        document.getElementById('toggleViceBtn').className = type === 'vice' ? 'toggle-btn active' : 'toggle-btn';
        renderEditorList();
    }

    function populateTargetSelect() {
        const sel = document.getElementById('ruleTargetId');
        sel.innerHTML = '';
        db.behaviors.forEach(b => {
            sel.innerHTML += `<option value="${b.id}" data-type="${b.type}">${b.title}</option>`;
        });
        updateRuleResultTypeBasedOnTarget();
    }

    function toggleRuleInputs() {
        const type = document.getElementById('ruleType').value;
        document.getElementById('specificBehDiv').style.display = type === 'specific' ? 'block' : 'none';
        
        const resTypeInput = document.getElementById('ruleResultType');
        const resTypeDisp = document.getElementById('ruleResultTypeDisplay');
        
        if (type === 'total_pos') {
            resTypeInput.value = 'reward'; resTypeDisp.value = 'Ù¾Ø§Ø¯Ø§Ø´';
        } else if (type === 'total_neg') {
            resTypeInput.value = 'penalty'; resTypeDisp.value = 'Ø¬Ø±ÛŒÙ…Ù‡';
        } else if (type === 'specific') {
            updateRuleResultTypeBasedOnTarget();
        }
    }

    function updateRuleResultTypeBasedOnTarget() {
        const sel = document.getElementById('ruleTargetId');
        if (sel.selectedIndex === -1) return;
        const type = sel.options[sel.selectedIndex].getAttribute('data-type');
        
        const resTypeInput = document.getElementById('ruleResultType');
        const resTypeDisp = document.getElementById('ruleResultTypeDisplay');
        const ind = document.getElementById('ruleAutoTypeIndicator');

        if (type === 'virtue') {
            resTypeInput.value = 'reward';
            resTypeDisp.value = 'Ù¾Ø§Ø¯Ø§Ø´';
            ind.innerText = "Ø±ÙØªØ§Ø± Ù…Ø«Ø¨Øª -> Ù¾Ø§Ø¯Ø§Ø´";
            ind.style.background = "#d1fae5"; ind.style.color = "#065f46";
        } else {
            resTypeInput.value = 'penalty';
            resTypeDisp.value = 'Ø¬Ø±ÛŒÙ…Ù‡';
            ind.innerText = "Ø±ÙØªØ§Ø± Ù…Ù†ÙÛŒ -> Ø¬Ø±ÛŒÙ…Ù‡";
            ind.style.background = "#fee2e2"; ind.style.color = "#991b1b";
        }
    }

    function renderEditorList() {
        const container = document.getElementById('editorListContainer');
        container.innerHTML = '';
        const search = document.getElementById('editorSearch').value.toLowerCase();

        if (currentEditorMode === 'behavior') {
            db.behaviors.forEach((b, idx) => {
                if (search && !b.title.toLowerCase().includes(search)) return;
                container.innerHTML += `
                    <div class="list-row">
                        <span>${b.title} <span style="font-size:0.8rem; color:#999;">(${b.type==='virtue'?'Ù…Ø«Ø¨Øª':'Ù…Ù†ÙÛŒ'} - ${b.weight})</span></span>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="editItem('behavior', ${idx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('behavior', ${idx})"></i>
                        </div>
                    </div>
                `;
            });
        } else {
            const filteredRules = db.rules.filter(r => {
                let isVirtue = false;
                if (r.type === 'total_pos') isVirtue = true;
                else if (r.type === 'total_neg') isVirtue = false;
                else if (r.type === 'specific') {
                    const b = db.behaviors.find(x => x.id === r.targetId);
                    if(b && b.type === 'virtue') isVirtue = true;
                }
                else if (r.type === 'total_net') {
                    isVirtue = r.resultType === 'reward';
                }
                return (currentRuleFilter === 'virtue' && isVirtue) || (currentRuleFilter === 'vice' && !isVirtue);
            });

            if(filteredRules.length === 0) container.innerHTML = '<p style="text-align:center; color:#999">Ù…ÙˆØ±Ø¯ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>';

            filteredRules.forEach((r) => {
                const originalIdx = db.rules.indexOf(r);
                let desc = getRuleDescription(r);
                container.innerHTML += `
                    <div class="list-row">
                        <div style="font-size:0.85rem;">
                            <strong>${desc}</strong> > ${Math.abs(r.threshold)}
                            <div style="color:var(--text-light); margin-top:2px;">${r.resultText}</div>
                        </div>
                        <div>
                            <i class="fas fa-edit btn-icon edit" onclick="editItem('rule', ${originalIdx})"></i>
                            <i class="fas fa-trash btn-icon delete" onclick="deleteItem('rule', ${originalIdx})"></i>
                        </div>
                    </div>
                `;
            });
        }
    }
    
    function filterEditorList() { renderEditorList(); }

    function editItem(type, index) {
        editingItemId = index; 
        document.getElementById('formTitle').innerText = "ÙˆÛŒØ±Ø§ÛŒØ´ Ù…ÙˆØ±Ø¯";
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
        
        if (type === 'behavior') {
            const item = db.behaviors[index];
            document.getElementById('behTitle').value = item.title;
            document.getElementById('behType').value = item.type;
            document.getElementById('behWeight').value = item.weight;
        } else {
            const item = db.rules[index];
            document.getElementById('ruleType').value = item.type;
            toggleRuleInputs();
            if(item.targetId) document.getElementById('ruleTargetId').value = item.targetId;
            document.getElementById('ruleThreshold').value = Math.abs(item.threshold);
            document.getElementById('ruleResultText').value = item.resultText;
            document.getElementById('ruleIsSpecific').checked = item.isSpecific;
        }
    }

    function resetEditorForm() {
        editingItemId = null;
        document.getElementById('formTitle').innerText = "Ø§ÙØ²ÙˆØ¯Ù† Ø¬Ø¯ÛŒØ¯";
        document.getElementById('cancelEditBtn').style.display = 'none';
        
        document.getElementById('behTitle').value = '';
        document.getElementById('ruleResultText').value = '';
        document.getElementById('ruleThreshold').value = '';
    }

    function saveEditorItem() {
        // Instruction 4: Auto scroll to new item is inherent as we append to list and re-render
        if (currentEditorMode === 'behavior') {
            const title = document.getElementById('behTitle').value.trim();
            const type = document.getElementById('behType').value;
            const weight = parseInt(document.getElementById('behWeight').value);
            
            if(!title) return alert('Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª');
            
            if (editingItemId !== null) {
                db.behaviors[editingItemId].title = title;
                db.behaviors[editingItemId].type = type;
                db.behaviors[editingItemId].weight = weight;
            } else {
                db.behaviors.push({
                    id: 'b' + Date.now(),
                    title, type, weight
                });
            }

        } else {
            const rType = document.getElementById('ruleType').value;
            const target = document.getElementById('ruleTargetId').value;
            const threshold = parseInt(document.getElementById('ruleThreshold').value);
            const resType = document.getElementById('ruleResultType').value;
            const resText = document.getElementById('ruleResultText').value.trim();
            const isSpec = document.getElementById('ruleIsSpecific').checked;

            if(!resText || isNaN(threshold)) return alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ø§Ù‚Øµ Ø§Ø³Øª');

            const newRule = {
                id: editingItemId !== null ? db.rules[editingItemId].id : 'r' + Date.now(),
                type: rType,
                targetId: rType === 'specific' ? target : null,
                threshold: Math.abs(threshold),
                resultType: resType,
                resultText: resText,
                isSpecific: isSpec
            };

            if (editingItemId !== null) {
                db.rules[editingItemId] = newRule;
            } else {
                db.rules.push(newRule);
            }
        }
        
        saveDB();
        resetEditorForm();
        renderEditorList();
        // Scroll to bottom of list
        const container = document.getElementById('editorListContainer');
        container.scrollTop = container.scrollHeight;
    }

    function deleteItem(type, index) {
        if(!confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
        if(type === 'behavior') db.behaviors.splice(index, 1);
        else db.rules.splice(index, 1);
        saveDB();
        resetEditorForm();
        renderEditorList();
    }

    function closeEditor() {
        document.getElementById('editorModal').style.display = 'none';
        renderHome();
    }

    // ==========================================
    // 8. DATA MANAGEMENT
    // ==========================================
    
    function backupData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "Ethics_Backup_" + getKey(new Date()) + ".json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function restoreData(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if(imported.behaviors && imported.rules) {
                    db = imported;
                    saveDB();
                    alert('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯.');
                    location.reload();
                } else {
                    alert('ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.');
                }
            } catch(err) {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„.');
            }
        };
        reader.readAsText(file);
    }
    
    function openClearDataModal() {
        document.getElementById('clearDataModal').style.display = 'flex';
    }
    
    function performClearData() {
        const option = document.querySelector('input[name="clearOption"]:checked').value;
        
        if (option === 'all') {
            if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù¾Ø§Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.")) {
                localStorage.removeItem('EthicsDB_Final');
                location.reload();
            }
        } else {
            const key = getKey(new Date());
            if (db.logs[key]) {
                delete db.logs[key];
                saveDB();
                renderHome();
                document.getElementById('clearDataModal').style.display = 'none';
                alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ù…Ø±ÙˆØ² Ù¾Ø§Ú© Ø´Ø¯.');
            }
        }
    }

</script>
</body>
</html>
