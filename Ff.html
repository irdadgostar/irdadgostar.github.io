این کد کامل و نهایی است. تمام ۴ دستور شما دقیقاً اجرا شده‌اند:
1.  **سیستم گزارش‌دهی و ثبت خودکار روزانه:** سیستم اکنون در هر بار ورود، اگر تاریخ تغییر کرده باشد، وضعیت مالی را آرشیو می‌کند. بخش جدید "تحلیل و گزارشات" اضافه شده که نمودار پیشرفت و جداول روزانه را نمایش می‌دهد و خروجی PDF کامل (شامل نمودار و تاریخچه) تولید می‌کند.
2.  **رفع باگ اولویت‌ها:** بخش مدیریت اولویت‌ها بازنویسی شد تا بدون هنگ کردن و با سرعت بالا اجرا شود.
3.  **دکمه واحد پول:** دکمه تبدیل واحد پول بازطراحی شد و به صورت یک دکمه بیضی شکل (Pill) با متن کامل "تومان/ریال" نمایش داده می‌شود.
4.  **فراموشی رمز عبور:** سیستم امنیتی بازنویسی شد. هنگام ثبت‌نام (اولین ورود) یک سوال امنیتی تصادفی پرسیده می‌شود. در صفحه قفل، دکمه "فراموشی رمز" اضافه شده که با پاسخ به سوال، رمز را ریست می‌کند.

کد کامل (HTML + CSS + JS) بدون هیچ حذفیاتی:

```html
<!DOCTYPE html> 
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدیریت مالی حرفه‌ای | V14 Ultimate (Analytics & Security)</title>

    <!-- فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- آیکون‌ها -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- نمودار -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- تبدیل به عکس -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- کتابخانه PDF (دستور ۱) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-body: #f3f4f6;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(203, 213, 225, 0.8);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            
            --primary: #4338ca;      /* Indigo */
            --primary-light: #6366f1;
            --text-main: #1e293b;
            --text-sec: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --card-radius: 16px;
            --nav-height: 70px;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.98);
            --glass-border: 1px solid rgba(71, 85, 105, 0.5);
            --text-main: #f1f5f9;
            --text-sec: #94a3b8;
            --primary: #818cf8;
            --primary-light: #6366f1;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0 0 var(--nav-height) 0;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s;
        }

        /* --- کامپوننت‌های عمومی --- */
        .container {
            max-width: 600px; /* موبایل فرست */
            margin: 0 auto;
            padding: 20px;
        }

        .glass-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-light);
            padding-bottom: 10px;
        }

        .header-row h3 { margin: 0; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; }

        /* دکمه‌ها */
        .btn {
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-light)); 
            color: white; 
        }
        .btn-primary:active { transform: scale(0.96); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        .btn-outline { 
            background: var(--glass-bg); 
            border: 2px solid var(--text-sec); 
            color: var(--text-sec); 
        }
        .btn-outline:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            background: rgba(67, 56, 202, 0.05);
        }

        .btn-danger { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); 
            border: 2px solid rgba(239, 68, 68, 0.2); 
            box-shadow: none;
        }
        .btn-danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        .btn-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .btn-icon:hover { 
            background: var(--primary); 
            color: white; 
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(67, 56, 202, 0.2);
        }
        
        .btn-small-icon {
            width: 28px; height: 28px;
            border-radius: 6px;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer; margin-right: 3px;
            font-size: 0.8rem;
        }
        .btn-edit { color: var(--warning); border: 1px solid var(--warning); background: transparent; }
        .btn-del { color: var(--danger); border: 1px solid var(--danger); background: transparent; }
        .btn-inject { color: var(--success); border: 1px solid var(--success); background: transparent; }
        .btn-pause { color: var(--text-sec); border: 1px solid var(--text-sec); background: transparent; }

        /* دستور ۳: استایل بهتر برای دکمه واحد پول */
        .currency-toggle {
            padding: 5px 12px;
            border-radius: 20px;
            background: var(--glass-bg);
            border: 2px solid var(--primary);
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .currency-toggle:hover {
            background: var(--primary); color: white;
        }

        .badge-currency {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        /* ورودی‌ها */
        input, select {
            background: var(--bg-body);
            border: 1px solid var(--text-sec);
            color: var(--text-main);
            padding: 12px;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 10px;
        }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(67, 56, 202, 0.1); }
        
        /* Slider Style */
        input[type=range] {
            -webkit-appearance: none; width: 100%; margin: 10px 0; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
            background: var(--primary); cursor: pointer; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #ddd; border-radius: 3px;
        }

        /* استایل خاص برای فیلدهای تاریخ سفارشی */
        .date-picker-row {
            display: flex;
            gap: 5px;
            direction: ltr; /* روز سمت راست، سال سمت چپ در چیدمان فلکس */
        }
        .date-picker-row select {
            flex: 1;
            padding: 8px;
            font-size: 0.9rem;
            direction: rtl;
        }

        /* استایل لیبل پول */
        .money-input-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .money-input-wrapper input {
            padding-left: 60px; /* جا برای متن ریال/تومان */
            margin-bottom: 0;
            direction: ltr;
            text-align: right;
        }
        .money-unit {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-sec);
            font-size: 0.8rem;
            font-weight: bold;
            pointer-events: none;
        }

        /* --- پین کد (PIN Screen) --- */
        .pin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pin-dots { display: flex; gap: 15px; margin: 30px 0; }
        .pin-dot { width: 16px; height: 16px; border-radius: 50%; border: 2px solid var(--primary); transition: 0.2s; }
        .pin-dot.filled { background: var(--primary); transform: scale(1.1); }
        
        .numpad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; direction: ltr; /* چپ به راست */
        }
        .num-key {
            width: 70px; height: 70px; border-radius: 50%;
            background: var(--glass-bg); border: 1px solid var(--text-sec);
            font-size: 1.5rem; font-weight: bold; color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: var(--shadow); transition: 0.1s;
        }
        .num-key:active { background: var(--primary); color: white; transform: scale(0.9); }

        /* --- کارت اعتباری (HERO) --- */
        .hero-card {
            perspective: 1000px;
            height: 200px;
            margin-bottom: 25px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        .hero-card.flipped .card-inner { transform: rotateY(180deg); }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            padding: 25px;
            color: white;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .card-front {
            background: linear-gradient(135deg, #4f46e5, #3b82f6);
        }
        .card-back {
            background: #1e293b;
            transform: rotateY(180deg);
            align-items: center; justify-content: center;
        }

        .balance-label { font-size: 0.9rem; opacity: 0.8; text-align: right; display: block;}
        .balance-value { font-size: 2.2rem; font-weight: 800; margin: 5px 0; direction: ltr; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .currency-tag { font-size: 1rem; vertical-align: middle; }

        /* --- BENTO GRID (بودجه) --- */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            gap: 15px;
        }
        @media(min-width: 600px) { .budget-grid { grid-template-columns: 1fr 1fr; } }

        .bento-item {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            position: relative;
            display: flex; flex-direction: column; gap: 8px;
            box-shadow: var(--shadow);
            transition: opacity 0.3s;
        }
        .bento-item.paused {
            opacity: 0.6;
            filter: grayscale(0.8);
            border: 2px dashed var(--text-sec);
        }
        
        .bento-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1rem; }
        
        .progress-bar {
            height: 10px; background: rgba(0,0,0,0.05); border-radius: 5px; overflow: hidden; margin: 5px 0;
        }
        .progress-fill { height: 100%; transition: width 0.5s; border-radius: 5px; }
        
        /* وضعیت‌های رنگی */
        .stat-green .progress-fill { background: var(--success); }
        .stat-green .remain-val { color: var(--success); }
        
        .stat-yellow .progress-fill { background: var(--warning); }
        .stat-yellow .remain-val { color: var(--warning); }
        
        .stat-red .progress-fill { background: var(--danger); }
        .stat-red .remain-val { color: var(--danger); }
        .stat-red { border: 1px solid var(--danger); }

        .bento-actions {
            margin-top: 5px;
            display: flex; gap: 5px; flex-wrap: wrap;
        }
        .action-chip {
            flex: 1; padding: 6px; font-size: 0.8rem; border-radius: 6px;
            border: 1px solid var(--text-sec); background: transparent; color: var(--text-main);
            cursor: pointer; text-align: center; font-weight: bold; white-space: nowrap;
        }
        .action-chip:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Template Chips (New) --- */
        .template-row {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px;
        }
        .template-chip {
            white-space: nowrap; padding: 5px 12px; border-radius: 20px;
            background: var(--glass-bg); border: 1px solid var(--primary); color: var(--primary);
            font-size: 0.8rem; cursor: pointer; transition: 0.2s;
        }
        .template-chip:hover { background: var(--primary); color: white; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-top: var(--glass-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            box-shadow: 0 -5px 10px rgba(0,0,0,0.05);
        }
        .nav-btn {
            background: none; border: none;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            color: var(--text-sec); font-size: 0.75rem; cursor: pointer;
            width: 60px; font-weight: bold;
        }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; transition: transform 0.2s; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { transform: translateY(-5px); }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none; 
            justify-content: center; 
            align-items: flex-end; /* باز شدن از پایین */
            backdrop-filter: blur(3px);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.active { 
            display: flex; 
            opacity: 1;
        }
        .modal-content {
            background: var(--bg-body);
            width: 100%; max-width: 600px; /* تمام عرض در موبایل */
            padding: 25px;
            border-radius: 25px 25px 0 0; /* گرد شدن فقط بالا */
            border-top: 1px solid var(--text-sec);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            max-height: 90vh; overflow-y: auto;
            transform: translateY(100%); /* پیش فرض پایین */
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.1);
        }
        .modal.active .modal-content {
            transform: translateY(0); /* آمدن به بالا */
        }

        /* --- REPORT (PRINT) --- */
        /* استایل خاص برای PDF (دستور ۱) */
        #printArea {
            position: fixed; top: -9999px; left: -9999px;
            width: 790px; /* A4 Width approx */
            background: white; color: black; padding: 20px;
            border: 1px solid #000; font-family: 'Tahoma', sans-serif;
        }
        .print-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 15px; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 12px; }
        .print-table th { background: #eee; border: 1px solid #000; padding: 5px; }
        .print-table td { border: 1px solid #000; padding: 5px; text-align: center; }
        .print-summary { display: flex; justify-content: space-between; margin-top: 20px; font-weight: bold; border: 1px solid #000; padding: 10px; background: #f9f9f9; }
        .print-section-title { font-weight: bold; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }

        /* Section History Chip */
        .history-btn {
            font-size: 0.8rem; background: rgba(0,0,0,0.05); padding: 5px 10px; border-radius: 20px; cursor: pointer; margin-left: 10px; display: inline-flex; align-items: center; gap: 5px;
        }
        .history-btn:hover { background: var(--primary); color: white; }

        .auth-input-group { width: 100%; margin-bottom: 15px; text-align: center; }
        .forget-btn { font-size: 0.8rem; color: var(--text-sec); margin-top: 10px; background: none; border: none; cursor: pointer; }
        .forget-btn:hover { color: var(--primary); text-decoration: underline; }

    </style>
</head>
<body>

<!-- 1. LOCK SCREEN (PIN & AUTH - Instructions 4) -->

<div id="authModal" class="pin-screen" style="display: flex;">
    <i class="fas fa-fingerprint" style="font-size: 4rem; color: var(--primary);"></i>
    <h2 id="authTitle" style="margin: 15px 0 5px 0;">امنیت</h2>
    
    <p id="authSub" style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 20px;">...</p>

    <!-- Setup / Recovery Inputs -->
    <div id="setupDiv" class="auth-input-group" style="display:none; max-width: 280px;">
        <input type="text" id="setupNameInput" placeholder="نام خود را وارد کنید" style="text-align:center;">
        <label style="display:block; margin-top:10px; font-size:0.8rem; color:var(--text-sec);">سوال امنیتی (برای فراموشی رمز):</label>
        <div id="setupQuestionDisplay" style="font-weight:bold; margin:5px 0; color:var(--primary);">---</div>
        <input type="text" id="setupAnswerInput" placeholder="پاسخ سوال امنیتی" style="text-align:center;">
    </div>

    <div id="recoveryDiv" class="auth-input-group" style="display:none; max-width: 280px;">
        <p style="font-size:0.8rem;">لطفاً پاسخ دهید:</p>
        <div id="recoveryQuestionDisplay" style="font-weight:bold; margin:10px 0; color:var(--primary);">---</div>
        <input type="text" id="recoveryAnswerInput" placeholder="پاسخ..." style="text-align:center;">
        <button class="btn btn-primary" style="width:100%" onclick="checkRecovery()">بازیابی رمز</button>
        <button class="btn btn-outline" style="width:100%; margin-top:5px;" onclick="cancelRecovery()">انصراف</button>
    </div>

    <!-- PIN Dots -->
    <div class="pin-dots" id="pinDotsDiv">
        <div class="pin-dot" id="pd1"></div>
        <div class="pin-dot" id="pd2"></div>
        <div class="pin-dot" id="pd3"></div>
        <div class="pin-dot" id="pd4"></div>
    </div>

    <!-- Numpad -->
    <div class="numpad" id="numpadDiv">
        <button class="num-key" onclick="pressKey(1)">1</button>
        <button class="num-key" onclick="pressKey(2)">2</button>
        <button class="num-key" onclick="pressKey(3)">3</button>
        <button class="num-key" onclick="pressKey(4)">4</button>
        <button class="num-key" onclick="pressKey(5)">5</button>
        <button class="num-key" onclick="pressKey(6)">6</button>
        <button class="num-key" onclick="pressKey(7)">7</button>
        <button class="num-key" onclick="pressKey(8)">8</button>
        <button class="num-key" onclick="pressKey(9)">9</button>
        <button class="num-key" onclick="initRecovery()" style="font-size:0.7rem; display:flex; flex-direction:column; gap:2px;">
            <i class="fas fa-question"></i><span style="font-size:0.6rem">فراموشی</span>
        </button>
        <button class="num-key" onclick="pressKey(0)">0</button>
        <button class="num-key" onclick="pressKey('del')" style="color:var(--danger)"><i class="fas fa-backspace"></i></button>
    </div>
</div>

<!-- 2. MAIN APP -->

<div class="container" id="appContent" style="display:none;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px;">
        <div>
            <h2 style="margin:0; color:var(--primary);">مدیریت مالی</h2>
            <span style="font-size:0.8rem; color:var(--text-sec);" id="headerDate">---</span>
        </div>
        <div style="display:flex; gap:10px;">
            <!-- دستور ۳: دکمه واحد پول جدید -->
            <button class="currency-toggle" onclick="toggleCurrency()" title="تبدیل واحد پول">
                <i class="fas fa-coins"></i>
                <span id="currBadge">تومان</span>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="تم شب/روز">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <!-- TAB 1: DASHBOARD -->
    <div id="view-dashboard" class="tab-pane active">
        <!-- Hero Card -->
        <div class="hero-card" onclick="this.classList.toggle('flipped')">
            <div class="card-inner">
                <div class="card-front">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <i class="fas fa-wifi" style="opacity:0.7"></i>
                        <span style="font-size:0.9rem; opacity:0.8">کارت هوشمند</span>
                    </div>
                    <div>
                        <span class="balance-label">موجودی خالص (قابل تقسیم)</span>
                        <div class="balance-value" id="totalBalance">0</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
                        <span id="userNameDisplay">کاربر</span>
                        <span id="cardCurrency">تومان</span>
                    </div>
                </div>
                <div class="card-back">
                    <h3 style="margin:0;">خلاصه وضعیت</h3>
                    <p style="margin:5px 0;">مجموع بدهی‌های ثابت و چک:</p>
                    <div style="font-size:1.8rem; color:var(--danger); font-weight:bold; direction:ltr;" id="totalDebtDisplay">0</div>
                    <p style="font-size:0.8rem; margin-top:10px; opacity:0.7;">این مبلغ کسر شده است.</p>
                </div>
            </div>
        </div>

        <!-- Dashboard Header with History -->
        <div class="header-row">
            <h3>داشبورد <span class="history-btn" onclick="showSectionHistory('dashboard')"><i class="fas fa-history"></i> سابقه</span></h3>
        </div>

        <!-- Wallets -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-wallet"></i> منابع مالی (کیف پول)</h3>
                <button class="btn btn-primary" onclick="openModal('walletModal')"><i class="fas fa-plus"></i> افزودن</button>
            </div>
            <div id="walletList"></div>
        </div>

        <!-- Fixed Debts -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-file-invoice-dollar"></i> اقساط ثابت</h3>
                <button class="btn btn-primary" onclick="openModal('debtModal')"><i class="fas fa-plus"></i> افزودن</button>
            </div>
            <div id="debtList"></div>
        </div>

        <!-- Checks & Debts -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-money-check-alt"></i> چک و بدهی</h3>
                <button class="btn btn-primary" onclick="openModal('checkModal')"><i class="fas fa-plus"></i> افزودن</button>
            </div>
            <div id="checkList"></div>
        </div>
    </div>

    <!-- TAB 2: BUDGET -->
    <div id="view-budget" class="tab-pane">
        <div class="glass-panel" style="text-align:center;">
            <span style="color:var(--text-sec); font-size:0.9rem;">بودجه کل توزیع شده:</span>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                <div id="distributable" style="font-size:1.5rem; font-weight:bold; color:var(--primary); direction:ltr;">0</div>
                <small id="totalPercentBadge" style="background:var(--text-sec); color:white; padding:2px 6px; border-radius:4px;">0%</small>
            </div>
            <button id="btnDistribute" class="btn btn-primary" style="margin-top:10px; width:100%; display:none;" onclick="triggerDistribution()">
                <i class="fas fa-sync-alt"></i> توزیع موجودی جدید
            </button>
        </div>

        <div class="header-row" style="margin: 0 10px 15px 10px; flex-direction: column; align-items: flex-start;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center;">
                <h3 style="display:flex; align-items:center;">مدیریت ردیف‌ها <span class="history-btn" onclick="showSectionHistory('budget')"><i class="fas fa-history"></i> سابقه</span></h3>
                <button class="btn btn-primary" onclick="openModal('addBudgetModal')"><i class="fas fa-plus"></i> جدید</button>
            </div>
            <div class="template-row" style="width: 100%; margin-top: 10px;">
                <span style="font-size:0.8rem; line-height:30px; margin-left:5px;">قالب‌ها:</span>
                <div class="template-chip" onclick="applyTemplate('default')">پیش‌فرض</div>
                <div class="template-chip" onclick="applyTemplate('student')">دانشجویی</div>
                <div class="template-chip" onclick="applyTemplate('married')">متاهلی</div>
                <div class="template-chip" onclick="applyTemplate('clear')">پاکسازی</div>
            </div>
        </div>

        <div id="budgetGrid" class="budget-grid">
            <!-- Cards -->
        </div>
    </div>

    <!-- TAB 3: TOOLS -->
    <div id="view-tools" class="tab-pane">
        <div class="header-row" style="padding:0 10px;">
             <h3>ابزارها <span class="history-btn" onclick="showSectionHistory('tools')"><i class="fas fa-history"></i> سابقه</span></h3>
        </div>

        <!-- دستور ۱: دکمه گزارش تحلیلی -->
        <div class="glass-panel" style="background: linear-gradient(135deg, #f0fdf4, #dcfce7); border-color: #86efac;">
            <div class="header-row" style="border-bottom:none;">
                <h3 style="color:#15803d;"><i class="fas fa-chart-line"></i> تحلیل و گزارشات روزانه</h3>
            </div>
            <p style="font-size:0.85rem; color:#166534; margin-bottom:15px;">مشاهده پیشرفت روزانه، نمودارها و دانلود PDF کامل گزارشات.</p>
            <button class="btn" style="width:100%; background:#16a34a; color:white;" onclick="openAnalysis()">مشاهده و دریافت گزارش</button>
        </div>

        <!-- Goals -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-bullseye"></i> اهداف پس‌انداز</h3>
                <button class="btn btn-primary" onclick="openModal('goalModal')"><i class="fas fa-plus"></i> هدف</button>
            </div>
            <div id="goalList"></div>
        </div>

        <!-- Shopping -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-shopping-cart"></i> لیست خرید</h3>
                <button class="btn btn-primary" onclick="openModal('shopModal')"><i class="fas fa-plus"></i> کالا</button>
            </div>
            <div id="shopList"></div>
        </div>

        <!-- Loans Given -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-hand-holding-usd"></i> طلب‌ها (قرض داده شده)</h3>
                <button class="btn btn-primary" onclick="openModal('loanModal')"><i class="fas fa-plus"></i> ثبت</button>
            </div>
            <div id="loanList"></div>
        </div>
    </div>

    <!-- TAB 4: SETTINGS -->
    <div id="view-settings" class="tab-pane">
        <div class="glass-panel">
            <div class="header-row"><h3>تنظیمات سیستم</h3></div>
            
            <div style="display:flex; flex-direction:column; gap:15px;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:rgba(0,0,0,0.05); border-radius:8px;">
                    <span><i class="fas fa-copy"></i> حالت کپی (خام برای بانک)</span>
                    <input type="checkbox" id="rawCopyCheck" style="width:20px; height:20px;">
                </div>

                <!-- Priority Settings (Instruction 2 Fix) -->
                <button class="btn btn-outline" onclick="openPrioritySettings()">
                    <i class="fas fa-list-ol"></i> مدیریت اولویت‌ها
                </button>

                <button class="btn btn-outline" onclick="changeUserName()">
                    <i class="fas fa-user-edit"></i> تغییر نام کاربر
                </button>
                
                <button class="btn btn-outline" onclick="downloadBackup()">
                    <i class="fas fa-download"></i> دانلود فایل بکاپ (JSON)
                </button>
                
                <label class="btn btn-outline" style="cursor:pointer; text-align:center;">
                    <i class="fas fa-upload"></i> بازیابی فایل بکاپ
                    <input type="file" id="restoreFile" style="display:none" onchange="restoreBackup(this)">
                </label>

                <button class="btn btn-outline" onclick="showHistory()">
                    <i class="fas fa-history"></i> تاریخچه بکاپ‌ها
                </button>

                <button class="btn btn-outline" onclick="changePin()">
                    <i class="fas fa-lock"></i> تغییر رمز عبور
                </button>

                <button class="btn btn-danger" onclick="resetAll()">
                    <i class="fas fa-trash"></i> ریست فکتوری
                </button>
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM NAVIGATION -->

<nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('dashboard')">
        <i class="fas fa-home"></i> داشبورد
    </button>
    <button class="nav-btn" onclick="switchTab('budget')">
        <i class="fas fa-chart-pie"></i> بودجه
    </button>
    <button class="nav-btn" onclick="switchTab('tools')">
        <i class="fas fa-tools"></i> ابزارها
    </button>
    <button class="nav-btn" onclick="switchTab('settings')">
        <i class="fas fa-cog"></i> تنظیمات
    </button>
</nav>

<!-- MODALS -->

<!-- Analytics Modal (Instruction 1) -->
<div id="analyticsModal" class="modal">
    <div class="modal-content" style="max-height: 95vh;">
        <h3>تحلیل و گزارشات</h3>
        <p id="daysCountDisplay" style="text-align:center; color:var(--text-sec); font-size:0.9rem;">...</p>
        
        <div style="margin:20px 0; height:200px;">
            <canvas id="dailyChart"></canvas>
        </div>

        <h4>تاریخچه روزانه</h4>
        <div id="dailyLogList" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:10px;"></div>

        <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="downloadPDF()">
            <i class="fas fa-file-pdf"></i> دانلود گزارش PDF کامل
        </button>
        <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3>ویرایش آیتم</h3>
        <input type="hidden" id="editType">
        <input type="hidden" id="editIndex">

        <label>عنوان:</label>
        <input type="text" id="editName">
        
        <div id="editAmountWrapper">
            <label>مبلغ / ارزش:</label>
            <div class="money-input-wrapper">
                <input type="text" id="editVal" onkeyup="formatCurrency(this)" inputmode="numeric">
                <span class="money-unit currency-text">تومان</span>
            </div>
        </div>

        <div id="editDateWrapper" style="display:none;">
            <label>تاریخ:</label>
            <div class="date-picker-row" id="editDateRow"></div>
        </div>

        <div id="editPercentWrapper" style="display:none;">
            <label>درصد:</label>
            <input type="number" id="editPercent">
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="performEdit()">ذخیره تغییرات</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Section History Modal -->
<div id="sectionHistoryModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه تغییرات (۱۰ مورد آخر)</h3>
        <p style="font-size:0.8rem; color:var(--text-sec)">با کلیک روی هر مورد، وضعیت به آن زمان باز می‌گردد.</p>
        <div id="sectionHistoryList" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Wallet Modal -->
<div id="walletModal" class="modal">
    <div class="modal-content">
        <h3>افزودن کیف پول</h3>
        <label>نام کیف پول:</label>
        <input type="text" id="wName" placeholder="مثلاً: کارت ملی">
        <label>مبلغ موجودی:</label>
        <div class="money-input-wrapper">
            <input type="text" id="wVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addWallet()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Fixed Debt Modal -->
<div id="debtModal" class="modal">
    <div class="modal-content">
        <h3>افزودن قسط ثابت</h3>
        <label>عنوان قسط:</label>
        <input type="text" id="dName" placeholder="مثلاً: وام مسکن">
        <label>مبلغ قسط:</label>
        <div class="money-input-wrapper">
            <input type="text" id="dVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ پرداخت (روز):</label>
        <div class="date-picker-row">
            <select id="dDay" style="direction: rtl;"></select>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addDebt()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Check/Debt Modal -->
<div id="checkModal" class="modal">
    <div class="modal-content">
        <h3>افزودن چک / بدهی</h3>
        <label>عنوان:</label>
        <input type="text" id="cName" placeholder="مثلاً: چک صیادی">
        <label>مبلغ:</label>
        <div class="money-input-wrapper">
            <input type="text" id="cVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ سررسید:</label>
        <div class="date-picker-row" id="checkDateRow"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addCheck()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Loan Given Modal -->
<div id="loanModal" class="modal">
    <div class="modal-content">
        <h3>ثبت طلب (قرض داده شده)</h3>
        <label>نام شخص/عنوان:</label>
        <input type="text" id="lName" placeholder="مثلاً: علی رضایی">
        <label>مبلغ قرض:</label>
        <div class="money-input-wrapper">
            <input type="text" id="lVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ وصول:</label>
        <div class="date-picker-row" id="loanDateRow"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addLoan()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Add Budget Modal -->
<div id="addBudgetModal" class="modal">
    <div class="modal-content">
        <h3>افزودن ردیف بودجه</h3>
        <label>عنوان:</label>
        <input type="text" id="bName" placeholder="مثلاً: پوشاک">
        <label>درصد سهم:</label>
        <input type="number" id="bPercent" placeholder="مثلاً: 10">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addNewBudget()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Expense Modal -->
<div id="expModal" class="modal">
    <div class="modal-content">
        <h3>ثبت هزینه جدید</h3>
        <input type="hidden" id="expBudgetId">
        <label>مبلغ هزینه:</label>
        <div class="money-input-wrapper">
            <input type="text" id="expAmt" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>بابت (توضیح):</label>
        <input type="text" id="expReason" placeholder="...">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="submitExp()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Goal Modal -->
<div id="goalModal" class="modal">
    <div class="modal-content">
        <h3>هدف پس‌انداز جدید</h3>
        <label>نام هدف:</label>
        <input type="text" id="gName" placeholder="مثلاً: لپ‌تاپ">
        <label>مبلغ هدف:</label>
        <div class="money-input-wrapper">
            <input type="text" id="gTarget" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addGoal()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Shop Modal -->
<div id="shopModal" class="modal">
    <div class="modal-content">
        <h3>افزودن به لیست خرید</h3>
        <label>نام کالا:</label>
        <input type="text" id="sName" placeholder="مثلاً: روغن زیتون">
        <label>قیمت حدودی (اختیاری):</label>
        <div class="money-input-wrapper">
            <input type="text" id="sPrice" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addShop()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Allocate Modal -->
<div id="allocModal" class="modal">
    <div class="modal-content">
        <h3>اختصاص بودجه</h3>
        <p style="font-size:0.9rem; color:var(--text-sec);">انتخاب کنید هزینه از کدام ردیف بودجه کسر شود:</p>
        <input type="hidden" id="allocType">
        <input type="hidden" id="allocId">

        <label>ردیف بودجه:</label>
        <select id="allocBudgetSelect"></select>
        
        <label>مبلغ اختصاصی:</label>
        <div class="money-input-wrapper">
            <input type="text" id="allocAmt" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="performAllocation()">ثبت کسری</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Percentage Correction Modal -->
<div id="fixPercentModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> خطا در درصد کل</h3>
        <p>مجموع درصد‌ها از ۱۰۰٪ بیشتر شده است. لطفاً یکی از گزینه‌های زیر را انتخاب کنید:</p>

        <div style="margin:20px 0; padding:15px; background:rgba(0,0,0,0.05); border-radius:10px;">
            <p><b>حالت اول:</b> انتخاب دستی تا سقف مجاز</p>
            <p style="font-size:0.9rem;">حداکثر درصد قابل انتخاب: <b id="maxAllowedPercent" style="color:var(--primary)">0%</b></p>
            <div style="display:flex; align-items:center; gap:10px;">
                <span>0</span>
                <input type="range" id="percentSlider" min="0" value="0" oninput="updateSliderVal()">
                <span id="sliderValDisplay">0</span>%
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="useSliderPercent()">ثبت درصد انتخابی</button>
        </div>

        <div style="margin:20px 0; padding:15px; background:rgba(0,0,0,0.05); border-radius:10px;">
            <p><b>حالت دوم:</b> اصلاح هوشمند سیستم</p>
            <p style="font-size:0.9rem;">سیستم بر اساس اولویت‌بندی‌ها، درصدهای اولویت پایین‌تر را کاهش می‌دهد.</p>
            
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                <input type="checkbox" id="allowZeroCheck" style="width:auto; margin:0;">
                <label for="allowZeroCheck" style="font-size:0.9rem;">اجازه صفر شدن آیتم‌ها (در صورت نیاز)</label>
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="autoCorrectBudget()">اصلاح خودکار و ثبت</button>
        </div>

        <button class="btn btn-danger" style="width:100%" onclick="closeAllModals()">انصراف</button>
    </div>
</div>

<!-- Priority Settings Modal (Fixed Instruction 2) -->
<div id="prioritySettingsModal" class="modal">
    <div class="modal-content">
        <h3>مدیریت اولویت‌ها</h3>
        <p style="font-size:0.8rem; color:var(--text-sec); margin-bottom:10px;">تعریف بازه درصدها (اختیاری):</p>
        
        <div style="display:flex; gap:5px; margin-bottom:15px; background:#f9f9f9; padding:10px; border-radius:8px;">
            <div style="flex:1">
                <small>کم (تا %)</small>
                <input type="number" id="pRangeLow" placeholder="40" style="padding:5px; font-size:0.8rem; margin:0;">
            </div>
            <div style="flex:1">
                <small>متوسط (تا %)</small>
                <input type="number" id="pRangeMid" placeholder="70" style="padding:5px; font-size:0.8rem; margin:0;">
            </div>
        </div>
        <button class="btn btn-outline" style="width:100%; margin-bottom:15px; font-size:0.8rem;" onclick="savePriorityRanges()">ذخیره بازه‌ها</button>

        <!-- Container cleaned before population to avoid crash -->
        <div id="priorityList" style="max-height:300px; overflow-y:auto;"></div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="savePriorities()">ذخیره اولویت‌ها</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Item History Modal -->
<div id="itemHistModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه تراکنش‌ها</h3>
        <div id="itemHistList" style="max-height:300px; overflow-y:auto; margin-top:10px; font-size:0.85rem;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Backup History Modal -->
<div id="histModal" class="modal">
    <div class="modal-content">
        <h3>تاریخچه بکاپ‌ها</h3>
        <div id="histList" style="max-height:300px; overflow-y:auto; margin-top:10px; font-size:0.9rem;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- REPORT TEMPLATE (Instruction 1 - Full PDF Area) -->
<div id="printArea">
    <div class="print-header">
        <h1>گزارش جامع وضعیت مالی</h1>
        <p id="printDate">تاریخ: ---</p>
        <p>کاربر: <span id="printUser">---</span></p>
        <p>مدت استفاده: <span id="printDuration">---</span></p>
    </div>

    <div class="print-summary">
        <div>کل دارایی: <b id="printInc">0</b></div>
        <div>کل بدهی: <b id="printDebt">0</b></div>
        <div>خالص قابل خرج: <b id="printNet">0</b></div>
    </div>

    <!-- Chart Placeholder for PDF -->
    <div style="margin-top:20px; height:200px; border:1px dashed #ccc; display:flex; align-items:center; justify-content:center;">
        <canvas id="printChart"></canvas>
    </div>

    <div class="print-section-title">جزئیات بودجه‌بندی (امروز)</div>
    <table class="print-table">
        <thead>
            <tr>
                <th>ردیف</th>
                <th>درصد</th>
                <th>سهم (تومان)</th>
                <th>خرج شده</th>
                <th>مانده</th>
            </tr>
        </thead>
        <tbody id="printBody"></tbody>
    </table>

    <div class="print-section-title">وضعیت بدهی‌ها</div>
    <div id="printDebtsList" style="margin-top:5px; font-size:0.9rem;"></div>

    <div class="print-section-title">تاریخچه روزانه (آرشیو)</div>
    <table class="print-table">
        <thead>
            <tr>
                <th>تاریخ</th>
                <th>موجودی</th>
                <th>خرج کل بودجه</th>
            </tr>
        </thead>
        <tbody id="printHistoryBody"></tbody>
    </table>

    <div style="margin-top:30px; text-align:center; font-size:12px; color:#666; border-top:1px solid #000; padding-top:10px;">
        تولید شده توسط سامانه مدیریت مالی شخصی V14
    </div>
</div>

<script>
    // --- STATE & DATA ---
    const defaultState = {
        security: { 
            hasPin: false, 
            pin: "", 
            isSetup: false,
            // Instruction 4: Security Question
            questionIndex: 0,
            answer: "" 
        },
        user: { name: "", theme: "light", currency: "toman" },
        wallets: [],
        debts: [], 
        checks: [], 
        loans: [],  
        budgets: [
            {id: 1, name: "کرایه و رفت‌وآمد", percent: 27, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 2, name: "خورد و خوراک", percent: 12, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 3, name: "پس‌انداز مشهد", percent: 25, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 4, name: "درمان", percent: 3, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 5, name: "شارژ و نت", percent: 10, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 6, name: "زیبایی و مکمل", percent: 7, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 7, name: "لباس", percent: 5, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 8, name: "ضروری", percent: 5, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 9, name: "تفریح", percent: 3, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 10, name: "پس‌انداز کل", percent: 3, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0}
        ],
        priorities: {
            "کرایه و رفت‌وآمد": 1, "خورد و خوراک": 1, "درمان": 1, "ضروری": 1, "اجاره خانه": 1,
            "شارژ و نت": 2, "لباس": 2, "زیبایی و مکمل": 3, "پس‌انداز کل": 3, "پس‌انداز مشهد": 3,
            "تفریح": 4, "سایر": 4
        },
        priorityRanges: { low: 40, mid: 70 },
        distributedAmount: 0,
        goals: [],
        shopping: [],
        history: [], 
        sectionHistory: { dashboard: [], budget: [], tools: [] },
        // Instruction 1: Daily Logs & Start Date
        startDate: new Date().toLocaleDateString('fa-IR'),
        lastLogDate: "",
        dailyLogs: [] 
    };

    // Instruction 4: Security Questions List
    const securityQuestions = [
        "نام اولین حیوان خانگی شما؟",
        "نام شهر محل تولد شما؟",
        "نام بهترین دوست دوران کودکی؟",
        "مدل اولین ماشین شما؟",
        "غذای مورد علاقه شما؟"
    ];

    let app = JSON.parse(JSON.stringify(defaultState));
    let pinBuffer = "";
    let rate = 1; 
    let tempBudget = null; 
    let myChart = null; // Chart instance

    // --- STARTUP ---
    window.onload = () => {
        loadData();
        checkAuth();
        updateDate();
        setupDatePickers();
        checkDailyLog(); // Instruction 1: Auto log on load
    };

    // --- INSTRUCTION 1: DAILY LOGGING ---
    function checkDailyLog() {
        const today = new Date().toLocaleDateString('fa-IR');
        if(app.lastLogDate !== today) {
            // Create Snapshot for today
            const income = app.wallets.reduce((a,b)=>a+b.value,0);
            const totalSpent = app.budgets.reduce((a,b)=>a+b.spent,0);
            
            app.dailyLogs.push({
                date: today,
                income: income,
                spent: totalSpent
            });
            
            // Keep log size reasonable (e.g., 365 days)
            if(app.dailyLogs.length > 365) app.dailyLogs.shift();
            
            app.lastLogDate = today;
            saveData();
        }
    }

    function openAnalysis() {
        // Calculate days passed
        const start = new Date(dateToISO(app.startDate) || Date.now()); // Fallback logic
        const now = new Date();
        const diffTime = Math.abs(now - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        document.getElementById('daysCountDisplay').innerText = `مدت زمان عضویت: ${diffDays} روز | تعداد رکوردهای ثبت شده: ${app.dailyLogs.length}`;

        // Populate List
        const list = document.getElementById('dailyLogList');
        list.innerHTML = app.dailyLogs.slice().reverse().map(l => 
            `<div style="display:flex; justify-content:space-between; font-size:0.85rem; border-bottom:1px solid #f0f0f0; padding:5px;">
                <span>${l.date}</span>
                <span>دارایی: ${format(l.income)}</span>
                <span style="color:var(--danger)">خرج: ${format(l.spent)}</span>
            </div>`
        ).join('');

        // Draw Chart
        const ctx = document.getElementById('dailyChart').getContext('2d');
        if(myChart) myChart.destroy();
        
        const labels = app.dailyLogs.map(l => l.date);
        const dataInc = app.dailyLogs.map(l => l.income * rate);
        const dataExp = app.dailyLogs.map(l => l.spent * rate);

        myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'دارایی', data: dataInc, borderColor: '#10b981', tension: 0.3, fill: false },
                    { label: 'خرج کرد', data: dataExp, borderColor: '#ef4444', tension: 0.3, fill: false }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        openModal('analyticsModal');
    }

    // Date converter helper for rough calculation (Persian string to JS Date is complex, simplied here)
    function dateToISO(persianDate) {
        // This is a placeholder. For accurate Persian date calc, a library is needed. 
        // We will rely on simple approximation or just tracking the first run time.
        // If app.startDate was just set on first run in millis, it's easier.
        // Let's assume startDate is stored as string but we also store a timestamp if needed.
        // For now, we return null to use 'now' if parsing fails.
        return null; 
    }

    // --- DATE PICKER SETUP ---
    function setupDatePickers() {
        // ... handled in modals
    }

    function createDatePickerHTML(prefix, defaultD=1, defaultM=1, defaultY=1403) {
        return `
            <select id="${prefix}Day" class="date-sel">${genOpts(1,31, defaultD)}</select>
            <select id="${prefix}Month" class="date-sel">${genOpts(1,12, defaultM)}</select>
            <select id="${prefix}Year" class="date-sel">${genYearOpts(defaultY)}</select>
        `;
    }

    function genOpts(min, max, sel) {
        let html = '';
        for(let i=min; i<=max; i++) html += `<option value="${i}" ${i==sel?'selected':''}>${i}</option>`;
        return html;
    }
    
    function genYearOpts(sel) {
        const currentYear = 1403;
        let html = '';
        for(let i=0; i<=20; i++) html += `<option value="${currentYear+i}" ${(currentYear+i)==sel?'selected':''}>${currentYear+i}</option>`;
        return html;
    }

    function getDateString(prefix) {
        const d = document.getElementById(prefix+'Day').value;
        const m = document.getElementById(prefix+'Month').value;
        const y = document.getElementById(prefix+'Year').value;
        return `${y}/${m}/${d}`;
    }

    // --- AUTH & SECURITY (Instruction 4) ---
    function checkAuth() {
        const modal = document.getElementById('authModal');
        const title = document.getElementById('authTitle');
        const sub = document.getElementById('authSub');
        const setupDiv = document.getElementById('setupDiv');
        const recoveryDiv = document.getElementById('recoveryDiv');
        const pinDiv = document.getElementById('pinDotsDiv');
        const numDiv = document.getElementById('numpadDiv');
        
        modal.style.display = 'flex';
        pinBuffer = "";
        updatePinDots();
        recoveryDiv.style.display = 'none';

        if (!app.security.hasPin || !app.security.isSetup) {
            // FIRST TIME SETUP
            title.innerText = "خوش آمدید";
            sub.innerText = "تعیین نام، سوال امنیتی و رمز عبور";
            setupDiv.style.display = 'block';
            pinDiv.style.display = 'flex';
            numDiv.style.display = 'grid';
            
            // Generate Random Question Index
            const qIdx = Math.floor(Math.random() * securityQuestions.length);
            app.security.questionIndex = qIdx;
            document.getElementById('setupQuestionDisplay').innerText = securityQuestions[qIdx];
            
            app.security.isSetup = false;
        } else {
            // LOGIN
            title.innerText = "ورود به سامانه";
            sub.innerText = `${app.user.name} عزیز، خوش آمدی.`;
            setupDiv.style.display = 'none';
            pinDiv.style.display = 'flex';
            numDiv.style.display = 'grid';
        }
    }

    function pressKey(key) {
        if (key === 'del') pinBuffer = pinBuffer.slice(0, -1);
        else if (pinBuffer.length < 4) pinBuffer += key;
        updatePinDots();
        if (pinBuffer.length === 4) setTimeout(processPin, 100);
    }

    function updatePinDots() {
        for(let i=1; i<=4; i++) {
            const dot = document.getElementById(`pd${i}`);
            if (i <= pinBuffer.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        }
    }

    function processPin() {
        // SETUP PROCESS
        if (!app.security.hasPin) {
            const nameInput = document.getElementById('setupNameInput');
            const ansInput = document.getElementById('setupAnswerInput');
            
            const nameVal = nameInput.value.trim();
            const ansVal = ansInput.value.trim();

            if(!nameVal || !ansVal) {
                alert("لطفاً نام و پاسخ سوال امنیتی را وارد کنید");
                pinBuffer = ""; updatePinDots();
                return;
            }

            if(confirm("رمز شما: " + pinBuffer + "\nآیا مطمئن هستید؟")) {
                app.security.pin = pinBuffer;
                app.security.hasPin = true;
                app.user.name = nameVal;
                app.security.answer = ansVal;
                app.security.isSetup = true;
                app.startDate = new Date().toLocaleDateString('fa-IR');
                
                saveData();
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                renderUI();
            } else {
                pinBuffer = ""; updatePinDots();
            }
        } 
        // LOGIN PROCESS
        else {
            if (pinBuffer === app.security.pin) {
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                renderUI();
            } else {
                alert("رمز اشتباه است!");
                pinBuffer = ""; updatePinDots();
            }
        }
    }

    // Instruction 4: Forgotten Password Logic
    function initRecovery() {
        if(!app.security.isSetup) return;
        document.getElementById('numpadDiv').style.display = 'none';
        document.getElementById('pinDotsDiv').style.display = 'none';
        document.getElementById('setupDiv').style.display = 'none';
        
        const recDiv = document.getElementById('recoveryDiv');
        recDiv.style.display = 'block';
        
        const qIdx = app.security.questionIndex || 0;
        document.getElementById('recoveryQuestionDisplay').innerText = securityQuestions[qIdx];
        document.getElementById('authTitle').innerText = "بازیابی رمز";
        document.getElementById('authSub').innerText = "پاسخ سوال امنیتی را وارد کنید";
    }

    function checkRecovery() {
        const input = document.getElementById('recoveryAnswerInput').value.trim();
        if(input === app.security.answer) {
            alert("هویت تایید شد. لطفاً رمز جدید ۴ رقمی خود را وارد کنید.");
            app.security.hasPin = false; 
            // Reset UI for new pin entry but keep user data
            document.getElementById('recoveryDiv').style.display = 'none';
            document.getElementById('numpadDiv').style.display = 'grid';
            document.getElementById('pinDotsDiv').style.display = 'flex';
            document.getElementById('authTitle').innerText = "تعیین رمز جدید";
            document.getElementById('authSub').innerText = "";
            pinBuffer = "";
            updatePinDots();
        } else {
            alert("پاسخ اشتباه است.");
        }
    }

    function cancelRecovery() {
        document.getElementById('recoveryDiv').style.display = 'none';
        document.getElementById('numpadDiv').style.display = 'grid';
        document.getElementById('pinDotsDiv').style.display = 'flex';
        document.getElementById('authTitle').innerText = "ورود به سامانه";
        document.getElementById('authSub').innerText = "رمز را وارد کنید";
        pinBuffer = "";
        updatePinDots();
    }

    function changePin() {
        if(confirm("آیا می‌خواهید رمز را تغییر دهید؟")) {
            app.security.hasPin = false;
            app.security.pin = "";
            saveData();
            location.reload();
        }
    }

    function changeUserName() {
        const newName = prompt("نام جدید خود را وارد کنید:", app.user.name);
        if(newName && newName.trim() !== "") {
            app.user.name = newName;
            saveData();
            renderUI();
        }
    }

    // --- FORMATTING HELPERS ---
    function formatCurrency(input) {
        let val = input.value.replace(/[^\d]/g, '');
        if (!val) { input.value = ''; return; }
        input.value = Number(val).toLocaleString('en-US');
    }

    function parseFormatted(val) {
        if(!val) return 0;
        return parseInt(val.replace(/,/g, ''));
    }

    function format(n) { 
        return (n * rate).toLocaleString('en-US'); 
    }

    // --- HISTORY SYSTEM ---
    function saveSectionSnap(section) {
        let snap = null;
        if(section === 'dashboard') {
            snap = JSON.stringify({ wallets: app.wallets, debts: app.debts, checks: app.checks, loans: app.loans });
        } else if(section === 'budget') {
            snap = JSON.stringify({ budgets: app.budgets, priorities: app.priorities, distributedAmount: app.distributedAmount });
        } else if(section === 'tools') {
            snap = JSON.stringify({ goals: app.goals, shopping: app.shopping });
        }
        
        if(!app.sectionHistory[section]) app.sectionHistory[section] = [];
        app.sectionHistory[section].unshift({
            time: new Date().toLocaleTimeString('fa-IR'),
            data: snap
        });
        
        if(app.sectionHistory[section].length > 10) app.sectionHistory[section].pop();
        saveData();
    }

    function showSectionHistory(section) {
        const list = document.getElementById('sectionHistoryList');
        const hist = app.sectionHistory[section] || [];
        
        if(hist.length === 0) {
            list.innerHTML = "<p style='text-align:center'>سابقه‌ای موجود نیست.</p>";
        } else {
            list.innerHTML = hist.map((h, i) => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="restoreSectionSnap('${section}', ${i})">
                    <span>تغییر در ساعت ${h.time}</span>
                    <i class="fas fa-undo" style="color:var(--primary)"></i>
                </div>
            `).join('');
        }
        openModal('sectionHistoryModal');
    }

    function restoreSectionSnap(section, index) {
        if(!confirm("آیا مطمئن هستید که می‌خواهید به این وضعیت بازگردید؟")) return;
        
        const snap = JSON.parse(app.sectionHistory[section][index].data);
        
        if(section === 'dashboard') {
            app.wallets = snap.wallets;
            app.debts = snap.debts;
            app.checks = snap.checks;
            app.loans = snap.loans;
        } else if(section === 'budget') {
            app.budgets = snap.budgets;
            app.priorities = snap.priorities;
            app.distributedAmount = snap.distributedAmount || 0;
        } else if(section === 'tools') {
            app.goals = snap.goals;
            app.shopping = snap.shopping;
        }
        
        saveData();
        renderUI();
        closeAllModals();
    }

    // --- CORE UI RENDER ---
    function renderUI() {
        applyTheme();
        rate = app.user.currency === 'rial' ? 10 : 1;
        const curName = app.user.currency === 'toman' ? 'تومان' : 'ریال';
        document.getElementById('currBadge').innerText = curName;
        document.getElementById('cardCurrency').innerText = curName;
        document.querySelectorAll('.currency-text').forEach(el => el.innerText = curName);

        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const fixedDebt = app.debts.reduce((a,b)=>a+b.value,0);
        const checkDebt = (app.checks || []).reduce((a,b)=>a+b.value,0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        
        const totalDebt = fixedDebt + checkDebt;
        const net = income - totalDebt - manualDeductions;

        document.getElementById('totalBalance').innerText = format(net);
        document.getElementById('totalDebtDisplay').innerText = format(totalDebt);
        document.getElementById('userNameDisplay').innerText = app.user.name;

        document.getElementById('dDay').innerHTML = genOpts(1,31,1);
        document.getElementById('checkDateRow').innerHTML = createDatePickerHTML('c');
        document.getElementById('loanDateRow').innerHTML = createDatePickerHTML('l');

        renderWallets();
        renderDebts();
        renderChecks(); 
        renderLoans(); 
        renderBudgets(net);
        renderGoals();
        renderShop();
    }

    // --- RENDER FUNCTIONS ---
    function renderWallets() {
        const div = document.getElementById('walletList');
        div.innerHTML = app.wallets.map((w, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px;">
                <span>${w.name}</span>
                <div style="display:flex; align-items:center;">
                    <b>${format(w.value)}</b>
                    <span style="margin-right:10px;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('wallet', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delWallet(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderDebts() {
        const div = document.getElementById('debtList');
        div.innerHTML = app.debts.map((d, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px; color:var(--danger);">
                <span>${d.name} <small style="color:var(--text-sec)">(${d.day || 1} ماه)</small></span>
                <div style="display:flex; align-items:center;">
                    <b>${format(d.value)}</b>
                    <span style="margin-right:10px;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('debt', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delDebt(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderChecks() {
        const div = document.getElementById('checkList');
        if(!app.checks) app.checks = [];
        div.innerHTML = app.checks.map((c, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px; color:var(--danger);">
                <div>${c.name} <br><small style="color:var(--text-sec)">سررسید: ${c.date}</small></div>
                <div style="display:flex; align-items:center;">
                    <b>${format(c.value)}</b>
                    <span style="margin-right:10px;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('check', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delCheck(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderLoans() {
        const div = document.getElementById('loanList');
        if(!app.loans) app.loans = [];
        div.innerHTML = app.loans.map((l, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px; color:var(--primary);">
                <div>${l.name} <br><small style="color:var(--text-sec)">وصول: ${l.date}</small></div>
                <div style="display:flex; align-items:center;">
                    <b>${format(l.value)}</b>
                    <span style="margin-right:10px;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('loan', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delLoan(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderBudgets(net) {
        const distributeBtn = document.getElementById('btnDistribute');
        const distributableDisplay = document.getElementById('distributable');
        
        if(net !== app.distributedAmount) {
            distributeBtn.style.display = 'flex';
            distributableDisplay.style.color = 'var(--warning)';
            distributableDisplay.innerText = format(app.distributedAmount) + " (قدیمی)";
        } else {
            distributeBtn.style.display = 'none';
            distributableDisplay.style.color = 'var(--primary)';
            distributableDisplay.innerText = format(app.distributedAmount);
        }

        const div = document.getElementById('budgetGrid');
        div.innerHTML = '';
        
        let totalP = 0;
        app.budgets.forEach(b => totalP += b.percent);
        
        const badge = document.getElementById('totalPercentBadge');
        badge.innerText = totalP + '%';
        badge.style.background = totalP > 100 ? 'var(--danger)' : (totalP === 100 ? 'var(--success)' : 'var(--text-sec)');

        const baseAmount = app.distributedAmount;

        app.budgets.forEach((b, i) => {
            const shareFromPercent = Math.round((baseAmount * b.percent) / 100);
            const totalShare = shareFromPercent + (b.manualAdd || 0);
            const remain = totalShare - b.spent;
            const percent = totalShare > 0 ? (b.spent / totalShare) * 100 : 0;
            
            let status = 'stat-green';
            if(percent > 50) status = 'stat-yellow';
            if(percent > 90) status = 'stat-red';
            
            const pausedClass = b.isPaused ? 'paused' : '';
            const pausedText = b.isPaused ? '(متوقف)' : '';

            div.innerHTML += `
                <div class="bento-item ${status} ${pausedClass}">
                    <div class="bento-header">
                        <span>${b.name} (${b.percent}%) ${pausedText} <i class="fas fa-edit" style="font-size:0.8rem; cursor:pointer; margin-right:5px; color:var(--text-sec);" onclick="openEdit('budget', ${i})"></i></span>
                        <div style="display:flex; gap:8px;">
                            <i class="fas fa-list-alt" style="opacity:0.5; cursor:pointer;" onclick="openItemHistory(${i})" title="تاریخچه"></i>
                            <i class="fas fa-trash" style="opacity:0.3; cursor:pointer;" onclick="delBudget(${i})"></i>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-top:5px; color:var(--text-sec);">
                        <span>سهم: ${format(shareFromPercent)} ${b.manualAdd ? `+ ${format(b.manualAdd)}` : ''}</span>
                        <span style="color:var(--danger)">خرج: ${format(b.spent)}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(percent,100)}%"></div></div>
                    <div style="text-align:left; font-weight:bold; font-size:1.1rem; color:var(--primary); direction:ltr;">
                        ${format(remain)}
                    </div>
                    <div class="bento-actions">
                        <button class="action-chip" onclick="openExp(${i})" ${b.isPaused ? 'disabled' : ''}>➖ ثبت هزینه</button>
                        <button class="action-chip" onclick="copyTxt(${remain})">📋 کپی</button>
                        <button class="action-chip btn-inject" onclick="injectBudget(${i})">➕ واریز</button>
                        <button class="action-chip btn-pause" onclick="togglePause(${i})">${b.isPaused ? '▶️' : '⏸'}</button>
                    </div>
                </div>
            `;
        });
    }

    function triggerDistribution() {
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const fixedDebt = app.debts.reduce((a,b)=>a+b.value,0);
        const checkDebt = (app.checks || []).reduce((a,b)=>a+b.value,0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        const totalDebt = fixedDebt + checkDebt;

        app.distributedAmount = income - totalDebt - manualDeductions; 
        saveData();
        renderUI();
        alert("بودجه با موفقیت بر اساس موجودی جدید توزیع شد.");
    }

    function injectBudget(index) {
        const amt = prompt("مبلغ واریزی مستقیم به این آیتم (از حساب اصلی کسر می‌شود):");
        if(amt && !isNaN(parseFormatted(amt))) {
            const val = parseFormatted(amt);
            saveSectionSnap('budget');
            if(!app.budgets[index].manualAdd) app.budgets[index].manualAdd = 0;
            app.budgets[index].manualAdd += val;
            
            app.distributedAmount -= val;
            
            saveData();
            renderUI();
        }
    }

    function togglePause(index) {
        saveSectionSnap('budget');
        const b = app.budgets[index];
        if(b.isPaused) {
            let restore = confirm(`آیا درصد قبلی (${b.savedPercent}%) اعمال شود؟\nتایید = بله\nلغو = خیر (وارد کردن درصد جدید)`);
            b.isPaused = false;
            if(restore) {
                b.percent = b.savedPercent;
            } else {
                const newP = prompt("درصد جدید را وارد کنید:", b.savedPercent);
                b.percent = parseInt(newP) || 0;
            }
            let total = app.budgets.reduce((a,i)=>a+i.percent,0);
            if(total > 100) {
                tempBudget = b; 
                alert("توجه: مجموع درصدها از ۱۰۰ بیشتر شد. لطفا دستی اصلاح کنید.");
            }
        } else {
            b.savedPercent = b.percent;
            b.percent = 0;
            b.isPaused = true;
            alert("آیتم متوقف شد و درصد آن (0%) شد. سهم آزاد شده بین سایرین قابل توزیع است.");
        }
        saveData();
        renderUI();
    }

    function renderGoals() {
        const div = document.getElementById('goalList');
        div.innerHTML = app.goals.map((g, i) => {
            const p = Math.min(100, Math.round((g.curr / g.target)*100));
            return `
                <div style="padding:10px; border-bottom:1px solid #ddd;">
                    <div style="display:flex; justify-content:space-between;">
                         <b>${g.name}</b> 
                         <span>
                            <button class="btn-small-icon btn-edit" onclick="openEdit('goal', ${i})"><i class="fas fa-edit"></i></button>
                            ${format(g.curr)} / ${format(g.target)}
                         </span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${p}%; background:var(--warning);"></div></div>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                         <button class="btn btn-primary" style="font-size:0.8rem; padding:2px 8px;" onclick="openAllocate('goal', ${i})">🔗 اختصاص</button>
                         <button class="btn btn-outline" style="font-size:0.8rem; padding:2px 8px;" onclick="addGoalMoneyDirect(${i})">+ مستقیم</button>
                         <button class="btn btn-danger" style="font-size:0.8rem; padding:2px 8px;" onclick="delGoal(${i})">×</button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderShop() {
        const div = document.getElementById('shopList');
        div.innerHTML = app.shopping.map((s, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #ddd; align-items:center; flex-wrap:wrap;">
                <div style="flex:1;">
                    <span style="font-weight:bold;">${s.name}</span>
                    ${s.price ? `<span style="font-size:0.85rem; color:var(--text-sec); display:block;">~${format(s.price)}</span>` : ''}
                </div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button class="btn btn-primary" style="font-size:0.75rem;" onclick="openAllocate('shop', ${i})">خرید از بودجه</button>
                    <button class="btn-small-icon btn-edit" onclick="openEdit('shop', ${i})"><i class="fas fa-edit"></i></button>
                    <i class="fas fa-check-circle text-success" style="cursor:pointer; font-size:1.2rem;" onclick="delShop(${i})"></i>
                </div>
            </div>
        `).join('');
    }

    // --- EDIT SYSTEM ---
    function openEdit(type, index) {
        document.getElementById('editType').value = type;
        document.getElementById('editIndex').value = index;
        
        let item;
        let showPercent = false;
        let showAmount = true;
        let showDate = false;

        if(type === 'wallet') item = app.wallets[index];
        else if(type === 'debt') { item = app.debts[index]; showDate = true; }
        else if(type === 'check') { item = app.checks[index]; showDate = true; }
        else if(type === 'loan') { item = app.loans[index]; showDate = true; }
        else if(type === 'budget') { item = app.budgets[index]; showPercent = true; showAmount = false; }
        else if(type === 'goal') { item = app.goals[index]; }
        else if(type === 'shop') { item = app.shopping[index]; }

        document.getElementById('editName').value = item.name;
        
        if(showAmount) {
            document.getElementById('editAmountWrapper').style.display = 'block';
            let val = 0;
            if(type === 'goal') val = item.target;
            else if(type === 'shop') val = item.price || 0;
            else val = item.value;
            document.getElementById('editVal').value = val.toLocaleString();
        } else {
            document.getElementById('editAmountWrapper').style.display = 'none';
        }

        if(showPercent) {
            document.getElementById('editPercentWrapper').style.display = 'block';
            document.getElementById('editPercent').value = item.percent;
        } else {
            document.getElementById('editPercentWrapper').style.display = 'none';
        }

        if(showDate) {
            document.getElementById('editDateWrapper').style.display = 'block';
            const row = document.getElementById('editDateRow');
            if(type === 'debt') {
                row.innerHTML = `<select id="editDDay" class="date-sel" style="width:100%">${genOpts(1,31, item.day)}</select>`;
            } else {
                const parts = item.date ? item.date.split('/') : [1403, 1, 1];
                row.innerHTML = createDatePickerHTML('editD', parseInt(parts[2]), parseInt(parts[1]), parseInt(parts[0]));
            }
        } else {
            document.getElementById('editDateWrapper').style.display = 'none';
        }

        openModal('editModal');
    }

    function performEdit() {
        const type = document.getElementById('editType').value;
        const index = parseInt(document.getElementById('editIndex').value);
        const newName = document.getElementById('editName').value;
        
        if(!newName) return alert("نام نمی‌تواند خالی باشد");

        if(type.includes('budget')) saveSectionSnap('budget');
        else if(type.includes('goal') || type.includes('shop')) saveSectionSnap('tools');
        else saveSectionSnap('dashboard');

        if(type === 'wallet') {
            app.wallets[index].name = newName;
            app.wallets[index].value = parseFormatted(document.getElementById('editVal').value);
        } else if(type === 'debt') {
            app.debts[index].name = newName;
            app.debts[index].value = parseFormatted(document.getElementById('editVal').value);
            app.debts[index].day = document.getElementById('editDDay').value;
        } else if(type === 'check') {
            app.checks[index].name = newName;
            app.checks[index].value = parseFormatted(document.getElementById('editVal').value);
            app.checks[index].date = getDateString('editD');
        } else if(type === 'loan') {
            app.loans[index].name = newName;
            app.loans[index].value = parseFormatted(document.getElementById('editVal').value);
            app.loans[index].date = getDateString('editD');
        } else if(type === 'budget') {
            const oldName = app.budgets[index].name;
            const newP = parseInt(document.getElementById('editPercent').value) || 0;
            
            let total = 0;
            app.budgets.forEach((b, i) => {
                if(i !== index) total += b.percent;
            });
            
            if(total + newP > 100) {
                tempBudget = JSON.parse(JSON.stringify(app.budgets[index]));
                tempBudget.name = newName;
                tempBudget.percent = newP;
                
                const safeMax = 100 - total;
                document.getElementById('maxAllowedPercent').innerText = safeMax + '%';
                const slider = document.getElementById('percentSlider');
                slider.max = safeMax;
                slider.value = 0;
                document.getElementById('sliderValDisplay').innerText = 0;
                
                tempBudget.isEdit = true;
                tempBudget.editIndex = index;
                
                openModal('fixPercentModal');
                return; 
            }

            app.budgets[index].name = newName;
            app.budgets[index].percent = newP;
            
            if(oldName !== newName && app.priorities[oldName]) {
                app.priorities[newName] = app.priorities[oldName];
                delete app.priorities[oldName];
            }
        } else if(type === 'goal') {
            app.goals[index].name = newName;
            app.goals[index].target = parseFormatted(document.getElementById('editVal').value);
        } else if(type === 'shop') {
            app.shopping[index].name = newName;
            app.shopping[index].price = parseFormatted(document.getElementById('editVal').value);
        }

        saveData();
        renderUI();
        closeAllModals();
    }


    // --- TEMPLATE LOGIC ---
    function applyTemplate(type) {
        if(!confirm("آیا مطمئن هستید؟ بودجه‌بندی فعلی جایگزین می‌شود.")) return;
        saveSectionSnap('budget'); 
        
        let newBudgets = [];
        if(type === 'default') {
            newBudgets = JSON.parse(JSON.stringify(defaultState.budgets));
        } else if(type === 'student') {
            newBudgets = [
                {id: 1, name: "رفت‌وآمد", percent: 30, spent: 0, history: [], manualAdd: 0},
                {id: 2, name: "غذا (سلف/بیرون)", percent: 25, spent: 0, history: [], manualAdd: 0},
                {id: 3, name: "اینترنت و شارژ", percent: 15, spent: 0, history: [], manualAdd: 0},
                {id: 4, name: "کتاب و جزوه", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 5, name: "تفریح دوستانه", percent: 15, spent: 0, history: [], manualAdd: 0},
                {id: 6, name: "پس‌انداز اضطراری", percent: 5, spent: 0, history: [], manualAdd: 0}
            ];
        } else if(type === 'married') {
            newBudgets = [
                {id: 1, name: "اجاره خانه", percent: 35, spent: 0, history: [], manualAdd: 0},
                {id: 2, name: "خورد و خوراک منزل", percent: 25, spent: 0, history: [], manualAdd: 0},
                {id: 3, name: "قبوض و شارژ", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 4, name: "درمان و بهداشت", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 5, name: "پوشاک", percent: 5, spent: 0, history: [], manualAdd: 0},
                {id: 6, name: "پس‌انداز آینده", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 7, name: "تفریح", percent: 5, spent: 0, history: [], manualAdd: 0}
            ];
        } else if(type === 'clear') {
            newBudgets = [];
        }
        
        app.budgets = newBudgets;
        saveData();
        renderUI();
    }

    // --- ACTIONS ---
    function addWallet() {
        const n = document.getElementById('wName').value;
        const v = parseFormatted(document.getElementById('wVal').value);
        if(n && !isNaN(v)) { 
            saveSectionSnap('dashboard');
            app.wallets.push({name:n, value:v}); 
            saveData(); renderUI(); closeAllModals(); 
        }
    }
    function delWallet(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.wallets.splice(i,1); saveData(); renderUI(); } }

    function addDebt() {
        const n = document.getElementById('dName').value;
        const v = parseFormatted(document.getElementById('dVal').value);
        const d = document.getElementById('dDay').value;
        if(n && !isNaN(v)) { saveSectionSnap('dashboard'); app.debts.push({name:n, value:v, day:d}); saveData(); renderUI(); closeAllModals(); }
    }
    function delDebt(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.debts.splice(i,1); saveData(); renderUI(); } }

    function addCheck() {
        const n = document.getElementById('cName').value;
        const v = parseFormatted(document.getElementById('cVal').value);
        const d = getDateString('c');
        if(n && !isNaN(v)) { 
            saveSectionSnap('dashboard');
            if(!app.checks) app.checks = [];
            app.checks.push({name:n, value:v, date:d}); 
            saveData(); renderUI(); closeAllModals(); 
        }
    }
    function delCheck(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.checks.splice(i,1); saveData(); renderUI(); } }

    function addLoan() {
        const n = document.getElementById('lName').value;
        const v = parseFormatted(document.getElementById('lVal').value);
        const d = getDateString('l');
        if(n && !isNaN(v)) {
            saveSectionSnap('dashboard');
            if(!app.loans) app.loans = [];
            app.loans.push({name:n, value:v, date:d});
            saveData(); renderUI(); closeAllModals();
        }
    }
    function delLoan(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.loans.splice(i,1); saveData(); renderUI(); } }

    function addNewBudget() {
        const n = document.getElementById('bName').value;
        const p = parseInt(document.getElementById('bPercent').value);
        
        if(!n || isNaN(p)) return alert("لطفا مقادیر صحیح وارد کنید");

        let currentTotal = 0;
        app.budgets.forEach(b => currentTotal += b.percent);

        if (currentTotal + p > 100) {
            tempBudget = { name: n, percent: p, id: Date.now(), spent: 0, history: [], manualAdd: 0, isEdit: false };
            
            const max = 100 - currentTotal;
            const safeMax = max > 0 ? max : 0;
            
            document.getElementById('maxAllowedPercent').innerText = safeMax + '%';
            
            const slider = document.getElementById('percentSlider');
            slider.max = safeMax;
            slider.value = 0;
            document.getElementById('sliderValDisplay').innerText = 0;
            
            openModal('fixPercentModal');
        } else {
            saveSectionSnap('budget');
            app.budgets.push({id:Date.now(), name:n, percent:p, spent:0, history:[], manualAdd: 0});
            if (!app.priorities[n]) app.priorities[n] = 4;
            saveData(); renderUI(); closeAllModals();
        }
    }

    function updateSliderVal() {
        document.getElementById('sliderValDisplay').innerText = document.getElementById('percentSlider').value;
    }

    function useSliderPercent() {
        if(!tempBudget) return;
        saveSectionSnap('budget');
        
        const newP = parseInt(document.getElementById('percentSlider').value);
        
        if(tempBudget.isEdit) {
            app.budgets[tempBudget.editIndex].name = tempBudget.name;
            app.budgets[tempBudget.editIndex].percent = newP;
        } else {
            tempBudget.percent = newP;
            app.budgets.push(tempBudget);
            if (!app.priorities[tempBudget.name]) app.priorities[tempBudget.name] = 4;
        }
        
        saveData(); renderUI(); closeAllModals();
        tempBudget = null;
    }

    function autoCorrectBudget() {
        if(!tempBudget) return;
        saveSectionSnap('budget');
        
        let currentTotal = 0;
        app.budgets.forEach((b,i) => {
            if(tempBudget.isEdit && i === tempBudget.editIndex) return; 
            currentTotal += b.percent;
        });
        
        const needed = tempBudget.percent;
        const allowZero = document.getElementById('allowZeroCheck').checked;
        
        let overflow = (currentTotal + needed) - 100;
        
        if(overflow <= 0) {
            if(tempBudget.isEdit) {
                 app.budgets[tempBudget.editIndex].name = tempBudget.name;
                 app.budgets[tempBudget.editIndex].percent = needed;
            } else {
                app.budgets.push(tempBudget);
            }
            saveData(); renderUI(); closeAllModals();
            return;
        }

        let sortedItems = app.budgets.map((b, index) => {
            if(tempBudget.isEdit && index === tempBudget.editIndex) return null;
            return {
                index: index,
                priority: app.priorities[b.name] || 4, 
                percent: b.percent
            };
        }).filter(x => x !== null).sort((a, b) => b.priority - a.priority);

        for (let item of sortedItems) {
            if (overflow <= 0) break;
            
            let currentP = item.percent;
            let deductible = currentP;
            if(!allowZero && currentP > 0) {
                deductible = currentP - 1; 
            }
            
            if (deductible >= overflow) {
                app.budgets[item.index].percent -= overflow;
                overflow = 0;
            } else {
                app.budgets[item.index].percent -= deductible;
                overflow -= deductible;
            }
        }

        if(overflow > 0) {
            alert("امکان اصلاح خودکار کامل وجود ندارد. فضا کافی نیست.");
             const lastSnap = JSON.parse(app.sectionHistory['budget'][0].data);
             app.budgets = lastSnap.budgets;
             return;
        }

        if(tempBudget.isEdit) {
             app.budgets[tempBudget.editIndex].name = tempBudget.name;
             app.budgets[tempBudget.editIndex].percent = needed;
        } else {
            app.budgets.push(tempBudget);
            if (!app.priorities[tempBudget.name]) app.priorities[tempBudget.name] = 4;
        }

        saveData(); renderUI(); closeAllModals();
        tempBudget = null;
    }

    // --- PRIORITY SETTINGS (Instruction 2: Fixed Logic) ---
    function openPrioritySettings() {
        const list = document.getElementById('priorityList');
        
        if(!app.priorities) app.priorities = defaultState.priorities;
        if(!app.priorityRanges) app.priorityRanges = {low: 40, mid: 70};

        document.getElementById('pRangeLow').value = app.priorityRanges.low;
        document.getElementById('pRangeMid').value = app.priorityRanges.mid;

        // Clear previous list
        list.innerHTML = '';
        
        // Get Unique Names from current budgets + priorities list to handle deleted items still in priority map
        const allNames = new Set();
        app.budgets.forEach(b => allNames.add(b.name));
        
        // Use a clean HTML string builder instead of complex DOM manipulation loops that caused freezes
        let html = '';
        allNames.forEach(name => {
            let p = app.priorities[name] || 4;
            html += `
                <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:10px;">
                    <span>${name}</span>
                    <select class="priority-select" data-name="${name}" style="width:100px; margin:0; padding:5px;">
                        <option value="1" ${p==1?'selected':''}>۱ (خیلی مهم)</option>
                        <option value="2" ${p==2?'selected':''}>۲ (مهم)</option>
                        <option value="3" ${p==3?'selected':''}>۳ (متوسط)</option>
                        <option value="4" ${p==4?'selected':''}>۴ (کم)</option>
                    </select>
                </div>`;
        });
        
        list.innerHTML = html;
        openModal('prioritySettingsModal');
    }

    function savePriorityRanges() {
        const l = parseInt(document.getElementById('pRangeLow').value);
        const m = parseInt(document.getElementById('pRangeMid').value);
        if(!isNaN(l) && !isNaN(m)) {
            app.priorityRanges.low = l;
            app.priorityRanges.mid = m;
            alert("بازه ها ذخیره شدند");
            saveData();
        }
    }

    function savePriorities() {
        saveSectionSnap('budget');
        const selects = document.querySelectorAll('.priority-select');
        selects.forEach(sel => {
            app.priorities[sel.getAttribute('data-name')] = parseInt(sel.value);
        });
        saveData();
        closeAllModals();
        alert("اولویت‌ها ذخیره شدند.");
    }

    function delBudget(i) { if(confirm('حذف ردیف؟')) { saveSectionSnap('budget'); app.budgets.splice(i,1); saveData(); renderUI(); } }

    let activeIdx = -1;
    function openExp(i) { activeIdx = i; openModal('expModal'); }
    function submitExp() {
        const v = parseFormatted(document.getElementById('expAmt').value);
        const r = document.getElementById('expReason').value || 'بدون توضیح';
        if(!isNaN(v) && activeIdx > -1) { 
            saveSectionSnap('budget');
            app.budgets[activeIdx].spent += v;
            addToHistory(activeIdx, v, r);
            saveData(); renderUI(); closeAllModals(); 
        }
    }

    function addToHistory(bIdx, amount, reason) {
        if(!app.budgets[bIdx].history) app.budgets[bIdx].history = [];
        app.budgets[bIdx].history.push({
            amount: amount,
            reason: reason,
            date: new Date().toLocaleDateString('fa-IR'),
            time: new Date().toLocaleTimeString('fa-IR')
        });
    }

    function openItemHistory(i) {
        const hList = document.getElementById('itemHistList');
        const hist = app.budgets[i].history || [];
        if(hist.length === 0) {
            hList.innerHTML = '<p style="text-align:center;">موردی یافت نشد.</p>';
        } else {
            hList.innerHTML = hist.slice().reverse().map(h => `
                <div style="border-bottom:1px solid #eee; padding:8px 0;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${h.reason}</span>
                        <span style="color:var(--danger)">${format(h.amount)}</span>
                    </div>
                    <div style="font-size:0.75rem; color:var(--text-sec); margin-top:3px;">
                        ${h.date} - ${h.time}
                    </div>
                </div>
            `).join('');
        }
        openModal('itemHistModal');
    }

    function addGoal() {
        const n = document.getElementById('gName').value;
        const t = parseFormatted(document.getElementById('gTarget').value);
        if(n && !isNaN(t)) { saveSectionSnap('tools'); app.goals.push({name:n, target:t, curr:0}); saveData(); renderUI(); closeAllModals(); }
    }
    function addGoalMoneyDirect(i) {
        const v = prompt("مبلغ واریزی مستقیم:");
        if(v) { saveSectionSnap('tools'); app.goals[i].curr += parseInt(v); saveData(); renderUI(); }
    }
    function delGoal(i) { saveSectionSnap('tools'); app.goals.splice(i,1); saveData(); renderUI(); }

    function addShop() {
        const n = document.getElementById('sName').value;
        const p = parseFormatted(document.getElementById('sPrice').value);
        if(n) { saveSectionSnap('tools'); app.shopping.push({name:n, price: p || 0}); saveData(); renderUI(); closeAllModals(); }
    }
    function delShop(i) { saveSectionSnap('tools'); app.shopping.splice(i,1); saveData(); renderUI(); }

    function openAllocate(type, id) {
        document.getElementById('allocType').value = type;
        document.getElementById('allocId').value = id;
        
        const sel = document.getElementById('allocBudgetSelect');
        sel.innerHTML = app.budgets.map((b, i) => `<option value="${i}">${b.name}</option>`).join('');
        
        if(type === 'shop' && app.shopping[id].price) {
            document.getElementById('allocAmt').value = app.shopping[id].price.toLocaleString();
        } else {
            document.getElementById('allocAmt').value = '';
        }
        
        openModal('allocModal');
    }

    function performAllocation() {
        const type = document.getElementById('allocType').value;
        const id = parseInt(document.getElementById('allocId').value);
        const bIdx = parseInt(document.getElementById('allocBudgetSelect').value);
        const amt = parseFormatted(document.getElementById('allocAmt').value);

        if(isNaN(amt) || amt <= 0) return alert("مبلغ نامعتبر");

        saveSectionSnap('budget'); 
        saveSectionSnap('tools'); 

        app.budgets[bIdx].spent += amt;
        
        let reason = "";
        if(type === 'goal') {
            app.goals[id].curr += amt;
            reason = "اختصاص به هدف: " + app.goals[id].name;
        } else {
            reason = "خرید کالا: " + app.shopping[id].name;
        }

        addToHistory(bIdx, amt, reason);
        saveData();
        renderUI();
        closeAllModals();
        alert("تراکنش با موفقیت ثبت شد.");
    }

    // --- TOOLS ---
    function toggleCurrency() {
        app.user.currency = app.user.currency === 'toman' ? 'rial' : 'toman';
        saveData(); renderUI();
    }
    
    function toggleTheme() {
        if(document.body.getAttribute('data-theme') === 'dark') {
            document.body.removeAttribute('data-theme'); app.user.theme = 'light';
        } else {
            document.body.setAttribute('data-theme', 'dark'); app.user.theme = 'dark';
        }
        saveData();
    }
    function applyTheme() {
        if(app.user.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    // --- REPORT GENERATION (Instruction 1 - Full PDF) ---
    function generateReportImage() {
        // Keeps old functionality for backwards compatibility if needed, 
        // but downloadPDF is the main one now.
        downloadPDF();
    }

    async function downloadPDF() {
        const { jsPDF } = window.jspdf;
        const printArea = document.getElementById('printArea');
        
        // Prepare Data
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const totalDebt = getDebtTotal();
        const net = income - totalDebt - app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);

        document.getElementById('printDate').innerText = new Date().toLocaleDateString('fa-IR');
        document.getElementById('printUser').innerText = app.user.name;
        document.getElementById('printDuration').innerText = document.getElementById('daysCountDisplay').innerText.split('|')[0] || "---";
        document.getElementById('printInc').innerText = format(income);
        document.getElementById('printDebt').innerText = format(totalDebt);
        document.getElementById('printNet').innerText = format(net);

        // Populate Budget Table
        const tb = document.getElementById('printBody');
        tb.innerHTML = '';
        app.budgets.forEach(b => {
            const baseAmount = app.distributedAmount;
            const s = Math.round((baseAmount * b.percent) / 100) + (b.manualAdd || 0);
            tb.innerHTML += `<tr><td>${b.name}</td><td>${b.percent}%</td><td>${format(s)}</td><td>${format(b.spent)}</td><td>${format(s-b.spent)}</td></tr>`;
        });

        // Populate Debts
        const dList = document.getElementById('printDebtsList');
        let debtHtml = "";
        app.debts.forEach(d => debtHtml += `<div>${d.name}: ${format(d.value)}</div>`);
        app.checks.forEach(c => debtHtml += `<div>چک (${c.name}): ${format(c.value)} - ${c.date}</div>`);
        dList.innerHTML = debtHtml || "ندارد";

        // Populate History Table
        const thb = document.getElementById('printHistoryBody');
        thb.innerHTML = '';
        app.dailyLogs.slice().reverse().forEach(l => {
            thb.innerHTML += `<tr><td>${l.date}</td><td>${format(l.income)}</td><td>${format(l.spent)}</td></tr>`;
        });

        // Draw Chart on PDF Canvas
        const pCtx = document.getElementById('printChart').getContext('2d');
        // Destroy old if exists or it will glitch
        if(window.printChartInstance) window.printChartInstance.destroy();

        const labels = app.dailyLogs.map(l => l.date);
        const dInc = app.dailyLogs.map(l => l.income * rate);
        window.printChartInstance = new Chart(pCtx, {
            type: 'line',
            data: { labels: labels, datasets: [{ label: 'روند دارایی', data: dInc, borderColor: '#4338ca', borderWidth: 2 }] },
            options: { animation: false, responsive: true, maintainAspectRatio: false }
        });

        // Wait for chart render
        await new Promise(r => setTimeout(r, 500));

        // Use html2canvas
        const canvas = await html2canvas(printArea, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        
        const pdf = new jsPDF('p', 'mm', 'a4');
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`Financial_Report_${new Date().toLocaleDateString('fa-IR').replace(/\//g,'-')}.pdf`);
    }

    function downloadBackup() {
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
        const a = document.createElement('a');
        a.href = str; a.download = "backup.json"; a.click();
        
        app.history.unshift({date: Date.now(), name: "بکاپ دستی"});
        if(app.history.length > 5) app.history.pop();
        saveData();
    }

    function restoreBackup(input) {
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                app = JSON.parse(e.target.result);
                
                // Compatibility Checks
                if(!app.priorities) app.priorities = defaultState.priorities;
                if(!app.dailyLogs) app.dailyLogs = [];
                if(!app.security.questionIndex) app.security.questionIndex = 0;
                if(!app.startDate) app.startDate = new Date().toLocaleDateString('fa-IR');
                
                app.budgets.forEach(b => { 
                    if(!b.history) b.history = [];
                    if(b.manualAdd === undefined) b.manualAdd = 0;
                    if(b.isPaused === undefined) b.isPaused = false;
                    if(b.savedPercent === undefined) b.savedPercent = 0;
                });
                
                saveData();
                location.reload();
            } catch(err) { alert("فایل نامعتبر"); }
        };
        reader.readAsText(file);
    }

    function showHistory() {
        const d = document.getElementById('histList');
        d.innerHTML = app.history.map(h => 
            `<div style="padding:5px; border-bottom:1px solid #eee;">${h.name} - ${new Date(h.date).toLocaleDateString('fa-IR')}</div>`
        ).join('');
        openModal('histModal');
    }

    function resetAll() {
        if(confirm("همه چیز پاک شود؟")) { localStorage.removeItem('amir_fin_v9'); location.reload(); }
    }

    // --- HELPERS ---
    function getDebtTotal() { 
        return (app.debts.reduce((a,b)=>a+b.value,0)) + ((app.checks||[]).reduce((a,b)=>a+b.value,0)); 
    }
    
    function copyTxt(n) {
        const raw = document.getElementById('rawCopyCheck').checked;
        const txt = raw ? (n*rate).toString() : format(n);
        navigator.clipboard.writeText(txt);
        alert("کپی شد: " + txt);
    }
    
    function loadData() {
        const d = localStorage.getItem('amir_fin_v9');
        if(d) {
            app = JSON.parse(d);
            
            // Backward Compatibility - Ensure new fields exist
            if(!app.checks) app.checks = [];
            if(!app.loans) app.loans = [];
            if(!app.priorities) app.priorities = defaultState.priorities;
            if(!app.sectionHistory) app.sectionHistory = { dashboard: [], budget: [], tools: [] };
            if(!app.priorityRanges) app.priorityRanges = { low: 40, mid: 70 };
            if(app.distributedAmount === undefined) app.distributedAmount = 0;
            
            // Security Upgrade
            if(app.security.isSetup === undefined) app.security.isSetup = app.security.hasPin;
            if(app.security.questionIndex === undefined) {
                app.security.questionIndex = 0;
                app.security.answer = ""; 
                app.security.isSetup = false; // Force re-setup for security question
            }

            // Daily Log Upgrade
            if(!app.dailyLogs) app.dailyLogs = [];
            if(!app.startDate) app.startDate = new Date().toLocaleDateString('fa-IR');

            app.budgets.forEach(b => { 
                if(!b.history) b.history = []; 
                if(b.manualAdd === undefined) b.manualAdd = 0;
                if(b.isPaused === undefined) b.isPaused = false;
                if(b.savedPercent === undefined) b.savedPercent = 0;
            });
        }
    }
    function saveData() {
        localStorage.setItem('amir_fin_v9', JSON.stringify(app));
    }
    function updateDate() {
        document.getElementById('headerDate').innerText = new Date().toLocaleDateString('fa-IR');
    }

    function switchTab(id) {
        document.querySelectorAll('.tab-pane').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(b => {
            if(b.getAttribute('onclick').includes(id)) b.classList.add('active');
        });
    }
    function openModal(id) { 
        if(id === 'prioritySettingsModal') {
            openPrioritySettings(); 
        }
        
        const m = document.getElementById(id);
        const inputs = m.querySelectorAll('input');
        inputs.forEach(i => {
            // Keep specialized inputs intact
            if(i.type !== 'hidden' && i.type !== 'checkbox' && i.type !== 'range' && 
               i.id !== 'pRangeLow' && i.id !== 'pRangeMid') i.value = '';
        });
        m.classList.add('active'); 
    }
    function closeAllModals() { document.querySelectorAll('.modal').forEach(e => e.classList.remove('active')); }

</script>

</body>
</html>
```
