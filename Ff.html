   <!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ† | V8 Luxury</title>
    
    <!-- ÙÙˆÙ†Øªâ€ŒÙ‡Ø§ -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Ø®Ø±ÙˆØ¬ÛŒ Ø¹Ú©Ø³ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            /* Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ø±ÙˆØ² (Day Luxury) */
            --bg-body: #eef2f6;
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.5);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --text-main: #1e293b;
            --text-sec: #64748b;
            --primary: #4f46e5; /* Indigo */
            --primary-grad: linear-gradient(135deg, #4f46e5 0%, #818cf8 100%);
            --accent: #f59e0b; /* Gold/Amber */
            --success: #10b981;
            --danger: #ef4444;
            --card-radius: 24px;
            --nav-height: 80px;
        }

        [data-theme="dark"] {
            /* Ù¾Ø§Ù„Øª Ø±Ù†Ú¯ÛŒ Ø´Ø¨ (Dark Luxury) */
            --bg-body: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --primary: #6366f1;
            --primary-grad: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0 0 var(--nav-height) 0; /* ÙØ¶Ø§ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø± Ù¾Ø§ÛŒÛŒÙ† */
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- GLASSMORPHISM UTILS --- */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--glass-shadow);
        }

        .container {
            max-width: 600px; /* Ø·Ø±Ø§Ø­ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù…Ø­ÙˆØ± */
            margin: 0 auto;
            padding: 20px;
        }

        /* --- VIRTUAL CREDIT CARD (HERO) --- */
        .card-container {
            perspective: 1000px;
            margin-bottom: 25px;
            height: 220px;
            cursor: pointer;
        }

        .credit-card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s;
            border-radius: 24px;
            box-shadow: 0 20px 40px -10px rgba(79, 70, 229, 0.5);
        }

        .credit-card.flipped {
            transform: rotateY(180deg);
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            padding: 25px;
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            overflow: hidden;
        }

        .card-front {
            background: var(--primary-grad);
        }

        .card-front::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 60%);
            opacity: 0.5;
        }

        .card-chip {
            width: 50px;
            height: 35px;
            background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);
            border-radius: 8px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .balance-label { font-size: 0.9rem; opacity: 0.8; }
        .balance-amount { font-size: 2rem; font-weight: 900; letter-spacing: 1px; margin: 5px 0; }
        .card-info { display: flex; justify-content: space-between; font-size: 0.9rem; opacity: 0.9; }

        .card-back {
            background: #1e293b; /* Dark Slate */
            transform: rotateY(180deg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .debt-summary { text-align: center; }
        .debt-amount { color: var(--danger); font-size: 1.8rem; font-weight: bold; }

        /* --- BENTO GRID LAYOUT --- */
        .section-title {
            font-size: 1.2rem;
            font-weight: 800;
            margin: 20px 0 15px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bento-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
        }

        .budget-card {
            padding: 15px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 160px;
            position: relative;
            overflow: hidden;
            transition: transform 0.2s;
        }
        .budget-card:active { transform: scale(0.98); }

        .budget-icon {
            width: 40px; height: 40px;
            border-radius: 12px;
            background: rgba(79, 70, 229, 0.1);
            color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .budget-name { font-weight: bold; font-size: 1rem; color: var(--text-main); }
        .budget-percent { font-size: 0.8rem; color: var(--text-sec); margin-bottom: auto; }
        
        .progress-wrapper { margin-top: 10px; }
        .progress-bg { height: 6px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; }
        
        .budget-remain { font-size: 0.9rem; font-weight: 800; margin-top: 5px; text-align: right; }

        /* Status Colors */
        .status-green .progress-fill { background: var(--success); }
        .status-green .budget-remain { color: var(--success); }
        .status-yellow .progress-fill { background: var(--warning); }
        .status-yellow .budget-remain { color: var(--warning); }
        .status-red .progress-fill { background: var(--danger); }
        .status-red .budget-remain { color: var(--danger); }
        .status-red { border: 1px solid var(--danger); animation: pulse-red 2s infinite; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: var(--nav-height);
            background: var(--bg-card);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 1000;
            padding-bottom: 15px; /* Ø¨Ø±Ø§ÛŒ Ø¢ÛŒÙÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ */
            backdrop-filter: blur(20px);
            background: rgba(255,255,255,0.9);
        }
        [data-theme="dark"] .bottom-nav { background: rgba(30,41,59,0.9); }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: var(--text-sec);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            width: 60px;
        }

        .nav-item i { font-size: 1.4rem; transition: transform 0.2s; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.active i { transform: translateY(-5px); }

        /* --- FLOATING ACTION BUTTON (FAB) --- */
        .fab-container {
            position: fixed;
            bottom: 90px; /* Above nav bar */
            left: 20px; /* ØªØºÛŒÛŒØ± Ø¨Ù‡ Ú†Ù¾ Ø¨Ø±Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ */
            z-index: 1100;
        }

        .fab-main {
            width: 60px; height: 60px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 10px 20px rgba(245, 158, 11, 0.4);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s;
        }
        .fab-main.open { transform: rotate(45deg); }

        .fab-menu {
            position: absolute;
            bottom: 70px;
            left: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s;
        }
        .fab-container.active .fab-menu { pointer-events: auto; opacity: 1; transform: translateY(0); }

        .fab-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .fab-btn {
            width: 50px; height: 50px;
            border-radius: 50%;
            border: none;
            color: white;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            cursor: pointer;
        }
        .fab-label {
            background: var(--text-main);
            color: var(--bg-card);
            padding: 5px 10px;
            border-radius: 8px;
            font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- TABS CONTENT --- */
        .tab-content { display: none; padding-bottom: 100px; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- MODALS & BOTTOM SHEETS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; justify-content: center; align-items: flex-end; }

        .bottom-sheet {
            background: var(--bg-card);
            width: 100%;
            max-width: 600px;
            border-top-left-radius: 24px;
            border-top-right-radius: 24px;
            padding: 25px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s;
            max-height: 85vh;
            overflow-y: auto;
        }

        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .sheet-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .sheet-header h3 { margin: 0; color: var(--primary); }

        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.9rem; color: var(--text-sec); }
        .form-input {
            width: 100%; padding: 12px 15px;
            border-radius: 12px; border: 1px solid var(--border);
            background: var(--bg-body); color: var(--text-main);
            font-size: 1rem;
        }
        .form-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* Buttons */
        .btn-primary {
            background: var(--primary); color: white; width: 100%;
            padding: 14px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.3);
        }
        .btn-outline {
            background: transparent; border: 1px solid var(--border);
            color: var(--text-main); width: 100%; padding: 12px;
            border-radius: 12px; font-weight: bold; cursor: pointer;
        }

        /* --- LISTS (Wallets, Goals) --- */
        .list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-bottom: 1px solid var(--border);
        }
        .list-item:last-child { border-bottom: none; }

        /* --- PIN LOCK --- */
        .pin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .pin-dots { display: flex; gap: 15px; margin: 30px 0; }
        .pin-dot { width: 15px; height: 15px; border-radius: 50%; border: 2px solid var(--primary); transition: 0.2s; }
        .pin-dot.filled { background: var(--primary); }
        .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .num-btn {
            width: 70px; height: 70px; border-radius: 50%;
            border: 1px solid var(--border); background: var(--bg-card);
            font-size: 1.5rem; color: var(--text-main); cursor: pointer;
        }

        /* --- UTILS --- */
        .text-sm { font-size: 0.85rem; opacity: 0.7; }
        .amount { font-family: 'Vazirmatn', sans-serif; letter-spacing: 0.5px; }
        .d-flex-between { display: flex; justify-content: space-between; align-items: center; }

    </style>
</head>
<body>

<!-- 1. PIN LOCK SCREEN -->
<div id="pinLock" class="pin-screen">
    <i class="fas fa-fingerprint" style="font-size: 4rem; color: var(--primary);"></i>
    <h2 style="margin-top:20px;">Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª</h2>
    <div class="pin-dots">
        <div class="pin-dot" id="dot1"></div>
        <div class="pin-dot" id="dot2"></div>
        <div class="pin-dot" id="dot3"></div>
        <div class="pin-dot" id="dot4"></div>
    </div>
    <div class="numpad">
        <button class="num-btn" onclick="enterPin(1)">1</button>
        <button class="num-btn" onclick="enterPin(2)">2</button>
        <button class="num-btn" onclick="enterPin(3)">3</button>
        <button class="num-btn" onclick="enterPin(4)">4</button>
        <button class="num-btn" onclick="enterPin(5)">5</button>
        <button class="num-btn" onclick="enterPin(6)">6</button>
        <button class="num-btn" onclick="enterPin(7)">7</button>
        <button class="num-btn" onclick="enterPin(8)">8</button>
        <button class="num-btn" onclick="enterPin(9)">9</button>
        <button class="num-btn" style="visibility:hidden"></button>
        <button class="num-btn" onclick="enterPin(0)">0</button>
        <button class="num-btn" onclick="clearPin()" style="color:var(--danger)"><i class="fas fa-backspace"></i></button>
    </div>
</div>

<!-- 2. MAIN APP CONTAINER -->
<div class="container" id="mainContainer" style="display:none;">

    <!-- TAB 1: DASHBOARD -->
    <div id="tab-home" class="tab-content active">
        <!-- Header -->
        <div class="section-title">
            <span>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ</span>
            <span class="text-sm" id="currentDate">1404/--/--</span>
        </div>

        <!-- Virtual Card (Hero) -->
        <div class="card-container" onclick="flipCard()">
            <div class="credit-card" id="creditCard">
                <!-- Front -->
                <div class="card-face card-front">
                    <div class="d-flex-between">
                        <div class="card-chip"></div>
                        <i class="fas fa-wifi" style="font-size:1.5rem;"></i>
                    </div>
                    <div>
                        <span class="balance-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©Ù„ (Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒÙ…)</span>
                        <div class="balance-amount"><span id="heroBalance">0</span> <small style="font-size:1rem">ØªÙˆÙ…Ø§Ù†</small></div>
                    </div>
                    <div class="card-info">
                        <span id="userNameDisplay">Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ†</span>
                        <span>V8 Luxury</span>
                    </div>
                </div>
                <!-- Back -->
                <div class="card-face card-back">
                    <div class="debt-summary">
                        <span>Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ø¯Ù‡ÛŒ Ùˆ Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡</span>
                        <div class="debt-amount" id="heroDebt">0</div>
                        <p class="text-sm" style="margin-top:10px; color:#cbd5e1;">Ø§ÛŒÙ† Ù…Ø¨Ù„Øº Ø§Ø² ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§ Ú©Ø³Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wallets Summary -->
        <div class="glass" style="padding: 15px; margin-bottom: 20px;">
            <div class="d-flex-between">
                <span><i class="fas fa-wallet" style="color:var(--primary)"></i> Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§</span>
                <button class="btn-outline" style="width:auto; padding:5px 10px; font-size:0.8rem;" onclick="openWalletModal()">Ù…Ø¯ÛŒØ±ÛŒØª</button>
            </div>
            <div id="walletSummary" style="margin-top:10px; display:flex; gap:10px; overflow-x:auto; padding-bottom:5px;">
                <!-- Wallet chips injected here -->
            </div>
        </div>

        <!-- Chart -->
        <div class="glass" style="padding: 15px;">
            <h4 style="margin:0 0 15px 0;">ØªØ­Ù„ÛŒÙ„ Ù‡Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§</h4>
            <div style="height: 200px;">
                <canvas id="dashboardChart"></canvas>
            </div>
        </div>
    </div>

    <!-- TAB 2: BUDGET (BENTO GRID) -->
    <div id="tab-budget" class="tab-content">
        <div class="section-title">
            <span>Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</span>
            <button class="btn-outline" style="width:auto; padding:5px 10px;" onclick="openScenarioModal()">Ø³Ù†Ø§Ø±ÛŒÙˆ</button>
        </div>

        <div id="budgetGrid" class="bento-grid">
            <!-- Budget Cards Injected Here -->
        </div>
        
        <div style="height: 100px;"></div> <!-- Space for scrolling -->
    </div>

    <!-- TAB 3: TOOLS -->
    <div id="tab-tools" class="tab-content">
        <div class="section-title">Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§</div>

        <!-- Savings Goals -->
        <div class="glass" style="padding: 20px; margin-bottom: 20px;">
            <div class="d-flex-between">
                <h3>ğŸ¯ Ø§Ù‡Ø¯Ø§Ù Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</h3>
                <button class="btn-outline" style="width:auto; padding:5px 10px;" onclick="addGoal()">+</button>
            </div>
            <div id="goalsList"></div>
        </div>

        <!-- Shopping List -->
        <div class="glass" style="padding: 20px; margin-bottom: 20px;">
            <div class="d-flex-between">
                <h3>ğŸ›’ Ù„ÛŒØ³Øª Ø®Ø±ÛŒØ¯ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                <button class="btn-outline" style="width:auto; padding:5px 10px;" onclick="openShopModal()">+</button>
            </div>
            <div id="shoppingList"></div>
        </div>

        <!-- Lending -->
        <div class="glass" style="padding: 20px;">
            <div class="d-flex-between">
                <h3>ğŸ¤ Ø¯ÙØªØ±Ú†Ù‡ Ù‚Ø±Ø¶ Ùˆ Ø·Ù„Ø¨</h3>
                <button class="btn-outline" style="width:auto; padding:5px 10px;" onclick="addLending()">+</button>
            </div>
            <div id="lendingList"></div>
        </div>
    </div>

    <!-- TAB 4: SETTINGS -->
    <div id="tab-settings" class="tab-content">
        <div class="section-title">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</div>
        
        <div class="glass" style="padding: 20px; display:flex; flex-direction:column; gap:15px;">
            <button class="list-item" onclick="toggleTheme()">
                <span><i class="fas fa-moon"></i> Ø­Ø§Ù„Øª Ø´Ø¨ / Ø±ÙˆØ²</span>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="list-item" onclick="exportDataXLSX()">
                <span><i class="fas fa-file-excel"></i> Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</span>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="list-item" onclick="exportImage()">
                <span><i class="fas fa-camera"></i> Ø®Ø±ÙˆØ¬ÛŒ ØªØµÙˆÛŒØ±ÛŒ</span>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="list-item" onclick="changePin()">
                <span><i class="fas fa-lock"></i> ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</span>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="list-item" onclick="closeMonth()">
                <span style="color:var(--warning)"><i class="fas fa-calendar-check"></i> Ø¨Ø³ØªÙ† Ø­Ø³Ø§Ø¨ Ù…Ø§Ù‡ (Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø§Ù†Ø¯Ù‡)</span>
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="list-item" onclick="resetApp()">
                <span style="color:var(--danger)"><i class="fas fa-trash"></i> Ø±ÛŒØ³Øª Ú©Ù„ÛŒ</span>
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </div>

</div>

<!-- BOTTOM NAVIGATION -->
<nav class="bottom-nav">
    <button class="nav-item active" onclick="navTo('home')">
        <i class="fas fa-home"></i>
        <span>Ø®Ø§Ù†Ù‡</span>
    </button>
    <button class="nav-item" onclick="navTo('budget')">
        <i class="fas fa-chart-pie"></i>
        <span>Ø¨ÙˆØ¯Ø¬Ù‡</span>
    </button>
    <button class="nav-item" onclick="navTo('tools')">
        <i class="fas fa-tools"></i>
        <span>Ø§Ø¨Ø²Ø§Ø±</span>
    </button>
    <button class="nav-item" onclick="navTo('settings')">
        <i class="fas fa-cog"></i>
        <span>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</span>
    </button>
</nav>

<!-- FAB (Floating Action Button) -->
<div class="fab-container" id="fabContainer">
    <div class="fab-menu">
        <div class="fab-item">
            <span class="fab-label">ÙˆØ±ÙˆØ¯ÛŒ Ù¾ÙˆÙ„</span>
            <button class="fab-btn" style="background:#10b981;" onclick="openWalletModal()"><i class="fas fa-plus"></i></button>
        </div>
        <div class="fab-item">
            <span class="fab-label">Ø«Ø¨Øª Ù‚Ø³Ø·</span>
            <button class="fab-btn" style="background:#ef4444;" onclick="addDebt()"><i class="fas fa-file-invoice-dollar"></i></button>
        </div>
    </div>
    <button class="fab-main" onclick="toggleFab()"><i class="fas fa-plus"></i></button>
</div>

<!-- MODAL: EXPENSE DETAIL (BOTTOM SHEET) -->
<div id="detailModal" class="modal-overlay">
    <div class="bottom-sheet">
        <div class="sheet-header">
            <h3 id="detailTitle">Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÙˆØ¯Ø¬Ù‡</h3>
            <button class="btn-outline" style="width:auto; border:none;" onclick="closeModal('detailModal')">&times;</button>
        </div>
        
        <input type="hidden" id="activeBudgetId">
        
        <div class="glass" style="padding:15px; margin-bottom:20px; text-align:center;">
            <span class="text-sm">Ù…Ø§Ù†Ø¯Ù‡ ÙØ¹Ù„ÛŒ</span>
            <div id="detailRemain" style="font-size:1.8rem; font-weight:900; color:var(--primary);">0</div>
        </div>

        <div class="form-group">
            <label class="form-label">Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯:</label>
            <input type="text" id="expAmount" class="form-input" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" inputmode="numeric" onkeyup="formatInput(this)">
        </div>
        <div class="form-group">
            <input type="text" id="expReason" class="form-input" placeholder="Ø¨Ø§Ø¨Øª (ØªÙˆØ¶ÛŒØ­)">
        </div>
        <div class="form-group d-flex-between">
            <label style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="expNeed"> Ø¶Ø±ÙˆØ±ÛŒ Ø¨ÙˆØ¯ØŸ (Need)
            </label>
        </div>
        
        <button class="btn-primary" onclick="submitExpense()">Ø«Ø¨Øª ØªØ±Ø§Ú©Ù†Ø´</button>

        <div style="margin-top:20px;">
            <label class="form-label">ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø®ÛŒØ±:</label>
            <div id="txList" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        
        <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;">
             <label class="form-label">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¨ÙˆØ¯Ø¬Ù‡:</label>
             <div class="d-flex-between" style="gap:10px;">
                 <input type="text" id="editBudgetName" class="form-input" placeholder="Ù†Ø§Ù…">
                 <input type="number" id="editBudgetPercent" class="form-input" placeholder="Ø¯Ø±ØµØ¯" style="width:80px;">
                 <button class="btn-outline" style="width:auto;" onclick="saveBudgetEdit()">Ø°Ø®ÛŒØ±Ù‡</button>
             </div>
        </div>
    </div>
</div>

<!-- MODAL: WALLET MANAGE -->
<div id="walletModal" class="modal-overlay">
    <div class="bottom-sheet">
        <div class="sheet-header">
            <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§</h3>
            <button class="btn-outline" style="width:auto; border:none;" onclick="closeModal('walletModal')">&times;</button>
        </div>
        <div id="walletModalList"></div>
        <button class="btn-primary" style="margin-top:15px;" onclick="addNewWalletRow()">+ Ú©ÛŒÙ Ø¬Ø¯ÛŒØ¯</button>
    </div>
</div>

<!-- SCRIPT -->
<script>
    // --- Data Model ---
    const defaultData = {
        settings: { pin: "1234", theme: "light", name: "Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ†" },
        wallets: [
            { id: 1, name: "Ú©Ø§Ø±Øª Ù…Ù„ÛŒ", value: 0 },
            { id: 2, name: "Ù†Ù‚Ø¯", value: 0 }
        ],
        debts: [
            { id: 1, name: "Ù‚Ø³Ø· ÙˆØ§Ù…", value: 0 }
        ],
        budgetItems: [
            { id: 1, name: "Ú©Ø±Ø§ÛŒÙ‡ Ø´Ù‡Ø±ÛŒ", percent: 27, spent: 0, rollover: 0, transactions: [] },
            { id: 2, name: "Ø®ÙˆØ±Ø¯ Ùˆ Ø®ÙˆØ±Ø§Ú©", percent: 12, spent: 0, rollover: 0, transactions: [] },
            { id: 3, name: "Ø³ÙØ± (Ù…Ø´Ù‡Ø¯)", percent: 25, spent: 0, rollover: 0, transactions: [] },
            { id: 4, name: "Ø¯ÙˆØ§ Ùˆ Ø¯Ø±Ù…Ø§Ù†", percent: 3, spent: 0, rollover: 0, transactions: [] },
            { id: 5, name: "Ø´Ø§Ø±Ú˜ Ùˆ Ù†Øª", percent: 10, spent: 0, rollover: 0, transactions: [] },
            { id: 6, name: "Ø²ÛŒØ¨Ø§ÛŒÛŒ Ùˆ Ù…Ú©Ù…Ù„", percent: 7, spent: 0, rollover: 0, transactions: [] },
            { id: 7, name: "Ù„Ø¨Ø§Ø³", percent: 5, spent: 0, rollover: 0, transactions: [] },
            { id: 8, name: "Ø¶Ø±ÙˆØ±ÛŒ", percent: 5, spent: 0, rollover: 0, transactions: [] },
            { id: 9, name: "ØªÙØ±ÛŒØ­", percent: 3, spent: 0, rollover: 0, transactions: [] },
            { id: 10, name: "Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²", percent: 3, spent: 0, rollover: 0, transactions: [] }
        ],
        goals: [],
        shopping: [],
        lending: []
    };

    let app = JSON.parse(JSON.stringify(defaultData));
    let pinBuffer = "";
    let chartInstance = null;

    // --- Init ---
    window.onload = function() {
        const saved = localStorage.getItem('amir_fin_v8');
        if(saved) app = JSON.parse(saved);
        
        applyTheme();
        updateDate();
        renderAll();
    };

    // --- PIN System ---
    function enterPin(num) {
        if(pinBuffer.length < 4) {
            pinBuffer += num;
            updatePinDots();
        }
        if(pinBuffer.length === 4) {
            setTimeout(validatePin, 300);
        }
    }

    function clearPin() {
        pinBuffer = "";
        updatePinDots();
    }

    function updatePinDots() {
        for(let i=1; i<=4; i++) {
            document.getElementById(`dot${i}`).className = i <= pinBuffer.length ? 'pin-dot filled' : 'pin-dot';
        }
    }

    function validatePin() {
        if(pinBuffer === app.settings.pin) {
            document.getElementById('pinLock').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
        } else {
            alert("Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!");
            clearPin();
        }
    }

    // --- Logic & Calculations ---
    function getTotalIncome() { return app.wallets.reduce((a,b) => a + b.value, 0); }
    function getTotalDebt() { return app.debts.reduce((a,b) => a + b.value, 0); }
    function getDistributable() { return getTotalIncome() - getTotalDebt(); }

    function renderAll() {
        document.getElementById('heroBalance').innerText = formatNum(getDistributable());
        document.getElementById('heroDebt').innerText = formatNum(getTotalDebt());
        document.getElementById('userNameDisplay').innerText = app.settings.name;
        
        renderWalletsSummary();
        renderBudgetGrid();
        renderGoals();
        renderShopping();
        renderLending();
        updateChart();
    }

    function save() {
        localStorage.setItem('amir_fin_v8', JSON.stringify(app));
        renderAll();
    }

    // --- Components Render ---
    function renderWalletsSummary() {
        const container = document.getElementById('walletSummary');
        container.innerHTML = app.wallets.map(w => 
            `<div class="tag-badge" style="font-size:0.9rem; padding:8px 15px; white-space:nowrap;">
                ${w.name}: <b>${formatNum(w.value)}</b>
            </div>`
        ).join('');
    }

    function renderBudgetGrid() {
        const container = document.getElementById('budgetGrid');
        container.innerHTML = '';
        const baseMoney = getDistributable();

        app.budgetItems.forEach((item, index) => {
            const budget = Math.round((baseMoney * item.percent) / 100) + item.rollover;
            const remaining = budget - item.spent;
            const percentUsed = budget > 0 ? (item.spent / budget) * 100 : 0;
            
            // ØªØ¹ÛŒÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ø±Ù†Ú¯ÛŒ (Ø³Ø¨Ø²ØŒ Ø²Ø±Ø¯ØŒ Ù‚Ø±Ù…Ø²)
            let statusClass = "status-green";
            if(percentUsed > 50) statusClass = "status-yellow";
            if(percentUsed > 90) statusClass = "status-red";

            container.innerHTML += `
                <div class="budget-card ${statusClass}" onclick="openDetail(${index})">
                    <div class="d-flex-between">
                        <div class="budget-icon"><i class="fas fa-wallet"></i></div>
                        <span class="budget-percent">${item.percent}%</span>
                    </div>
                    <div class="budget-name">${item.name}</div>
                    
                    <div class="progress-wrapper">
                        <div class="progress-bg">
                            <div class="progress-fill" style="width: ${Math.min(percentUsed, 100)}%"></div>
                        </div>
                        <div class="budget-remain">${formatNum(remaining)}</div>
                    </div>
                </div>
            `;
        });
    }

    // --- Detail Modal (Bottom Sheet) ---
    let currentBudgetIndex = -1;

    function openDetail(index) {
        currentBudgetIndex = index;
        const item = app.budgetItems[index];
        const baseMoney = getDistributable();
        const budget = Math.round((baseMoney * item.percent) / 100) + item.rollover;
        const remaining = budget - item.spent;

        document.getElementById('detailTitle').innerText = item.name;
        document.getElementById('detailRemain').innerText = formatNum(remaining);
        
        // Fill Edit inputs
        document.getElementById('editBudgetName').value = item.name;
        document.getElementById('editBudgetPercent').value = item.percent;

        // Render Transactions
        const txList = document.getElementById('txList');
        txList.innerHTML = item.transactions.map(t => `
            <div class="list-item">
                <div>
                    <div style="font-weight:bold">${t.reason}</div>
                    <div class="text-sm">${new Date(t.date).toLocaleDateString('fa-IR')}</div>
                </div>
                <div style="color:var(--danger)">-${formatNum(t.amount)}</div>
            </div>
        `).join('');

        document.getElementById('detailModal').classList.add('active');
    }

    function submitExpense() {
        const amtRaw = document.getElementById('expAmount').value;
        const amt = parseInt(toEnglish(amtRaw).replace(/,/g, '')) || 0;
        const reason = document.getElementById('expReason').value;
        const isNeed = document.getElementById('expNeed').checked;

        if(amt > 0) {
            const item = app.budgetItems[currentBudgetIndex];
            item.spent += amt;
            item.transactions.unshift({
                amount: amt,
                reason: reason || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
                date: new Date().toISOString(),
                isNeed: isNeed
            });
            
            document.getElementById('expAmount').value = '';
            document.getElementById('expReason').value = '';
            save();
            openDetail(currentBudgetIndex); // Refresh modal
        }
    }

    function saveBudgetEdit() {
        const name = document.getElementById('editBudgetName').value;
        const percent = parseFloat(document.getElementById('editBudgetPercent').value) || 0;
        
        app.budgetItems[currentBudgetIndex].name = name;
        app.budgetItems[currentBudgetIndex].percent = percent;
        save();
        closeModal('detailModal');
    }

    // --- Wallet Management ---
    function openWalletModal() {
        const list = document.getElementById('walletModalList');
        list.innerHTML = '';
        
        app.wallets.forEach((w, i) => {
            list.innerHTML += `
                <div class="form-group d-flex-between">
                    <input type="text" value="${w.name}" class="form-input" style="width:40%" onchange="updWallet(${i}, 'name', this.value)">
                    <input type="text" value="${formatNum(w.value)}" class="form-input" style="width:40%" onkeyup="formatInput(this)" onchange="updWallet(${i}, 'value', this.value)">
                    <i class="fas fa-trash text-sm" style="color:var(--danger)" onclick="delWallet(${i})"></i>
                </div>
            `;
        });
        document.getElementById('walletModal').classList.add('active');
    }

    function updWallet(i, key, val) {
        if(key === 'value') app.wallets[i].value = parseInt(toEnglish(val).replace(/,/g,'')) || 0;
        else app.wallets[i].name = val;
        save();
    }
    
    function addNewWalletRow() {
        app.wallets.push({id: Date.now(), name: 'Ø¬Ø¯ÛŒØ¯', value: 0});
        save(); openWalletModal();
    }
    function delWallet(i) {
        if(confirm('Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) { app.wallets.splice(i, 1); save(); openWalletModal(); }
    }

    // --- Debts (Quick Add via FAB) ---
    function addDebt() {
        const name = prompt("Ø¹Ù†ÙˆØ§Ù† Ù‚Ø³Ø·/Ø¨Ø¯Ù‡ÛŒ:");
        const val = prompt("Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†):");
        if(name && val) {
            app.debts.push({ id: Date.now(), name: name, value: parseInt(val) || 0 });
            save();
        }
    }

    // --- Goals & Tools ---
    function renderGoals() {
        const div = document.getElementById('goalsList');
        div.innerHTML = app.goals.map((g, i) => {
            const p = Math.min(100, Math.round((g.current / g.target) * 100));
            return `
                <div class="glass" style="padding:10px; margin-bottom:10px;">
                    <div class="d-flex-between">
                        <strong>${g.name}</strong>
                        <span class="text-sm">${formatNum(g.current)} / ${formatNum(g.target)}</span>
                    </div>
                    <div class="progress-bg" style="margin-top:5px;"><div class="progress-fill" style="width:${p}%; background:var(--accent)"></div></div>
                    <div style="margin-top:8px; text-align:left;">
                        <button class="btn-outline" style="width:auto; padding:4px 8px; font-size:0.8rem;" onclick="goalDeposit(${i})">+ ÙˆØ§Ø±ÛŒØ²</button>
                        <button class="btn-outline" style="width:auto; padding:4px 8px; font-size:0.8rem; color:var(--danger); border-color:var(--danger);" onclick="delGoal(${i})">Ã—</button>
                    </div>
                </div>
            `;
        }).join('');
    }
    function addGoal() {
        const n = prompt("Ù†Ø§Ù… Ù‡Ø¯Ù:"); const t = prompt("Ù…Ø¨Ù„Øº Ù‡Ø¯Ù:");
        if(n && t) { app.goals.push({name:n, target:parseInt(t), current:0}); save(); }
    }
    function goalDeposit(i) {
        const v = prompt("Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ:");
        if(v) { app.goals[i].current += parseInt(v); save(); }
    }
    function delGoal(i) { app.goals.splice(i,1); save(); }

    function renderShopping() {
        const div = document.getElementById('shoppingList');
        div.innerHTML = app.shopping.map((s, i) => `
            <div class="list-item">
                <span>${s.name}</span>
                <i class="fas fa-check" style="color:var(--success); cursor:pointer;" onclick="delShop(${i})"></i>
            </div>
        `).join('');
    }
    function openShopModal() {
        const n = prompt("Ù†Ø§Ù… Ú©Ø§Ù„Ø§:");
        if(n) { app.shopping.push({name:n}); save(); }
    }
    function delShop(i) { app.shopping.splice(i,1); save(); }

    function renderLending() {
        const div = document.getElementById('lendingList');
        div.innerHTML = app.lending.map((l, i) => `
            <div class="glass" style="padding:10px; margin-bottom:10px; border-right: 4px solid ${l.type === 'give' ? 'var(--warning)' : 'var(--danger)'}">
                <div class="d-flex-between">
                    <strong>${l.name}</strong>
                    <b>${formatNum(l.amount)}</b>
                </div>
                <div class="text-sm">${l.type === 'give' ? 'Ø·Ù„Ø¨ Ø¯Ø§Ø±Ù…' : 'Ø¨Ø¯Ù‡Ú©Ø§Ø±Ù…'}</div>
                <button class="btn-outline" style="width:100%; margin-top:5px; font-size:0.8rem;" onclick="delLend(${i})">ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯</button>
            </div>
        `).join('');
    }
    function addLending() {
        const n = prompt("Ù†Ø§Ù… Ø´Ø®Øµ:"); const a = prompt("Ù…Ø¨Ù„Øº:");
        const t = confirm("Ø¢ÛŒØ§ Ø´Ù…Ø§ Ù¾ÙˆÙ„ Ø¯Ø§Ø¯ÛŒØ¯ØŸ (Ok=Ø¨Ù„Ù‡ / Cancel=Ù…Ù† Ú¯Ø±ÙØªÙ…)") ? 'give' : 'get';
        if(n && a) { app.lending.push({name:n, amount:parseInt(a), type:t}); save(); }
    }
    function delLend(i) { app.lending.splice(i,1); save(); }

    // --- Chart ---
    function updateChart() {
        const ctx = document.getElementById('dashboardChart').getContext('2d');
        const labels = app.budgetItems.map(i => i.name);
        const data = app.budgetItems.map(i => i.spent);
        
        if(chartInstance) chartInstance.destroy();
        
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    }

    // --- Features (Export, Theme, etc) ---
    function toggleTheme() {
        const body = document.body;
        if(body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            app.settings.theme = 'light';
        } else {
            body.setAttribute('data-theme', 'dark');
            app.settings.theme = 'dark';
        }
        save();
    }
    
    function applyTheme() {
        if(app.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    function exportDataXLSX() {
        const wb = XLSX.utils.book_new();
        
        // Ø´ÛŒØª Ø¨ÙˆØ¯Ø¬Ù‡
        const wsData = [["Ø¹Ù†ÙˆØ§Ù†", "Ø¯Ø±ØµØ¯", "Ø¨ÙˆØ¯Ø¬Ù‡", "Ø®Ø±Ø¬ Ø´Ø¯Ù‡", "Ù…Ø§Ù†Ø¯Ù‡"]];
        const base = getDistributable();
        app.budgetItems.forEach(b => {
            const bud = Math.round((base * b.percent)/100) + b.rollover;
            wsData.push([b.name, b.percent, bud, b.spent, bud - b.spent]);
        });
        const ws = XLSX.utils.aoa_to_sheet(wsData);
        XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙˆØ¯Ø¬Ù‡");

        XLSX.writeFile(wb, "Report.xlsx");
    }

    function exportImage() {
        html2canvas(document.body).then(canvas => {
            const link = document.createElement('a');
            link.download = 'Dashboard.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    function changePin() {
        const newPin = prompt("Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¬Ø¯ÛŒØ¯ (Û´ Ø±Ù‚Ù…):");
        if(newPin && newPin.length === 4) {
            app.settings.pin = newPin;
            save();
            alert("Ø±Ù…Ø² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯.");
        }
    }

    function closeMonth() {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø§Ù‡ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯ØŸ Ù…Ø§Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.")) return;
        const base = getDistributable();
        app.budgetItems.forEach(item => {
            const bud = Math.round((base * item.percent)/100) + item.rollover;
            let rem = bud - item.spent;
            if(rem < 0) rem = 0;
            item.rollover = rem;
            item.spent = 0;
            item.transactions = [];
        });
        save();
        alert("Ù…Ø§Ù‡ Ø¬Ø¯ÛŒØ¯ Ø¢ØºØ§Ø² Ø´Ø¯!");
    }

    function resetApp() {
        if(confirm("Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            localStorage.removeItem('amir_fin_v8');
            location.reload();
        }
    }

    // --- Navigation & UI ---
    function navTo(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function toggleFab() {
        document.getElementById('fabContainer').classList.toggle('active');
        document.querySelector('.fab-main').classList.toggle('open');
    }

    function flipCard() {
        document.getElementById('creditCard').classList.toggle('flipped');
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // --- Helpers ---
    function formatNum(n) { return n ? n.toLocaleString('en-US') : '0'; }
    function toEnglish(str) { return str.toString().replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d)); }
    function formatInput(el) { 
        let v = toEnglish(el.value).replace(/[^0-9]/g, '');
        el.value = v ? parseInt(v).toLocaleString('en-US') : ''; 
    }
    function updateDate() {
        const d = new Date();
        document.getElementById('currentDate').innerText = d.toLocaleDateString('fa-IR');
    }

</script>
</body>
</html>
