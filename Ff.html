<!DOCTYPE html> 
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مدیریت مالی حرفه‌ای | V15 Modern (Security & Analytics)</title>

    <!-- فونت وزیرمتن -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- آیکون‌ها (FontAwesome 6) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- نمودار -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- تبدیل به عکس -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* پالت رنگی مدرن و حرفه‌ای */
            --bg-body: #f8fafc;
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(226, 232, 240, 0.8);
            --shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05), 0 0 3px rgba(0,0,0,0.02);
            
            --primary: #4f46e5;      /* Indigo 600 */
            --primary-light: #6366f1; /* Indigo 500 */
            --primary-dark: #4338ca;
            
            --text-main: #0f172a;    /* Slate 900 */
            --text-sec: #64748b;     /* Slate 500 */
            
            --success: #10b981;      /* Emerald 500 */
            --danger: #ef4444;       /* Red 500 */
            --warning: #f59e0b;      /* Amber 500 */
            
            --card-radius: 20px;
            --nav-height: 75px;
            --input-bg: #f1f5f9;
        }

        [data-theme="dark"] {
            --bg-body: #0f172a;
            --glass-bg: rgba(30, 41, 59, 0.98);
            --glass-border: 1px solid rgba(51, 65, 85, 0.5);
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --primary: #818cf8;
            --primary-light: #6366f1;
            --primary-dark: #4f46e5;
            --input-bg: #1e293b;
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 0 0 var(--nav-height) 0;
            min-height: 100vh;
            overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }

        /* --- کامپوننت‌های عمومی --- */
        .container {
            max-width: 600px; /* موبایل فرست */
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 90px;
        }

        .glass-panel {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: var(--card-radius);
            box-shadow: var(--shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.1);
            padding-bottom: 10px;
        }

        .header-row h3 { 
            margin: 0; 
            font-size: 1.15rem; 
            color: var(--text-main); 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-weight: 800;
        }

        /* دکمه‌ها - مدرن */
        .btn {
            padding: 12px 18px;
            border-radius: 14px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease-out;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; 
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }
        .btn-primary:active { transform: scale(0.97); }

        .btn-outline { 
            background: transparent; 
            border: 2px solid var(--glass-border); 
            color: var(--text-sec); 
        }
        .btn-outline:hover { 
            border-color: var(--primary); 
            color: var(--primary); 
            background: rgba(79, 70, 229, 0.05);
        }

        .btn-danger { 
            background: rgba(239, 68, 68, 0.1); 
            color: var(--danger); 
            border: 1px solid rgba(239, 68, 68, 0.1);
            box-shadow: none;
        }
        .btn-danger:hover { background: var(--danger); color: white; }

        .btn-icon {
            width: 44px; height: 44px;
            border-radius: 14px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            transition: all 0.2s;
        }
        .btn-icon:hover { 
            background: var(--primary); 
            color: white; 
            transform: translateY(-2px);
        }
        
        .btn-small-icon {
            width: 32px; height: 32px;
            border-radius: 10px;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: pointer; margin-right: 5px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-edit { color: var(--primary); background: rgba(79, 70, 229, 0.1); border:none; }
        .btn-del { color: var(--danger); background: rgba(239, 68, 68, 0.1); border:none; }
        .btn-inject { color: var(--success); background: rgba(16, 185, 129, 0.1); border:none; }
        .btn-pause { color: var(--text-sec); background: rgba(148, 163, 184, 0.2); border:none; }

        /* Currency Badge */
        .currency-toggle-btn {
            background: var(--glass-bg);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }
        .currency-toggle-btn.active {
            background: var(--primary);
            color: white;
        }

        /* ورودی‌ها - مدرن */
        input, select {
            background: var(--input-bg);
            border: 1px solid transparent;
            color: var(--text-main);
            padding: 14px;
            border-radius: 12px;
            font-size: 1rem;
            width: 100%;
            margin-bottom: 12px;
            transition: all 0.2s;
        }
        input:focus, select:focus { 
            border-color: var(--primary); 
            background: var(--glass-bg);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.15); 
        }
        
        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none; width: 100%; margin: 15px 0; background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: var(--primary); cursor: pointer; margin-top: -10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #cbd5e1; border-radius: 3px;
        }

        .date-picker-row {
            display: flex;
            gap: 8px;
            direction: ltr; 
        }
        .date-picker-row select {
            flex: 1;
            padding: 10px;
            font-size: 0.9rem;
            direction: rtl;
        }

        .money-input-wrapper {
            position: relative;
            margin-bottom: 12px;
        }
        .money-input-wrapper input {
            padding-left: 70px;
            margin-bottom: 0;
            direction: ltr;
            text-align: right;
            font-weight: bold;
            letter-spacing: 0.5px;
        }
        .money-unit {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 0.85rem;
            font-weight: bold;
            pointer-events: none;
            background: rgba(79, 70, 229, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        /* --- LOCK SCREEN (Instruction 1 Setup) --- */
        .pin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-body); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow-y: auto; padding: 20px;
        }
        .pin-dots { display: flex; gap: 20px; margin: 30px 0; }
        .pin-dot { width: 18px; height: 18px; border-radius: 50%; border: 2px solid var(--primary); transition: 0.2s; }
        .pin-dot.filled { background: var(--primary); transform: scale(1.2); box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); }
        
        .numpad {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; direction: ltr;
        }
        .num-key {
            width: 75px; height: 75px; border-radius: 25px;
            background: var(--glass-bg); border: none;
            font-size: 1.6rem; font-weight: bold; color: var(--text-main);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); transition: 0.15s;
        }
        .num-key:active { background: var(--primary); color: white; transform: scale(0.95); }

        .forgot-pass-link {
            margin-top: 30px;
            color: var(--text-sec);
            font-size: 0.9rem;
            text-decoration: none;
            cursor: pointer;
            border-bottom: 1px dashed var(--text-sec);
            padding-bottom: 2px;
        }
        
        .guest-btn {
            margin-top: 20px;
            background: transparent;
            border: 2px solid var(--success);
            color: var(--success);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            display: flex; align-items: center; gap: 8px;
        }
        .guest-btn:hover { background: var(--success); color: white; }

        /* Setup Form Step 1 */
        .setup-card {
            background: var(--glass-bg);
            padding: 30px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 350px;
            text-align: center;
        }
        .setup-card h2 { color: var(--primary); margin-top: 0; }

        /* --- HERO CARD --- */
        .hero-card {
            perspective: 1000px;
            height: 220px;
            margin-bottom: 30px;
            cursor: pointer;
        }
        .card-inner {
            position: relative;
            width: 100%; height: 100%;
            text-align: center;
            transition: transform 0.8s;
            transform-style: preserve-3d;
            border-radius: 24px;
            box-shadow: 0 20px 40px -5px rgba(79, 70, 229, 0.4);
        }
        .hero-card.flipped .card-inner { transform: rotateY(180deg); }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 24px;
            padding: 25px;
            color: white;
            display: flex; flex-direction: column; justify-content: space-between;
            overflow: hidden;
        }
        .card-front {
            background: linear-gradient(120deg, #4f46e5, #8b5cf6);
        }
        /* طرح زمینه کارت */
        .card-front::before {
            content: ''; position: absolute; top: -50px; right: -50px;
            width: 150px; height: 150px; background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }
        .card-front::after {
            content: ''; position: absolute; bottom: -30px; left: -30px;
            width: 100px; height: 100px; background: rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        .card-back {
            background: #1e293b;
            transform: rotateY(180deg);
            align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .balance-label { font-size: 0.95rem; opacity: 0.9; text-align: right; display: block; font-weight: 300;}
        .balance-value { font-size: 2.5rem; font-weight: 800; margin: 10px 0; direction: ltr; text-shadow: 0 2px 4px rgba(0,0,0,0.2); letter-spacing: 1px; }

        /* --- BENTO GRID --- */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            gap: 15px;
        }
        @media(min-width: 600px) { .budget-grid { grid-template-columns: 1fr 1fr; } }

        .bento-item {
            background: var(--glass-bg);
            border: var(--glass-border);
            border-radius: 18px;
            padding: 18px;
            display: flex; flex-direction: column; gap: 10px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
        }
        .bento-item.paused {
            opacity: 0.7;
            filter: grayscale(1);
            border: 2px dashed var(--text-sec);
        }
        
        .bento-header { display: flex; justify-content: space-between; align-items: center; font-weight: 700; font-size: 1.05rem; }
        
        .progress-bar {
            height: 12px; background: rgba(0,0,0,0.05); border-radius: 6px; overflow: hidden; margin: 5px 0;
        }
        .progress-fill { height: 100%; transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 6px; }
        
        .stat-green .progress-fill { background: var(--success); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .stat-yellow .progress-fill { background: var(--warning); box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        .stat-red .progress-fill { background: var(--danger); box-shadow: 0 0 10px rgba(239, 68, 68, 0.4); }
        
        .bento-actions {
            margin-top: 8px;
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .action-chip {
            flex: 1; padding: 8px; font-size: 0.85rem; border-radius: 10px;
            border: 1px solid var(--glass-border); background: rgba(255,255,255,0.5); color: var(--text-main);
            cursor: pointer; text-align: center; font-weight: bold; white-space: nowrap;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: 0.2s;
        }
        .action-chip:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- Template Chips --- */
        .template-row {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: none;
        }
        .template-chip {
            white-space: nowrap; padding: 8px 16px; border-radius: 25px;
            background: var(--glass-bg); border: 1px solid var(--primary); color: var(--primary);
            font-size: 0.85rem; cursor: pointer; transition: 0.2s; font-weight: bold;
        }
        .template-chip:hover { background: var(--primary); color: white; }

        /* --- BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: var(--nav-height);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: var(--glass-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 1000;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            padding-bottom: 10px; /* Safe area */
        }
        .nav-btn {
            background: none; border: none;
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            color: var(--text-sec); font-size: 0.7rem; cursor: pointer;
            width: 70px; font-weight: 600;
            transition: 0.3s;
        }
        .nav-btn i { font-size: 1.5rem; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .nav-btn.active { color: var(--primary); }
        .nav-btn.active i { transform: translateY(-8px); filter: drop-shadow(0 4px 6px rgba(79, 70, 229, 0.4)); }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 2000;
            display: none; 
            justify-content: center; 
            align-items: flex-end; 
            backdrop-filter: blur(5px);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal.active { 
            display: flex; 
            opacity: 1;
        }
        .modal-content {
            background: var(--bg-body);
            width: 100%; max-width: 600px;
            padding: 30px 25px;
            border-radius: 30px 30px 0 0; 
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.2);
            max-height: 85vh; overflow-y: auto;
            transform: translateY(100%); 
            transition: transform 0.3s cubic-bezier(0.19, 1, 0.22, 1);
        }
        .modal.active .modal-content {
            transform: translateY(0); 
        }

        /* --- TAB CONTENT --- */
        .tab-pane { display: none; padding-bottom: 20px; animation: fadeIn 0.4s ease; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- REPORT (PRINT) --- */
        #printArea {
            position: absolute; top: -9999px; left: -9999px;
            width: 800px; background: white; color: black; padding: 40px;
            border: 2px solid #333; font-family: 'Vazirmatn', sans-serif;
            z-index: 99999;
        }
        .print-header { text-align: center; border-bottom: 2px solid #000; margin-bottom: 20px; padding-bottom: 15px; }
        .print-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .print-table th { background: #eee; border: 1px solid #000; padding: 10px; }
        .print-table td { border: 1px solid #000; padding: 8px; text-align: center; }
        .print-summary { display: flex; justify-content: space-between; margin-top: 20px; font-weight: bold; border: 1px solid #000; padding: 10px; background: #f9f9f9; }
        .print-section-title { font-weight: bold; margin-top: 20px; border-bottom: 1px solid #ccc; padding-bottom: 5px; }
        .print-chart-container { width: 100%; height: 300px; margin-top: 20px; border: 1px dashed #ccc; padding: 10px; }

        /* Section History Chip */
        .history-btn {
            font-size: 0.75rem; background: rgba(0,0,0,0.05); padding: 5px 12px; border-radius: 20px; cursor: pointer; margin-left: 10px; display: inline-flex; align-items: center; gap: 5px; color: var(--text-sec); border: 1px solid transparent;
        }
        .history-btn:hover { background: var(--primary); color: white; }

    </style>
</head>
<body>

<!-- 1. LOCK SCREEN & SETUP (Instructions 1 & 2) -->

<div id="authModal" class="pin-screen">
    
    <!-- STEP 1: INITIAL SETUP FORM (Instruction 1) -->
    <div id="setupStep1" class="setup-card" style="display:none;">
        <i class="fas fa-user-shield" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
        <h2>راه‌اندازی اولیه</h2>
        <p style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 20px;">لطفاً اطلاعات زیر را جهت امنیت وارد کنید</p>
        
        <label style="display:block; text-align:right; font-size:0.85rem; margin-bottom:5px;">نام و نام خانوادگی:</label>
        <input type="text" id="setupName" placeholder="نام شما">
        
        <label style="display:block; text-align:right; font-size:0.85rem; margin-bottom:5px;">کد ملی (جهت بازیابی):</label>
        <input type="tel" id="setupNationalId" placeholder="کد ملی ۱۰ رقمی" inputmode="numeric">

        <label style="display:block; text-align:right; font-size:0.85rem; margin-bottom:5px; color:var(--primary);">سوال امنیتی:</label>
        <div id="setupSecurityQText" style="background:var(--input-bg); padding:10px; border-radius:8px; margin-bottom:10px; font-size:0.9rem; font-weight:bold;">---</div>
        <input type="text" id="setupSecurityAns" placeholder="پاسخ سوال امنیتی">

        <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="processSetupStep1()">
            تایید و مرحله بعد <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- STEP 2 & LOGIN: PIN PAD -->
    <div id="pinContainer" style="display:none; flex-direction:column; align-items:center; width:100%;">
        <i class="fas fa-fingerprint" style="font-size: 4rem; color: var(--primary);"></i>
        <h2 id="authTitle" style="margin: 15px 0 5px 0;">امنیت</h2>
        <p id="authSub" style="font-size: 0.9rem; color: var(--text-sec); margin-bottom: 20px;">...</p>

        <div class="pin-dots">
            <div class="pin-dot" id="pd1"></div>
            <div class="pin-dot" id="pd2"></div>
            <div class="pin-dot" id="pd3"></div>
            <div class="pin-dot" id="pd4"></div>
        </div>

        <div class="numpad">
            <button class="num-key" onclick="pressKey(1)">1</button>
            <button class="num-key" onclick="pressKey(2)">2</button>
            <button class="num-key" onclick="pressKey(3)">3</button>
            <button class="num-key" onclick="pressKey(4)">4</button>
            <button class="num-key" onclick="pressKey(5)">5</button>
            <button class="num-key" onclick="pressKey(6)">6</button>
            <button class="num-key" onclick="pressKey(7)">7</button>
            <button class="num-key" onclick="pressKey(8)">8</button>
            <button class="num-key" onclick="pressKey(9)">9</button>
            <div class="num-key" style="visibility: hidden;"></div>
            <button class="num-key" onclick="pressKey(0)">0</button>
            <button class="num-key" onclick="pressKey('del')" style="color:var(--danger)"><i class="fas fa-backspace"></i></button>
        </div>

        <!-- Instruction 2: Forgot Password -->
        <div id="forgotPassDiv" class="forgot-pass-link" onclick="startRecovery()" style="display:none;">
            <i class="fas fa-key"></i> فراموشی رمز عبور
        </div>
        
        <!-- Instruction 1: Guest Login -->
        <button id="guestLoginBtn" class="guest-btn" onclick="guestLogin()">
            <i class="fas fa-user-secret"></i> ورود آزاد (مهمان)
        </button>
        <div style="font-size:0.7rem; color:var(--text-sec); margin-top:5px; text-align:center; max-width:250px; display:none;" id="guestWarn">
            در ورود آزاد هیچ اطلاعاتی ذخیره نمی‌شود.
        </div>
    </div>
</div>

<!-- 2. MAIN APP -->

<div class="container" id="appContent" style="display:none;">

    <!-- Header -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 10px;">
        <div>
            <h2 style="margin:0; color:var(--primary); font-size:1.4rem;">مدیریت مالی</h2>
            <span style="font-size:0.8rem; color:var(--text-sec);" id="headerDate">---</span>
            <!-- Days Passed -->
            <div style="font-size:0.75rem; color:var(--success); margin-top:2px; font-weight:bold;" id="daysPassedLabel">روز ۰</div>
        </div>
        <div style="display:flex; gap:8px;">
            <button class="currency-toggle-btn" id="currBtn" onclick="toggleCurrency()">
                <i class="fas fa-coins"></i> <span id="currBtnText">تومان</span>
            </button>
            <button class="btn-icon" onclick="toggleTheme()" title="تم شب/روز">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <!-- TAB 1: DASHBOARD -->
    <div id="view-dashboard" class="tab-pane active">
        <!-- Hero Card -->
        <div class="hero-card" onclick="this.classList.toggle('flipped')">
            <div class="card-inner">
                <div class="card-front">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <i class="fas fa-wifi" style="opacity:0.7"></i>
                        <span style="font-size:0.9rem; opacity:0.9; font-weight:bold;">V15 Ultimate</span>
                    </div>
                    <div>
                        <span class="balance-label">موجودی خالص (قابل تقسیم)</span>
                        <div class="balance-value" id="totalBalance">0</div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.9rem; opacity:0.9;">
                        <span id="userNameDisplay">کاربر</span>
                        <span id="cardCurrency">تومان</span>
                    </div>
                </div>
                <div class="card-back">
                    <h3 style="margin:0;">خلاصه بدهی‌ها</h3>
                    <p style="margin:5px 0; color:#cbd5e1;">مجموع اقساط و چک‌های فعال:</p>
                    <div style="font-size:2rem; color:var(--danger); font-weight:bold; direction:ltr;" id="totalDebtDisplay">0</div>
                    <p style="font-size:0.8rem; margin-top:10px; opacity:0.7;">این مبلغ از موجودی کسر شده است.</p>
                </div>
            </div>
        </div>

        <div class="header-row">
            <h3><i class="fas fa-chart-line"></i> داشبورد <span class="history-btn" onclick="showSectionHistory('dashboard')"><i class="fas fa-history"></i> سابقه</span></h3>
        </div>

        <!-- Wallets -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-wallet" style="color:var(--primary)"></i> منابع مالی (کیف پول)</h3>
                <button class="btn btn-primary" onclick="openModal('walletModal')"><i class="fas fa-plus"></i></button>
            </div>
            <div id="walletList"></div>
        </div>

        <!-- Fixed Debts -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-file-invoice-dollar" style="color:var(--danger)"></i> اقساط ثابت</h3>
                <button class="btn btn-primary" onclick="openModal('debtModal')"><i class="fas fa-plus"></i></button>
            </div>
            <div id="debtList"></div>
        </div>

        <!-- Checks & Debts -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-money-check-alt" style="color:var(--warning)"></i> چک و بدهی</h3>
                <button class="btn btn-primary" onclick="openModal('checkModal')"><i class="fas fa-plus"></i></button>
            </div>
            <div id="checkList"></div>
        </div>
    </div>

    <!-- TAB 2: BUDGET -->
    <div id="view-budget" class="tab-pane">
        <div class="glass-panel" style="text-align:center;">
            <span style="color:var(--text-sec); font-size:0.9rem;">بودجه کل توزیع شده:</span>
            <div style="display: flex; justify-content: center; align-items: center; gap: 10px;">
                <div id="distributable" style="font-size:1.6rem; font-weight:bold; color:var(--primary); direction:ltr;">0</div>
                <small id="totalPercentBadge" style="background:var(--text-sec); color:white; padding:3px 8px; border-radius:6px; font-weight:bold;">0%</small>
            </div>
            <button id="btnDistribute" class="btn btn-primary" style="margin-top:15px; width:100%; display:none;" onclick="triggerDistribution()">
                <i class="fas fa-sync-alt"></i> توزیع موجودی جدید
            </button>
        </div>

        <div class="header-row" style="margin: 0 5px 15px 5px; flex-direction: column; align-items: flex-start; border:none;">
            <div style="display: flex; justify-content: space-between; width: 100%; align-items: center; margin-bottom:10px;">
                <h3 style="display:flex; align-items:center;"><i class="fas fa-chart-pie"></i> مدیریت ردیف‌ها <span class="history-btn" onclick="showSectionHistory('budget')"><i class="fas fa-history"></i> سابقه</span></h3>
                <button class="btn btn-primary" onclick="openModal('addBudgetModal')"><i class="fas fa-plus"></i> جدید</button>
            </div>
            <!-- Template Selection -->
            <div class="template-row" style="width: 100%;">
                <span style="font-size:0.8rem; line-height:30px; margin-left:5px; color:var(--text-sec);">قالب‌ها:</span>
                <div class="template-chip" onclick="applyTemplate('default')"><i class="fas fa-magic"></i> پیش‌فرض</div>
                <div class="template-chip" onclick="applyTemplate('student')"><i class="fas fa-user-graduate"></i> دانشجویی</div>
                <div class="template-chip" onclick="applyTemplate('married')"><i class="fas fa-user-friends"></i> متاهلی</div>
                <div class="template-chip" onclick="applyTemplate('clear')"><i class="fas fa-eraser"></i> پاکسازی</div>
            </div>
        </div>

        <div id="budgetGrid" class="budget-grid">
            <!-- کارت‌های بودجه اینجا ساخته می‌شوند -->
        </div>
    </div>

    <!-- TAB 3: TOOLS -->
    <div id="view-tools" class="tab-pane">
        <div class="header-row" style="padding:0 10px;">
             <h3><i class="fas fa-tools"></i> ابزارها <span class="history-btn" onclick="showSectionHistory('tools')"><i class="fas fa-history"></i> سابقه</span></h3>
        </div>

        <!-- Goals -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-bullseye" style="color:var(--success)"></i> اهداف پس‌انداز</h3>
                <button class="btn btn-primary" onclick="openModal('goalModal')"><i class="fas fa-plus"></i></button>
            </div>
            <div id="goalList"></div>
        </div>

        <!-- Shopping -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-shopping-cart" style="color:var(--primary)"></i> لیست خرید</h3>
                <button class="btn btn-primary" onclick="openModal('shopModal')"><i class="fas fa-plus"></i></button>
            </div>
            <div id="shopList"></div>
        </div>

        <!-- Loans Given -->
        <div class="glass-panel">
            <div class="header-row">
                <h3><i class="fas fa-hand-holding-usd" style="color:var(--warning)"></i> طلب‌ها (قرض داده شده)</h3>
                <button class="btn btn-primary" onclick="openModal('loanModal')"><i class="fas fa-plus"></i></button>
            </div>
            <div id="loanList"></div>
        </div>
    </div>

    <!-- TAB 4: SETTINGS -->
    <div id="view-settings" class="tab-pane">
        <div class="glass-panel">
            <div class="header-row"><h3><i class="fas fa-cog"></i> تنظیمات سیستم</h3></div>
            
            <div style="display:flex; flex-direction:column; gap:15px;">
                
                <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:var(--bg-body); border-radius:12px;">
                    <span style="font-weight:bold;"><i class="fas fa-copy"></i> حالت کپی (خام)</span>
                    <input type="checkbox" id="rawCopyCheck" style="width:24px; height:24px; margin:0;">
                </div>

                <!-- Priority Settings (Instruction 3) -->
                <button class="btn btn-outline" onclick="openPrioritySettings()">
                    <i class="fas fa-list-ol"></i> مدیریت اولویت‌ها (اصلاح هوشمند)
                </button>

                <button class="btn btn-outline" onclick="changeUserName()">
                    <i class="fas fa-user-edit"></i> تغییر نام کاربر
                </button>

                <button class="btn btn-outline" onclick="generateReportImage()">
                    <i class="fas fa-file-pdf"></i> دانلود گزارش و نمودار (PDF/PNG)
                </button>
                
                <button class="btn btn-outline" onclick="downloadBackup()">
                    <i class="fas fa-download"></i> دانلود فایل بکاپ (JSON)
                </button>
                
                <label class="btn btn-outline" style="cursor:pointer; text-align:center;">
                    <i class="fas fa-upload"></i> بازیابی فایل بکاپ
                    <input type="file" id="restoreFile" style="display:none" onchange="restoreBackup(this)">
                </label>

                <button class="btn btn-outline" onclick="showHistory()">
                    <i class="fas fa-history"></i> تاریخچه بکاپ‌ها
                </button>

                <button class="btn btn-outline" onclick="changePin()">
                    <i class="fas fa-lock"></i> تغییر رمز عبور
                </button>

                <button class="btn btn-danger" onclick="resetAll()">
                    <i class="fas fa-trash-alt"></i> ریست فکتوری (حذف همه اطلاعات)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- BOTTOM NAVIGATION -->

<nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchTab('dashboard')">
        <i class="fas fa-home"></i> داشبورد
    </button>
    <button class="nav-btn" onclick="switchTab('budget')">
        <i class="fas fa-chart-pie"></i> بودجه
    </button>
    <button class="nav-btn" onclick="switchTab('tools')">
        <i class="fas fa-tools"></i> ابزارها
    </button>
    <button class="nav-btn" onclick="switchTab('settings')">
        <i class="fas fa-cogs"></i> تنظیمات
    </button>
</nav>

<!-- MODALS -->

<!-- Recovery Modal (Instruction 2) -->
<div id="recoveryModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-key"></i> بازیابی رمز عبور</h3>
        
        <label>کد ملی شما:</label>
        <input type="tel" id="recoveryNationalId" placeholder="کد ملی ۱۰ رقمی" inputmode="numeric">

        <label style="margin-top:10px;">پاسخ سوال امنیتی:</label>
        <p id="recoveryQuestionText" style="font-weight:bold; color:var(--primary); margin: 5px 0 10px 0; background:rgba(0,0,0,0.05); padding:10px; border-radius:8px;">---</p>
        <input type="text" id="recoveryAnswerInput" placeholder="پاسخ شما...">
        
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="checkRecoveryAnswer()">بررسی و تغییر رمز</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">بستن</button>
        </div>
    </div>
</div>

<!-- Edit Modal (Instruction 5 & 6) -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> ویرایش آیتم</h3>
        <input type="hidden" id="editType">
        <input type="hidden" id="editIndex">

        <label>عنوان:</label>
        <input type="text" id="editName">
        
        <div id="editAmountWrapper">
            <label>مبلغ / ارزش:</label>
            <div class="money-input-wrapper">
                <!-- Instruction 6: inputmode numeric -->
                <input type="text" id="editVal" onkeyup="formatCurrency(this)" inputmode="numeric">
                <span class="money-unit currency-text">تومان</span>
            </div>
        </div>

        <div id="editDateWrapper" style="display:none;">
            <label>تاریخ:</label>
            <div class="date-picker-row" id="editDateRow">
                <!-- Populated dynamically -->
            </div>
        </div>

        <div id="editPercentWrapper" style="display:none;">
            <label>درصد:</label>
            <input type="number" id="editPercent" inputmode="numeric">
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="performEdit()">ذخیره تغییرات</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Section History Modal -->
<div id="sectionHistoryModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-history"></i> تاریخچه تغییرات (۱۰ مورد آخر)</h3>
        <p style="font-size:0.8rem; color:var(--text-sec)">با کلیک روی هر مورد، وضعیت به آن زمان باز می‌گردد.</p>
        <div id="sectionHistoryList" style="max-height:300px; overflow-y:auto; margin-top:10px;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Wallet Modal -->
<div id="walletModal" class="modal">
    <div class="modal-content">
        <h3>افزودن کیف پول</h3>
        <label>نام کیف پول:</label>
        <input type="text" id="wName" placeholder="مثلاً: کارت ملی">
        <label>مبلغ موجودی:</label>
        <div class="money-input-wrapper">
            <input type="text" id="wVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addWallet()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Fixed Debt Modal -->
<div id="debtModal" class="modal">
    <div class="modal-content">
        <h3>افزودن قسط ثابت</h3>
        <label>عنوان قسط:</label>
        <input type="text" id="dName" placeholder="مثلاً: وام مسکن">
        <label>مبلغ قسط:</label>
        <div class="money-input-wrapper">
            <input type="text" id="dVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ پرداخت (روز در ماه):</label>
        <div class="date-picker-row">
            <select id="dDay" style="direction: rtl;"></select>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addDebt()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Check/Debt Modal -->
<div id="checkModal" class="modal">
    <div class="modal-content">
        <h3>افزودن چک / بدهی</h3>
        <label>عنوان:</label>
        <input type="text" id="cName" placeholder="مثلاً: چک صیادی">
        <label>مبلغ:</label>
        <div class="money-input-wrapper">
            <input type="text" id="cVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ سررسید:</label>
        <div class="date-picker-row" id="checkDateRow"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addCheck()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Loan Given Modal -->
<div id="loanModal" class="modal">
    <div class="modal-content">
        <h3>ثبت طلب (قرض داده شده)</h3>
        <label>نام شخص/عنوان:</label>
        <input type="text" id="lName" placeholder="مثلاً: علی رضایی">
        <label>مبلغ قرض:</label>
        <div class="money-input-wrapper">
            <input type="text" id="lVal" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>تاریخ وصول:</label>
        <div class="date-picker-row" id="loanDateRow"></div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addLoan()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Add Budget Modal -->
<div id="addBudgetModal" class="modal">
    <div class="modal-content">
        <h3>افزودن ردیف بودجه</h3>
        <label>عنوان:</label>
        <input type="text" id="bName" placeholder="مثلاً: پوشاک">
        <label>درصد سهم:</label>
        <input type="number" id="bPercent" placeholder="مثلاً: 10" inputmode="numeric">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addNewBudget()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Expense Modal -->
<div id="expModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-receipt"></i> ثبت هزینه جدید</h3>
        <input type="hidden" id="expBudgetId">
        <label>مبلغ هزینه:</label>
        <div class="money-input-wrapper">
            <input type="text" id="expAmt" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <label>بابت (توضیح):</label>
        <input type="text" id="expReason" placeholder="...">
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="submitExp()">ثبت هزینه</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Goal Modal -->
<div id="goalModal" class="modal">
    <div class="modal-content">
        <h3>هدف پس‌انداز جدید</h3>
        <label>نام هدف:</label>
        <input type="text" id="gName" placeholder="مثلاً: خرید لپ‌تاپ">
        <label>مبلغ هدف:</label>
        <div class="money-input-wrapper">
            <input type="text" id="gTarget" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addGoal()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Shop Modal -->
<div id="shopModal" class="modal">
    <div class="modal-content">
        <h3>افزودن به لیست خرید</h3>
        <label>نام کالا:</label>
        <input type="text" id="sName" placeholder="مثلاً: روغن زیتون">
        <label>قیمت حدودی (اختیاری):</label>
        <div class="money-input-wrapper">
            <input type="text" id="sPrice" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="addShop()">ثبت</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Allocate Modal -->
<div id="allocModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-link"></i> اختصاص بودجه</h3>
        <p style="font-size:0.9rem; color:var(--text-sec);">انتخاب کنید هزینه از کدام ردیف بودجه کسر شود:</p>
        <input type="hidden" id="allocType">
        <input type="hidden" id="allocId">

        <label>ردیف بودجه:</label>
        <select id="allocBudgetSelect"></select>
        
        <label>مبلغ اختصاصی:</label>
        <div class="money-input-wrapper">
            <input type="text" id="allocAmt" onkeyup="formatCurrency(this)" inputmode="numeric" placeholder="0">
            <span class="money-unit currency-text">تومان</span>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="performAllocation()">ثبت کسری</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Percentage Correction Modal -->
<div id="fixPercentModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> خطا در درصد کل</h3>
        <p>مجموع درصد‌ها از ۱۰۰٪ بیشتر شده است. لطفاً یکی از گزینه‌های زیر را انتخاب کنید:</p>

        <div style="margin:20px 0; padding:15px; background:var(--input-bg); border-radius:12px;">
            <p style="margin-top:0;"><b>حالت اول:</b> انتخاب دستی تا سقف مجاز</p>
            <p style="font-size:0.9rem;">حداکثر درصد قابل انتخاب: <b id="maxAllowedPercent" style="color:var(--primary)">0%</b></p>
            <div style="display:flex; align-items:center; gap:10px;">
                <span>0</span>
                <input type="range" id="percentSlider" min="0" value="0" oninput="updateSliderVal()">
                <span id="sliderValDisplay">0</span>%
            </div>
            <button class="btn btn-outline" style="width:100%; margin-top:10px;" onclick="useSliderPercent()">ثبت درصد انتخابی</button>
        </div>

        <div style="margin:20px 0; padding:15px; background:var(--input-bg); border-radius:12px;">
            <p style="margin-top:0;"><b>حالت دوم:</b> اصلاح هوشمند سیستم</p>
            <p style="font-size:0.9rem;">سیستم بر اساس اولویت‌بندی‌ها، درصدهای اولویت پایین‌تر را کاهش می‌دهد.</p>
            
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px;">
                <input type="checkbox" id="allowZeroCheck" style="width:auto; margin:0;">
                <label for="allowZeroCheck" style="font-size:0.9rem;">اجازه صفر شدن آیتم‌ها</label>
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="autoCorrectBudget()">اصلاح خودکار و ثبت</button>
        </div>

        <button class="btn btn-danger" style="width:100%" onclick="closeAllModals()">انصراف</button>
    </div>
</div>

<!-- Priority Settings Modal (Instruction 3) -->
<div id="prioritySettingsModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-list-ol"></i> مدیریت اولویت‌ها</h3>
        <p style="font-size:0.85rem; color:var(--text-sec); margin-bottom:10px;">برای اصلاح هوشمند، درصدها را تعریف کنید:</p>
        
        <div style="display:flex; gap:10px; margin-bottom:15px; background:var(--input-bg); padding:10px; border-radius:12px;">
            <div style="flex:1">
                <small>حد پایین (%)</small>
                <input type="number" id="pRangeLow" placeholder="40" style="padding:8px; font-size:0.9rem; margin:0;" inputmode="numeric">
            </div>
            <div style="flex:1">
                <small>حد بالا (%)</small>
                <input type="number" id="pRangeMid" placeholder="70" style="padding:8px; font-size:0.9rem; margin:0;" inputmode="numeric">
            </div>
        </div>
        <button class="btn btn-outline" style="width:100%; margin-bottom:15px; font-size:0.8rem;" onclick="savePriorityRanges()">ذخیره بازه‌ها</button>

        <hr style="border:0; border-top:1px dashed #ccc; margin-bottom:15px;">
        <p style="font-size:0.85rem;">تعیین اولویت هر ردیف:</p>

        <div id="priorityList" style="max-height:250px; overflow-y:auto; padding-bottom:10px;">
            <!-- Generated via JS safely -->
        </div>

        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn btn-primary" style="flex:1" onclick="savePriorities()">ذخیره اولویت‌ها</button>
            <button class="btn btn-outline" style="flex:1" onclick="closeAllModals()">لغو</button>
        </div>
    </div>
</div>

<!-- Item History Modal -->
<div id="itemHistModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-history"></i> تاریخچه تراکنش‌ها</h3>
        <div id="itemHistList" style="max-height:300px; overflow-y:auto; margin-top:10px; font-size:0.9rem;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- Backup History Modal -->
<div id="histModal" class="modal">
    <div class="modal-content">
        <h3><i class="fas fa-database"></i> تاریخچه بکاپ‌ها</h3>
        <div id="histList" style="max-height:300px; overflow-y:auto; margin-top:10px; font-size:0.9rem;"></div>
        <button class="btn btn-outline" style="width:100%; margin-top:15px;" onclick="closeAllModals()">بستن</button>
    </div>
</div>

<!-- REPORT TEMPLATE -->
<div id="printArea">
    <div class="print-header">
        <h1>گزارش جامع وضعیت مالی</h1>
        <p id="printDate">تاریخ: ---</p>
        <p>کاربر: <span id="printUser">---</span> | روزهای سپری شده: <span id="printDays">0</span></p>
    </div>

    <div class="print-summary">
        <div>کل دارایی: <b id="printInc">0</b></div>
        <div>کل بدهی: <b id="printDebt">0</b></div>
        <div>خالص قابل خرج: <b id="printNet">0</b></div>
    </div>

    <!-- Chart Container for PDF -->
    <div class="print-section-title">نمودار پیشرفت مالی (روزانه)</div>
    <div class="print-chart-container">
        <canvas id="printChart"></canvas>
    </div>

    <div class="print-section-title">تاریخچه روزانه اخیر</div>
    <table class="print-table" style="font-size:0.8rem;">
        <thead>
            <tr><th>تاریخ</th><th>خالص (تومان)</th><th>هزینه شده</th></tr>
        </thead>
        <tbody id="printHistoryTable"></tbody>
    </table>

    <div class="print-section-title">جزئیات بودجه‌بندی</div>
    <table class="print-table">
        <thead>
            <tr>
                <th>ردیف</th>
                <th>درصد</th>
                <th>سهم (تومان)</th>
                <th>خرج شده</th>
                <th>مانده</th>
            </tr>
        </thead>
        <tbody id="printBody"></tbody>
    </table>

    <div class="print-section-title">وضعیت بدهی‌ها</div>
    <div id="printDebtsList" style="margin-top:5px; font-size:0.9rem;"></div>

    <div class="print-section-title">وضعیت اهداف مالی</div>
    <div id="printGoalsList" style="margin-top:5px; font-size:0.9rem;"></div>

    <div style="margin-top:30px; text-align:center; font-size:12px; color:#666; border-top:1px solid #000; padding-top:10px;">
        تولید شده توسط سامانه مدیریت مالی شخصی V15 Ultimate
    </div>
</div>

<script>
    // --- STATE & DATA ---
    const defaultState = {
        security: { 
            hasPin: false, 
            pin: "", 
            isSetup: false, 
            questionId: 0, 
            answer: "", 
            nationalId: "" // Instruction 1: Added National ID
        },
        user: { name: "", theme: "light", currency: "toman", startDate: Date.now() },
        wallets: [],
        debts: [], 
        checks: [], 
        loans: [],  
        budgets: [
            {id: 1, name: "کرایه و رفت‌وآمد", percent: 27, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 2, name: "خورد و خوراک", percent: 12, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 3, name: "پس‌انداز", percent: 25, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 4, name: "درمان", percent: 3, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 5, name: "شارژ و نت", percent: 10, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 6, name: "پوشاک", percent: 7, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 7, name: "تفریح", percent: 6, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0},
            {id: 8, name: "ضروری", percent: 10, spent: 0, history: [], manualAdd: 0, isPaused: false, savedPercent: 0}
        ],
        priorities: {
            "کرایه و رفت‌وآمد": 1, "خورد و خوراک": 1, "درمان": 1, "ضروری": 1, "اجاره خانه": 1,
            "شارژ و نت": 2, "پوشاک": 2, "پس‌انداز": 3,
            "تفریح": 4, "سایر": 4
        },
        priorityRanges: { low: 40, mid: 70 }, 
        distributedAmount: 0, 
        goals: [],
        shopping: [],
        history: [], 
        dailyLogs: [], 
        sectionHistory: { dashboard: [], budget: [], tools: [] }
    };

    const securityQuestions = [
        "نام اولین حیوان خانگی شما چیست؟",
        "نام معلم کلاس اول دبستان شما چه بود؟",
        "نام خیابانی که در کودکی در آن زندگی می‌کردید؟",
        "رنگ مورد علاقه شما چیست؟",
        "نام بهترین دوست دوران کودکی؟"
    ];

    let app = JSON.parse(JSON.stringify(defaultState));
    let pinBuffer = "";
    let rate = 1; 
    let tempBudget = null; 
    let isGuest = false; // Instruction 1: Guest Mode Flag

    // --- STARTUP ---
    window.onload = () => {
        loadData();
        if(!isGuest) processDailyLog(); 
        checkAuth();
        updateDate();
        setupDatePickers();
    };

    function processDailyLog() {
        const today = new Date().toLocaleDateString('fa-IR');
        if(!app.dailyLogs) app.dailyLogs = [];
        
        const lastLog = app.dailyLogs.length > 0 ? app.dailyLogs[app.dailyLogs.length-1] : null;
        
        if (!lastLog || lastLog.date !== today) {
            const income = app.wallets.reduce((a,b)=>a+b.value,0);
            const totalDebt = app.debts.reduce((a,b)=>a+b.value,0) + (app.checks || []).reduce((a,b)=>a+b.value,0);
            const net = income - totalDebt;
            const spent = app.budgets.reduce((a,b)=>a+b.spent,0);
            
            app.dailyLogs.push({ date: today, net: net, spent: spent, timestamp: Date.now() });
            saveData();
        }
    }

    // --- DATE PICKER SETUP ---
    function setupDatePickers() { }

    function createDatePickerHTML(prefix, defaultD=1, defaultM=1, defaultY=1403) {
        return `
            <select id="${prefix}Day" class="date-sel">${genOpts(1,31, defaultD)}</select>
            <select id="${prefix}Month" class="date-sel">${genOpts(1,12, defaultM)}</select>
            <select id="${prefix}Year" class="date-sel">${genYearOpts(defaultY)}</select>
        `;
    }

    function genOpts(min, max, sel) {
        let html = '';
        for(let i=min; i<=max; i++) html += `<option value="${i}" ${i==sel?'selected':''}>${i}</option>`;
        return html;
    }
    
    function genYearOpts(sel) {
        const currentYear = 1403;
        let html = '';
        for(let i=0; i<=20; i++) html += `<option value="${currentYear+i}" ${(currentYear+i)==sel?'selected':''}>${currentYear+i}</option>`;
        return html;
    }

    function getDateString(prefix) {
        const d = document.getElementById(prefix+'Day').value;
        const m = document.getElementById(prefix+'Month').value;
        const y = document.getElementById(prefix+'Year').value;
        return `${y}/${m}/${d}`;
    }

    // --- AUTH & SETUP (Instruction 1 & 2) ---
    function checkAuth() {
        const modal = document.getElementById('authModal');
        const setupStep1 = document.getElementById('setupStep1');
        const pinContainer = document.getElementById('pinContainer');
        const title = document.getElementById('authTitle');
        const sub = document.getElementById('authSub');
        const forgotDiv = document.getElementById('forgotPassDiv');
        const guestWarn = document.getElementById('guestWarn');

        modal.style.display = 'flex';
        pinBuffer = "";
        updatePinDots();

        // Check if fully setup
        if (!app.security.hasPin || !app.security.isSetup) {
            // SHOW SETUP STEP 1
            setupStep1.style.display = 'block';
            pinContainer.style.display = 'none';
            
            // Random Question
            const randIdx = Math.floor(Math.random() * securityQuestions.length);
            document.getElementById('setupSecurityQText').innerText = securityQuestions[randIdx];
            document.getElementById('setupSecurityQText').setAttribute('data-qid', randIdx);
        } else {
            // SHOW LOGIN
            setupStep1.style.display = 'none';
            pinContainer.style.display = 'flex';
            title.innerText = "ورود امن";
            sub.innerText = `${app.user.name} خوش آمدی.`;
            forgotDiv.style.display = 'block';
            document.getElementById('guestLoginBtn').style.display = 'flex';
            guestWarn.style.display = 'block';
        }
    }

    // Instruction 1: Step 1 Processing
    function processSetupStep1() {
        const name = document.getElementById('setupName').value.trim();
        const nid = document.getElementById('setupNationalId').value.trim();
        const ans = document.getElementById('setupSecurityAns').value.trim();
        const qId = document.getElementById('setupSecurityQText').getAttribute('data-qid');

        if(!name || !nid || !ans) return alert("لطفاً تمام موارد را تکمیل کنید.");

        // Store temporarily in app state, but don't save yet until PIN is set
        app.user.name = name;
        app.security.nationalId = nid;
        app.security.answer = ans;
        app.security.questionId = parseInt(qId);
        
        // Move to Step 2 (PIN)
        document.getElementById('setupStep1').style.display = 'none';
        document.getElementById('pinContainer').style.display = 'flex';
        document.getElementById('authTitle').innerText = "تعیین رمز عبور";
        document.getElementById('authSub').innerText = "یک رمز ۴ رقمی برای ورود تعیین کنید";
        document.getElementById('forgotPassDiv').style.display = 'none';
        document.getElementById('guestLoginBtn').style.display = 'none'; // No guest in setup
    }

    function guestLogin() {
        isGuest = true;
        // Reset to clean state for guest
        app = JSON.parse(JSON.stringify(defaultState));
        app.user.name = "مهمان";
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        renderUI();
        alert("شما وارد حساب مهمان شدید. اطلاعات ذخیره نخواهد شد.");
    }

    function pressKey(key) {
        if (key === 'del') pinBuffer = pinBuffer.slice(0, -1);
        else if (pinBuffer.length < 4) pinBuffer += key;
        updatePinDots();
        if (pinBuffer.length === 4) setTimeout(processPin, 100);
    }

    function updatePinDots() {
        for(let i=1; i<=4; i++) {
            const dot = document.getElementById(`pd${i}`);
            if (i <= pinBuffer.length) dot.classList.add('filled');
            else dot.classList.remove('filled');
        }
    }

    function processPin() {
        if (!app.security.hasPin) {
            // Confirming Setup
            if(confirm("رمز شما: " + pinBuffer + "\nآیا مطمئن هستید؟")) {
                app.security.pin = pinBuffer;
                app.security.hasPin = true;
                app.security.isSetup = true;
                if(!app.user.startDate) app.user.startDate = Date.now();
                
                saveData(); // Save everything now
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                renderUI();
            } else {
                pinBuffer = ""; updatePinDots();
            }
        } else {
            // Normal Login
            if (pinBuffer === app.security.pin) {
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('appContent').style.display = 'block';
                renderUI();
            } else {
                alert("رمز اشتباه است!");
                pinBuffer = ""; updatePinDots();
            }
        }
    }

    // Instruction 2: Recover Password (Fixed)
    function startRecovery() {
        const qId = app.security.questionId || 0;
        document.getElementById('recoveryQuestionText').innerText = securityQuestions[qId];
        document.getElementById('recoveryAnswerInput').value = '';
        document.getElementById('recoveryNationalId').value = '';
        openModal('recoveryModal');
    }

    function checkRecoveryAnswer() {
        const userAns = document.getElementById('recoveryAnswerInput').value.trim();
        const userNid = document.getElementById('recoveryNationalId').value.trim();
        
        if(userAns === app.security.answer && userNid === app.security.nationalId) {
            alert("هویت شما تایید شد. لطفاً رمز جدید را وارد کنید.");
            app.security.hasPin = false; // Reset pin status so next input sets it
            closeAllModals();
            
            // Show setup screen for PIN only
            document.getElementById('setupStep1').style.display = 'none';
            document.getElementById('pinContainer').style.display = 'flex';
            document.getElementById('authTitle').innerText = "تعیین رمز جدید";
            document.getElementById('authSub').innerText = "رمز جدید خود را وارد کنید";
            document.getElementById('forgotPassDiv').style.display = 'none';
            document.getElementById('guestLoginBtn').style.display = 'none';
            pinBuffer = ""; updatePinDots();
        } else {
            alert("اطلاعات وارد شده صحیح نمی‌باشد.");
        }
    }

    function changePin() {
        if(confirm("آیا می‌خواهید رمز را تغییر دهید؟")) {
            app.security.hasPin = false;
            app.security.pin = "";
            saveData();
            location.reload();
        }
    }

    function changeUserName() {
        const newName = prompt("نام جدید خود را وارد کنید:", app.user.name);
        if(newName && newName.trim() !== "") {
            app.user.name = newName;
            saveData();
            renderUI();
        }
    }

    // --- FORMATTING HELPERS ---
    function formatCurrency(input) {
        let val = input.value.replace(/[^\d]/g, '');
        if (!val) { input.value = ''; return; }
        input.value = Number(val).toLocaleString('en-US');
    }

    function parseFormatted(val) {
        if(!val) return 0;
        if(typeof val === 'number') return val;
        return parseInt(val.replace(/,/g, ''));
    }

    function format(n) { 
        return (n * rate).toLocaleString('en-US'); 
    }

    // --- HISTORY SYSTEM ---
    function saveSectionSnap(section) {
        if(isGuest) return;
        let snap = null;
        if(section === 'dashboard') {
            snap = JSON.stringify({ wallets: app.wallets, debts: app.debts, checks: app.checks, loans: app.loans });
        } else if(section === 'budget') {
            snap = JSON.stringify({ budgets: app.budgets, priorities: app.priorities, distributedAmount: app.distributedAmount });
        } else if(section === 'tools') {
            snap = JSON.stringify({ goals: app.goals, shopping: app.shopping });
        }
        
        if(!app.sectionHistory[section]) app.sectionHistory[section] = [];
        app.sectionHistory[section].unshift({
            time: new Date().toLocaleTimeString('fa-IR'),
            data: snap
        });
        
        if(app.sectionHistory[section].length > 10) app.sectionHistory[section].pop();
        saveData();
    }

    function showSectionHistory(section) {
        const list = document.getElementById('sectionHistoryList');
        const hist = app.sectionHistory[section] || [];
        
        if(hist.length === 0) {
            list.innerHTML = "<p style='text-align:center'>سابقه‌ای موجود نیست.</p>";
        } else {
            list.innerHTML = hist.map((h, i) => `
                <div style="padding:10px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; cursor:pointer;" onclick="restoreSectionSnap('${section}', ${i})">
                    <span>تغییر در ساعت ${h.time}</span>
                    <i class="fas fa-undo" style="color:var(--primary)"></i>
                </div>
            `).join('');
        }
        openModal('sectionHistoryModal');
    }

    function restoreSectionSnap(section, index) {
        if(!confirm("آیا مطمئن هستید که می‌خواهید به این وضعیت بازگردید؟")) return;
        
        const snap = JSON.parse(app.sectionHistory[section][index].data);
        
        if(section === 'dashboard') {
            app.wallets = snap.wallets;
            app.debts = snap.debts;
            app.checks = snap.checks;
            app.loans = snap.loans;
        } else if(section === 'budget') {
            app.budgets = snap.budgets;
            app.priorities = snap.priorities;
            app.distributedAmount = snap.distributedAmount || 0;
        } else if(section === 'tools') {
            app.goals = snap.goals;
            app.shopping = snap.shopping;
        }
        
        saveData();
        renderUI();
        closeAllModals();
    }

    // --- CORE UI RENDER ---
    function renderUI() {
        applyTheme();
        rate = app.user.currency === 'rial' ? 10 : 1;
        const curName = app.user.currency === 'toman' ? 'تومان' : 'ریال';
        
        document.getElementById('currBtnText').innerText = curName;
        document.getElementById('cardCurrency').innerText = curName;
        document.querySelectorAll('.currency-text').forEach(el => el.innerText = curName);

        if(app.user.startDate) {
            const diff = Date.now() - app.user.startDate;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            document.getElementById('daysPassedLabel').innerText = `روز ${days + 1}`;
        }

        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const fixedDebt = app.debts.reduce((a,b)=>a+b.value,0);
        const checkDebt = (app.checks || []).reduce((a,b)=>a+b.value,0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        
        const totalDebt = fixedDebt + checkDebt;
        const net = income - totalDebt - manualDeductions;

        document.getElementById('totalBalance').innerText = format(net);
        document.getElementById('totalDebtDisplay').innerText = format(totalDebt);
        document.getElementById('userNameDisplay').innerText = app.user.name;

        // Populate Date Pickers for Add Modals
        document.getElementById('dDay').innerHTML = genOpts(1,31,1);
        document.getElementById('checkDateRow').innerHTML = createDatePickerHTML('c');
        document.getElementById('loanDateRow').innerHTML = createDatePickerHTML('l');

        renderWallets();
        renderDebts();
        renderChecks(); 
        renderLoans(); 
        renderBudgets(net);
        renderGoals();
        renderShop();
    }

    function renderWallets() {
        const div = document.getElementById('walletList');
        div.innerHTML = app.wallets.map((w, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px;">
                <span style="font-weight:600">${w.name}</span>
                <div style="display:flex; align-items:center;">
                    <b style="color:var(--text-main)">${format(w.value)}</b>
                    <span style="margin-right:10px; display:flex;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('wallet', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delWallet(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderDebts() {
        const div = document.getElementById('debtList');
        div.innerHTML = app.debts.map((d, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px; color:var(--danger);">
                <span style="font-weight:600">${d.name} <small style="color:var(--text-sec)">(${d.day || 1} ماه)</small></span>
                <div style="display:flex; align-items:center;">
                    <b>${format(d.value)}</b>
                    <span style="margin-right:10px; display:flex;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('debt', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delDebt(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderChecks() {
        const div = document.getElementById('checkList');
        if(!app.checks) app.checks = [];
        div.innerHTML = app.checks.map((c, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px; color:var(--warning);">
                <div><span style="font-weight:600">${c.name}</span> <br><small style="color:var(--text-sec)">سررسید: ${c.date}</small></div>
                <div style="display:flex; align-items:center;">
                    <b>${format(c.value)}</b>
                    <span style="margin-right:10px; display:flex;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('check', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delCheck(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderLoans() {
        const div = document.getElementById('loanList');
        if(!app.loans) app.loans = [];
        div.innerHTML = app.loans.map((l, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #ddd; padding:10px; color:var(--primary);">
                <div><span style="font-weight:600">${l.name}</span> <br><small style="color:var(--text-sec)">وصول: ${l.date}</small></div>
                <div style="display:flex; align-items:center;">
                    <b>${format(l.value)}</b>
                    <span style="margin-right:10px; display:flex;">
                        <button class="btn-small-icon btn-edit" onclick="openEdit('loan', ${i})"><i class="fas fa-edit"></i></button>
                        <button class="btn-small-icon btn-del" onclick="delLoan(${i})"><i class="fas fa-trash"></i></button>
                    </span>
                </div>
            </div>
        `).join('');
    }

    function renderBudgets(net) {
        const distributeBtn = document.getElementById('btnDistribute');
        const distributableDisplay = document.getElementById('distributable');
        
        if(net !== app.distributedAmount) {
            distributeBtn.style.display = 'flex';
            distributableDisplay.style.color = 'var(--warning)';
            distributableDisplay.innerText = format(app.distributedAmount) + " (قدیمی)";
        } else {
            distributeBtn.style.display = 'none';
            distributableDisplay.style.color = 'var(--primary)';
            distributableDisplay.innerText = format(app.distributedAmount);
        }

        const div = document.getElementById('budgetGrid');
        div.innerHTML = '';
        
        let totalP = 0;
        app.budgets.forEach(b => totalP += b.percent);
        
        const badge = document.getElementById('totalPercentBadge');
        badge.innerText = totalP + '%';
        badge.style.background = totalP > 100 ? 'var(--danger)' : (totalP === 100 ? 'var(--success)' : 'var(--text-sec)');

        const baseAmount = app.distributedAmount;

        app.budgets.forEach((b, i) => {
            const shareFromPercent = Math.round((baseAmount * b.percent) / 100);
            const totalShare = shareFromPercent + (b.manualAdd || 0);
            const remain = totalShare - b.spent;
            const percent = totalShare > 0 ? (b.spent / totalShare) * 100 : 0;
            
            let status = 'stat-green';
            if(percent > 50) status = 'stat-yellow';
            if(percent > 90) status = 'stat-red';
            
            const pausedClass = b.isPaused ? 'paused' : '';
            const pausedText = b.isPaused ? '(متوقف)' : '';
            
            // Priority Indicator
            const prio = app.priorities[b.name] || 4;
            const prioColor = prio === 1 ? 'red' : (prio === 2 ? 'orange' : (prio === 3 ? 'blue' : 'gray'));

            div.innerHTML += `
                <div class="bento-item ${status} ${pausedClass}">
                    <div class="bento-header">
                        <span>
                            <i class="fas fa-circle" style="font-size:0.5rem; color:${prioColor}; margin-left:5px;" title="اولویت ${prio}"></i>
                            ${b.name} (${b.percent}%) ${pausedText} 
                        </span>
                        <div style="display:flex; gap:8px;">
                            <i class="fas fa-edit" style="font-size:0.9rem; cursor:pointer; color:var(--text-sec);" onclick="openEdit('budget', ${i})"></i>
                            <i class="fas fa-list-alt" style="opacity:0.6; cursor:pointer;" onclick="openItemHistory(${i})" title="تاریخچه"></i>
                            <i class="fas fa-trash" style="opacity:0.4; cursor:pointer;" onclick="delBudget(${i})"></i>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-size:0.85rem; margin-top:5px; color:var(--text-sec);">
                        <span>سهم: ${format(shareFromPercent)} ${b.manualAdd ? `+ ${format(b.manualAdd)}` : ''}</span>
                        <span style="color:var(--danger)">خرج: ${format(b.spent)}</span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${Math.min(percent,100)}%"></div></div>
                    <div style="text-align:left; font-weight:bold; font-size:1.2rem; color:var(--text-main); direction:ltr;">
                        ${format(remain)}
                    </div>
                    <div class="bento-actions">
                        <button class="action-chip" onclick="openExp(${i})" ${b.isPaused ? 'disabled' : ''}><i class="fas fa-minus"></i> هزینه</button>
                        <button class="action-chip" onclick="copyTxt(${remain})"><i class="fas fa-copy"></i> کپی</button>
                        <button class="action-chip btn-inject" onclick="injectBudget(${i})"><i class="fas fa-plus"></i> واریز</button>
                        <button class="action-chip btn-pause" onclick="togglePause(${i})">${b.isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>'}</button>
                    </div>
                </div>
            `;
        });
    }

    function triggerDistribution() {
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const fixedDebt = app.debts.reduce((a,b)=>a+b.value,0);
        const checkDebt = (app.checks || []).reduce((a,b)=>a+b.value,0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        const totalDebt = fixedDebt + checkDebt;
        const net = income - totalDebt - manualDeductions;

        app.distributedAmount = net;
        saveData();
        renderUI();
    }

    function injectBudget(index) {
        const amt = prompt("مبلغ واریزی مستقیم به این آیتم (از حساب اصلی کسر می‌شود):");
        if(amt && !isNaN(parseFormatted(amt))) {
            const val = parseFormatted(amt);
            saveSectionSnap('budget');
            if(!app.budgets[index].manualAdd) app.budgets[index].manualAdd = 0;
            app.budgets[index].manualAdd += val;
            
            app.distributedAmount -= val;
            
            saveData();
            renderUI();
        }
    }

    function togglePause(index) {
        saveSectionSnap('budget');
        const b = app.budgets[index];
        if(b.isPaused) {
            let restore = confirm(`آیا درصد قبلی (${b.savedPercent}%) اعمال شود؟\nتایید = بله\nلغو = خیر (وارد کردن درصد جدید)`);
            b.isPaused = false;
            if(restore) {
                b.percent = b.savedPercent;
            } else {
                const newP = prompt("درصد جدید را وارد کنید:", b.savedPercent);
                b.percent = parseInt(newP) || 0;
            }
        } else {
            b.savedPercent = b.percent;
            b.percent = 0;
            b.isPaused = true;
            alert("آیتم متوقف شد و درصد آن (0%) شد. سهم آزاد شده بین سایرین قابل توزیع است.");
        }
        saveData();
        renderUI();
    }

    function renderGoals() {
        const div = document.getElementById('goalList');
        div.innerHTML = app.goals.map((g, i) => {
            const p = g.target > 0 ? Math.min(100, Math.round((g.curr / g.target)*100)) : 0;
            return `
                <div style="padding:15px; border-bottom:1px solid #eee;">
                    <div style="display:flex; justify-content:space-between;">
                         <b>${g.name}</b> 
                         <span style="font-size:0.9rem;">
                            <button class="btn-small-icon btn-edit" onclick="openEdit('goal', ${i})"><i class="fas fa-edit"></i></button>
                            ${format(g.curr)} / ${format(g.target)}
                         </span>
                    </div>
                    <div class="progress-bar"><div class="progress-fill" style="width:${p}%; background:var(--warning);"></div></div>
                    <div style="display:flex; gap:8px; margin-top:8px;">
                         <button class="btn btn-primary" style="font-size:0.75rem; padding:4px 10px;" onclick="openAllocate('goal', ${i})"><i class="fas fa-link"></i> بودجه</button>
                         <button class="btn btn-outline" style="font-size:0.75rem; padding:4px 10px;" onclick="addGoalMoneyDirect(${i})"><i class="fas fa-plus"></i> مستقیم</button>
                         <button class="btn btn-danger" style="font-size:0.75rem; padding:4px 10px;" onclick="delGoal(${i})"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderShop() {
        const div = document.getElementById('shopList');
        div.innerHTML = app.shopping.map((s, i) => `
            <div style="display:flex; justify-content:space-between; padding:15px; border-bottom:1px solid #ddd; align-items:center; flex-wrap:wrap;">
                <div style="flex:1;">
                    <span style="font-weight:bold;">${s.name}</span>
                    ${s.price ? `<span style="font-size:0.85rem; color:var(--text-sec); display:block;">~${format(s.price)}</span>` : ''}
                </div>
                <div style="display:flex; gap:8px; align-items:center;">
                    <button class="btn btn-primary" style="font-size:0.75rem;" onclick="openAllocate('shop', ${i})">خرید با بودجه</button>
                    <button class="btn-small-icon btn-edit" onclick="openEdit('shop', ${i})"><i class="fas fa-edit"></i></button>
                    <i class="fas fa-check-circle text-success" style="cursor:pointer; font-size:1.4rem; color:var(--success);" onclick="delShop(${i})"></i>
                </div>
            </div>
        `).join('');
    }

    // --- EDIT SYSTEM (Instruction 5 - Pre-filling Data) ---
    function openEdit(type, index) {
        document.getElementById('editType').value = type;
        document.getElementById('editIndex').value = index;
        
        let item;
        let showPercent = false;
        let showAmount = true;
        let showDate = false;

        if(type === 'wallet') item = app.wallets[index];
        else if(type === 'debt') { 
            item = app.debts[index]; 
            showDate = true; 
        }
        else if(type === 'check') { item = app.checks[index]; showDate = true; }
        else if(type === 'loan') { item = app.loans[index]; showDate = true; }
        else if(type === 'budget') { item = app.budgets[index]; showPercent = true; showAmount = false; }
        else if(type === 'goal') { item = app.goals[index]; }
        else if(type === 'shop') { item = app.shopping[index]; }

        // Pre-fill Name
        document.getElementById('editName').value = item.name;
        
        // Pre-fill Amount
        if(showAmount) {
            document.getElementById('editAmountWrapper').style.display = 'block';
            let val = 0;
            if(type === 'goal') val = item.target;
            else if(type === 'shop') val = item.price || 0;
            else val = item.value;
            document.getElementById('editVal').value = val.toLocaleString('en-US');
        } else {
            document.getElementById('editAmountWrapper').style.display = 'none';
        }

        // Pre-fill Percent
        if(showPercent) {
            document.getElementById('editPercentWrapper').style.display = 'block';
            document.getElementById('editPercent').value = item.percent;
        } else {
            document.getElementById('editPercentWrapper').style.display = 'none';
        }

        // Pre-fill Date (Instruction 5 Fixed)
        if(showDate) {
            document.getElementById('editDateWrapper').style.display = 'block';
            const row = document.getElementById('editDateRow');
            if(type === 'debt') {
                row.innerHTML = `<select id="editDDay" class="date-sel" style="width:100%">${genOpts(1,31, item.day)}</select>`;
            } else {
                // Parse "YYYY/MM/DD"
                let d = 1, m = 1, y = 1403;
                if(item.date) {
                    const parts = item.date.split('/');
                    if(parts.length === 3) {
                         y = parseInt(parts[0]);
                         m = parseInt(parts[1]);
                         d = parseInt(parts[2]);
                    }
                }
                row.innerHTML = createDatePickerHTML('editD', d, m, y);
            }
        } else {
            document.getElementById('editDateWrapper').style.display = 'none';
        }

        openModal('editModal');
    }

    function performEdit() {
        const type = document.getElementById('editType').value;
        const index = parseInt(document.getElementById('editIndex').value);
        const newName = document.getElementById('editName').value;
        
        if(!newName) return alert("نام نمی‌تواند خالی باشد");

        if(type.includes('budget')) saveSectionSnap('budget');
        else if(type.includes('goal') || type.includes('shop')) saveSectionSnap('tools');
        else saveSectionSnap('dashboard');

        if(type === 'wallet') {
            app.wallets[index].name = newName;
            app.wallets[index].value = parseFormatted(document.getElementById('editVal').value);
        } else if(type === 'debt') {
            app.debts[index].name = newName;
            app.debts[index].value = parseFormatted(document.getElementById('editVal').value);
            app.debts[index].day = document.getElementById('editDDay').value;
        } else if(type === 'check') {
            app.checks[index].name = newName;
            app.checks[index].value = parseFormatted(document.getElementById('editVal').value);
            app.checks[index].date = getDateString('editD');
        } else if(type === 'loan') {
            app.loans[index].name = newName;
            app.loans[index].value = parseFormatted(document.getElementById('editVal').value);
            app.loans[index].date = getDateString('editD');
        } else if(type === 'budget') {
            const oldName = app.budgets[index].name;
            const newP = parseInt(document.getElementById('editPercent').value) || 0;
            
            let total = 0;
            app.budgets.forEach((b, i) => {
                if(i !== index) total += b.percent;
            });
            
            if(total + newP > 100) {
                tempBudget = JSON.parse(JSON.stringify(app.budgets[index]));
                tempBudget.name = newName;
                tempBudget.percent = newP;
                
                const safeMax = 100 - total;
                document.getElementById('maxAllowedPercent').innerText = safeMax + '%';
                const slider = document.getElementById('percentSlider');
                slider.max = safeMax;
                slider.value = 0;
                document.getElementById('sliderValDisplay').innerText = 0;
                
                tempBudget.isEdit = true;
                tempBudget.editIndex = index;
                
                openModal('fixPercentModal');
                return; 
            }

            app.budgets[index].name = newName;
            app.budgets[index].percent = newP;
            
            if(oldName !== newName && app.priorities[oldName]) {
                app.priorities[newName] = app.priorities[oldName];
                delete app.priorities[oldName];
            }
        } else if(type === 'goal') {
            app.goals[index].name = newName;
            app.goals[index].target = parseFormatted(document.getElementById('editVal').value);
        } else if(type === 'shop') {
            app.shopping[index].name = newName;
            app.shopping[index].price = parseFormatted(document.getElementById('editVal').value);
        }

        saveData();
        renderUI();
        closeAllModals();
    }

    // --- TEMPLATE LOGIC ---
    function applyTemplate(type) {
        if(!confirm("آیا مطمئن هستید؟ بودجه‌بندی فعلی جایگزین می‌شود.")) return;
        saveSectionSnap('budget'); 
        
        let newBudgets = [];
        if(type === 'default') {
            newBudgets = JSON.parse(JSON.stringify(defaultState.budgets));
        } else if(type === 'student') {
            newBudgets = [
                {id: 1, name: "رفت‌وآمد", percent: 30, spent: 0, history: [], manualAdd: 0},
                {id: 2, name: "غذا", percent: 25, spent: 0, history: [], manualAdd: 0},
                {id: 3, name: "نت و شارژ", percent: 15, spent: 0, history: [], manualAdd: 0},
                {id: 4, name: "جزوه و کتاب", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 5, name: "تفریح", percent: 15, spent: 0, history: [], manualAdd: 0},
                {id: 6, name: "پس‌انداز", percent: 5, spent: 0, history: [], manualAdd: 0}
            ];
        } else if(type === 'married') {
            newBudgets = [
                {id: 1, name: "اجاره", percent: 35, spent: 0, history: [], manualAdd: 0},
                {id: 2, name: "خرج منزل", percent: 25, spent: 0, history: [], manualAdd: 0},
                {id: 3, name: "قبوض", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 4, name: "درمان", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 5, name: "پوشاک", percent: 5, spent: 0, history: [], manualAdd: 0},
                {id: 6, name: "پس‌انداز", percent: 10, spent: 0, history: [], manualAdd: 0},
                {id: 7, name: "تفریح", percent: 5, spent: 0, history: [], manualAdd: 0}
            ];
        } else if(type === 'clear') {
            newBudgets = [];
        }
        
        app.budgets = newBudgets;
        saveData();
        renderUI();
    }

    // --- ACTIONS ---
    function addWallet() {
        const n = document.getElementById('wName').value;
        const v = parseFormatted(document.getElementById('wVal').value);
        if(n && !isNaN(v)) { 
            saveSectionSnap('dashboard');
            app.wallets.push({name:n, value:v}); 
            saveData(); renderUI(); closeAllModals(); 
        }
    }
    function delWallet(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.wallets.splice(i,1); saveData(); renderUI(); } }

    function addDebt() {
        const n = document.getElementById('dName').value;
        const v = parseFormatted(document.getElementById('dVal').value);
        const d = document.getElementById('dDay').value;
        if(n && !isNaN(v)) { saveSectionSnap('dashboard'); app.debts.push({name:n, value:v, day:d}); saveData(); renderUI(); closeAllModals(); }
    }
    function delDebt(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.debts.splice(i,1); saveData(); renderUI(); } }

    function addCheck() {
        const n = document.getElementById('cName').value;
        const v = parseFormatted(document.getElementById('cVal').value);
        const d = getDateString('c');
        if(n && !isNaN(v)) { 
            saveSectionSnap('dashboard');
            if(!app.checks) app.checks = [];
            app.checks.push({name:n, value:v, date:d}); 
            saveData(); renderUI(); closeAllModals(); 
        }
    }
    function delCheck(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.checks.splice(i,1); saveData(); renderUI(); } }

    function addLoan() {
        const n = document.getElementById('lName').value;
        const v = parseFormatted(document.getElementById('lVal').value);
        const d = getDateString('l');
        if(n && !isNaN(v)) {
            saveSectionSnap('dashboard');
            if(!app.loans) app.loans = [];
            app.loans.push({name:n, value:v, date:d});
            saveData(); renderUI(); closeAllModals();
        }
    }
    function delLoan(i) { if(confirm('حذف؟')) { saveSectionSnap('dashboard'); app.loans.splice(i,1); saveData(); renderUI(); } }

    // --- BUDGET ADDITION & AUTO CORRECTION (Instruction 3) ---
    function addNewBudget() {
        const n = document.getElementById('bName').value;
        const p = parseInt(document.getElementById('bPercent').value);
        
        if(!n || isNaN(p)) return alert("لطفا مقادیر صحیح وارد کنید");

        let currentTotal = 0;
        app.budgets.forEach(b => currentTotal += b.percent);

        if (currentTotal + p > 100) {
            tempBudget = { name: n, percent: p, id: Date.now(), spent: 0, history: [], manualAdd: 0, isEdit: false };
            
            const max = 100 - currentTotal;
            const safeMax = max > 0 ? max : 0;
            
            document.getElementById('maxAllowedPercent').innerText = safeMax + '%';
            
            const slider = document.getElementById('percentSlider');
            slider.max = safeMax;
            slider.value = 0;
            document.getElementById('sliderValDisplay').innerText = 0;
            
            openModal('fixPercentModal');
        } else {
            saveSectionSnap('budget');
            app.budgets.push({id:Date.now(), name:n, percent:p, spent:0, history:[], manualAdd: 0});
            // Assign default priority (Low)
            if (!app.priorities[n]) app.priorities[n] = 4;
            saveData(); renderUI(); closeAllModals();
        }
    }

    function updateSliderVal() {
        document.getElementById('sliderValDisplay').innerText = document.getElementById('percentSlider').value;
    }

    function useSliderPercent() {
        if(!tempBudget) return;
        saveSectionSnap('budget');
        
        const newP = parseInt(document.getElementById('percentSlider').value);
        
        if(tempBudget.isEdit) {
            app.budgets[tempBudget.editIndex].name = tempBudget.name;
            app.budgets[tempBudget.editIndex].percent = newP;
        } else {
            tempBudget.percent = newP;
            app.budgets.push(tempBudget);
            if (!app.priorities[tempBudget.name]) app.priorities[tempBudget.name] = 4;
        }
        
        saveData(); renderUI(); closeAllModals();
        tempBudget = null;
    }

    // Instruction 3: Enhanced Auto-Correction Logic
    function autoCorrectBudget() {
        if(!tempBudget) return;
        saveSectionSnap('budget');
        
        // Exclude the item being edited from the current total calculation
        let currentTotal = 0;
        app.budgets.forEach((b,i) => {
            if(tempBudget.isEdit && i === tempBudget.editIndex) return; 
            currentTotal += b.percent;
        });
        
        const needed = tempBudget.percent;
        const allowZero = document.getElementById('allowZeroCheck').checked;
        
        let overflow = (currentTotal + needed) - 100;
        
        // If no overflow, just add/update
        if(overflow <= 0) {
            if(tempBudget.isEdit) {
                 app.budgets[tempBudget.editIndex].name = tempBudget.name;
                 app.budgets[tempBudget.editIndex].percent = needed;
            } else {
                app.budgets.push(tempBudget);
            }
            saveData(); renderUI(); closeAllModals();
            return;
        }

        // Sort existing budgets by Priority (4=Low is first to go, 1=High is last)
        // We create a list of candidates
        let candidates = app.budgets.map((b, index) => {
            if(tempBudget.isEdit && index === tempBudget.editIndex) return null; 
            return {
                index: index,
                name: b.name,
                priority: app.priorities[b.name] || 4, // Default Low
                percent: b.percent
            };
        }).filter(x => x !== null).sort((a, b) => b.priority - a.priority); // Descending: 4, 3, 2, 1

        for (let item of candidates) {
            if (overflow <= 0) break;
            
            let currentP = item.percent;
            let deductible = currentP;
            if(!allowZero && currentP > 0) {
                deductible = currentP - 1; // Keep at least 1%
            }
            
            if (deductible >= overflow) {
                app.budgets[item.index].percent -= overflow;
                overflow = 0;
            } else {
                app.budgets[item.index].percent -= deductible;
                overflow -= deductible;
            }
        }

        if(overflow > 0) {
            alert("امکان اصلاح خودکار کامل وجود ندارد (اولویت‌ها اجازه کاهش بیشتر را نمی‌دهند).");
             // Restore backup
             const lastSnap = JSON.parse(app.sectionHistory['budget'][0].data);
             app.budgets = lastSnap.budgets;
             return;
        }

        if(tempBudget.isEdit) {
             app.budgets[tempBudget.editIndex].name = tempBudget.name;
             app.budgets[tempBudget.editIndex].percent = needed;
        } else {
            app.budgets.push(tempBudget);
            if (!app.priorities[tempBudget.name]) app.priorities[tempBudget.name] = 4;
        }

        saveData(); renderUI(); closeAllModals();
        tempBudget = null;
    }

    // --- PRIORITY SETTINGS (Instruction 3 Fix) ---
    function openPrioritySettings() {
        const list = document.getElementById('priorityList');
        
        if(!app.priorities) app.priorities = defaultState.priorities;
        if(!app.priorityRanges) app.priorityRanges = {low: 40, mid: 70};

        document.getElementById('pRangeLow').value = app.priorityRanges.low;
        document.getElementById('pRangeMid').value = app.priorityRanges.mid;

        const frag = document.createDocumentFragment();
        
        // Collect all budget names + existing priority keys
        const allNames = new Set();
        app.budgets.forEach(b => allNames.add(b.name));
        Object.keys(app.priorities).forEach(k => {
             // Only add if it maps to a currently existing budget to avoid clutter
             if(app.budgets.find(b => b.name === k)) allNames.add(k);
        });

        allNames.forEach(name => {
            let p = app.priorities[name] || 4;
            const div = document.createElement('div');
            div.style.cssText = "display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:10px;";
            div.innerHTML = `
                <span style="font-size:0.9rem; font-weight:bold;">${name}</span>
                <select class="priority-select" data-name="${name}" style="width:130px; margin:0; padding:6px; font-size:0.8rem; border-radius:8px;">
                    <option value="1" ${p==1?'selected':''}>🔴 خیلی مهم (1)</option>
                    <option value="2" ${p==2?'selected':''}>🟠 مهم (2)</option>
                    <option value="3" ${p==3?'selected':''}>🔵 متوسط (3)</option>
                    <option value="4" ${p==4?'selected':''}>⚪ کم (4)</option>
                </select>
            `;
            frag.appendChild(div);
        });
        
        list.innerHTML = '';
        list.appendChild(frag);
        openModal('prioritySettingsModal');
    }

    function savePriorityRanges() {
        const l = parseInt(document.getElementById('pRangeLow').value);
        const m = parseInt(document.getElementById('pRangeMid').value);
        if(!isNaN(l) && !isNaN(m)) {
            app.priorityRanges.low = l;
            app.priorityRanges.mid = m;
            saveData();
            alert("بازه ها ذخیره شدند.");
        }
    }

    function savePriorities() {
        saveSectionSnap('budget');
        const selects = document.querySelectorAll('.priority-select');
        selects.forEach(sel => {
            app.priorities[sel.getAttribute('data-name')] = parseInt(sel.value);
        });
        saveData();
        closeAllModals();
        renderUI(); // Re-render to show priority dots
        alert("اولویت‌ها ذخیره شدند.");
    }

    function delBudget(i) { if(confirm('حذف ردیف؟')) { saveSectionSnap('budget'); app.budgets.splice(i,1); saveData(); renderUI(); } }

    let activeIdx = -1;
    function openExp(i) { activeIdx = i; openModal('expModal'); }
    function submitExp() {
        const v = parseFormatted(document.getElementById('expAmt').value);
        const r = document.getElementById('expReason').value || 'بدون توضیح';
        if(!isNaN(v) && activeIdx > -1) { 
            saveSectionSnap('budget');
            app.budgets[activeIdx].spent += v;
            addToHistory(activeIdx, v, r);
            saveData(); renderUI(); closeAllModals(); 
        }
    }

    function addToHistory(bIdx, amount, reason) {
        if(!app.budgets[bIdx].history) app.budgets[bIdx].history = [];
        app.budgets[bIdx].history.push({
            amount: amount,
            reason: reason,
            date: new Date().toLocaleDateString('fa-IR'),
            time: new Date().toLocaleTimeString('fa-IR')
        });
    }

    function openItemHistory(i) {
        const hList = document.getElementById('itemHistList');
        const hist = app.budgets[i].history || [];
        if(hist.length === 0) {
            hList.innerHTML = '<p style="text-align:center;">موردی یافت نشد.</p>';
        } else {
            hList.innerHTML = hist.slice().reverse().map(h => `
                <div style="border-bottom:1px solid #eee; padding:10px 0;">
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        <span>${h.reason}</span>
                        <span style="color:var(--danger)">${format(h.amount)}</span>
                    </div>
                    <div style="font-size:0.75rem; color:var(--text-sec); margin-top:3px;">
                        <i class="far fa-clock"></i> ${h.date} - ${h.time}
                    </div>
                </div>
            `).join('');
        }
        openModal('itemHistModal');
    }

    function addGoal() {
        const n = document.getElementById('gName').value;
        const t = parseFormatted(document.getElementById('gTarget').value);
        if(n && !isNaN(t)) { saveSectionSnap('tools'); app.goals.push({name:n, target:t, curr:0}); saveData(); renderUI(); closeAllModals(); }
    }
    function addGoalMoneyDirect(i) {
        const v = prompt("مبلغ واریزی مستقیم:");
        if(v) { saveSectionSnap('tools'); app.goals[i].curr += parseInt(v); saveData(); renderUI(); }
    }
    function delGoal(i) { saveSectionSnap('tools'); app.goals.splice(i,1); saveData(); renderUI(); }

    function addShop() {
        const n = document.getElementById('sName').value;
        const p = parseFormatted(document.getElementById('sPrice').value);
        if(n) { saveSectionSnap('tools'); app.shopping.push({name:n, price: p || 0}); saveData(); renderUI(); closeAllModals(); }
    }
    function delShop(i) { saveSectionSnap('tools'); app.shopping.splice(i,1); saveData(); renderUI(); }

    // --- ALLOCATION LOGIC ---
    function openAllocate(type, id) {
        document.getElementById('allocType').value = type;
        document.getElementById('allocId').value = id;
        
        const sel = document.getElementById('allocBudgetSelect');
        sel.innerHTML = app.budgets.map((b, i) => `<option value="${i}">${b.name}</option>`).join('');
        
        // Auto fill price if shopping
        if(type === 'shop' && app.shopping[id].price) {
            document.getElementById('allocAmt').value = app.shopping[id].price.toLocaleString('en-US');
        } else {
            document.getElementById('allocAmt').value = '';
        }
        
        openModal('allocModal');
    }

    function performAllocation() {
        const type = document.getElementById('allocType').value;
        const id = parseInt(document.getElementById('allocId').value);
        const bIdx = parseInt(document.getElementById('allocBudgetSelect').value);
        const amt = parseFormatted(document.getElementById('allocAmt').value);

        if(isNaN(amt) || amt <= 0) return alert("مبلغ نامعتبر");

        saveSectionSnap('budget'); 
        saveSectionSnap('tools'); 

        app.budgets[bIdx].spent += amt;
        
        let reason = "";
        if(type === 'goal') {
            app.goals[id].curr += amt;
            reason = "اختصاص به هدف: " + app.goals[id].name;
        } else {
            reason = "خرید کالا: " + app.shopping[id].name;
        }

        addToHistory(bIdx, amt, reason);
        saveData();
        renderUI();
        closeAllModals();
        alert("تراکنش با موفقیت ثبت شد.");
    }

    // --- UTILS ---
    function toggleCurrency() {
        app.user.currency = app.user.currency === 'toman' ? 'rial' : 'toman';
        const btn = document.getElementById('currBtn');
        if(app.user.currency === 'rial') btn.classList.add('active');
        else btn.classList.remove('active');
        saveData(); renderUI();
    }
    
    function toggleTheme() {
        if(document.body.getAttribute('data-theme') === 'dark') {
            document.body.removeAttribute('data-theme'); app.user.theme = 'light';
        } else {
            document.body.setAttribute('data-theme', 'dark'); app.user.theme = 'dark';
        }
        saveData();
    }
    function applyTheme() {
        if(app.user.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    function generateReportImage() {
        const income = app.wallets.reduce((a,b)=>a+b.value,0);
        const totalDebt = app.debts.reduce((a,b)=>a+b.value,0) + (app.checks || []).reduce((a,b)=>a+b.value,0);
        const manualDeductions = app.budgets.reduce((a,b) => a + (b.manualAdd || 0), 0);
        const net = income - totalDebt - manualDeductions;
        const days = app.user.startDate ? Math.floor((Date.now() - app.user.startDate)/(1000*60*60*24))+1 : 0;

        document.getElementById('printDate').innerText = new Date().toLocaleDateString('fa-IR');
        document.getElementById('printUser').innerText = app.user.name;
        document.getElementById('printDays').innerText = days;
        document.getElementById('printInc').innerText = format(income);
        document.getElementById('printDebt').innerText = format(totalDebt);
        document.getElementById('printNet').innerText = format(net);

        if(app.dailyLogs && app.dailyLogs.length > 0) {
            const ctx = document.getElementById('printChart').getContext('2d');
            if(window.myPrintChart) window.myPrintChart.destroy();
            const logs = app.dailyLogs.slice(-15);
            window.myPrintChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: logs.map(l => l.date),
                    datasets: [{
                        label: 'خالص دارایی',
                        data: logs.map(l => l.net),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        fill: true
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
            document.getElementById('printHistoryTable').innerHTML = logs.map(l => `<tr><td>${l.date}</td><td>${format(l.net)}</td><td>${format(l.spent)}</td></tr>`).join('');
        }

        const tb = document.getElementById('printBody');
        tb.innerHTML = '';
        app.budgets.forEach(b => {
            const baseAmount = app.distributedAmount;
            const s = Math.round((baseAmount * b.percent) / 100) + (b.manualAdd || 0);
            tb.innerHTML += `<tr><td>${b.name}</td><td>${b.percent}%</td><td>${format(s)}</td><td>${format(b.spent)}</td><td>${format(s-b.spent)}</td></tr>`;
        });

        const dList = document.getElementById('printDebtsList');
        let debtHtml = "";
        app.debts.forEach(d => debtHtml += `<div>${d.name}: ${format(d.value)}</div>`);
        app.checks.forEach(c => debtHtml += `<div>چک (${c.name}): ${format(c.value)} - ${c.date}</div>`);
        dList.innerHTML = debtHtml || "ندارد";

        const gList = document.getElementById('printGoalsList');
        let goalHtml = "";
        app.goals.forEach(g => goalHtml += `<div>${g.name}: ${format(g.curr)} / ${format(g.target)}</div>`);
        gList.innerHTML = goalHtml || "ندارد";

        const el = document.getElementById('printArea');
        el.style.top = "0";
        setTimeout(() => {
            html2canvas(el).then(c => {
                const a = document.createElement('a');
                a.download = `Financial_Report_${days}Days.png`; a.href = c.toDataURL(); a.click();
                el.style.top = "-9999px";
            });
        }, 1200);
    }

    function downloadBackup() {
        if(isGuest) return alert("در حالت مهمان امکان بکاپ وجود ندارد.");
        const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(app));
        const a = document.createElement('a');
        a.href = str; a.download = "backup_v15.json"; a.click();
        app.history.unshift({date: Date.now(), name: "بکاپ دستی"});
        saveData();
    }

    function restoreBackup(input) {
        if(isGuest) return alert("در حالت مهمان امکان بازیابی وجود ندارد.");
        const file = input.files[0];
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const backup = JSON.parse(e.target.result);
                // Merge strategies to ensure v15 compatibility
                app = { ...defaultState, ...backup };
                
                // Deep merge necessary objects
                if(!app.security.nationalId) app.security.nationalId = "";
                if(!app.priorities) app.priorities = defaultState.priorities;
                
                saveData();
                location.reload();
            } catch(err) { alert("فایل نامعتبر"); }
        };
        reader.readAsText(file);
    }

    function showHistory() {
        const d = document.getElementById('histList');
        d.innerHTML = app.history.map(h => 
            `<div style="padding:5px; border-bottom:1px solid #eee;">${h.name} - ${new Date(h.date).toLocaleDateString('fa-IR')}</div>`
        ).join('');
        openModal('histModal');
    }

    function resetAll() {
        if(confirm("هشدار: تمام اطلاعات پاک خواهد شد. ادامه می‌دهید؟")) { localStorage.removeItem('amir_fin_v9'); location.reload(); }
    }

    function copyTxt(n) {
        const raw = document.getElementById('rawCopyCheck').checked;
        const txt = raw ? (n*rate).toString() : format(n);
        navigator.clipboard.writeText(txt);
        alert("کپی شد: " + txt);
    }
    
    function loadData() {
        const d = localStorage.getItem('amir_fin_v9');
        if(d) {
            const loaded = JSON.parse(d);
            app = { ...defaultState, ...loaded };
            
            // Re-ensure defaults for new props
            if(!app.security.nationalId) app.security.nationalId = "";
            if(!app.dailyLogs) app.dailyLogs = [];
            if(!app.sectionHistory) app.sectionHistory = { dashboard: [], budget: [], tools: [] };
        }
    }
    
    function saveData() {
        if(!isGuest) {
            localStorage.setItem('amir_fin_v9', JSON.stringify(app));
        }
    }
    
    function updateDate() {
        document.getElementById('headerDate').innerText = new Date().toLocaleDateString('fa-IR', {weekday:'long', day:'numeric', month:'long'});
    }

    // --- UI NAVIGATION ---
    function switchTab(id) {
        document.querySelectorAll('.tab-pane').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+id).classList.add('active');
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach(b => {
            if(b.getAttribute('onclick').includes(id)) b.classList.add('active');
        });
    }
    function openModal(id) { 
        if(id === 'prioritySettingsModal') {
            openPrioritySettings(); 
        }
        
        const m = document.getElementById(id);
        const inputs = m.querySelectorAll('input');
        inputs.forEach(i => {
            if(i.type !== 'hidden' && i.type !== 'checkbox' && i.type !== 'range' && i.id !== 'pRangeLow' && i.id !== 'pRangeMid' && !i.value) i.value = '';
        });
        m.classList.add('active'); 
    }
    function closeAllModals() { document.querySelectorAll('.modal').forEach(e => e.classList.remove('active')); }

</script>

</body>
</html>
