<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ | Ù†Ø³Ø®Ù‡ V4.0</title>
    <!-- ÙÙˆÙ†Øª Ùˆ Ø¢ÛŒÚ©ÙˆÙ† -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #f1f5f9;
            --primary: #2563eb;         /* Ø¢Ø¨ÛŒ */
            --primary-dark: #1e40af;
            --success: #10b981;         /* Ø³Ø¨Ø² */
            --warning: #f59e0b;         /* Ø²Ø±Ø¯ */
            --danger: #ef4444;          /* Ù‚Ø±Ù…Ø² */
            --text-main: #0f172a;
            --text-light: #64748b;
            --card-bg: #ffffff;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .app-container {
            width: 100%;
            max-width: 1000px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            overflow: hidden; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¨ÛŒØ±ÙˆÙ† Ø²Ø¯Ú¯ÛŒ */
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            background: #1e293b;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        header h1 {
            margin: 0;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }
        .btn-icon:hover { background: rgba(255,255,255,0.2); }

        /* --- DASHBOARD CONTROL --- */
        .controls-panel {
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 0.8rem;
            color: var(--text-light);
            font-weight: bold;
        }

        select, .btn-scenario {
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: #f8fafc;
            font-size: 0.9rem;
            width: 100%;
            cursor: pointer;
        }

        .scenarios {
            display: flex;
            gap: 5px;
        }
        
        .btn-scenario {
            background: #eff6ff;
            color: var(--primary);
            border: 1px solid #bfdbfe;
            text-align: center;
            transition: 0.2s;
        }
        .btn-scenario:hover { background: var(--primary); color: white; }

        /* --- MAIN INPUT --- */
        .income-section {
            background: linear-gradient(to right, #eff6ff, #fff);
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .big-input-wrapper {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        .big-input {
            width: 100%;
            padding: 12px 15px;
            font-size: 1.5rem;
            text-align: center;
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-weight: 800;
            color: var(--primary-dark);
            direction: ltr; /* Ø¹Ø¯Ø¯ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ */
        }

        .percent-status {
            margin-top: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        /* --- CHART SECTION --- */
        .chart-container {
            padding: 20px;
            display: flex;
            justify-content: center;
            background: #fff;
            border-bottom: 1px solid var(--border);
            max-height: 300px;
        }
        
        canvas {
            max-width: 100%;
            max-height: 250px;
        }

        /* --- BUDGET ITEMS (Cards) --- */
        .items-container {
            padding: 20px;
            background: #f8fafc;
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }

        /* Ø·Ø±Ø§Ø­ÛŒ Ú©Ø§Ø±Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø±Ø¯ÛŒÙ */
        .budget-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 12px;
            transition: transform 0.2s;
        }

        .budget-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
        }

        /* Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ Ú©Ø§Ø±Øª: Ù†Ø§Ù… Ùˆ Ø¯Ø±ØµØ¯ */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .item-name-input {
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            width: 100%;
            background: transparent;
            border-bottom: 1px dashed transparent;
        }
        .item-name-input:focus { border-bottom-color: var(--primary); }

        .percent-input-wrapper {
            position: relative;
            width: 70px;
            flex-shrink: 0;
        }
        .percent-input {
            width: 100%;
            padding: 5px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-weight: bold;
            background: #f1f5f9;
            direction: ltr;
        }
        .percent-symbol {
            position: absolute;
            left: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: #64748b;
        }

        /* Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ…: Ø§Ø¹Ø¯Ø§Ø¯ (Ø¨ÙˆØ¯Ø¬Ù‡ØŒ Ø®Ø±Ø¬ Ø´Ø¯Ù‡ØŒ Ù…Ø§Ù†Ø¯Ù‡) */
        .card-body {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
            align-items: center;
        }

        .stat-box {
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .stat-label { font-size: 0.75rem; color: var(--text-light); }
        
        .stat-value { 
            font-weight: 800; 
            font-size: 0.95rem; 
            color: var(--primary);
            cursor: pointer;
        }

        /* Ø§ÛŒÙ†Ù¾ÙˆØª Ø®Ø±Ø¬ Ú©Ø±Ø¯ */
        .expense-input {
            width: 100%;
            padding: 5px;
            text-align: center;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 0.9rem;
            color: var(--danger);
            direction: ltr;
        }

        .remaining-value { color: var(--success); }
        .remaining-value.negative { color: var(--danger); }

        /* Ø±Ø¯ÛŒÙ Ø³ÙˆÙ…: Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .card-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #f1f5f9;
            padding-top: 10px;
        }

        .btn-mini {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-copy { background: #dbeafe; color: var(--primary); }
        .btn-delete { background: #fee2e2; color: var(--danger); }

        /* --- FOOTER ACTION --- */
        .fab-container {
            position: sticky;
            bottom: 20px;
            right: 20px;
            display: flex;
            justify-content: center;
            pointer-events: none; /* ØªØ§ Ø±ÙˆÛŒ Ù…Ø­ØªÙˆØ§ Ø±Ø§ Ù†Ú¯ÛŒØ±Ø¯ */
        }
        
        .add-btn-float {
            pointer-events: auto;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: bold;
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }
        .add-btn-float:active { transform: scale(0.95); }

        /* --- TOAST --- */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-100px);
            background: #1e293b;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 0.9rem;
            opacity: 0;
            transition: 0.3s;
            z-index: 100;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }

        @media (min-width: 768px) {
            .items-container { grid-template-columns: 1fr 1fr; } /* Ø¯Ùˆ Ø³ØªÙˆÙ†Ù‡ Ø¯Ø± ØªØ¨Ù„Øª/PC */
        }
    </style>
</head>
<body>

<div class="app-container">
    
    <!-- Ù‡Ø¯Ø± -->
    <header>
        <h1><i class="fas fa-chart-pie"></i> Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§Ù„ÛŒ Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ†</h1>
        <div class="header-actions">
            <button class="btn-icon" onclick="exportData()" title="Ø®Ø±ÙˆØ¬ÛŒ ÙØ§ÛŒÙ„"><i class="fas fa-download"></i></button>
            <button class="btn-icon" style="background:#ef4444;" onclick="resetApp()" title="Ø±ÛŒØ³Øª Ú©Ø§Ù…Ù„"><i class="fas fa-trash"></i></button>
        </div>
    </header>

    <!-- Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ Ùˆ Ø³Ù†Ø§Ø±ÛŒÙˆ -->
    <div class="controls-panel">
        <div class="control-group">
            <label>Ø­Ø§Ù„Øª Ú©Ù¾ÛŒ:</label>
            <select id="copyModeSelector">
                <option value="formatted">Ø¨Ø§ Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ (Û±,Û°Û°Û°)</option>
                <option value="raw">Ø®Ø§Ù… (1000)</option>
            </select>
        </div>
        <div class="control-group">
            <label>Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§:</label>
            <div class="scenarios">
                <button class="btn-scenario" onclick="applyScenario('default')">Ø¹Ø§Ø¯ÛŒ</button>
                <button class="btn-scenario" onclick="applyScenario('survival')">Ø¨Ù‚Ø§ âš ï¸</button>
                <button class="btn-scenario" onclick="applyScenario('travel')">Ø³ÙØ± âœˆï¸</button>
            </div>
        </div>
    </div>

    <!-- ÙˆØ±ÙˆØ¯ÛŒ Ø§ØµÙ„ÛŒ -->
    <div class="income-section">
        <label style="display:block; margin-bottom:10px; font-weight:bold;">ğŸ’° Ú©Ù„ Ù¾ÙˆÙ„ Ø¯Ø±ÛŒØ§ÙØªÛŒ (ØªÙˆÙ…Ø§Ù†):</label>
        <div class="big-input-wrapper">
            <!-- pattern Ùˆ inputmode Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ ØªØ§ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø¹Ø¯Ø¯ÛŒ Ø¨Ø§Ø² Ø´ÙˆØ¯ -->
            <input type="text" id="totalInput" class="big-input" placeholder="0" inputmode="numeric" oninput="handleTotalChange(this)">
        </div>
        <div class="percent-status">
            <span id="totalPercentTxt">Ø¬Ù…Ø¹: Û°Ùª</span>
            <span id="statusMessage">...</span>
        </div>
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <div class="chart-container">
        <canvas id="budgetChart"></canvas>
    </div>

    <!-- Ù„ÛŒØ³Øª Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ -->
    <div id="itemsList" class="items-container">
        <!-- JS fills this -->
    </div>

    <!-- Ø¯Ú©Ù…Ù‡ Ø´Ù†Ø§ÙˆØ± Ø§ÙØ²ÙˆØ¯Ù† -->
    <div style="height: 80px;"></div> <!-- ÙØ¶Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø³Ú©Ø±ÙˆÙ„ -->
    <div class="fab-container">
        <button class="add-btn-float" onclick="addNewItem()">
            <i class="fas fa-plus"></i> Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯
        </button>
    </div>

</div>

<!-- Ù¾ÛŒØ§Ù… Ú©Ù¾ÛŒ -->
<div id="toast" class="toast">Ú©Ù¾ÛŒ Ø´Ø¯!</div>

<script>
    // --- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÙ‡ ---
    const defaultItems = [
        { id: 1, name: "Û±. Ú©Ø±Ø§ÛŒÙ‡ Ø´Ù‡Ø±ÛŒ", percent: 27, spent: 0 },
        { id: 2, name: "Û². Ø®ÙˆØ±Ø§Ú© Ùˆ Ù†Ø§Ù†", percent: 12, spent: 0 },
        { id: 3, name: "Û³. Ø³ÙØ± (Ù…Ø´Ù‡Ø¯)", percent: 25, spent: 0 },
        { id: 4, name: "Û´. Ø¯ÙˆØ§ Ùˆ Ø¯Ø±Ù…Ø§Ù†", percent: 3, spent: 0 },
        { id: 5, name: "Ûµ. Ø´Ø§Ø±Ú˜ Ùˆ Ù†Øª", percent: 10, spent: 0 },
        { id: 6, name: "Û¶. Ø²ÛŒØ¨Ø§ÛŒÛŒ Ùˆ Ù…Ú©Ù…Ù„", percent: 7, spent: 0 },
        { id: 7, name: "Û·. Ù„Ø¨Ø§Ø³", percent: 5, spent: 0 },
        { id: 8, name: "Û¸. Ø¶Ø±ÙˆØ±ÛŒ", percent: 5, spent: 0 },
        { id: 9, name: "Û¹. ØªÙØ±ÛŒØ­", percent: 3, spent: 0 },
        { id: 10, name: "Û±Û°. Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²", percent: 3, spent: 0 }
    ];

    // Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§
    const scenarios = {
        default: defaultItems,
        survival: [ // Ø­Ø§Ù„Øª Ø¨Ù‚Ø§: ÙÙ‚Ø· ØºØ°Ø§ Ùˆ Ú©Ø±Ø§ÛŒÙ‡
            { name: "Û±. Ú©Ø±Ø§ÛŒÙ‡ Ø´Ù‡Ø±ÛŒ", percent: 40, spent: 0 },
            { name: "Û². Ø®ÙˆØ±Ø§Ú© Ø­ÛŒØ§ØªÛŒ", percent: 40, spent: 0 },
            { name: "Û³. Ø´Ø§Ø±Ú˜ Ùˆ Ù†Øª", percent: 10, spent: 0 },
            { name: "Û´. Ø¯Ø±Ù…Ø§Ù†", percent: 10, spent: 0 },
            { name: "Ûµ. Ù…ØªÙØ±Ù‚Ù‡", percent: 0, spent: 0 }
        ],
        travel: [ // Ø­Ø§Ù„Øª Ø³ÙØ±: ØªÙ…Ø±Ú©Ø² Ø±ÙˆÛŒ Ø°Ø®ÛŒØ±Ù‡
            { name: "Û±. Ú©Ø±Ø§ÛŒÙ‡ Ø´Ù‡Ø±ÛŒ", percent: 25, spent: 0 },
            { name: "Û². Ø®ÙˆØ±Ø§Ú©", percent: 10, spent: 0 },
            { name: "Û³. Ø³ÙØ± (ÙÙˆØ±ÛŒ)", percent: 50, spent: 0 }, // ÛµÛ° Ø¯Ø±ØµØ¯!
            { name: "Û´. Ø´Ø§Ø±Ú˜ Ùˆ Ù†Øª", percent: 10, spent: 0 },
            { name: "Ûµ. Ø³Ø§ÛŒØ±", percent: 5, spent: 0 }
        ]
    };

    let appData = {
        totalIncome: 0,
        items: JSON.parse(JSON.stringify(defaultItems))
    };

    let chartInstance = null;

    // --- ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ---

    function init() {
        loadData();
        renderItems();
        updateChart();
    }

    function loadData() {
        const saved = localStorage.getItem('amir_budget_v4');
        if (saved) {
            appData = JSON.parse(saved);
            // Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¹Ø¯Ø¯ ÙØ±Ù…Øª Ø´Ø¯Ù‡ Ø¨Ù‡ Ø§ÛŒÙ†Ù¾ÙˆØª
            document.getElementById('totalInput').value = formatNumber(appData.totalIncome);
        }
    }

    function saveData() {
        localStorage.setItem('amir_budget_v4', JSON.stringify(appData));
        updateUIStats();
        updateChart();
    }

    function handleTotalChange(el) {
        // ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ù‚Ø¨ÙˆÙ„ Ú©Ù† (Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ)
        let raw = toEnglishDigits(el.value).replace(/[^0-9]/g, '');
        
        if (raw === '') {
            appData.totalIncome = 0;
            el.value = '';
        } else {
            appData.totalIncome = parseInt(raw);
            el.value = parseInt(raw).toLocaleString('en-US');
        }
        saveData();
        renderItems(); // Ø¨Ø§Ø²Ø³Ø§Ø²ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ±
    }

    function updateItem(index, key, value) {
        if (key === 'percent') {
            appData.items[index].percent = parseFloat(toEnglishDigits(value)) || 0;
        } else if (key === 'name') {
            appData.items[index].name = value;
        } else if (key === 'spent') {
            let clean = toEnglishDigits(value).replace(/[^0-9]/g, '');
            appData.items[index].spent = parseInt(clean) || 0;
        }
        saveData();
        // ÙÙ‚Ø· Ø§Ú¯Ø± Ø¯Ø±ØµØ¯ Ø¹ÙˆØ¶ Ø´Ø¯ Ø±Ù†Ø¯Ø± Ú©Ù†ØŒ Ø§Ú¯Ø± Ø®Ø±Ø¬ Ú©Ø±Ø¯ Ø¹ÙˆØ¶ Ø´Ø¯ ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ù…Ø§Ù†Ø¯Ù‡ Ø¢Ù¾Ø¯ÛŒØª Ø´Ù‡ (Ø¨Ø±Ø§ÛŒ Ù¾Ø±Ø´ Ù†Ú©Ø±Ø¯Ù† ÙÙˆÚ©ÙˆØ³)
        if (key !== 'spent') renderItems(); 
        else {
            // Ø¢Ù¾Ø¯ÛŒØª ØªÚ©ÛŒ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±Ø´ ÙÙˆÚ©ÙˆØ³
            const budget = (appData.totalIncome * appData.items[index].percent) / 100;
            const remaining = budget - appData.items[index].spent;
            const row = document.querySelectorAll('.budget-card')[index];
            const remEl = row.querySelector('.remaining-value');
            remEl.innerText = formatNumber(remaining);
            remEl.className = remaining < 0 ? 'stat-value remaining-value negative' : 'stat-value remaining-value';
            updateChart();
        }
    }

    function addNewItem() {
        appData.items.push({ name: 'Ø¬Ø¯ÛŒØ¯', percent: 0, spent: 0 });
        saveData();
        renderItems();
    }

    function deleteItem(index) {
        if(confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
            appData.items.splice(index, 1);
            saveData();
            renderItems();
        }
    }

    function applyScenario(type) {
        if(confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.")) {
            if (scenarios[type]) {
                // Ú©Ù¾ÛŒ Ø¹Ù…ÛŒÙ‚
                appData.items = JSON.parse(JSON.stringify(scenarios[type]));
                saveData();
                renderItems();
            }
        }
    }

    function resetApp() {
        if(confirm("Ù‡Ù…Ù‡ Ú†ÛŒØ² Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            localStorage.removeItem('amir_budget_v4');
            location.reload();
        }
    }

    function exportData() {
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "budget_backup.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    // --- Ø±Ù†Ø¯Ø± Ú©Ø±Ø¯Ù† ---

    function renderItems() {
        const container = document.getElementById('itemsList');
        container.innerHTML = '';

        let totalPercent = 0;

        appData.items.forEach((item, index) => {
            totalPercent += item.percent;
            const budgetAmount = Math.round((appData.totalIncome * item.percent) / 100);
            const remaining = budgetAmount - item.spent;
            const spentFormatted = item.spent === 0 ? '' : item.spent.toLocaleString('en-US');

            const card = document.createElement('div');
            card.className = 'budget-card';
            card.innerHTML = `
                <div class="card-header">
                    <input type="text" class="item-name-input" value="${item.name}" onchange="updateItem(${index}, 'name', this.value)">
                    <div class="percent-input-wrapper">
                        <span class="percent-symbol">%</span>
                        <input type="tel" class="percent-input" value="${item.percent}" onchange="updateItem(${index}, 'percent', this.value)">
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="stat-box" onclick="copyToClip(${budgetAmount})" title="Ú©Ù¾ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡">
                        <span class="stat-label">Ø¨ÙˆØ¯Ø¬Ù‡</span>
                        <span class="stat-value" style="color:var(--primary)">${formatNumber(budgetAmount)}</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-label">Ø®Ø±Ø¬ Ø´Ø¯Ù‡</span>
                        <input type="tel" class="expense-input" placeholder="0" value="${spentFormatted}" oninput="formatInput(this); updateItem(${index}, 'spent', this.value)">
                    </div>
                    <div class="stat-box" onclick="copyToClip(${remaining})" title="Ú©Ù¾ÛŒ Ù…Ø§Ù†Ø¯Ù‡">
                        <span class="stat-label">Ù…Ø§Ù†Ø¯Ù‡</span>
                        <span class="stat-value remaining-value ${remaining < 0 ? 'negative' : ''}">${formatNumber(remaining)}</span>
                    </div>
                </div>

                <div class="card-footer">
                    <button class="btn-mini btn-copy" onclick="copyToClip(${budgetAmount})"><i class="far fa-copy"></i> Ú©Ù¾ÛŒ</button>
                    <button class="btn-mini btn-delete" onclick="deleteItem(${index})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(card);
        });

        // Ø¢Ù¾Ø¯ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±ØµØ¯
        const statusEl = document.getElementById('statusMessage');
        const totalPerEl = document.getElementById('totalPercentTxt');
        totalPerEl.innerText = `Ø¬Ù…Ø¹ Ø¯Ø±ØµØ¯: ${totalPercent}%`;
        
        if(totalPercent === 100) {
            statusEl.innerText = "âœ… Ø¹Ø§Ù„ÛŒ (ØªÚ©Ù…ÛŒÙ„)";
            statusEl.style.color = "var(--success)";
        } else if (totalPercent > 100) {
            statusEl.innerText = `âš ï¸ ${totalPercent - 100}% Ø§Ø¶Ø§ÙÙ‡!`;
            statusEl.style.color = "var(--danger)";
        } else {
            statusEl.innerText = `ğŸ”µ ${100 - totalPercent}% Ù…Ø§Ù†Ø¯Ù‡`;
            statusEl.style.color = "var(--warning)";
        }
    }

    // --- Ù†Ù…ÙˆØ¯Ø§Ø± ---
    function updateChart() {
        const ctx = document.getElementById('budgetChart').getContext('2d');
        
        // Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø±
        const labels = appData.items.map(i => i.name.split('.')[1] || i.name); // Ø§Ø³Ù… Ú©ÙˆØªØ§Ù‡
        const data = appData.items.map(i => (appData.totalIncome * i.percent) / 100);
        const bgColors = [
            '#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
            '#ec4899', '#06b6d4', '#84cc16', '#64748b', '#14b8a6'
        ];

        if (chartInstance) {
            chartInstance.destroy();
        }

        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: bgColors,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { family: 'Vazirmatn' } } }
                }
            }
        });
    }

    // --- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ---

    function toEnglishDigits(str) {
        if(!str) return "";
        return str.toString().replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    }

    function formatNumber(num) {
        return Math.round(num).toLocaleString('en-US');
    }

    // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† ÙˆØ±ÙˆØ¯ÛŒ Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾ (Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„Ø¯ Ø®Ø±Ø¬ Ø´Ø¯Ù‡)
    function formatInput(el) {
        let raw = toEnglishDigits(el.value).replace(/[^0-9]/g, '');
        if(raw) el.value = parseInt(raw).toLocaleString('en-US');
        else el.value = '';
    }

    function copyToClip(amount) {
        const mode = document.getElementById('copyModeSelector').value;
        let txt = "";
        
        if (mode === 'raw') {
            txt = Math.round(amount).toString();
        } else {
            txt = Math.round(amount).toLocaleString('en-US'); // ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø¨Ø§ Ú©Ø§Ù…Ø§
        }

        navigator.clipboard.writeText(txt).then(() => {
            const t = document.getElementById('toast');
            t.innerText = `Ú©Ù¾ÛŒ Ø´Ø¯: ${txt}`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        });
    }

    // Ø§Ø¬Ø±Ø§
    init();

</script>
</body>
</html>
