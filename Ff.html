<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÙ… Ø¬Ø§Ù…Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ù†Ø§Ø¨Ø¹ Ù…Ø§Ù„ÛŒ | Ù†Ø³Ø®Ù‡ V7 Ultimate</title>
    
    <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- ØªØ¨Ø¯ÛŒÙ„ HTML Ø¨Ù‡ Ø¹Ú©Ø³ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            /* Light Theme */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --border: #e2e8f0;
            --input-bg: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark Theme */
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-sec: #94a3b8;
            --primary: #3b82f6;
            --primary-dark: #60a5fa;
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --border: #334155;
            --input-bg: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
        }

        /* --- LAYOUT --- */
        .app-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            align-items: start;
        }

        /* --- SIDEBAR --- */
        .sidebar {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            position: sticky;
            top: 20px;
            box-shadow: var(--shadow);
            height: calc(100vh - 40px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* --- MAIN CONTENT --- */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
        }

        /* --- HEADER & CONTROLS --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .brand h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .top-actions { display: flex; gap: 10px; }

        .btn-icon {
            width: 40px; height: 40px;
            border-radius: 10px;
            border: 1px solid var(--border);
            background: var(--bg-card);
            color: var(--text-sec);
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
        }
        .btn-icon:hover { color: var(--primary); border-color: var(--primary); }

        /* --- WALLET SECTION --- */
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        .wallet-item {
            background: rgba(37, 99, 235, 0.1);
            border: 1px solid var(--primary);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            position: relative;
        }
        .wallet-item input {
            background: transparent; border: none; text-align: center; width: 100%;
            color: var(--text-main); font-weight: bold;
        }
        .wallet-val { font-size: 1.1rem; color: var(--primary); font-weight: 800; margin-top: 5px; cursor: pointer;}

        /* --- DEBT SECTION --- */
        .debt-list { margin-top: 10px; display: flex; flex-direction: column; gap: 8px; }
        .debt-item {
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid var(--danger);
            padding: 8px 12px;
            border-radius: 6px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9rem;
        }

        /* --- BUDGET GRID --- */
        .budget-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 15px;
        }

        .budget-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            display: flex; flex-direction: column; gap: 10px;
            position: relative;
            transition: transform 0.2s;
        }
        .budget-card:hover { transform: translateY(-3px); border-color: var(--primary); }

        .card-header { display: flex; justify-content: space-between; align-items: center; }
        .item-name { background: transparent; border: none; font-weight: bold; color: var(--text-main); width: 60%; font-size: 1rem; }
        .percent-box { background: var(--bg-body); padding: 2px 8px; border-radius: 4px; display: flex; align-items: center; font-size: 0.9rem; }
        .percent-input { width: 30px; background: transparent; border: none; text-align: center; font-weight: bold; color: var(--text-main); }

        .budget-stats {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; text-align: center;
            background: var(--bg-body); padding: 8px; border-radius: 8px; font-size: 0.85rem;
        }
        .stat-val { display: block; font-weight: bold; font-size: 0.95rem; margin-top: 3px; }
        .text-p { color: var(--primary); }
        .text-d { color: var(--danger); }
        .text-s { color: var(--success); }

        .rollover-badge { font-size: 0.7rem; background: var(--warning); color: #000; padding: 2px 5px; border-radius: 4px; display: inline-block; margin-top: 2px;}

        .card-actions { display: flex; gap: 5px; margin-top: 5px; }
        .btn-act { flex: 1; padding: 6px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-card); cursor: pointer; color: var(--text-sec); font-size: 0.8rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-act:hover { background: var(--bg-body); color: var(--primary); }
        .btn-act.exp { background: rgba(239, 68, 68, 0.1); color: var(--danger); border-color: transparent; }
        .btn-act.exp:hover { background: var(--danger); color: white; }

        /* --- TABS --- */
        .tabs { display: flex; gap: 10px; border-bottom: 2px solid var(--border); margin-bottom: 15px; overflow-x: auto; }
        .tab-btn {
            padding: 10px 20px; background: none; border: none; cursor: pointer;
            color: var(--text-sec); font-weight: bold; white-space: nowrap;
        }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); margin-bottom: -2px; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* --- GOALS --- */
        .goal-item { margin-bottom: 15px; border: 1px solid var(--border); padding: 10px; border-radius: 8px; }
        .progress-bar-bg { background: var(--bg-body); height: 10px; border-radius: 5px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { background: var(--success); height: 100%; width: 0%; transition: width 0.5s; }

        /* --- MODALS --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8); z-index: 2000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-overlay.active { display: flex; }
        .modal-box {
            background: var(--bg-card); width: 90%; max-width: 500px;
            border-radius: 16px; padding: 25px; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9rem; color: var(--text-sec); }
        .form-input { 
            width: 100%; padding: 12px; 
            background: var(--input-bg); border: 1px solid var(--border); 
            color: var(--text-main); border-radius: 8px; font-size: 1rem; 
        }
        
        /* --- PIN LOCK --- */
        #pinModal .modal-box { text-align: center; }
        .pin-input { font-size: 2rem; letter-spacing: 10px; text-align: center; }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            .app-wrapper { grid-template-columns: 1fr; }
            .sidebar { height: auto; position: static; box-shadow: none; border-bottom: 1px solid var(--border); }
        }

        /* --- BUTTONS --- */
        .btn-main { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; }

        /* --- TAGS --- */
        .tag-badge { font-size: 0.75rem; background: var(--bg-body); padding: 2px 6px; border-radius: 4px; color: var(--secondary); margin-right: 5px; }

    </style>
</head>
<body>

<!-- 1. PIN LOCK MODAL -->
<div id="pinModal" class="modal-overlay active" style="z-index: 9999;">
    <div class="modal-box">
        <i class="fas fa-lock" style="font-size: 3rem; color: var(--primary); margin-bottom: 20px;"></i>
        <h2>Ø³Ø§Ù…Ø§Ù†Ù‡ Ù‚ÙÙ„ Ø§Ø³Øª</h2>
        <p>Ù„Ø·ÙØ§Ù‹ Ù¾ÛŒÙ† Ú©Ø¯ Û´ Ø±Ù‚Ù…ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: 1234)</p>
        <input type="password" id="pinInput" class="form-input pin-input" maxlength="4" inputmode="numeric">
        <p id="pinError" style="color: var(--danger); display:none;">Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª!</p>
        <button class="btn-main" style="width:100%; margin-top:20px;" onclick="checkPin()">ÙˆØ±ÙˆØ¯</button>
    </div>
</div>

<div class="app-wrapper" id="mainApp" style="filter: blur(5px); pointer-events: none;">
    
    <!-- SIDEBAR: Wallets, Debts, Analysis -->
    <aside class="sidebar">
        <div class="brand">
            <h1><i class="fas fa-shield-alt"></i> Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ</h1>
            <span style="color:var(--text-sec)">Ù†Ø³Ø®Ù‡ V7 Ultimate</span>
        </div>

        <!-- Wallets -->
        <div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4><i class="fas fa-wallet"></i> Ù…Ù†Ø§Ø¨Ø¹ Ù¾ÙˆÙ„ (Wallets)</h4>
                <button class="btn-icon" style="width:25px; height:25px; font-size:0.8rem;" onclick="addWallet()">+</button>
            </div>
            <div id="walletList" class="wallet-grid"></div>
            <div style="margin-top:10px; text-align:center; font-weight:bold; color:var(--success);">
                Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ø§Ø±Ø§ÛŒÛŒ: <span id="totalWalletVal">0</span>
            </div>
        </div>

        <!-- Debts -->
        <div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4><i class="fas fa-file-invoice-dollar"></i> Ø§Ù‚Ø³Ø§Ø· Ù…Ø§Ù‡Ø§Ù†Ù‡</h4>
                <button class="btn-icon" style="width:25px; height:25px; font-size:0.8rem;" onclick="addDebt()">+</button>
            </div>
            <div id="debtList" class="debt-list"></div>
            <div style="margin-top:5px; font-size:0.9rem; color:var(--danger);">
                Ù…Ø¬Ù…ÙˆØ¹ Ú©Ø³Ø± Ø´Ø¯Ù‡: <span id="totalDebtVal">0</span>
            </div>
        </div>

        <!-- Calc Box -->
        <div class="card" style="background:var(--bg-body); text-align:center;">
            <label style="font-size:0.9rem; color:var(--text-sec)">Ø¨ÙˆØ¯Ø¬Ù‡ Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒÙ…:</label>
            <div id="distributableIncome" style="font-size:1.5rem; font-weight:900; color:var(--primary);">0</div>
            <button class="btn-main" style="width:100%; margin-top:10px;" onclick="calculateAll()">
                <i class="fas fa-calculator"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ ØªÙˆØ²ÛŒØ¹
            </button>
        </div>

        <!-- Charts -->
        <div>
            <canvas id="mainChart" height="200"></canvas>
        </div>
        <div>
            <canvas id="trendChart" height="150"></canvas>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- Header -->
        <header class="card header">
            <div class="datetime-display" id="clock">--:--</div>
            <div class="top-actions">
                <button class="btn-icon" onclick="toggleTheme()" title="Ø­Ø§Ù„Øª Ø´Ø¨/Ø±ÙˆØ²"><i class="fas fa-moon"></i></button>
                <button class="btn-icon" onclick="exportExcel()" title="Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„"><i class="fas fa-file-excel"></i></button>
                <button class="btn-icon" onclick="exportImage()" title="Ø®Ø±ÙˆØ¬ÛŒ Ø¹Ú©Ø³"><i class="fas fa-camera"></i></button>
                <button class="btn-icon" onclick="saveSnapshot()" title="Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª"><i class="fas fa-save"></i></button>
                <button class="btn-icon" onclick="closeMonth()" title="Ø¨Ø³ØªÙ† Ø­Ø³Ø§Ø¨ Ù…Ø§Ù‡ (Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø§Ù†Ø¯Ù‡)" style="color:var(--warning); border-color:var(--warning);"><i class="fas fa-calendar-check"></i></button>
            </div>
        </header>

        <!-- Budget Grid -->
        <section class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3><i class="fas fa-chart-pie"></i> Ø¨ÙˆØ¯Ø¬Ù‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
                <button class="btn-icon" onclick="addBudgetItem()">+</button>
            </div>
            <div id="budgetContainer" class="budget-grid"></div>
        </section>

        <!-- Extra Tools Tabs -->
        <section class="card">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('goals')">ğŸ¯ Ø§Ù‡Ø¯Ø§Ù Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²</button>
                <button class="tab-btn" onclick="switchTab('shopping')">ğŸ›’ Ù„ÛŒØ³Øª Ø®Ø±ÛŒØ¯</button>
                <button class="tab-btn" onclick="switchTab('lending')">ğŸ¤ Ù‚Ø±Ø¶ Ùˆ Ø·Ù„Ø¨</button>
            </div>

            <!-- Tab: Goals -->
            <div id="tab-goals" class="tab-content active">
                <button class="btn-main" style="margin-bottom:15px;" onclick="addGoal()">+ Ù‡Ø¯Ù Ø¬Ø¯ÛŒØ¯</button>
                <div id="goalsList"></div>
            </div>

            <!-- Tab: Shopping -->
            <div id="tab-shopping" class="tab-content">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="shopItem" class="form-input" placeholder="Ø¢ÛŒØªÙ… (Ù…Ø«Ù„Ø§: Ù†Ø§Ù†)">
                    <select id="shopSource" class="form-input">
                        <!-- Budgets populated here -->
                    </select>
                    <input type="number" id="shopCost" class="form-input" placeholder="Ù‚ÛŒÙ…Øª">
                    <button class="btn-main" onclick="addShoppingItem()">Ø§ÙØ²ÙˆØ¯Ù†</button>
                </div>
                <div id="shoppingList"></div>
            </div>

            <!-- Tab: Lending -->
            <div id="tab-lending" class="tab-content">
                <button class="btn-main" style="margin-bottom:15px;" onclick="addLending()">+ Ø«Ø¨Øª Ù‚Ø±Ø¶/Ø·Ù„Ø¨</button>
                <div id="lendingList"></div>
            </div>
        </section>
    </main>
</div>

<!-- MODAL: ADD EXPENSE -->
<div id="expenseModal" class="modal-overlay">
    <div class="modal-box">
        <h3>Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</h3>
        <input type="hidden" id="expId">
        <div class="form-group">
            <label>Ù…Ø¨Ù„Øº:</label>
            <input type="text" id="expAmount" class="form-input" onkeyup="formatInput(this)">
        </div>
        <div class="form-group">
            <label>Ø¨Ø§Ø¨Øª (ØªÙˆØ¶ÛŒØ­):</label>
            <input type="text" id="expReason" class="form-input">
        </div>
        <div class="form-group" style="display:flex; align-items:center; gap:10px;">
            <input type="checkbox" id="expNeed" style="width:20px; height:20px;">
            <label for="expNeed" style="margin:0;">Ø¢ÛŒØ§ Ø§ÛŒÙ† Ù‡Ø²ÛŒÙ†Ù‡ Ø¶Ø±ÙˆØ±ÛŒ (Ù†ÛŒØ§Ø²) Ø¨ÙˆØ¯ØŸ</label>
        </div>
        <div class="form-group">
            <label>Ø¨Ø±Ú†Ø³Ø¨ (ØªÚ¯):</label>
            <input type="text" id="expTag" class="form-input" placeholder="#Ø§Ø³Ù†Ù¾ #Ø®ÙˆØ§Ø¨Ú¯Ø§Ù‡">
        </div>
        <div style="text-align:right;">
            <button class="btn-main" onclick="submitExpense()">Ø«Ø¨Øª</button>
            <button class="btn-danger" onclick="closeModal('expenseModal')">Ù„ØºÙˆ</button>
        </div>
    </div>
</div>

<script>
    // --- Data Structure ---
    const defaultData = {
        settings: { pin: "1234", theme: "light", currency: "ØªÙˆÙ…Ø§Ù†" },
        wallets: [
            { id: 1, name: "Ú©Ø§Ø±Øª Ù…Ù„ÛŒ", value: 0 },
            { id: 2, name: "Ù¾ÙˆÙ„ Ù†Ù‚Ø¯", value: 0 }
        ],
        debts: [ // Fixed costs deducted first
            { id: 1, name: "Ù‚Ø³Ø· ÙˆØ§Ù…", value: 0 }
        ],
        budgetItems: [
            { id: 1, name: "Ú©Ø±Ø§ÛŒÙ‡ Ø´Ù‡Ø±ÛŒ", percent: 27, spent: 0, rollover: 0, transactions: [] },
            { id: 2, name: "Ø®ÙˆØ±Ø¯ Ùˆ Ø®ÙˆØ±Ø§Ú©", percent: 12, spent: 0, rollover: 0, transactions: [] },
            { id: 3, name: "Ø³ÙØ± (Ù…Ø´Ù‡Ø¯)", percent: 25, spent: 0, rollover: 0, transactions: [] },
            { id: 4, name: "Ø¯ÙˆØ§ Ùˆ Ø¯Ø±Ù…Ø§Ù†", percent: 3, spent: 0, rollover: 0, transactions: [] },
            { id: 5, name: "Ø´Ø§Ø±Ú˜ Ùˆ Ù†Øª", percent: 10, spent: 0, rollover: 0, transactions: [] },
            { id: 6, name: "Ø²ÛŒØ¨Ø§ÛŒÛŒ Ùˆ Ù…Ú©Ù…Ù„", percent: 7, spent: 0, rollover: 0, transactions: [] },
            { id: 7, name: "Ù„Ø¨Ø§Ø³", percent: 5, spent: 0, rollover: 0, transactions: [] },
            { id: 8, name: "Ø¶Ø±ÙˆØ±ÛŒ", percent: 5, spent: 0, rollover: 0, transactions: [] },
            { id: 9, name: "ØªÙØ±ÛŒØ­", percent: 3, spent: 0, rollover: 0, transactions: [] },
            { id: 10, name: "Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø²", percent: 3, spent: 0, rollover: 0, transactions: [] }
        ],
        goals: [],
        shoppingList: [],
        lendingList: [],
        history: [] // For trend analysis
    };

    let app = JSON.parse(JSON.stringify(defaultData));
    let charts = {};

    // --- INIT ---
    function init() {
        const saved = localStorage.getItem('amir_fin_v7');
        if (saved) app = JSON.parse(saved);
        
        applyTheme();
        setInterval(() => {
            document.getElementById('clock').innerText = new Date().toLocaleString('fa-IR');
        }, 1000);

        renderWallets();
        renderDebts();
        renderBudget();
        renderGoals();
        renderShopping();
        renderLending();
        updateCharts();
        populateBudgetSelect();
    }

    // --- SECURITY ---
    function checkPin() {
        const input = document.getElementById('pinInput').value;
        if (input === app.settings.pin) {
            document.getElementById('pinModal').classList.remove('active');
            document.getElementById('mainApp').style.filter = "none";
            document.getElementById('mainApp').style.pointerEvents = "auto";
            init();
        } else {
            document.getElementById('pinError').style.display = "block";
        }
    }

    // --- WALLETS & DEBTS ---
    function renderWallets() {
        const div = document.getElementById('walletList');
        div.innerHTML = '';
        let total = 0;
        app.wallets.forEach((w, i) => {
            total += w.value;
            div.innerHTML += `
                <div class="wallet-item">
                    <input value="${w.name}" onchange="updateWallet(${i}, 'name', this.value)">
                    <div class="wallet-val" onclick="promptWalletVal(${i})">${formatNum(w.value)}</div>
                </div>
            `;
        });
        document.getElementById('totalWalletVal').innerText = formatNum(total);
        calculateDistributable();
    }

    function updateWallet(i, key, val) {
        if(key === 'value') app.wallets[i].value = parseInt(val) || 0;
        else app.wallets[i].name = val;
        save(); renderWallets();
    }

    function promptWalletVal(i) {
        let val = prompt("Ù…Ø¨Ù„Øº Ø¬Ø¯ÛŒØ¯:", app.wallets[i].value);
        if(val !== null) updateWallet(i, 'value', val);
    }

    function addWallet() {
        app.wallets.push({ id: Date.now(), name: "Ú©ÛŒÙ Ø¬Ø¯ÛŒØ¯", value: 0 });
        save(); renderWallets();
    }

    function renderDebts() {
        const div = document.getElementById('debtList');
        div.innerHTML = '';
        let total = 0;
        app.debts.forEach((d, i) => {
            total += d.value;
            div.innerHTML += `
                <div class="debt-item">
                    <input style="background:transparent; border:none; width:50%" value="${d.name}" onchange="updateDebt(${i}, 'name', this.value)">
                    <span onclick="promptDebtVal(${i})" style="cursor:pointer; font-weight:bold;">${formatNum(d.value)}</span>
                    <i class="fas fa-times" style="cursor:pointer; color:var(--danger)" onclick="delDebt(${i})"></i>
                </div>
            `;
        });
        document.getElementById('totalDebtVal').innerText = formatNum(total);
        calculateDistributable();
    }

    function updateDebt(i, key, val) {
        if(key === 'value') app.debts[i].value = parseInt(val) || 0;
        else app.debts[i].name = val;
        save(); renderDebts();
    }

    function promptDebtVal(i) {
        let val = prompt("Ù…Ø¨Ù„Øº Ù‚Ø³Ø·:", app.debts[i].value);
        if(val !== null) updateDebt(i, 'value', val);
    }

    function addDebt() {
        app.debts.push({ id: Date.now(), name: "Ù‚Ø³Ø· Ø¬Ø¯ÛŒØ¯", value: 0 });
        save(); renderDebts();
    }
    function delDebt(i) { app.debts.splice(i, 1); save(); renderDebts(); }

    // --- CORE CALCULATION ---
    function calculateDistributable() {
        const totalIncome = app.wallets.reduce((a, b) => a + b.value, 0);
        const totalDebts = app.debts.reduce((a, b) => a + b.value, 0);
        const distributable = totalIncome - totalDebts;
        document.getElementById('distributableIncome').innerText = formatNum(distributable);
        return distributable;
    }

    function calculateAll() {
        const base = calculateDistributable();
        // Just refresh view, calculation happens in render
        renderBudget();
        showToast("Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ø¨Ø±ÙˆØ² Ø´Ø¯");
    }

    // --- BUDGET GRID ---
    function renderBudget() {
        const container = document.getElementById('budgetContainer');
        container.innerHTML = '';
        const baseMoney = calculateDistributable();

        app.budgetItems.forEach((item, index) => {
            // ÙØ±Ù…ÙˆÙ„: (Ù¾ÙˆÙ„ Ù‚Ø§Ø¨Ù„ ØªÙ‚Ø³ÛŒÙ… * Ø¯Ø±ØµØ¯) + Ù…Ø§Ù†Ø¯Ù‡ Ø§Ù†ØªÙ‚Ø§Ù„ ÛŒØ§ÙØªÙ‡ Ø§Ø² Ù…Ø§Ù‡ Ù‚Ø¨Ù„
            const currentBudget = Math.round((baseMoney * item.percent) / 100) + item.rollover;
            const remaining = currentBudget - item.spent;

            let rolloverHtml = item.rollover > 0 ? `<span class="rollover-badge">+${formatNum(item.rollover)} Ù…Ø§Ù‡ Ù‚Ø¨Ù„</span>` : '';

            container.innerHTML += `
                <div class="budget-card">
                    <div class="card-header">
                        <input class="item-name" value="${item.name}" onchange="updItem(${index}, 'name', this.value)">
                        <div class="percent-box">
                            <input class="percent-input" value="${item.percent}" onchange="updItem(${index}, 'percent', this.value)">%
                        </div>
                    </div>
                    ${rolloverHtml}
                    <div class="budget-stats">
                        <div>
                            <span style="color:var(--text-sec)">Ø¨ÙˆØ¯Ø¬Ù‡</span>
                            <span class="stat-val text-p">${formatNum(currentBudget)}</span>
                        </div>
                        <div>
                            <span style="color:var(--text-sec)">Ø®Ø±Ø¬</span>
                            <span class="stat-val text-d">${formatNum(item.spent)}</span>
                        </div>
                        <div>
                            <span style="color:var(--text-sec)">Ù…Ø§Ù†Ø¯Ù‡</span>
                            <span class="stat-val text-s">${formatNum(remaining)}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn-act exp" onclick="openExpModal(${index})"><i class="fas fa-minus"></i> Ø«Ø¨Øª Ù‡Ø²ÛŒÙ†Ù‡</button>
                        <button class="btn-act" onclick="showTx(${index})"><i class="fas fa-list"></i> Ø±ÛŒØ²</button>
                        <button class="btn-act" onclick="delItem(${index})" style="flex:0"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        });
        updateCharts();
    }

    function updItem(i, key, val) {
        if(key === 'percent') app.budgetItems[i].percent = parseFloat(val) || 0;
        else app.budgetItems[i].name = val;
        save(); renderBudget();
    }
    
    function addBudgetItem() {
        app.budgetItems.push({ id: Date.now(), name: "Ø¬Ø¯ÛŒØ¯", percent: 0, spent: 0, rollover: 0, transactions: [] });
        save(); renderBudget();
    }
    function delItem(i) {
        if(confirm("Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) { app.budgetItems.splice(i, 1); save(); renderBudget(); }
    }

    // --- EXPENSES ---
    let activeItemIdx = -1;
    function openExpModal(i) {
        activeItemIdx = i;
        document.getElementById('expenseModal').classList.add('active');
        document.getElementById('expAmount').value = '';
        document.getElementById('expReason').value = '';
    }

    function submitExpense() {
        const amt = parseInt(document.getElementById('expAmount').value.replace(/,/g, '')) || 0;
        const reason = document.getElementById('expReason').value;
        const isNeed = document.getElementById('expNeed').checked;
        const tag = document.getElementById('expTag').value;

        if (amt > 0 && activeItemIdx > -1) {
            app.budgetItems[activeItemIdx].spent += amt;
            app.budgetItems[activeItemIdx].transactions.push({
                amount: amt,
                reason: reason,
                date: new Date().toISOString(),
                isNeed: isNeed,
                tag: tag
            });
            
            // Ø§Ú¯Ø± Ø§Ø² Ù„ÛŒØ³Øª Ø®Ø±ÛŒØ¯ Ø¨ÙˆØ¯Ù‡ØŒ ØªÛŒÚ©Ø´ Ø±Ùˆ Ø¨Ø²Ù† (Ø§ÛŒÙ†Ø¬Ø§ Ø³Ø§Ø¯Ù‡ Ø´Ø¯Ù‡)
            
            save(); renderBudget();
            closeModal('expenseModal');
            showToast("Ù‡Ø²ÛŒÙ†Ù‡ Ø«Ø¨Øª Ø´Ø¯");
        }
    }

    // --- ROLLOVER (Ø¨Ø³ØªÙ† Ù…Ø§Ù‡) ---
    function closeMonth() {
        if(!confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\nÛ±. Ù…Ø¨Ø§Ù„Øº Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ù‡ Ù…Ø§Ù‡ Ø¨Ø¹Ø¯ Ù…Ù†ØªÙ‚Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.\nÛ². Ø®Ø±Ø¬â€ŒÙ‡Ø§ ØµÙØ± Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.\nÛ³. Ø§ÛŒÙ† ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.")) return;

        // Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø¨Ø±Ø§ÛŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø±ÙˆÙ†Ø¯
        const snapshot = {
            date: new Date().toISOString(),
            totalIncome: calculateDistributable(),
            totalSpent: app.budgetItems.reduce((a, b) => a + b.spent, 0)
        };
        app.history.push(snapshot);

        // Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ù†ØªÙ‚Ø§Ù„
        const baseMoney = calculateDistributable();
        app.budgetItems.forEach(item => {
            const currentBudget = Math.round((baseMoney * item.percent) / 100) + item.rollover;
            let remaining = currentBudget - item.spent;
            if (remaining < 0) remaining = 0; // Ø¨Ø¯Ù‡ÛŒ Ù…Ù†ØªÙ‚Ù„ Ù†Ø´ÙˆØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
            
            item.rollover = remaining; // Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø§Ù†Ø¯Ù‡
            item.spent = 0; // ØµÙØ± Ú©Ø±Ø¯Ù† Ø®Ø±Ø¬
            item.transactions = []; // Ø¢Ø±Ø´ÛŒÙˆ Ú©Ø±Ø¯Ù† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ (Ø§ÛŒÙ†Ø¬Ø§ Ù¾Ø§Ú© Ù…ÛŒÚ©Ù†ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ø³Ø¨Ú©ÛŒ)
        });

        save();
        renderBudget();
        showToast("Ù…Ø§Ù‡ Ø¨Ø³ØªÙ‡ Ø´Ø¯ Ùˆ Ù…Ø§Ù†Ø¯Ù‡â€ŒÙ‡Ø§ Ù…Ù†ØªÙ‚Ù„ Ø´Ø¯Ù†Ø¯ âœ…");
    }

    // --- EXTRA TOOLS ---
    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+id).classList.add('active');
        event.target.classList.add('active');
    }

    // Goals
    function renderGoals() {
        const div = document.getElementById('goalsList');
        div.innerHTML = '';
        app.goals.forEach((g, i) => {
            const percent = Math.min(100, Math.round((g.current / g.target) * 100));
            div.innerHTML += `
                <div class="goal-item">
                    <div style="display:flex; justify-content:space-between;">
                        <b>${g.name}</b>
                        <span>${formatNum(g.current)} / ${formatNum(g.target)}</span>
                    </div>
                    <div class="progress-bar-bg">
                        <div class="progress-bar-fill" style="width:${percent}%"></div>
                    </div>
                    <div style="margin-top:5px; text-align:right;">
                        <button class="btn-act" onclick="addGoalMoney(${i})">+ ÙˆØ§Ø±ÛŒØ²</button>
                        <i class="fas fa-trash text-d" style="cursor:pointer; margin-right:10px;" onclick="delGoal(${i})"></i>
                    </div>
                </div>
            `;
        });
    }
    function addGoal() {
        const name = prompt("Ù†Ø§Ù… Ù‡Ø¯Ù:");
        const target = prompt("Ù…Ø¨Ù„Øº Ù‡Ø¯Ù:");
        if(name && target) {
            app.goals.push({ name, target: parseInt(target), current: 0 });
            save(); renderGoals();
        }
    }
    function addGoalMoney(i) {
        const val = prompt("Ù…Ø¨Ù„Øº ÙˆØ§Ø±ÛŒØ²ÛŒ:");
        if(val) {
            app.goals[i].current += parseInt(val);
            save(); renderGoals();
        }
    }
    function delGoal(i) { app.goals.splice(i, 1); save(); renderGoals(); }

    // Shopping List (Smart)
    function populateBudgetSelect() {
        const sel = document.getElementById('shopSource');
        sel.innerHTML = '';
        app.budgetItems.forEach((b, i) => {
            sel.innerHTML += `<option value="${i}">${b.name}</option>`;
        });
    }
    function renderShopping() {
        const div = document.getElementById('shoppingList');
        div.innerHTML = '';
        app.shoppingList.forEach((s, i) => {
            div.innerHTML += `
                <div style="display:flex; justify-content:space-between; border-bottom:1px solid var(--border); padding:8px;">
                    <span>${s.item} (${formatNum(s.cost)})</span>
                    <div>
                        <button class="btn-act text-s" onclick="buyItem(${i})">Ø®Ø±ÛŒØ¯ Ø´Ø¯</button>
                        <i class="fas fa-times text-d" onclick="delShop(${i})"></i>
                    </div>
                </div>
            `;
        });
    }
    function addShoppingItem() {
        const item = document.getElementById('shopItem').value;
        const budgetIdx = document.getElementById('shopSource').value;
        const cost = document.getElementById('shopCost').value;
        if(item && cost) {
            app.shoppingList.push({ item, budgetIdx, cost: parseInt(cost) });
            save(); renderShopping();
        }
    }
    function buyItem(i) {
        const item = app.shoppingList[i];
        // Ú©Ø³Ø± Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡
        app.budgetItems[item.budgetIdx].spent += item.cost;
        app.budgetItems[item.budgetIdx].transactions.push({
            amount: item.cost,
            reason: `Ø®Ø±ÛŒØ¯ Ø§Ø² Ù„ÛŒØ³Øª: ${item.item}`,
            date: new Date().toISOString(),
            isNeed: true
        });
        app.shoppingList.splice(i, 1);
        save(); renderShopping(); renderBudget();
        showToast("Ø®Ø±ÛŒØ¯ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯ Ùˆ Ø§Ø² Ø¨ÙˆØ¯Ø¬Ù‡ Ú©Ø³Ø± Ú¯Ø±Ø¯ÛŒØ¯");
    }
    function delShop(i) { app.shoppingList.splice(i, 1); save(); renderShopping(); }

    // Lending
    function renderLending() {
        const div = document.getElementById('lendingList');
        div.innerHTML = '';
        app.lendingList.forEach((l, i) => {
            const color = l.type === 'lent' ? 'var(--warning)' : 'var(--danger)';
            div.innerHTML += `
                <div style="padding:10px; border:1px solid var(--border); margin-bottom:5px; border-radius:8px; border-right:4px solid ${color};">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${l.person}</strong>
                        <b>${formatNum(l.amount)}</b>
                    </div>
                    <div style="font-size:0.8rem; color:var(--text-sec);">${l.type === 'lent' ? 'Ø·Ù„Ø¨ Ø¯Ø§Ø±Ù…' : 'Ø¨Ø¯Ù‡Ú©Ø§Ø±Ù…'}</div>
                    <button class="btn-act" onclick="delLending(${i})">ØªØ³ÙˆÛŒÙ‡ Ø´Ø¯</button>
                </div>
            `;
        });
    }
    function addLending() {
        const person = prompt("Ù†Ø§Ù… Ø´Ø®Øµ:");
        const amount = prompt("Ù…Ø¨Ù„Øº:");
        const type = confirm("Ø¢ÛŒØ§ Ø´Ù…Ø§ Ù¾ÙˆÙ„ Ø¯Ø§Ø¯ÛŒØ¯ØŸ (Ok = Ù…Ù† Ø¯Ø§Ø¯Ù… / Cancel = Ù…Ù† Ú¯Ø±ÙØªÙ…)") ? 'lent' : 'borrowed';
        if(person && amount) {
            app.lendingList.push({ person, amount: parseInt(amount), type });
            save(); renderLending();
        }
    }
    function delLending(i) { app.lendingList.splice(i, 1); save(); renderLending(); }

    // --- CHARTS ---
    function updateCharts() {
        // Pie Chart
        const ctxP = document.getElementById('mainChart').getContext('2d');
        const labels = app.budgetItems.map(i => i.name);
        const data = app.budgetItems.map(i => i.spent);
        
        if(charts.pie) charts.pie.destroy();
        charts.pie = new Chart(ctxP, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{ data: data, backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] }]
            },
            options: { plugins: { legend: { display: false } } }
        });

        // Trend Chart
        const ctxT = document.getElementById('trendChart').getContext('2d');
        const trendLabels = app.history.map(h => new Date(h.date).toLocaleDateString('fa-IR'));
        const trendData = app.history.map(h => h.totalSpent);

        if(charts.line) charts.line.destroy();
        charts.line = new Chart(ctxT, {
            type: 'line',
            data: {
                labels: trendLabels,
                datasets: [{ 
                    label: 'Ø±ÙˆÙ†Ø¯ Ù‡Ø²ÛŒÙ†Ù‡',
                    data: trendData,
                    borderColor: '#2563eb',
                    tension: 0.4
                }]
            }
        });
    }

    // --- EXPORTS ---
    function exportExcel() {
        let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
        csvContent += "Item,Percent,Budget,Spent,Remaining\n";
        
        const baseMoney = calculateDistributable();
        app.budgetItems.forEach(item => {
            const budget = Math.round((baseMoney * item.percent) / 100) + item.rollover;
            const rem = budget - item.spent;
            csvContent += `${item.name},${item.percent}%,${budget},${item.spent},${rem}\n`;
        });

        const encodedUri = encodeURI(csvContent);
        const link = document.createElement("a");
        link.setAttribute("href", encodedUri);
        link.setAttribute("download", "finance_report.csv");
        document.body.appendChild(link);
        link.click();
    }

    function exportImage() {
        html2canvas(document.body).then(canvas => {
            const link = document.createElement('a');
            link.download = 'finance_dashboard.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    }

    // --- UTILS ---
    function save() { localStorage.setItem('amir_fin_v7', JSON.stringify(app)); }
    function formatNum(n) { return n ? n.toLocaleString('en-US') : '0'; }
    function formatInput(el) { el.value = el.value.replace(/[^0-9]/g, '').replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg) { /* Toast logic same as before */ }
    
    function toggleTheme() {
        const body = document.body;
        if(body.getAttribute('data-theme') === 'dark') {
            body.removeAttribute('data-theme');
            app.settings.theme = 'light';
        } else {
            body.setAttribute('data-theme', 'dark');
            app.settings.theme = 'dark';
        }
        save();
    }
    
    function applyTheme() {
        if(app.settings.theme === 'dark') document.body.setAttribute('data-theme', 'dark');
    }

    function saveSnapshot() {
        // Logic to save current state to a separate key
        alert("Ø°Ø®ÛŒØ±Ù‡ Ù†Ù‚Ø·Ù‡â€ŒØ§ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯");
    }

    init();
</script>
</body>
</html>
