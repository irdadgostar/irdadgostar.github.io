<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø³ÛŒØ³ØªÙ… Ø¬Ø§Ù…Ø¹ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨ÙˆØ¯Ø¬Ù‡</title>
    
    <!-- ÙÙˆÙ†Øª ÙˆØ²ÛŒØ±Ù…ØªÙ† -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />
    <!-- Ø¢ÛŒÚ©ÙˆÙ†â€ŒÙ‡Ø§ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-body: #eef2f6;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #475569;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ca8a04;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --border: #cbd5e1;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: 'Vazirmatn', sans-serif;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 950px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border);
        }

        /* --- HEADER & INFO --- */
        .top-bar {
            background: #1e293b;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        .date-time {
            display: flex;
            gap: 15px;
            font-weight: bold;
            font-family: monospace; /* Ø¨Ø±Ø§ÛŒ Ø«Ø§Ø¨Øª Ù…Ø§Ù†Ø¯Ù† Ø¹Ø±Ø¶ Ø§Ø¹Ø¯Ø§Ø¯ */
            font-size: 1rem;
        }

        .main-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            background: #fff;
        }

        .user-title {
            font-size: 1.4rem;
            font-weight: 900;
            color: var(--primary);
            cursor: pointer;
            border-bottom: 2px dashed #94a3b8;
            padding-bottom: 2px;
        }
        .user-title:hover { color: var(--primary-hover); border-color: var(--primary); }

        /* --- CONTROL PANEL --- */
        .controls {
            padding: 15px 20px;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .input-wrapper label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.85rem;
            color: var(--secondary);
            font-weight: bold;
        }

        select, .action-btn {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            font-size: 0.95rem;
            background: white;
            cursor: pointer;
        }

        .scenario-btns {
            display: flex;
            gap: 5px;
        }
        .scenario-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
            background: #e2e8f0;
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            transition: 0.2s;
        }
        .scenario-btn:hover { background: #cbd5e1; }
        .scenario-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- MAIN INPUT --- */
        .money-section {
            padding: 30px 20px;
            text-align: center;
            background: linear-gradient(to bottom, #eff6ff, #ffffff);
        }

        .big-money-input {
            width: 100%;
            max-width: 400px;
            font-size: 1.8rem;
            text-align: center;
            padding: 15px;
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-weight: bold;
            color: var(--text-main);
            direction: ltr; /* ØªØ§ÛŒÙ¾ Ø¹Ø¯Ø¯ Ø±Ø§Ø­Øª ØªØ± */
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.1);
        }

        /* --- CHART --- */
        .chart-wrapper {
            padding: 10px;
            display: flex;
            justify-content: center;
            max-height: 250px;
            margin-bottom: 20px;
        }

        /* --- LIST ITEMS --- */
        .budget-list {
            padding: 20px;
            background: #f1f5f9;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .budget-row {
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-right: 5px solid var(--primary);
            transition: transform 0.2s;
        }
        
        .budget-row:hover { transform: translateY(-2px); }

        /* Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ Ú©Ø§Ø±Øª: Ù†Ø§Ù… Ùˆ Ø¯Ø±ØµØ¯ */
        .row-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        
        .row-name {
            font-weight: bold;
            font-size: 1.1rem;
            border: none;
            width: 100%;
            border-bottom: 1px solid transparent;
        }
        .row-name:focus { border-bottom: 1px solid var(--primary); }

        .row-percent-group {
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 0 5px;
            width: 80px;
        }
        
        .row-percent {
            width: 100%;
            border: none;
            background: transparent;
            text-align: center;
            font-weight: bold;
            padding: 5px;
            direction: ltr;
        }

        /* Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ… Ú©Ø§Ø±Øª: Ù…Ø¨Ø§Ù„Øº */
        .row-body {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            background: #f8fafc;
            padding: 10px;
            border-radius: 8px;
        }

        .stat-col {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            text-align: center;
        }

        .stat-label { font-size: 0.75rem; color: var(--secondary); }
        
        .stat-val { 
            font-weight: 800; 
            font-size: 0.95rem; 
            color: var(--primary);
        }

        .expense-input {
            width: 100%;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px;
            font-size: 0.9rem;
            direction: ltr;
        }

        .rem-val { color: var(--success); }
        .rem-val.neg { color: var(--danger); }

        /* Ø±Ø¯ÛŒÙ Ø³ÙˆÙ…: Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ */
        .row-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            border-top: 1px solid #f1f5f9;
            padding-top: 10px;
        }

        .mini-btn {
            background: #fff;
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .mini-btn:hover { background: #f1f5f9; border-color: var(--secondary); }
        .btn-del { color: var(--danger); border-color: #fecaca; }
        .btn-del:hover { background: #fef2f2; }

        /* --- BIG BUTTONS --- */
        .action-area {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 15px;
            position: sticky;
            bottom: 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }

        .big-btn {
            flex: 1;
            padding: 15px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }

        .btn-calc {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }
        .btn-calc:hover { background: var(--primary-hover); transform: translateY(-2px); }
        
        .btn-add {
            background: #f1f5f9;
            color: var(--text-main);
            border: 1px solid var(--border);
            flex: 0 0 auto;
            width: 60px;
        }
        .btn-add:hover { background: #e2e8f0; }

        /* --- STATUS BAR --- */
        .status-bar {
            background: #334155;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }

        /* Ù…ÙˆØ¨Ø§ÛŒÙ„ */
        @media (min-width: 768px) {
            .budget-list {
                display: grid;
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container">
    
    <!-- Ù†ÙˆØ§Ø± Ø¨Ø§Ù„Ø§: Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ® -->
    <div class="top-bar">
        <div id="clock" class="date-time">00:00:00</div>
        <div id="date" class="date-time">1400/01/01</div>
    </div>

    <!-- Ù‡Ø¯Ø± Ø§ØµÙ„ÛŒ: Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
    <div class="main-header">
        <div>
            <span style="color:var(--secondary); font-size:0.9rem;">Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±ÛŒØ²ÛŒ Ù…Ø§Ù„ÛŒÙ:</span>
            <div id="userTitle" class="user-title" onclick="editTitle()" title="Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†Ø§Ù… Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯">Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ†</div>
        </div>
        <div>
            <button class="mini-btn" onclick="exportData()"><i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡/Ø®Ø±ÙˆØ¬ÛŒ</button>
            <button class="mini-btn btn-del" onclick="fullReset()"><i class="fas fa-trash"></i> Ø±ÛŒØ³Øª Ú©Ù„ÛŒ</button>
        </div>
    </div>

    <!-- Ù¾Ù†Ù„ Ú©Ù†ØªØ±Ù„ -->
    <div class="controls">
        <div class="input-wrapper">
            <label>ÙˆØ§Ø­Ø¯ Ù¾ÙˆÙ„:</label>
            <select id="currencySelect" onchange="runCalc()">
                <option value="ØªÙˆÙ…Ø§Ù†">ØªÙˆÙ…Ø§Ù†</option>
                <option value="Ø±ÛŒØ§Ù„">Ø±ÛŒØ§Ù„</option>
            </select>
        </div>
        <div class="input-wrapper">
            <label>Ø³Ù†Ø§Ø±ÛŒÙˆÙ‡Ø§ (ØªØºÛŒÛŒØ± Ø³Ø±ÛŒØ¹ Ø¯Ø±ØµØ¯Ù‡Ø§):</label>
            <div class="scenario-btns">
                <button class="scenario-btn active" onclick="setScenario('default')">Ø¹Ø§Ø¯ÛŒ</button>
                <button class="scenario-btn" onclick="setScenario('survival')">Ø¨Ù‚Ø§ âš ï¸</button>
                <button class="scenario-btn" onclick="setScenario('travel')">Ø³ÙØ± âœˆï¸</button>
            </div>
        </div>
    </div>

    <!-- ÙˆØ±ÙˆØ¯ÛŒ Ù¾ÙˆÙ„ Ø§ØµÙ„ÛŒ -->
    <div class="money-section">
        <label style="display:block; margin-bottom:15px; font-weight:bold; color:var(--secondary)">
            <i class="fas fa-coins"></i> Ù…Ø¨Ù„Øº ÙˆØ±ÙˆØ¯ÛŒ Ú©Ù„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:
        </label>
        <input type="text" id="totalMoney" class="big-money-input" placeholder="0" onkeyup="formatMainInput(this)">
    </div>

    <!-- Ù†Ù…ÙˆØ¯Ø§Ø± -->
    <div class="chart-wrapper">
        <canvas id="myChart"></canvas>
    </div>

    <!-- Ù†ÙˆØ§Ø± ÙˆØ¶Ø¹ÛŒØª Ø¯Ø±ØµØ¯ -->
    <div class="status-bar" id="percentStatusBar">
        <span>Ø¬Ù…Ø¹ Ú©Ù„ Ø¯Ø±ØµØ¯Ù‡Ø§: 0%</span>
        <span>ÙˆØ¶Ø¹ÛŒØª: Ù†Ø±Ù…Ø§Ù„</span>
    </div>

    <!-- Ù„ÛŒØ³Øª Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡ -->
    <div id="rowContainer" class="budget-list">
        <!-- Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø§ Ù¾Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯ -->
    </div>

    <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ù¾Ø§ÛŒÛŒÙ† -->
    <div class="action-area">
        <button class="big-btn btn-add" onclick="addNewRow()" title="Ø§ÙØ²ÙˆØ¯Ù† Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯"><i class="fas fa-plus"></i></button>
        <button class="big-btn btn-calc" onclick="runCalc()"><i class="fas fa-calculator"></i> Ù…Ø­Ø§Ø³Ø¨Ù‡ Ùˆ Ø§Ø¹Ù…Ø§Ù„ ØªØºÛŒÛŒØ±Ø§Øª</button>
    </div>

</div>

<script>
    // --- Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
    const defaultStructure = [
        { name: "Û±. Ú©Ø±Ø§ÛŒÙ‡ Ø´Ù‡Ø±ÛŒ", percent: 27, spent: 0 },
        { name: "Û². Ø®ÙˆØ±Ø¯ Ùˆ Ø®ÙˆØ±Ø§Ú©", percent: 12, spent: 0 },
        { name: "Û³. Ø³ÙØ± (Ù…Ø´Ù‡Ø¯)", percent: 25, spent: 0 },
        { name: "Û´. Ø¯ÙˆØ§ Ùˆ Ø¯Ø±Ù…Ø§Ù†", percent: 3, spent: 0 },
        { name: "Ûµ. Ø´Ø§Ø±Ú˜ Ùˆ Ù†Øª", percent: 10, spent: 0 },
        { name: "Û¶. Ø²ÛŒØ¨Ø§ÛŒÛŒ Ùˆ Ù…Ú©Ù…Ù„", percent: 7, spent: 0 },
        { name: "Û·. Ù„Ø¨Ø§Ø³", percent: 5, spent: 0 },
        { name: "Û¸. Ø¶Ø±ÙˆØ±ÛŒ Ùˆ Ø§Ø¶Ø·Ø±Ø§Ø±ÛŒ", percent: 5, spent: 0 },
        { name: "Û¹. Ù‡Ø¯ÛŒÙ‡ Ùˆ ØªÙØ±ÛŒØ­", percent: 3, spent: 0 },
        { name: "Û±Û°. Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ú©Ù„", percent: 3, spent: 0 }
    ];

    const scenarios = {
        default: defaultStructure,
        survival: [
            { name: "Û±. Ú©Ø±Ø§ÛŒÙ‡ Ø­ÛŒØ§ØªÛŒ", percent: 40, spent: 0 },
            { name: "Û². Ø®ÙˆØ±Ø§Ú© Ø­ÛŒØ§ØªÛŒ", percent: 40, spent: 0 },
            { name: "Û³. Ø¯Ø±Ù…Ø§Ù† Ùˆ Ø¯Ø§Ø±Ùˆ", percent: 10, spent: 0 },
            { name: "Û´. Ø§ÛŒÙ†ØªØ±Ù†Øª Ùˆ Ø´Ø§Ø±Ú˜", percent: 10, spent: 0 }
        ],
        travel: [
            { name: "Û±. Ù¾Ø³â€ŒØ§Ù†Ø¯Ø§Ø² Ø³ÙØ±", percent: 60, spent: 0 },
            { name: "Û². Ú©Ø±Ø§ÛŒÙ‡", percent: 20, spent: 0 },
            { name: "Û³. Ø®ÙˆØ±Ø§Ú© Ø³Ø§Ø¯Ù‡", percent: 20, spent: 0 }
        ]
    };

    let appData = {
        userName: "Ø§Ù…ÛŒØ±Ø­Ø³ÛŒÙ†",
        currency: "ØªÙˆÙ…Ø§Ù†",
        totalIncome: 0,
        rows: JSON.parse(JSON.stringify(defaultStructure))
    };

    let chartObj = null;

    // --- Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    function init() {
        startClock();
        loadFromStorage();
        renderRows();
        updateUI();
    }

    // --- Ø³Ø§Ø¹Øª Ùˆ ØªØ§Ø±ÛŒØ® ---
    function startClock() {
        const update = () => {
            const now = new Date();
            // ØªØ§Ø±ÛŒØ® Ø´Ù…Ø³ÛŒ
            const dateOpts = { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'persian' };
            document.getElementById('date').innerText = new Intl.DateTimeFormat('fa-IR', dateOpts).format(now);
            // Ø³Ø§Ø¹Øª
            const timeOpts = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
            document.getElementById('clock').innerText = new Intl.DateTimeFormat('fa-IR', timeOpts).format(now);
        };
        setInterval(update, 1000);
        update();
    }

    // --- Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§ÙØ¸Ù‡ ---
    function loadFromStorage() {
        const saved = localStorage.getItem('budget_pro_v5');
        if(saved) {
            appData = JSON.parse(saved);
        }
        // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ù‡Ø¯Ø±
        document.getElementById('userTitle').innerText = appData.userName;
        document.getElementById('currencySelect').value = appData.currency;
        if(appData.totalIncome > 0) {
            document.getElementById('totalMoney').value = appData.totalIncome.toLocaleString('en-US');
        }
    }

    function saveToStorage() {
        localStorage.setItem('budget_pro_v5', JSON.stringify(appData));
    }

    // --- Ù…Ù†Ø·Ù‚ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---
    function editTitle() {
        const newName = prompt("Ù†Ø§Ù… Ø®ÙˆØ¯ ÛŒØ§ Ø¹Ù†ÙˆØ§Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:", appData.userName);
        if(newName) {
            appData.userName = newName;
            document.getElementById('userTitle').innerText = newName;
            saveToStorage();
        }
    }

    function formatMainInput(el) {
        // Ø­Ø°Ù Ù‡Ø±Ú†ÛŒØ²ÛŒ ØºÛŒØ± Ø§Ø² Ø¹Ø¯Ø¯
        let val = el.value.replace(/[^0-9Û°-Û¹]/g, '');
        // ØªØ¨Ø¯ÛŒÙ„ ÙØ§Ø±Ø³ÛŒ Ø¨Ù‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ
        val = toEnglishDigits(val);
        
        if(!val) {
            appData.totalIncome = 0;
            el.value = "";
        } else {
            appData.totalIncome = parseInt(val);
            el.value = parseInt(val).toLocaleString('en-US');
        }
        // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø²Ù†Ø¯Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)
        runCalc();
    }

    function runCalc() {
        // Û±. Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
        appData.currency = document.getElementById('currencySelect').value;
        
        // Û². Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ùˆ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
        updateRowsUI();
        updateTotalPercent();
        drawChart();
        saveToStorage();
    }

    function updateRowsUI() {
        const container = document.getElementById('rowContainer');
        // Ø¨Ù‡ Ø¬Ø§ÛŒ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ùˆ Ø³Ø§Ø®ØªÙ† Ù…Ø¬Ø¯Ø¯ (Ú©Ù‡ ÙÙˆÚ©Ø³ Ø±Ø§ Ù…ÛŒâ€ŒÙ¾Ø±Ø§Ù†Ø¯)ØŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø§Ø®Ù„ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        // Ø§Ù…Ø§ Ø§Ú¯Ø± ØªØ¹Ø¯Ø§Ø¯ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§ Ø¹ÙˆØ¶ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ø±Ù†Ø¯Ø± Ù…Ø¬Ø¯Ø¯ Ú©Ù†ÛŒÙ….
        const domRows = container.children;
        if(domRows.length !== appData.rows.length) {
            renderRows(); // Ø³Ø§Ø®ØªØ§Ø± ØªØºÛŒÛŒØ± Ú©Ø±Ø¯Ù‡ØŒ Ø±Ù†Ø¯Ø± Ú©Ø§Ù…Ù„
            return;
        }

        // Ø¢Ù¾Ø¯ÛŒØª Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¯Ø§Ø®Ù„ Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§
        appData.rows.forEach((item, index) => {
            const card = domRows[index];
            const budgetVal = (appData.totalIncome * item.percent) / 100;
            const remaining = budgetVal - item.spent;

            card.querySelector('.budget-display').innerText = formatNum(budgetVal) + " " + appData.currency;
            
            const remEl = card.querySelector('.remain-display');
            remEl.innerText = formatNum(remaining) + " " + appData.currency;
            remEl.className = remaining < 0 ? "stat-val rem-val neg" : "stat-val rem-val";
        });
    }

    function renderRows() {
        const container = document.getElementById('rowContainer');
        container.innerHTML = "";

        appData.rows.forEach((item, index) => {
            const budgetVal = (appData.totalIncome * item.percent) / 100;
            const remaining = budgetVal - item.spent;

            const div = document.createElement('div');
            div.className = 'budget-row';
            div.innerHTML = `
                <div class="row-header">
                    <input type="text" class="row-name" value="${item.name}" onchange="updateRowData(${index}, 'name', this.value)">
                    <div class="row-percent-group">
                        <input type="tel" class="row-percent" value="${item.percent}" oninput="updateRowData(${index}, 'percent', this.value)">
                        <span style="font-size:0.8rem">%</span>
                    </div>
                </div>
                
                <div class="row-body">
                    <div class="stat-col" onclick="copyText('${Math.round(budgetVal)}')" title="Ú©Ù¾ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡">
                        <span class="stat-label">Ø¨ÙˆØ¯Ø¬Ù‡</span>
                        <span class="stat-val budget-display">${formatNum(budgetVal)} ${appData.currency}</span>
                    </div>
                    <div class="stat-col">
                        <span class="stat-label">Ø®Ø±Ø¬ Ø´Ø¯Ù‡</span>
                        <input type="tel" class="expense-input" value="${item.spent > 0 ? item.spent.toLocaleString('en-US') : ''}" placeholder="0" oninput="updateRowData(${index}, 'spent', this.value)">
                    </div>
                    <div class="stat-col" onclick="copyText('${Math.round(remaining)}')" title="Ú©Ù¾ÛŒ Ù…Ø§Ù†Ø¯Ù‡">
                        <span class="stat-label">Ù…Ø§Ù†Ø¯Ù‡</span>
                        <span class="stat-val remain-display ${remaining<0?'neg':''}">${formatNum(remaining)} ${appData.currency}</span>
                    </div>
                </div>

                <div class="row-footer">
                    <button class="mini-btn" onclick="copyText('${Math.round(budgetVal)}')"><i class="far fa-copy"></i> Ú©Ù¾ÛŒ Ø¨ÙˆØ¯Ø¬Ù‡</button>
                    <button class="mini-btn btn-del" onclick="deleteRow(${index})"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function updateRowData(index, key, value) {
        if(key === 'name') {
            appData.rows[index].name = value;
        } else if (key === 'percent') {
            let val = parseFloat(toEnglishDigits(value)) || 0;
            appData.rows[index].percent = val;
            updateTotalPercent();
            drawChart();
        } else if (key === 'spent') {
            let val = parseInt(toEnglishDigits(value).replace(/[^0-9]/g, '')) || 0;
            appData.rows[index].spent = val;
            // ÙØ±Ù…Øª Ú©Ø±Ø¯Ù† Ø§ÛŒÙ†Ù¾ÙˆØª Ù‡Ù†Ú¯Ø§Ù… ØªØ§ÛŒÙ¾
            event.target.value = val > 0 ? val.toLocaleString('en-US') : '';
            // Ø¢Ù¾Ø¯ÛŒØª ØªÚ©ÛŒ Ù…Ø§Ù†Ø¯Ù‡ Ø­Ø³Ø§Ø¨ (Ø¨Ø¯ÙˆÙ† Ø±Ù†Ø¯Ø± Ú©Ø§Ù…Ù„)
            const budget = (appData.totalIncome * appData.rows[index].percent) / 100;
            const rem = budget - val;
            const card = document.getElementById('rowContainer').children[index];
            const remEl = card.querySelector('.remain-display');
            remEl.innerText = formatNum(rem) + " " + appData.currency;
            remEl.className = rem < 0 ? "stat-val rem-val neg" : "stat-val rem-val";
        }
        saveToStorage();
        if(key === 'percent') updateRowsUI(); // Ø§Ú¯Ø± Ø¯Ø±ØµØ¯ Ø¹ÙˆØ¶ Ø´Ø¯ØŒ Ù…Ø¨Ø§Ù„Øº Ø¨Ø§ÛŒØ¯ Ø¢Ù¾Ø¯ÛŒØª Ø´Ù†
    }

    function updateTotalPercent() {
        let total = 0;
        appData.rows.forEach(r => total += r.percent);
        const bar = document.getElementById('percentStatusBar');
        
        let msg = "Ù†Ø±Ù…Ø§Ù„";
        let color = "#334155"; // Ø®Ø§Ú©Ø³ØªØ±ÛŒ ØªÛŒØ±Ù‡

        if(total === 100) {
            msg = "âœ… Ø¹Ø§Ù„ÛŒ (ØªÚ©Ù…ÛŒÙ„)";
            color = "var(--success)";
        } else if (total > 100) {
            msg = `âš ï¸ Ø®Ø·Ø§: ${total - 100}% Ø§Ø¶Ø§ÙÙ‡ Ø§Ø³Øª!`;
            color = "var(--danger)";
        } else {
            msg = `ğŸ”µ ${100 - total}% Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡`;
            color = "var(--warning)";
        }

        bar.style.backgroundColor = color;
        bar.innerHTML = `<span>Ø¬Ù…Ø¹ Ø¯Ø±ØµØ¯Ù‡Ø§: ${total}%</span><span>${msg}</span>`;
    }

    function addNewRow() {
        appData.rows.push({ name: "Ù‡Ø²ÛŒÙ†Ù‡ Ø¬Ø¯ÛŒØ¯", percent: 0, spent: 0 });
        saveToStorage();
        renderRows();
    }

    function deleteRow(index) {
        if(confirm("Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ")) {
            appData.rows.splice(index, 1);
            saveToStorage();
            renderRows();
            updateTotalPercent();
            drawChart();
        }
    }

    function setScenario(type) {
        if(confirm("Ø¢ÛŒØ§ Ø³Ù†Ø§Ø±ÛŒÙˆ ØªØºÛŒÛŒØ± Ú©Ù†Ø¯ØŸ Ù…Ù‚Ø§Ø¯ÛŒØ± ÙØ¹Ù„ÛŒ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.")) {
            if(scenarios[type]) {
                appData.rows = JSON.parse(JSON.stringify(scenarios[type]));
                saveToStorage();
                renderRows();
                runCalc();
            }
        }
    }

    function fullReset() {
        if(confirm("Ù‡Ù…Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø§Ú© Ø´ÙˆØ¯ØŸ")) {
            localStorage.removeItem('budget_pro_v5');
            location.reload();
        }
    }

    function exportData() {
        const data = JSON.stringify(appData, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'budget_backup.json';
        a.click();
    }

    // --- Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ú©Ù…Ú©ÛŒ ---
    function toEnglishDigits(str) {
        return str.toString().replace(/[Û°-Û¹]/g, d => 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(d));
    }

    function formatNum(num) {
        return Math.round(num).toLocaleString('en-US');
    }

    function copyText(txt) {
        // Ú©Ù¾ÛŒ Ø¨Ø¯ÙˆÙ† Ø¬Ø¯Ø§Ú©Ù†Ù†Ø¯Ù‡ (Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ù†Ú©)
        navigator.clipboard.writeText(txt).then(() => {
            alert("Ù…Ø¨Ù„Øº Ú©Ù¾ÛŒ Ø´Ø¯: " + txt);
        });
    }

    // --- Ø±Ø³Ù… Ù†Ù…ÙˆØ¯Ø§Ø± ---
    function drawChart() {
        const ctx = document.getElementById('myChart').getContext('2d');
        const labels = appData.rows.map(r => r.name.split('.')[1] || r.name); // Ø§Ø³Ù… Ú©ÙˆØªØ§Ù‡
        const data = appData.rows.map(r => (appData.totalIncome * r.percent) / 100);
        
        if(chartObj) chartObj.destroy();

        chartObj = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: [
                        '#2563eb', '#16a34a', '#dc2626', '#ca8a04', 
                        '#9333ea', '#0891b2', '#db2777', '#475569'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { font: { family: 'Vazirmatn' } } }
                }
            }
        });
    }

    // --- Ø§Ø¬Ø±Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---
    init();

</script>

</body>
</html>
